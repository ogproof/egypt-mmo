<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Egypt MMO - Network Fixes Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .warning {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Egypt MMO - Network Fixes Test</h1>
    
    <div class="test-section">
        <h3>üß™ Network Connection Test</h3>
        <p>This page tests the networking fixes to prevent duplicate connections and initialization issues.</p>
        <button onclick="testNetworkInit()">Test Network Initialization</button>
        <button onclick="testMultipleConnections()">Test Multiple Connections</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>
    
    <div class="test-section">
        <h3>üìä Test Results</h3>
        <div id="log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>üîç Issues Fixed</h3>
        <ul>
            <li>‚úÖ Multiple startGame() calls prevention</li>
            <li>‚úÖ Duplicate network initialization prevention</li>
            <li>‚úÖ Duplicate event handler setup prevention</li>
            <li>‚úÖ Duplicate multiplayer callback setup prevention</li>
            <li>‚úÖ Duplicate world joins prevention</li>
            <li>‚úÖ Missing onTimeUpdate callback setter</li>
            <li>‚úÖ Connection race condition prevention</li>
        </ul>
    </div>
    
    <script>
        let logElement;
        let testCount = 0;
        
        // Mock NetworkManager for testing
        class MockNetworkManager {
            constructor() {
                this.isConnected = false;
                this.isInitialized = false;
                this.eventsSetup = false;
                this.connecting = false;
                this.playerId = null;
                this.sessionId = null;
                this.onPlayerJoin = null;
                this.onPlayerLeave = null;
                this.onPlayerMove = null;
                this.onChatMessage = null;
                this.onWorldUpdate = null;
                this.onTimeUpdate = null;
            }
            
            async init() {
                if (this.isInitialized) {
                    log('‚ö†Ô∏è NetworkManager already initialized, skipping...');
                    return;
                }
                
                log('üåê Initializing Network Manager...');
                this.isInitialized = true;
                log('‚úÖ Network Manager initialized');
            }
            
            async connect() {
                if (this.connecting) {
                    log('‚ö†Ô∏è Connection already in progress, skipping...');
                    return;
                }
                
                if (this.isConnected) {
                    log('‚úÖ Already connected to server');
                    return;
                }
                
                this.connecting = true;
                log('üåê Attempting to connect...');
                
                // Simulate connection delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                this.isConnected = true;
                this.connecting = false;
                this.playerId = 'test_player_' + Date.now();
                log(`üåê Connected to server - Player ID: ${this.playerId}`);
            }
            
            setupSocketEvents() {
                if (this.eventsSetup) {
                    log('‚ö†Ô∏è Socket events already set up, skipping...');
                    return;
                }
                
                log('üîß Setting up Socket.IO event handlers...');
                this.eventsSetup = true;
                log('‚úÖ Socket.IO event handlers set up successfully');
            }
            
            onPlayerJoin(callback) { this.onPlayerJoin = callback; }
            onPlayerLeave(callback) { this.onPlayerLeave = callback; }
            onPlayerMove(callback) { this.onPlayerMove = callback; }
            onChatMessage(callback) { this.onChatMessage = callback; }
            onWorldUpdate(callback) { this.onWorldUpdate = callback; }
            onTimeUpdate(callback) { this.onTimeUpdate = callback; }
            
            joinWorld(playerData) {
                log('üåç Joining world with data:', playerData);
            }
        }
        
        // Mock GameEngine for testing
        class MockGameEngine {
            constructor() {
                this.isInitialized = false;
                this.multiplayerCallbacksSetup = false;
                this.worldJoined = false;
                this.networkManager = null;
            }
            
            async init() {
                if (this.isInitialized) {
                    log('‚ö†Ô∏è GameEngine already initialized, skipping...');
                    return;
                }
                
                log('üéÆ Initializing Game Engine...');
                this.isInitialized = true;
                log('‚úÖ Game Engine initialized');
            }
            
            setNetworkManager(networkManager) {
                this.networkManager = networkManager;
                log('üîó Network Manager connected to Game Engine');
            }
            
            setupMultiplayerCallbacks() {
                if (this.multiplayerCallbacksSetup) {
                    log('‚ö†Ô∏è Multiplayer callbacks already set up, skipping...');
                    return;
                }
                
                log('üîß Setting up multiplayer callbacks...');
                
                if (!this.networkManager) {
                    log('‚ùå No network manager available for multiplayer callbacks');
                    return;
                }
                
                log('‚úÖ Network manager found, setting up callbacks...');
                
                // Set up callbacks
                this.networkManager.onPlayerJoin = (playerData) => {
                    log(`üë• Player joined: ${playerData.name}`);
                };
                
                this.networkManager.onPlayerLeave = (playerId) => {
                    log(`üë• Player left: ${playerId}`);
                };
                
                this.networkManager.onPlayerMove = (data) => {
                    log(`üë• Player moved: ${data.playerId}`);
                };
                
                this.networkManager.onWorldUpdate = (worldData) => {
                    log(`üåç World state update received`);
                };
                
                this.networkManager.onTimeUpdate = (timeData) => {
                    log(`üïê Time update received`);
                };
                
                log('‚úÖ Multiplayer callbacks set up successfully');
                this.multiplayerCallbacksSetup = true;
                
                // Join the world after setting up callbacks
                this.joinWorld();
            }
            
            async joinWorld() {
                if (this.worldJoined) {
                    log('‚ö†Ô∏è Already joined world, skipping...');
                    return;
                }
                
                if (!this.networkManager) {
                    log('‚ö†Ô∏è Cannot join world: no network manager');
                    return;
                }
                
                const playerData = {
                    name: 'TestPlayer',
                    position: { x: 0, y: 0, z: 0 },
                    rotation: { x: 0, y: 0, z: 0 },
                    level: 1,
                    skills: {},
                    inventory: [],
                    equipment: {}
                };
                
                log('üåç Joining world with player data:', playerData);
                this.networkManager.joinWorld(playerData);
                this.worldJoined = true;
            }
        }
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            let logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                logMessage += ` ${JSON.stringify(data, null, 2)}`;
            }
            
            logElement.innerHTML += logMessage + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }
        
        function testNetworkInit() {
            testCount++;
            log(`\nüß™ Test ${testCount}: Network Initialization`);
            
            const networkManager = new MockNetworkManager();
            const gameEngine = new MockGameEngine();
            
            // Test multiple init calls
            log('Testing multiple init calls...');
            networkManager.init();
            networkManager.init(); // Should be skipped
            
            // Test multiple connection attempts
            log('Testing multiple connection attempts...');
            networkManager.connect();
            networkManager.connect(); // Should be skipped
            
            // Test multiple event setup
            log('Testing multiple event setup...');
            networkManager.setupSocketEvents();
            networkManager.setupSocketEvents(); // Should be skipped
            
            // Test game engine setup
            log('Testing game engine setup...');
            gameEngine.setNetworkManager(networkManager);
            gameEngine.setupMultiplayerCallbacks();
            gameEngine.setupMultiplayerCallbacks(); // Should be skipped
        }
        
        function testMultipleConnections() {
            testCount++;
            log(`\nüß™ Test ${testCount}: Multiple Connections`);
            
            const networkManager = new MockNetworkManager();
            
            // Test rapid connection attempts
            log('Testing rapid connection attempts...');
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    networkManager.connect();
                }, i * 100);
            }
        }
        
        function clearLog() {
            logElement.innerHTML = '';
            testCount = 0;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            logElement = document.getElementById('log');
            log('üöÄ Network Fixes Test Page Loaded');
            log('Click the test buttons to verify the fixes work correctly');
        });
    </script>
</body>
</html>
