import{V as x,Q as H,C as ae,M as v,a as f,b as re,S as le,c as ce,A as de,d as Y,e as Q,R as he,f as B,D as U,G as F,g as q,h as z,P as X,F as ue,i as R,B as M,j as P,k as j,I as me,l as J,m as ge,n as pe,o as fe,p as ye,q as ee,r as Z,L as we,s as te,t as ie,u as ve,v as _e,W as be,w as Me,x as Se,y as xe,z as Ie,E as Ee,H as ke}from"./three-C8PiImrb.js";import{l as Ae}from"./networking-BsC3Nmyy.js";function Ne(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();class ne{constructor(e,t){this.scene=e,this.physicsWorld=t,this.position=new x(0,0,0),this.rotation=0,this.isMoving=!1,this.targetPosition=null,this.moveSpeed=15,this.movementQuat=new H,this.targetQuat=new H,this.movementPath=null,this.currentPathIndex=0,this.camera=null,this.mesh=null,this.nameTag=null,this.targetIndicator=null,this.equipment={head:null,chest:null,legs:null,feet:null,weapon:null,offhand:null,accessory:null},this.equipmentMeshes={weapon:null,offhand:null},this.equippedLight=null,this.mixer=null,this.animations={},this.currentAnimation="idle",this.cameraRotation=new H,this.cameraRotationDirection=0,this.rotationSpeed=.01,this.movementDirection=null,this.stats={health:100,maxHealth:100,level:1,experience:0},this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è Player already initialized, skipping...");return}console.log("üë§ Initializing Player..."),this.createMesh(),this.createNameTag(),this.setupAnimations(),this.position.set(0,0,0),this.mesh.position.copy(this.position),this.isInitialized=!0,console.log("‚úÖ Player initialized")}createMesh(){this.createHumanMesh(),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}createHumanMesh(){const e=new ae(.5,1.5,8,8),t=new v({color:7048739,transparent:!0,opacity:.9});this.mesh=new f(e,t),this.mesh.position.y=1.5,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,console.log("üë§ Simple capsule character created"),this.createNameTag()}animateWalk(e){this.mesh&&(this.mesh.position.y=1.5+Math.sin(e*8)*.1)}animateIdle(e){if(this.mesh){const s=1+Math.sin(e*2)*.02;this.mesh.scale.set(s,s,s)}}resetAnimation(){this.mesh&&(this.mesh.position.y=1.5,this.mesh.scale.set(1,1,1))}createNameTag(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=256,e.height=64,t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e.width,e.height),t.fillStyle="#ffffff",t.font="24px Arial",t.textAlign="center",t.fillText("Player",e.width/2,40);const i=new re(e),s=new le({map:i}),o=new ce(s);o.position.y=2.5,o.scale.set(2,.5,1),this.mesh.add(o)}setupAnimations(){this.mixer=new de(this.mesh),this.createIdleAnimation(),this.createWalkAnimation(),this.playAnimation("idle")}createIdleAnimation(){const e=[0,1,2],t=[[0,0,0,1],[0,.02,0,1],[0,0,0,1]],i=new Y(".quaternion",e,t.flat()),s=new Q("idle",2,[i]);this.animations.idle=this.mixer.clipAction(s)}createWalkAnimation(){const e=[0,.5,1],t=[[0,0,0,1],[0,.05,0,1],[0,0,0,1]],i=new Y(".quaternion",e,t.flat()),s=new Q("walk",1,[i]);this.animations.walk=this.mixer.clipAction(s)}playAnimation(e){this.currentAnimation!==e&&(this.animations[this.currentAnimation]&&this.animations[this.currentAnimation].stop(),this.animations[e]&&(this.animations[e].play(),this.currentAnimation=e))}handleKeyDown(e){switch(e){case"ArrowLeft":this.cameraRotationDirection=-1;break;case"ArrowRight":this.cameraRotationDirection=1;break}}handleKeyUp(e){switch(e){case"ArrowLeft":case"ArrowRight":this.cameraRotationDirection=0;break}}rotateCamera(e){if(this.cameraRotationDirection!==0){const t=new H().setFromAxisAngle(new x(0,1,0),this.cameraRotationDirection*this.rotationSpeed*e*60);this.cameraRotation.multiply(t)}}handleMouseMove(e,t){}update(e){if(!this.isInitialized)return;this.updateMovement(e);const t=performance.now()*.001;this.isMoving?this.animateWalk(t):this.animateIdle(t)}updateMovement(e){if(!this.isMoving||!this.targetPosition)return;if(this.position.distanceTo(this.targetPosition)<.2){this.isMoving=!1,this.targetPosition=null,this.movementPath=null,this.currentPathIndex=0;const l=this.scene.userData.gridManager;l&&l.clearHighlight(),console.log("‚úÖ Reached destination");return}const i=this.targetPosition.clone().sub(this.position).normalize(),s=this.moveSpeed*e,o=this.position.clone().add(i.multiplyScalar(s));if(this.position.copy(o),this.mesh.position.copy(this.position),this.camera&&(this.camera.position.x=this.position.x,this.camera.position.z=this.position.z+10,this.camera.lookAt(this.position)),i.length()>.1){const l=Math.atan2(i.x,i.z);this.mesh.rotation.y=l}this.nameTag&&(this.nameTag.position.copy(this.position),this.nameTag.position.y+=3),this.updateEquipmentPositions()}updateTorchAnimation(e){if(!this.equipmentMeshes.offhand)return;const t=Date.now()*.003,i=Math.sin(t*8)*.1+Math.sin(t*15)*.05+.95,s=this.equipmentMeshes.offhand.children[1];if(s&&s.scale.setScalar(i),this.equippedLight){const o=Math.sin(t*6)*.2+Math.sin(t*12)*.1+.9;this.equippedLight.intensity=1.5*o}}updatePhysics(e){if(!this.mesh||!this.mesh.parent){console.error("‚ùå Mesh is missing or not in scene!");return}if(this.mesh.position.x=this.position.x,this.mesh.position.y=this.position.y,this.mesh.position.z=this.position.z,this.mesh.updateMatrix(),this.isMoving&&Math.random()<.02&&(console.log("üîó Mesh Sync - Internal:",this.position.x.toFixed(2),this.position.z.toFixed(2)),console.log("üîó Mesh Sync - Mesh:",this.mesh.position.x.toFixed(2),this.mesh.position.z.toFixed(2))),this.movementDirection){const t=Math.atan2(this.movementDirection.x,this.movementDirection.z),i=new H().setFromAxisAngle(new x(0,1,0),t);this.mesh.quaternion.copy(i)}}updateAnimations(e){this.mixer&&this.mixer.update(e)}updateStats(e){}startGathering(e){console.log("Started gathering from ".concat(e.name||"resource"))}moveToPosition(e){console.log("üë§ Player.moveToPosition called with:",e);const t=this.scene.userData.gridManager;if(!t){console.warn("‚ùå Grid manager not found, using direct movement"),this.moveToPositionDirect(e);return}if(t.isWalkable(e))this.targetPosition=e.clone(),this.targetPosition.y=0,t.highlightCell(e),console.log("üë§ Moving to clicked position: ".concat(this.targetPosition.x.toFixed(1),", ").concat(this.targetPosition.z.toFixed(1)));else{const i=t.findNearestWalkable(e),s=t.getCellAtWorld(i);if(!s||s.state!=="walkable"){console.warn("‚ùå No walkable cell found at target position");return}t.highlightCell(i),this.targetPosition=i.clone(),this.targetPosition.y=0,console.log("üë§ Moving to nearest walkable: ".concat(this.targetPosition.x.toFixed(1),", ").concat(this.targetPosition.z.toFixed(1)))}this.isMoving=!0,this.showTargetIndicator(this.targetPosition),this.movementPath=[this.targetPosition.clone()],this.currentPathIndex=0,console.log("üó∫Ô∏è Direct path to target")}moveToPositionDirect(e){this.targetPosition=new x(e.x,0,e.z),this.isMoving=!0,console.log("üë§ Moving to position: ".concat(this.targetPosition.x,", ").concat(this.targetPosition.z)),this.showTargetIndicator(this.targetPosition)}showTargetIndicator(e){this.targetIndicator&&this.scene.remove(this.targetIndicator);const t=new he(.3,.5,16),i=new B({color:65280,transparent:!0,opacity:.7,side:U});this.targetIndicator=new f(t,i),this.targetIndicator.rotation.x=-Math.PI/2,this.targetIndicator.position.copy(e),this.targetIndicator.position.y=.1,this.scene.add(this.targetIndicator),setTimeout(()=>{this.targetIndicator&&(this.scene.remove(this.targetIndicator),this.targetIndicator=null)},3e3)}getPosition(){return this.position.clone()}getRotation(){return this.mesh.quaternion.clone()}getCameraRotation(){return this.cameraRotation.clone()}setCameraSpeed(e){this.rotationSpeed=.01*e}getStats(){return{...this.stats}}getEquipment(){return{...this.equipment}}takeDamage(e){return this.stats.health=Math.max(0,this.stats.health-e),this.stats.health<=0&&this.die(),this.stats.health}heal(e){return this.stats.health=Math.min(this.stats.maxHealth,this.stats.health+e),this.stats.health}addExperience(e){this.stats.experience+=e;const t=this.getExperienceForLevel(this.stats.level+1);return this.stats.experience>=t&&this.levelUp(),this.stats.experience}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUp(){this.stats.level++,this.stats.maxHealth+=10,this.stats.health=this.stats.maxHealth,console.log("üéâ Level up! You are now level ".concat(this.stats.level))}die(){console.log("üíÄ Player died!"),this.respawn()}respawn(){this.position.set(0,0,0),this.stats.health=this.stats.maxHealth,console.log("üîÑ Player respawned")}equipItem(e,t){this.equipment[t]&&this.unequipItem(t),this.equipment[t]=e,t==="offhand"&&e==="torch"&&this.equipTorch(),console.log("üîß Equipped ".concat(e," in ").concat(t," slot"))}unequipItem(e){const t=this.equipment[e];t&&(e==="offhand"&&t==="torch"&&this.unequipTorch(),this.equipment[e]=null,console.log("üîß Unequipped ".concat(t," from ").concat(e," slot")))}equipTorch(){const e=new F,t=new q(.05,.05,1.5,8),i=new v({color:9127187}),s=new f(t,i);s.position.y=.75,e.add(s);const o=new z(.08,.4,8),l=new B({color:16729344,transparent:!0,opacity:.8}),u=new f(o,l);u.position.y=1.6,e.add(u),e.position.set(0,0,.6),e.rotation.z=0,this.mesh.add(e),this.equipmentMeshes.offhand=e,this.equippedLight=new X(16739125,8,40,1),this.equippedLight.position.set(0,1.5,.6),this.equippedLight.isPlayerTorchLight=!0,this.mesh.add(this.equippedLight),console.log("üî• Bright torch equipped and lit!")}unequipTorch(){this.equipmentMeshes.offhand&&(this.mesh.remove(this.equipmentMeshes.offhand),this.equipmentMeshes.offhand=null),this.equippedLight&&(this.mesh.remove(this.equippedLight),this.equippedLight=null),console.log("üî• Torch unequipped and extinguished")}setCamera(e){this.camera=e,console.log("üì∑ Camera reference set for player")}updateEquipmentPositions(){this.equippedLight}destroy(){this.mesh&&this.scene.remove(this.mesh),this.mixer&&this.mixer.stopAllAction(),console.log("üë§ Player destroyed")}}class Te{constructor(e){this.scene=e,this.worldSize=1e3,this.terrain=null,this.pyramids=[],this.temples=[],this.sphinxes=[],this.obelisks=[],this.resourceNodes=[],this.decorations=[],this.camera=null,this.frameCount=0,this.frustum=new ue,this.visibleObjects=new Set,this.lodLevels=new Map,this.uiManager=null,this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è WorldManager already initialized, skipping...");return}console.log("üåç Initializing World Manager..."),this.createTerrain(),this.createEgyptianStructures(),this.createResourceNodes(),this.createDecorations(),this.createLighting(),this.protectImportantObjects(),this.isInitialized=!0,console.log("‚úÖ World Manager initialized")}createTerrain(){const e=new R(this.worldSize,this.worldSize,8,8),t=new v({color:9127187,side:U});this.terrain=new f(e,t),this.terrain.rotation.x=-Math.PI/2,this.terrain.receiveShadow=!0,this.terrain.castShadow=!1,this.terrain.userData.type="terrain",this.scene.add(this.terrain),this.addTerrainVariation()}addTerrainVariation(){const e=new R(this.worldSize,this.worldSize,6,6),t=new v({color:10506797,side:U,transparent:!0,opacity:.7}),i=new f(e,t);i.rotation.x=-Math.PI/2,i.position.y=.1,i.receiveShadow=!0,i.castShadow=!1;const s=i.geometry.attributes.position.array;for(let o=0;o<s.length;o+=3){const l=s[o],u=s[o+2],m=Math.sin(l*.02)*Math.cos(u*.02)*3+Math.sin(l*.05)*Math.cos(u*.05)*1.5+Math.sin(l*.1)*Math.cos(u*.1)*.5;s[o+1]=m}i.geometry.attributes.position.needsUpdate=!0,this.scene.add(i)}createEgyptianStructures(){this.createPyramids(),this.createTemples(),this.createSphinxes(),this.createObelisks()}createPyramids(){[{x:-100,z:-100,size:20},{x:100,z:-150,size:15},{x:-150,z:100,size:25}].forEach((t,i)=>{const s=this.createPyramid(t.size);s.position.set(t.x,0,t.z),s.userData.type="landmark",s.userData.name="Pyramid ".concat(i+1),this.scene.add(s),this.pyramids.push(s)})}createPyramid(e){const t=new z(e,e*1.5,4),i=new v({color:16032864,transparent:!0,opacity:.9}),s=new f(t,i);s.castShadow=!0,s.receiveShadow=!0;const o=new v({color:9139029,transparent:!0,opacity:.3}),l=new f(t,o);return l.scale.setScalar(.8),l.position.y=e*.1,s.add(l),s}createTemples(){[{x:50,z:50},{x:-80,z:80},{x:120,z:-80}].forEach((t,i)=>{const s=this.createTemple();s.position.set(t.x,0,t.z),s.userData.type="landmark",s.userData.name="Temple ".concat(i+1),this.scene.add(s),this.temples.push(s)})}createTemple(){const e=new F,t=new M(15,2,15),i=new v({color:13808780}),s=new f(t,i);s.position.y=1,s.castShadow=!0,s.receiveShadow=!0,e.add(s);const o=new M(10,8,10),l=new v({color:16032864}),u=new f(o,l);u.position.y=6,u.castShadow=!0,u.receiveShadow=!0,e.add(u);const m=new z(8,4,4),p=new v({color:9139029}),w=new f(m,p);w.position.y=12,w.castShadow=!0,w.receiveShadow=!0,e.add(w);for(let n=0;n<4;n++){const a=new q(.5,.5,6),r=new v({color:13808780}),c=new f(a,r),h=n/4*Math.PI*2;c.position.set(Math.cos(h)*8,4,Math.sin(h)*8),c.castShadow=!0,c.receiveShadow=!0,e.add(c)}return e}createSphinxes(){[{x:0,z:-200},{x:200,z:0},{x:-200,z:0}].forEach((t,i)=>{const s=this.createSphinx();s.position.set(t.x,0,t.z),s.userData.type="landmark",s.userData.name="Sphinx ".concat(i+1),this.scene.add(s),this.sphinxes.push(s)})}createSphinx(){const e=new F,t=new M(8,4,12),i=new v({color:13808780}),s=new f(t,i);s.position.y=2,s.castShadow=!0,s.receiveShadow=!0,e.add(s);const o=new M(4,3,4),l=new v({color:13808780}),u=new f(o,l);u.position.set(0,5,-4),u.castShadow=!0,u.receiveShadow=!0,e.add(u);const m=new P(.3,8,8),p=new v({color:0}),w=new f(m,p);w.position.set(-.8,5.5,-1.5),e.add(w);const n=new f(m,p);return n.position.set(.8,5.5,-1.5),e.add(n),e}createObelisks(){[{x:30,z:30},{x:-30,z:-30},{x:30,z:-30},{x:-30,z:30}].forEach((t,i)=>{const s=this.createObelisk();s.position.set(t.x,0,t.z),s.userData.type="landmark",s.userData.name="Obelisk ".concat(i+1),this.scene.add(s),this.obelisks.push(s)})}createObelisk(){const e=new F,t=new M(2,1,2),i=new v({color:9139029}),s=new f(t,i);s.position.y=.5,s.castShadow=!0,s.receiveShadow=!0,e.add(s);const o=new M(1,15,1),l=new v({color:13808780}),u=new f(o,l);u.position.y=8.5,u.castShadow=!0,u.receiveShadow=!0,e.add(u);const m=new z(.8,2,4),p=new v({color:16766720}),w=new f(m,p);return w.position.y=16,w.castShadow=!0,w.receiveShadow=!0,e.add(w),e}createResourceNodes(){[{type:"mining",name:"Copper Mine",color:13467442,position:{x:-50,z:-50}},{type:"mining",name:"Iron Mine",color:6908265,position:{x:50,z:-50}},{type:"woodcutting",name:"Palm Grove",color:2263842,position:{x:-50,z:50}},{type:"herbalism",name:"Herb Garden",color:3329330,position:{x:50,z:50}},{type:"fishing",name:"Oasis",color:52945,position:{x:0,z:-100}}].forEach((t,i)=>{const s=this.createResourceNode(t);s.position.set(t.position.x,0,t.position.z),s.userData.type="resource_node",s.userData.resourceType=t.type,s.userData.name=t.name,this.scene.add(s),this.resourceNodes[i]=s})}createResourceNode(e){let t,i;switch(e.type){case"mining":t=new z(3,6,8),i=new v({color:e.color});break;case"woodcutting":t=new q(2,3,8),i=new v({color:e.color});break;case"herbalism":t=new P(2,8,8),i=new v({color:e.color});break;case"fishing":t=new q(5,5,1),i=new v({color:e.color,transparent:!0,opacity:.6});break;default:t=new M(3,3,3),i=new v({color:e.color})}const s=new f(t,i);return s.position.y=t.parameters.height/2,s.castShadow=!0,s.receiveShadow=!0,s}createDecorations(){console.log("üè† Creating world decorations..."),this.createPalmTrees(),this.createRocks(),this.createSandDunes(),this.createMedievalHouse(),console.log("‚úÖ World decorations created")}createMedievalHouse(){console.log("üè† Creating detailed medieval house...");const e=new F,t=new x(15,0,15);e.position.copy(t),this.createHouseStructure(e),this.createHouseInterior(e),this.createHouseFurniture(e),this.createHouseDecorations(e),this.scene.add(e),this.decorations.push(e),console.log("‚úÖ Medieval house created at position:",t)}createHouseStructure(e){const t=new M(16,2,12),i=new v({color:6908265}),s=new f(t,i);s.position.y=1,s.castShadow=!0,s.receiveShadow=!0,e.add(s);const o=new M(15,6,11),l=new v({color:9127187}),u=new f(o,l);u.position.y=5,u.castShadow=!0,u.receiveShadow=!0,e.add(u);const m=new z(10,4,8),p=new v({color:6636321}),w=new f(m,p);w.position.y=11,w.castShadow=!0,w.receiveShadow=!0,e.add(w);const n=new M(3,5,.5),a=new v({color:6636321}),r=new f(n,a);r.position.set(0,2.5,5.8),e.add(r);const c=new M(2.6,4.6,.2),h=new v({color:9127187}),g=new f(c,h);g.position.set(0,2.3,6.2),e.add(g);const d=new M(2,2,.2),y=new v({color:8900331,transparent:!0,opacity:.7}),_=new f(d,y);_.position.set(-4,4,5.8),e.add(_);const S=new f(d,y);S.position.set(4,4,5.8),e.add(S);const k=new f(d,y);k.position.set(-3,4,-5.8),k.rotation.y=Math.PI,e.add(k);const E=new f(d,y);E.position.set(3,4,-5.8),E.rotation.y=Math.PI,e.add(E);const C=new M(1.5,4,1.5),L=new v({color:6908265}),b=new f(C,L);b.position.set(5,12,0),b.castShadow=!0,b.receiveShadow=!0,e.add(b)}createHouseInterior(e){const t=new M(14,.4,10),i=new v({color:9127187}),s=new f(t,i);s.position.set(0,.2,0),s.receiveShadow=!0,e.add(s);const o=new v({color:13808780}),l=new M(.4,5.6,10),u=new f(l,o);u.position.set(0,2.8,0),u.receiveShadow=!0,e.add(u);const m=new M(.4,5.6,10),p=new f(m,o);p.position.set(-4,2.8,0),p.receiveShadow=!0,e.add(p);const w=new M(.4,5.6,10),n=new f(w,o);n.position.set(4,2.8,0),n.receiveShadow=!0,e.add(n);const a=new M(14,5.6,.4),r=new f(a,o);r.position.set(0,2.8,-5),r.receiveShadow=!0,e.add(r);const c=new M(14,5.6,.4),h=new f(c,o);h.position.set(0,2.8,5),h.receiveShadow=!0,e.add(h)}createHouseFurniture(e){const t=new M(5,.6,3.6),i=new v({color:9127187}),s=new f(t,i);s.position.set(-5,.3,-3),s.castShadow=!0,s.receiveShadow=!0,e.add(s);const o=new M(4.6,.4,3.2),l=new v({color:14596231}),u=new f(o,l);u.position.set(-5,.7,-3),e.add(u);const m=new M(1.6,.2,1.2),p=new v({color:16119260}),w=new f(m,p);w.position.set(-5,1.1,-4.4),e.add(w);const n=new f(m,p);n.position.set(-5,1.1,-3.2),e.add(n);const a=new M(4,.2,2.4),r=new v({color:9127187}),c=new f(a,r);c.position.set(5,1.6,0),c.castShadow=!0,c.receiveShadow=!0,e.add(c);const h=new M(.2,1.6,.2),g=new v({color:6636321});for(let A=0;A<4;A++){const G=new f(h,g),V=5+(A%2===0?-1.8:1.8),oe=A<2?-1:1;G.position.set(V,.8,oe),e.add(G)}const d=new M(1.2,.2,1.2),y=new M(1.2,1.6,.2);[{x:5,z:2.5,rotation:0},{x:5,z:-2.5,rotation:Math.PI},{x:7.5,z:0,rotation:Math.PI/2},{x:2.5,z:0,rotation:-Math.PI/2}].forEach(A=>{const G=new f(d,r);G.position.set(A.x,.8,A.z),e.add(G);const V=new f(y,r);V.position.set(A.x,1.6,A.z+(A.rotation===0?.6:-.6)),V.rotation.y=A.rotation,e.add(V)});const S=new M(3,2.4,1.6),k=new v({color:6908265}),E=new f(S,k);E.position.set(0,1.2,-4.4),E.castShadow=!0,E.receiveShadow=!0,e.add(E);const C=new M(2,1.6,.6),L=new v({color:16729344,emissive:16729344,emissiveIntensity:.3}),b=new f(C,L);b.position.set(0,.8,-5.2),e.add(b);const $=new X(16739125,1,6);$.position.set(0,.8,-5.2),e.add($);const T=new f(t,i);T.position.set(5,.3,-3),T.castShadow=!0,T.receiveShadow=!0,e.add(T);const K=new f(o,l);K.position.set(5,.7,-3),e.add(K);const N=new f(m,p);N.position.set(5,1.1,-4.4),e.add(N);const D=new f(m,p);D.position.set(5,1.1,-3.2),e.add(D)}createHouseDecorations(e){const t=new R(3,2),i=new v({color:9109504}),s=new f(t,i);s.position.set(0,4,-4.8),s.rotation.y=Math.PI,e.add(s);const o=new q(.1,.1,.6),l=new v({color:16119260}),u=new f(o,l);u.position.set(5,1.9,0),e.add(u);const m=new P(.16),p=new v({color:16766720,emissive:16766720,emissiveIntensity:.5}),w=new f(m,p);w.position.set(5,2.3,0),e.add(w);const n=new X(16766720,.6,4);n.position.set(5,2.3,0),e.add(n);const a=new M(.6,.1,.4),r=new v({color:9127187});for(let $=0;$<5;$++){const T=new f(a,r);T.position.set(5+($-2)*.3,1.95,.4),T.rotation.z=Math.random()*.2-.1,e.add(T)}const c=new R(6,4),h=new v({color:9109504}),g=new f(c,h);g.position.set(0,.22,0),g.rotation.x=-Math.PI/2,e.add(g);const d=new M(1.5,1,1),y=new v({color:9127187}),_=new f(d,y);_.position.set(-5,.5,3),_.castShadow=!0,_.receiveShadow=!0,e.add(_);const S=new q(.2,.2,2),k=new v({color:6908265}),E=new f(S,k);E.position.set(5,1,3),e.add(E);const C=new P(.3),L=new v({color:6908265}),b=new f(C,L);b.position.set(5,2.2,3),e.add(b)}createPalmTrees(){[{x:-20,z:-20},{x:20,z:-20},{x:-20,z:20},{x:20,z:20}].forEach(t=>{const i=this.createPalmTree();i.position.set(t.x,0,t.z),this.scene.add(i),this.decorations.push(i)})}createPalmTree(){const e=new F,t=new q(.4,.6,8,8),i=new v({color:9127187,roughness:.8}),s=new f(t,i);s.position.y=4,s.castShadow=!0,s.receiveShadow=!0,s.scale.set(1,1,1),e.add(s);const o=[2263842,3329330,25600];[{height:7.5,radius:1.5,count:8},{height:6.8,radius:1.2,count:6},{height:6.1,radius:.9,count:4}].forEach(p=>{for(let w=0;w<p.count;w++){const n=this.createSimplePalmFrond(),a=w/p.count*Math.PI*2;n.position.set(Math.cos(a)*p.radius,p.height,Math.sin(a)*p.radius),n.rotation.y=a,n.rotation.x=Math.PI*.15,n.rotation.z=(Math.random()-.5)*.4;const r=Math.floor(Math.random()*o.length);n.children.forEach(c=>{c.material&&c.material.color.setHex(o[r])}),e.add(n)}});const u=new P(.1,6,6),m=new v({color:9127187});for(let p=0;p<6;p++){const w=new f(u,m),n=p/6*Math.PI*2,a=.6;w.position.set(Math.cos(n)*a,6.8,Math.sin(n)*a),e.add(w)}return e}createSimplePalmFrond(){const e=new F,t=new q(.02,.05,3,6),i=new v({color:2263842}),s=new f(t,i);s.position.y=1.5,e.add(s);const o=4;for(let l=0;l<o;l++){const u=new R(.8,.3,1,1),m=new v({color:2263842,side:U}),p=new f(u,m);p.position.y=l/o*2.5,p.position.x=l/o*.2,p.rotation.z=l/o*.3,e.add(p)}return e}createRocks(){const e=new j(1.5),t=new v({color:6908265}),i=new me(e,t,20);i.castShadow=!0,i.receiveShadow=!0;for(let s=0;s<20;s++){const o=new J,l=(Math.random()-.5)*this.worldSize,u=(Math.random()-.5)*this.worldSize;o.setPosition(l,1.5,u),o.scale(new x(Math.random()*.5+.75,Math.random()*.5+.75,Math.random()*.5+.75)),i.setMatrixAt(s,o)}this.scene.add(i),this.decorations.push(i)}createRock(){const e=new j(Math.random()*2+1),t=new v({color:6908265}),i=new f(e,t);return i.position.y=e.parameters.radius,i.castShadow=!0,i.receiveShadow=!0,i.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),i}createSandDunes(){for(let e=0;e<10;e++){const t=this.createSandDune(),i=(Math.random()-.5)*this.worldSize,s=(Math.random()-.5)*this.worldSize;t.position.set(i,0,s),this.scene.add(t),this.decorations.push(t)}}createSandDune(){const e=new z(8,4,8),t=new v({color:16032864,transparent:!0,opacity:.8}),i=new f(e,t);return i.position.y=2,i.castShadow=!0,i.receiveShadow=!0,i.rotation.y=Math.random()*Math.PI*2,i}createLighting(){this.dayNightCycle={time:0,cycleSpeed:1e-4,sun:null,moon:null,ambientLight:null,directionalLight:null,stars:[]},this.dayNightCycle.ambientLight=new ge(4210752,.4),this.scene.add(this.dayNightCycle.ambientLight),this.dayNightCycle.directionalLight=new pe(16777215,1),this.dayNightCycle.directionalLight.position.set(50,100,50),this.dayNightCycle.directionalLight.castShadow=!0,this.dayNightCycle.directionalLight.shadow.mapSize.width=2048,this.dayNightCycle.directionalLight.shadow.mapSize.height=2048,this.dayNightCycle.directionalLight.shadow.camera.near=.1,this.dayNightCycle.directionalLight.shadow.camera.far=300,this.dayNightCycle.directionalLight.shadow.camera.left=-100,this.dayNightCycle.directionalLight.shadow.camera.right=100,this.dayNightCycle.directionalLight.shadow.camera.top=100,this.dayNightCycle.directionalLight.shadow.camera.bottom=-100,this.dayNightCycle.directionalLight.shadow.bias=-1e-4,this.dayNightCycle.directionalLight.shadow.normalBias=.02,this.dayNightCycle.directionalLight.shadow.radius=2,this.dayNightCycle.directionalLight.shadow.camera.updateProjectionMatrix(),this.dayNightCycle.directionalLight.shadow.autoUpdate=!0,this.scene.add(this.dayNightCycle.directionalLight);const e=new P(10,16,16),t=new B({color:16766720});this.dayNightCycle.sun=new f(e,t),this.dayNightCycle.sun.castShadow=!1,this.dayNightCycle.sun.receiveShadow=!1,this.scene.add(this.dayNightCycle.sun);const i=new P(8,16,16),s=new B({color:15132410});this.dayNightCycle.moon=new f(i,s),this.dayNightCycle.moon.castShadow=!1,this.dayNightCycle.moon.receiveShadow=!1,this.scene.add(this.dayNightCycle.moon),this.createSkyGradient(),this.createStars(),this.createTorch(),this.dayNightCycle.time=.35,this.updateDayNightCycle()}createSkyGradient(){const e=new P(500,32,32),t=new fe({uniforms:{time:{value:0},topColor:{value:new ee(8900331)},bottomColor:{value:new ee(14743295)},offset:{value:33},exponent:{value:.6}},vertexShader:"\n                varying vec3 vWorldPosition;\n                void main() {\n                    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n                    vWorldPosition = worldPosition.xyz;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                uniform vec3 topColor;\n                uniform vec3 bottomColor;\n                uniform float offset;\n                uniform float exponent;\n                varying vec3 vWorldPosition;\n                void main() {\n                    float h = normalize(vWorldPosition + offset).y;\n                    gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);\n                }\n            ",side:ye});this.skyDome=new f(e,t),this.scene.add(this.skyDome)}updateDayNightCycle(){const e=this.dayNightCycle.time,t=e*Math.PI*2,i=(e+.5)*Math.PI*2,s=Math.sin(t)*300+400,o=Math.cos(t)*800;this.dayNightCycle.sun.position.set(o,s,0),this.dayNightCycle.directionalLight&&this.camera&&Math.random()<.02&&console.log("üåû Sun visual at: (".concat(o.toFixed(1),", ").concat(s.toFixed(1),") | Time: ").concat((e*24).toFixed(1),"h | Light intensity: ").concat(this.dayNightCycle.directionalLight.intensity.toFixed(1)));const l=Math.sin(i)*200+300,u=Math.cos(i)*600;this.dayNightCycle.moon.position.set(u,l,0),e>.25&&e<.75?(this.dayNightCycle.directionalLight.intensity=2,this.dayNightCycle.ambientLight.intensity=.8,this.updateSkyColors(8900331,14743295,16777215)):(this.dayNightCycle.directionalLight.intensity=1.5,this.dayNightCycle.ambientLight.intensity=.3,this.updateSkyColors(726054,1710638,1450302)),this.dayNightCycle.sun.visible=e>.25&&e<.75,this.dayNightCycle.moon.visible=e<=.25||e>=.75,e>.4&&e<.6?this.dayNightCycle.sun.material.color.setHex(16777215):e>.25&&e<.4?this.dayNightCycle.sun.material.color.setHex(16766720):e>.6&&e<.75&&this.dayNightCycle.sun.material.color.setHex(16739125)}updateSkyColors(e,t,i){this.skyDome&&this.skyDome.material.uniforms&&(this.skyDome.material.uniforms.topColor.value.setHex(e),this.skyDome.material.uniforms.bottomColor.value.setHex(t))}createStars(){const e=new P(.5,8,8),t=new B({color:16777215});for(let i=0;i<50;i++){const s=new f(e,t),o=Math.acos(-1+2*Math.random()),l=Math.sqrt(1-Math.pow(-1+2*Math.random(),2))*(2*Math.PI),u=400+Math.random()*100;s.position.set(u*Math.sin(o)*Math.cos(l),u*Math.cos(o),u*Math.sin(o)*Math.sin(l)),s.material.opacity=.5+Math.random()*.5,s.material.transparent=!0,this.dayNightCycle.stars.push(s),this.scene.add(s)}}createTorch(){this.torch=new F;const e=new q(.1,.1,2,8),t=new v({color:9127187}),i=new f(e,t);i.position.y=1,i.castShadow=!0,i.receiveShadow=!0,this.torch.add(i);const s=new z(.3,.5,8),o=new v({color:6636321}),l=new f(s,o);l.position.y=2.25,l.castShadow=!0,l.receiveShadow=!0,this.torch.add(l);const u=new z(.2,.8,8),m=new B({color:16729344,transparent:!0,opacity:.8});this.flame=new f(u,m),this.flame.position.y=2.6,this.flame.castShadow=!1,this.flame.receiveShadow=!1,this.torch.add(this.flame),this.torchLight=new X(16739125,1.5,15,2),this.torchLight.position.set(0,2.5,0),this.torchLight.castShadow=!0,this.torchLight.shadow.mapSize.width=512,this.torchLight.shadow.mapSize.height=512,this.torchLight.shadow.camera.near=.1,this.torchLight.shadow.camera.far=20,this.torchLight.shadow.camera.fov=90,this.torchLight.shadow.bias=-.001,this.torchLight.shadow.radius=1,this.torch.add(this.torchLight),this.torch.position.set(60,0,60),this.torch.rotation.y=Math.PI/4,this.scene.add(this.torch),this.torchElements={flame:this.flame,light:this.torchLight},console.log("üî• Torch created and placed in the world")}updateStarsVisibility(){const e=this.dayNightCycle.time,t=e<=.25||e>=.75;this.dayNightCycle.stars.forEach(i=>{if(i.visible=t,t){const s=Math.sin(Date.now()*.001+i.position.x*.01)*.3+.7;i.material.opacity=s}})}update(e){if(this.updateDayNightCycleProgress(e),this.updateDecorations(e),this.camera){if(this.frameCount||(this.frameCount=0),this.frameCount++,this.frameCount%10===0&&(this.updateFrustum(),this.updateObjectVisibility(),this.updateLOD(this.camera.position)),this.frameCount%5===0&&this.ensureCloseObjectsVisible(),this.updateShadowCamera(),this.frameCount%300===0){const t=this.dayNightCycle.directionalLight.shadow.camera;console.log("üì∑ Shadow Camera - Pos: (".concat(t.position.x.toFixed(1),", ").concat(t.position.y.toFixed(1),", ").concat(t.position.z.toFixed(1),") | Looking at: (").concat(this.dayNightCycle.directionalLight.target.position.x.toFixed(1),", ").concat(this.dayNightCycle.directionalLight.target.position.y.toFixed(1),", ").concat(this.dayNightCycle.directionalLight.target.position.z.toFixed(1),")"))}this.frameCount%60===0&&(console.log("üåç World update - Time: ".concat((this.dayNightCycle.time*24).toFixed(1),"h | Camera set: ").concat(!!this.camera," | Light: ").concat(!!this.dayNightCycle.directionalLight)),this.frameCount%600===0&&this.debugLights(),this.frameCount===1&&this.checkForDefaultLights(),this.frameCount%1800===0&&this.monitorObjectHealth(),this.frameCount%720===0&&this.debugObjectVisibility(),this.frameCount%3600===0&&this.validateWorldIntegrity())}else(!this.frameCount||this.frameCount%120===0)&&console.log("üåç World update - Camera not set in WorldManager")}updateDayNightCycleProgress(e){this.dayNightCycle.time+=this.dayNightCycle.cycleSpeed*e*60,this.dayNightCycle.time>=1&&(this.dayNightCycle.time=0),this.updateDayNightCycle(),this.updateAtmosphericEffects(),this.uiManager&&this.uiManager.updateTimeDisplay(this.dayNightCycle.time)}updateAtmosphericEffects(){const e=this.dayNightCycle.time;e>.2&&e<.3||e>.7&&e<.8?(this.scene.fog||(this.scene.fog=new Z(15132410,100,300)),this.scene.fog.color.setHex(15132410)):e>.25&&e<.75?this.scene.fog&&(this.scene.fog=null):(this.scene.fog||(this.scene.fog=new Z(726054,50,200)),this.scene.fog.color.setHex(726054)),this.updateTerrainColors(e),this.updateStarsVisibility()}updateShadowCamera(){if(!this.dayNightCycle.directionalLight||!this.camera)return;const e=this.camera.position,t=this.dayNightCycle.time,i=t*Math.PI*2,s=Math.cos(i)*200,o=Math.sin(i)*100+100,l=e.x+s,u=e.z,m=o;this.dayNightCycle.directionalLight.position.set(l,m,u);const p=e.x-s,w=e.z;this.dayNightCycle.directionalLight.target.position.set(p,0,w),this.dayNightCycle.directionalLight.target.updateMatrixWorld(!0),this.dayNightCycle.directionalLight.shadow.needsUpdate=!0,this.frameCount%600===0&&(console.log("üåû PROPER Shadow System - Sun at (".concat(s.toFixed(1),", ").concat(o.toFixed(1),") | Time: ").concat((t*24).toFixed(1),"h")),console.log("üîç Light pos: (".concat(l.toFixed(1),", ").concat(m.toFixed(1),", ").concat(u.toFixed(1),") | Target: (").concat(p.toFixed(1),", 0, ").concat(w.toFixed(1),")")))}updateTerrainColors(e){if(this.terrain){const t=this.terrain.material;e>.25&&e<.75?t.color.setHex(9127187):e>.4&&e<.6?t.color.setHex(13808780):e>.25&&e<.4||e>.6&&e<.75?t.color.setHex(13468991):t.color.setHex(6636321)}}updateDecorations(e){this.updateTorchAnimation(e)}updateTorchAnimation(e){if(!this.torchElements)return;const t=Date.now()*.003,i=Math.sin(t*8)*.1+Math.sin(t*15)*.05+.95;this.torchElements.flame.scale.setScalar(i),this.torchElements.flame.rotation.z=Math.sin(t*3)*.1;const s=Math.sin(t*6)*.2+Math.sin(t*12)*.1+.9;this.torchElements.light.intensity=1.5*s;const o=Math.sin(t*4)*.1;this.torchElements.light.color.setRGB(1,.42+o,.21+o*.5)}getWorldSize(){return this.worldSize}getChunkSize(){return this.chunkSize}getResourceNodes(){return Array.from(this.resourceNodes.values())}getLandmarks(){return[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks]}destroy(){this.scene.remove(this.terrain),this.buildings.forEach(e=>{this.scene.remove(e)}),this.resourceNodes.forEach(e=>{this.scene.remove(e)}),this.npcs.forEach(e=>{this.scene.remove(e)}),this.decorations.forEach(e=>{this.scene.remove(e)}),this.pyramids.forEach(e=>{this.scene.remove(e)}),this.temples.forEach(e=>{this.scene.remove(e)}),this.sphinxes.forEach(e=>{this.scene.remove(e)}),this.obelisks.forEach(e=>{this.scene.remove(e)}),this.torch&&this.scene.remove(this.torch),console.log("üåç World Manager destroyed")}setCamera(e){console.log("üåç Camera set in WorldManager:",e?"YES":"NO"),this.camera=e,this.updateFrustum(),console.log("üîç Checking all lights after camera set:"),this.debugLights()}updateFrustum(){this.camera&&this.frustum.setFromProjectionMatrix(new J().multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse))}isObjectVisible(e){return!this.frustum||!e.geometry?!0:(e.geometry.boundingSphere||e.geometry.computeBoundingSphere(),this.frustum.intersectsSphere(e.geometry.boundingSphere))}updateObjectVisibility(){this.camera&&this.optimizeObjectVisibility()}updateStructureVisibility(e){e.forEach(t=>{t&&(t.visible=!0,this.visibleObjects.add(t))})}updateLOD(e){this.pyramids.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)}),this.temples.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)}),this.sphinxes.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)})}applyLOD(e,t){t>300?e.geometry&&e.geometry.attributes.position.count>200&&e.geometry.setDrawRange(0,200):t>150?e.geometry&&e.geometry.attributes.position.count>300&&e.geometry.setDrawRange(0,300):e.geometry&&e.geometry.setDrawRange(0,e.geometry.attributes.position.count)}setShadowDistance(e){if(this.camera){const t=this.camera.position;this.pyramids.forEach(i=>{const s=t.distanceTo(i.position);i.castShadow=s<e,i.receiveShadow=s<e}),this.temples.forEach(i=>{const s=t.distanceTo(i.position);i.castShadow=s<e,i.receiveShadow=s<e}),this.sphinxes.forEach(i=>{const s=t.distanceTo(i.position);i.castShadow=s<e,i.receiveShadow=s<e}),this.obelisks.forEach(i=>{const s=t.distanceTo(i.position);i.castShadow=s<e,i.receiveShadow=s<e})}}checkForDefaultLights(){if(console.log("üîç Checking for default Three.js lights..."),this.scene.children.length>0){let e=!1;this.scene.children.forEach((t,i)=>{t.isLight&&t!==this.dayNightCycle.directionalLight&&t!==this.dayNightCycle.ambientLight&&(console.log("‚ö†Ô∏è Found default light at index ".concat(i,":"),t.type),e=!0,console.log("üîß Removing default light: ".concat(t.type)),this.scene.remove(t))}),e||console.log("‚úÖ No default lights found")}}setUIManager(e){this.uiManager=e}debugLights(){console.log("üîç Debugging all lights in scene:");let e=0;this.scene.traverse(t=>{t.isLight&&(e++,console.log("  Light ".concat(e,": ").concat(t.type," at (").concat(t.position.x.toFixed(1),", ").concat(t.position.y.toFixed(1),", ").concat(t.position.z.toFixed(1),")")),console.log("    - Intensity: ".concat(t.intensity)),console.log("    - Casts shadows: ".concat(t.castShadow)),console.log("    - Name: ".concat(t.name||"unnamed")),t===this.dayNightCycle.directionalLight?console.log("    - ‚úÖ This is the day/night cycle light"):t===this.dayNightCycle.ambientLight?console.log("    - ‚úÖ This is the day/night cycle ambient light"):t.isPlayerTorchLight?console.log("    - üî• This is the player's equipped torch light"):console.log("    - ‚ÑπÔ∏è Additional light source"))}),console.log("Total lights found: ".concat(e))}cleanupUnusedResources(){console.log("üåç Starting WorldManager resource cleanup...");const e=this.pyramids.length,t=this.temples.length,i=this.sphinxes.length,s=this.obelisks.length,o=this.resourceNodes.length,l=this.decorations.length;this.cleanupCorruptedObjects(),this.optimizeObjectVisibility(),console.log("üåç Cleanup completed:"),console.log("  - Pyramids: ".concat(e," ‚Üí ").concat(this.pyramids.length)),console.log("  - Temples: ".concat(t," ‚Üí ").concat(this.temples.length)),console.log("  - Sphinxes: ".concat(i," ‚Üí ").concat(this.sphinxes.length)),console.log("  - Obelisks: ".concat(s," ‚Üí ").concat(this.obelisks.length)),console.log("  - Resources: ".concat(o," ‚Üí ").concat(this.resourceNodes.length)),console.log("  - Decorations: ".concat(l," ‚Üí ").concat(this.decorations.length))}cleanupCorruptedObjects(){const e=[];this.pyramids.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted pyramid detected, removing:",t),e.push({object:t,type:"pyramid",index:i}))}),this.temples.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted temple detected, removing:",t),e.push({object:t,type:"temple",index:i}))}),this.sphinxes.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted sphinx detected, removing:",t),e.push({object:t,type:"sphinx",index:i}))}),this.obelisks.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted obelisk detected, removing:",t),e.push({object:t,type:"obelisk",index:i}))}),this.resourceNodes.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted resource node detected, removing:",t),e.push({object:t,type:"resource",index:i}))}),this.decorations.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("‚ö†Ô∏è Corrupted decoration detected, removing:",t),e.push({object:t,type:"decoration",index:i}))}),e.forEach(({object:t,type:i,index:s})=>{this.removeObjectSafely(t,i,s)}),e.length>0&&console.log("üîß Removed ".concat(e.length," corrupted objects"))}isObjectCorrupted(e){return!!(!e||!e.isObject3D||e.position&&(isNaN(e.position.x)||isNaN(e.position.y)||isNaN(e.position.z)||!isFinite(e.position.x)||!isFinite(e.position.y)||!isFinite(e.position.z))||e.geometry&&!e.geometry.attributes||e.material&&!e.material.isMaterial||e.position&&(Math.abs(e.position.x)>this.worldSize*2||Math.abs(e.position.z)>this.worldSize*2||e.position.y<-100||e.position.y>1e3))}optimizeObjectVisibility(){if(!this.camera)return;const e=this.camera.position,t=300,i=200,s=50;this.pyramids.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)}),this.temples.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)}),this.sphinxes.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)}),this.obelisks.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)}),this.resourceNodes.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)}),this.decorations.forEach(o=>{const l=e.distanceTo(o.position);if(o.visible=!0,l<=s)o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count);else if(l>i){if(o.geometry&&o.geometry.attributes.position){const u=l>t?.5:.8;o.geometry.setDrawRange(0,Math.floor(o.geometry.attributes.position.count*u))}}else o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count)})}validateWorldIntegrity(){console.log("üåç Starting world integrity validation...");let e=0,t=0,i=0;return[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks,...this.resourceNodes,...this.decorations].forEach((o,l)=>{e++,this.isObjectCorrupted(o)?(i++,console.warn("‚ö†Ô∏è Invalid object at index ".concat(l,":"),o)):t++}),this.scene&&this.scene.traverse(o=>{o&&o.isObject3D&&o!==this.terrain&&(e++,this.isObjectCorrupted(o)?(i++,console.warn("‚ö†Ô∏è Invalid scene object:",o)):t++)}),console.log("üåç World integrity check: ".concat(t," valid, ").concat(i," invalid out of ").concat(e," total objects")),i>0&&(console.warn("‚ö†Ô∏è ".concat(i," invalid objects detected - running cleanup...")),this.cleanupCorruptedObjects()),{total:e,valid:t,invalid:i}}debugObjectVisibility(){if(!this.camera)return;const e=this.camera.position;console.log("üîç Debugging object visibility near camera:",e.toArray().map(s=>s.toFixed(1)));let t=0,i=0;return this.pyramids.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden pyramid at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),this.temples.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden temple at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),this.sphinxes.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden sphinx at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),this.obelisks.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden obelisk at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),this.resourceNodes.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden resource at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),this.decorations.forEach((s,o)=>{const l=e.distanceTo(s.position);s.visible?i++:(t++,console.warn("‚ö†Ô∏è Hidden decoration at index ".concat(o,", distance: ").concat(l.toFixed(1))),s.visible=!0)}),t>0?console.warn("üîß Fixed ".concat(t," hidden objects, ").concat(i," were already visible")):console.log("‚úÖ All objects are visible (".concat(i," total)")),{hidden:t,visible:i}}forceAllObjectsVisible(){console.log("üîß Force making all objects visible..."),this.pyramids.forEach(e=>e.visible=!0),this.temples.forEach(e=>e.visible=!0),this.sphinxes.forEach(e=>e.visible=!0),this.obelisks.forEach(e=>e.visible=!0),this.resourceNodes.forEach(e=>e.visible=!0),this.decorations.forEach(e=>e.visible=!0),console.log("‚úÖ All objects forced to visible")}protectImportantObjects(){this.terrain&&(this.terrain.userData.protected=!0,this.terrain.userData.critical=!0),this.dayNightCycle&&(this.dayNightCycle.ambientLight&&(this.dayNightCycle.ambientLight.userData.protected=!0,this.dayNightCycle.ambientLight.userData.critical=!0),this.dayNightCycle.directionalLight&&(this.dayNightCycle.directionalLight.userData.protected=!0,this.dayNightCycle.directionalLight.userData.critical=!0)),this.torchLight&&(this.torchLight.userData.protected=!0,this.torchLight.userData.critical=!0)}removeObjectSafely(e,t,i){if(e.userData&&e.userData.protected)return console.warn("‚ö†Ô∏è Attempted to remove protected ".concat(t,", skipping:"),e),!1;try{switch(this.scene&&e.parent&&this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(s=>s.dispose()):e.material.dispose()),t){case"pyramid":this.pyramids.splice(i,1);break;case"temple":this.temples.splice(i,1);break;case"sphinx":this.sphinxes.splice(i,1);break;case"obelisk":this.obelisks.splice(i,1);break;case"resource":this.resourceNodes.splice(i,1);break;case"decoration":this.decorations.splice(i,1);break}return console.log("‚úÖ Successfully removed corrupted ".concat(t," at index ").concat(i)),!0}catch(s){return console.error("‚ùå Error removing corrupted ".concat(t,":"),s),!1}}monitorObjectHealth(){const e=this.worldSize*.1,t=new x(0,0,0),i=[];return this.pyramids.forEach((s,o)=>{s.position.distanceTo(t)>e&&i.push({object:s,type:"pyramid",index:o,distance:s.position.distanceTo(t)})}),this.temples.forEach((s,o)=>{s.position.distanceTo(t)>e&&i.push({object:s,type:"temple",index:o,distance:s.position.distanceTo(t)})}),this.sphinxes.forEach((s,o)=>{s.position.distanceTo(t)>e&&i.push({object:s,type:"sphinx",index:o,distance:s.position.distanceTo(t)})}),this.obelisks.forEach((s,o)=>{s.position.distanceTo(t)>e&&i.push({object:s,type:"obelisk",index:o,distance:s.position.distanceTo(t)})}),i.length>0&&(console.warn("‚ö†Ô∏è ".concat(i.length," objects have drifted too far from center:")),i.forEach(({type:s,index:o,distance:l})=>{console.warn("  - ".concat(s," at index ").concat(o,": ").concat(l.toFixed(1)," units from center"))})),i}restoreDriftedObjects(){this.monitorObjectHealth().forEach(({object:t,type:i,index:s})=>{const o=this.getRestoredPosition(t,i);o&&(t.position.copy(o),console.log("‚úÖ Restored ".concat(i," at index ").concat(s," to position:"),o))})}getRestoredPosition(e,t){const i=this.worldSize/2;switch(t){case"pyramid":return new x((Math.random()-.5)*i*.8,0,(Math.random()-.5)*i*.8);case"temple":return new x((Math.random()-.5)*i*.6,0,(Math.random()-.5)*i*.6);case"sphinx":return new x((Math.random()-.5)*i*.7,0,(Math.random()-.5)*i*.7);case"obelisk":return new x((Math.random()-.5)*i*.5,0,(Math.random()-.5)*i*.5);default:return new x((Math.random()-.5)*i*.4,0,(Math.random()-.5)*i*.4)}}ensureCloseObjectsVisible(){if(!this.camera)return;const e=this.camera.position,t=100,i=[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks,...this.resourceNodes,...this.decorations];let s=0;i.forEach(o=>{o&&o.position&&e.distanceTo(o.position)<=t&&(o.visible=!0,s++,o.geometry&&o.geometry.attributes.position&&o.geometry.setDrawRange(0,o.geometry.attributes.position.count))}),s>0&&this.frameCount%300===0&&console.log("üîí Safety check: Ensuring ".concat(s," objects within ").concat(t,"m are visible"))}}class Ce{constructor(e,t=1e3,i=2){this.scene=e,this.worldSize=t,this.gridSize=i,this.gridCells=new Map,this.visibleCells=new Set,this.highlightedCell=null,this.gridMesh=null,this.cellsX=Math.ceil(t/i),this.cellsZ=Math.ceil(t/i),this.totalCells=this.cellsX*this.cellsZ,this.cellStates={EMPTY:"empty",WALKABLE:"walkable",OBSTACLE:"obstacle",WATER:"water",BUILDING:"building"},console.log("üó∫Ô∏è Grid Manager initialized: ".concat(this.cellsX,"x").concat(this.cellsZ," cells (").concat(this.totalCells," total) - ").concat(i,"x").concat(i," units each"))}init(){console.log("üó∫Ô∏è Initializing Grid Manager..."),this.createGrid(),this.initializeCellStates(),this.createGridVisualization(),console.log("‚úÖ Grid Manager initialized")}createGrid(){for(let e=0;e<this.cellsX;e++)for(let t=0;t<this.cellsZ;t++){const i=this.getCellKey(e,t),s=e*this.gridSize-this.worldSize/2+this.gridSize/2,o=t*this.gridSize-this.worldSize/2+this.gridSize/2;this.gridCells.set(i,{x:e,z:t,worldX:s,worldZ:o,center:new x(s,0,o),state:this.cellStates.WALKABLE,occupied:!1,height:0,objects:[]})}}initializeCellStates(){this.gridCells.forEach((e,t)=>{(e.x===0||e.x===this.cellsX-1||e.z===0||e.z===this.cellsZ-1)&&(e.state=this.cellStates.OBSTACLE);const i=this.cellsX/2,s=this.cellsZ/2;Math.sqrt(Math.pow(e.x-i,2)+Math.pow(e.z-s,2))<20&&(e.state=this.cellStates.WALKABLE)})}createGridVisualization(){this.gridMesh=new F,this.scene.add(this.gridMesh),this.createGridLines(),this.gridMesh.visible=!1,console.log("üó∫Ô∏è Grid visualization created (hidden by default - press G to show)")}createGridLines(){const e=new we({color:4473924,transparent:!0,opacity:.1});for(let t=0;t<=this.cellsX;t++){const i=t*this.gridSize-this.worldSize/2,s=new te().setFromPoints([new x(i,0,-this.worldSize/2),new x(i,0,this.worldSize/2)]),o=new ie(s,e);this.gridMesh.add(o)}for(let t=0;t<=this.cellsZ;t++){const i=t*this.gridSize-this.worldSize/2,s=new te().setFromPoints([new x(-this.worldSize/2,0,i),new x(this.worldSize/2,0,i)]),o=new ie(s,e);this.gridMesh.add(o)}}worldToGrid(e){const t=Math.floor((e.x+this.worldSize/2)/this.gridSize),i=Math.floor((e.z+this.worldSize/2)/this.gridSize);return{x:t,z:i}}gridToWorld(e,t){const i=e*this.gridSize-this.worldSize/2+this.gridSize/2,s=t*this.gridSize-this.worldSize/2+this.gridSize/2;return new x(i,0,s)}getCellKey(e,t){return"".concat(e,",").concat(t)}getCellAtWorld(e){const t=this.worldToGrid(e),i=this.getCellKey(t.x,t.z);return this.gridCells.get(i)}getCellAtGrid(e,t){const i=this.getCellKey(e,t);return this.gridCells.get(i)}isWalkable(e){const t=this.getCellAtWorld(e);return t&&t.state===this.cellStates.WALKABLE&&!t.occupied}findNearestWalkable(e){const t=this.worldToGrid(e),i=10;for(let s=0;s<=i;s++)for(let o=-s;o<=s;o++)for(let l=-s;l<=s;l++)if(Math.abs(o)===s||Math.abs(l)===s){const u=t.x+o,m=t.z+l;if(u>=0&&u<this.cellsX&&m>=0&&m<this.cellsZ){const p=this.getCellAtGrid(u,m);if(p&&p.state===this.cellStates.WALKABLE&&!p.occupied)return p.center.clone()}}return e.clone()}highlightCell(e){this.clearHighlight();const t=this.getCellAtWorld(e);if(!t||t.state!==this.cellStates.WALKABLE)return!1;const i=new R(this.gridSize*.9,this.gridSize*.9),s=new B({color:65280,transparent:!0,opacity:.3,side:U});return this.highlightedCell=new f(i,s),this.highlightedCell.rotation.x=-Math.PI/2,this.highlightedCell.position.copy(t.center),this.highlightedCell.position.y=.1,this.scene.add(this.highlightedCell),!0}clearHighlight(){this.highlightedCell&&(this.scene.remove(this.highlightedCell),this.highlightedCell=null)}getPathToTarget(e,t){return this.worldToGrid(e),this.worldToGrid(e),[t.clone()]}toggleGrid(){this.gridMesh&&(this.gridMesh.visible=!this.gridMesh.visible,console.log("üó∫Ô∏è Grid visibility toggled:",this.gridMesh.visible))}setGridVisible(e){this.gridMesh&&(this.gridMesh.visible=e,console.log("üó∫Ô∏è Grid visibility set to:",e))}update(){}destroy(){this.clearHighlight(),this.gridMesh&&(this.scene.remove(this.gridMesh),this.gridMesh=null),this.gridCells.clear(),this.visibleCells.clear()}}class Pe{constructor(){this.keys=new Set,this.mousePosition={x:0,y:0},this.mouseButtons=new Set,this.touchEvents=[],this.isInitialized=!1,this.isMouseDown=!1,this.isTouchActive=!1,this.touchStartPosition={x:0,y:0},this.mouseSensitivity=1,this.mouseDelta={x:0,y:0},this.onKeyDown=null,this.onKeyUp=null,this.onMouseClick=null,this.onMouseMove=null,this.onTouchStart=null,this.onTouchMove=null,this.onTouchEnd=null}init(){if(this.isInitialized){console.warn("‚ö†Ô∏è InputManager already initialized, skipping...");return}this.setupKeyboardEvents(),this.setupMouseEvents(),this.setupTouchEvents(),console.log("üéÆ Input Manager initialized"),this.isInitialized=!0}setupKeyboardEvents(){document.addEventListener("keydown",e=>{if(e.repeat)return;const t=e.code||e.key;this.keys.add(t),this.onKeyDown&&this.onKeyDown(t),this.isGameKey(t)&&e.preventDefault()}),document.addEventListener("keyup",e=>{const t=e.code||e.key;this.keys.delete(t),this.onKeyUp&&this.onKeyUp(t)})}setupMouseEvents(){const e=document.getElementById("game-canvas");e&&(e.addEventListener("click",t=>{const i=e.getBoundingClientRect(),s=(t.clientX-i.left)/i.width*2-1,o=-((t.clientY-i.top)/i.height)*2+1;this.mousePosition={x:s,y:o},this.onMouseClick&&this.onMouseClick(t,{x:s,y:o})}),e.addEventListener("mousemove",t=>{const i=e.getBoundingClientRect(),s=(t.clientX-i.left)/i.width*2-1,o=-((t.clientY-i.top)/i.height)*2+1;this.mousePosition={x:s,y:o},this.onMouseMove&&this.onMouseMove(t,{x:s,y:o})}),e.addEventListener("mousedown",t=>{this.isMouseDown=!0}),e.addEventListener("mouseup",()=>{this.isMouseDown=!1}),e.addEventListener("contextmenu",t=>{t.preventDefault()}))}setupTouchEvents(){const e=document.getElementById("game-canvas");e&&(e.addEventListener("touchstart",t=>{if(t.preventDefault(),this.isTouchActive=!0,t.touches.length===1){const i=t.touches[0];this.touchStartPosition.x=i.clientX,this.touchStartPosition.y=i.clientY}}),e.addEventListener("touchmove",t=>{t.preventDefault()}),e.addEventListener("touchend",t=>{t.preventDefault(),this.isTouchActive=!1}))}isKeyPressed(e){return this.keys.has(e)}isAnyKeyPressed(){return this.keys.size>0}getMousePosition(){return{...this.mousePosition}}getMovementInput(){const e={x:0,z:0};if((this.isKeyPressed("KeyW")||this.isKeyPressed("ArrowUp"))&&(e.z=-1),(this.isKeyPressed("KeyS")||this.isKeyPressed("ArrowDown"))&&(e.z=1),(this.isKeyPressed("KeyA")||this.isKeyPressed("ArrowLeft"))&&(e.x=-1),(this.isKeyPressed("KeyD")||this.isKeyPressed("ArrowRight"))&&(e.x=1),e.x!==0&&e.z!==0){const t=Math.sqrt(e.x*e.x+e.z*e.z);e.x/=t,e.z/=t}return e}getActionInput(){return{jump:this.isKeyPressed("Space"),sprint:this.isKeyPressed("ShiftLeft"),interact:this.isKeyPressed("KeyE"),inventory:this.isKeyPressed("KeyI"),crafting:this.isKeyPressed("KeyC"),map:this.isKeyPressed("KeyM"),skills:this.isKeyPressed("KeyK")}}setOnKeyDown(e){this.onKeyDown=e}setOnKeyUp(e){this.onKeyUp=e}setOnMouseMove(e){this.onMouseMove=e}setOnMouseClick(e){this.onMouseClick=e}isGameKey(e){return["KeyW","KeyA","KeyS","KeyD","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","ShiftLeft","KeyE","KeyI","KeyC","KeyM","KeyK"].includes(e)}update(){}reset(){this.keys.clear(),this.mouseDelta.x=0,this.mouseDelta.y=0,this.isMouseDown=!1}setMouseSensitivity(e){this.mouseSensitivity=e,console.log("üñ±Ô∏è Mouse sensitivity updated to: ".concat(e))}exitPointerLock(){}destroy(){this.exitPointerLock(),this.reset(),console.log("üéÆ Input Manager destroyed")}}class Le{constructor(){this.recipes=new Map,this.isInitialized=!1,this.playerSkills={smithing:1,crafting:1,cooking:1,alchemy:1},this.playerExperience={smithing:0,crafting:0,alchemy:0,woodworking:0}}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è CraftingSystem already initialized, skipping...");return}console.log("‚öíÔ∏è Initializing Crafting System..."),this.loadRecipes(),this.isInitialized=!0,console.log("‚úÖ Crafting System initialized")}loadRecipes(){this.addRecipe("bronze_sword",{name:"Bronze Sword",type:"weapon",skill:"smithing",level:1,experience:25,materials:[{id:"bronze_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:5e3}),this.addRecipe("iron_sword",{name:"Iron Sword",type:"weapon",skill:"smithing",level:5,experience:50,materials:[{id:"iron_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:8e3}),this.addRecipe("steel_sword",{name:"Steel Sword",type:"weapon",skill:"smithing",level:10,experience:100,materials:[{id:"steel_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:12e3}),this.addRecipe("leather_armor",{name:"Leather Armor",type:"armor",skill:"crafting",level:1,experience:20,materials:[{id:"leather",quantity:3},{id:"thread",quantity:2}],tools:["needle"],time:4e3}),this.addRecipe("bronze_armor",{name:"Bronze Armor",type:"armor",skill:"smithing",level:5,experience:45,materials:[{id:"bronze_ingot",quantity:4},{id:"leather",quantity:2}],tools:["hammer"],time:1e4}),this.addRecipe("bronze_pickaxe",{name:"Bronze Pickaxe",type:"tool",skill:"smithing",level:1,experience:30,materials:[{id:"bronze_ingot",quantity:1},{id:"wood",quantity:2}],tools:["hammer"],time:6e3}),this.addRecipe("iron_pickaxe",{name:"Iron Pickaxe",type:"tool",skill:"smithing",level:5,experience:60,materials:[{id:"iron_ingot",quantity:1},{id:"wood",quantity:2}],tools:["hammer"],time:9e3}),this.addRecipe("health_potion",{name:"Health Potion",type:"potion",skill:"alchemy",level:1,experience:15,materials:[{id:"herbs",quantity:2},{id:"water",quantity:1}],tools:["mortar"],time:3e3}),this.addRecipe("strength_potion",{name:"Strength Potion",type:"potion",skill:"alchemy",level:5,experience:35,materials:[{id:"herbs",quantity:3},{id:"water",quantity:1},{id:"crystal",quantity:1}],tools:["mortar"],time:6e3}),this.addRecipe("wooden_shield",{name:"Wooden Shield",type:"armor",skill:"woodworking",level:1,experience:25,materials:[{id:"wood",quantity:4},{id:"leather",quantity:1}],tools:["chisel"],time:5e3})}addRecipe(e,t){this.recipes.set(e,t)}getRecipe(e){return this.recipes.get(e)}getAllRecipes(){return Array.from(this.recipes.values())}getRecipesBySkill(e){return Array.from(this.recipes.values()).filter(t=>t.skill===e)}getRecipesByLevel(e,t){return this.getRecipesBySkill(e).filter(i=>i.level<=t)}canCraftItem(e,t,i){const s=this.getRecipe(e);if(!s)return!1;if(this.playerSkills[s.skill]<s.level)return{canCraft:!1,reason:"Requires ".concat(s.skill," level ").concat(s.level)};for(const o of s.materials){const l=this.getMaterialQuantity(t,o.id);if(l<o.quantity)return{canCraft:!1,reason:"Need ".concat(o.quantity," ").concat(o.id,", have ").concat(l)}}for(const o of s.tools)if(!this.hasTool(i,o))return{canCraft:!1,reason:"Need ".concat(o," tool")};return{canCraft:!0}}craftItem(e,t,i){const s=this.canCraftItem(e,t,i);if(!s.canCraft)return console.log("Cannot craft ".concat(e,": ").concat(s.reason)),!1;const o=this.getRecipe(e);for(const u of o.materials)this.consumeMaterial(t,u.id,u.quantity);this.addExperience(o.skill,o.experience);const l=this.createItem(e,o);return console.log("Successfully crafted ".concat(l.name,"!")),console.log("Gained ".concat(o.experience," ").concat(o.skill," experience")),l}createItem(e,t){return{id:e,name:t.name,type:t.type,skill:t.skill,level:t.level,quality:this.calculateQuality(t.skill),durability:this.calculateDurability(t.skill),stats:this.calculateStats(t)}}calculateQuality(e){const t=this.playerSkills[e],i=1,s=(t-1)*.1;return Math.min(i+s,2)}calculateDurability(e){const t=this.playerSkills[e],i=100,s=(t-1)*10;return i+s}calculateStats(e){const t={},i=this.calculateQuality(e.skill);switch(e.type){case"weapon":t.damage=Math.floor(e.level*5*i),t.speed=Math.max(1-e.level*.05,.5);break;case"armor":t.defense=Math.floor(e.level*3*i),t.weight=e.level*.5;break;case"tool":t.efficiency=Math.floor(e.level*2*i),t.durability=this.calculateDurability(e.skill);break;case"potion":t.power=Math.floor(e.level*2*i),t.duration=e.level*30;break}return t}addExperience(e,t){this.playerExperience[e]+=t;const i=this.playerSkills[e],s=this.getExperienceForLevel(i+1);this.playerExperience[e]>=s&&this.levelUpSkill(e)}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUpSkill(e){return this.playerSkills[e]++,console.log("üéâ ".concat(e," leveled up to ").concat(this.playerSkills[e],"!")),this.playerSkills[e]}getMaterialQuantity(e,t){return{bronze_ingot:5,iron_ingot:3,steel_ingot:1,wood:10,leather:8,thread:15,herbs:20,water:50,crystal:2}[t]||0}consumeMaterial(e,t,i){console.log("Consumed ".concat(i," ").concat(t))}hasTool(e,t){return["hammer","needle","mortar","chisel"].includes(t)}getPlayerSkills(){return{...this.playerSkills}}getPlayerExperience(){return{...this.playerExperience}}getSkillLevel(e){return this.playerSkills[e]||0}getSkillExperience(e){return this.playerExperience[e]||0}getNextLevelProgress(e){const t=this.playerSkills[e],i=this.playerExperience[e],s=this.getExperienceForLevel(t),o=this.getExperienceForLevel(t+1),l=(i-s)/(o-s);return Math.max(0,Math.min(1,l))}getSkillInfo(e){return{level:this.playerSkills[e],experience:this.playerExperience[e],nextLevelExp:this.getExperienceForLevel(this.playerSkills[e]+1),progress:this.getNextLevelProgress(e)}}}class $e{constructor(){this.inventory={slots:[],gold:100,level:1,experience:0},this.equipment={head:null,chest:null,legs:null,feet:null,weapon:null,offhand:null,accessory:null},this.itemDatabase=new Map,this.maxSlots=64,this.slots=new Array(this.maxSlots).fill(null),this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è InventorySystem already initialized, skipping...");return}console.log("üéí Initializing Inventory System..."),console.log("üìö Loading item database..."),this.loadItemDatabase(),console.log("üìö Item database loaded with ".concat(this.itemDatabase.size," items")),console.log("üì¶ Adding starting items..."),this.addStartingItems(),this.isInitialized=!0,console.log("‚úÖ Inventory System initialized")}loadItemDatabase(){console.log("üìö Starting to load item database..."),this.addItemToDatabase("bronze_ingot",{name:"Bronze Ingot",type:"material",description:"A refined bronze ingot for crafting",stackable:!0,maxStack:100,value:5,rarity:"common"}),console.log("üìö Added bronze_ingot to database"),this.addItemToDatabase("iron_ingot",{name:"Iron Ingot",type:"material",description:"A refined iron ingot for crafting",stackable:!0,maxStack:100,value:10,rarity:"common"}),console.log("üìö Added iron_ingot to database"),this.addItemToDatabase("steel_ingot",{name:"Steel Ingot",type:"material",description:"A refined steel ingot for crafting",stackable:!0,maxStack:100,value:25,rarity:"uncommon"}),console.log("üìö Added steel_ingot to database"),this.addItemToDatabase("wood",{name:"Wood",type:"material",description:"Basic wood for crafting",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("üìö Added wood to database"),this.addItemToDatabase("leather",{name:"Leather",type:"material",description:"Tanned leather for crafting",stackable:!0,maxStack:100,value:3,rarity:"common"}),console.log("üìö Added leather to database"),this.addItemToDatabase("thread",{name:"Thread",type:"material",description:"Strong thread for sewing",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("üìö Added thread to database"),this.addItemToDatabase("herbs",{name:"Herbs",type:"material",description:"Medicinal herbs for alchemy",stackable:!0,maxStack:100,value:2,rarity:"common"}),console.log("üìö Added herbs to database"),this.addItemToDatabase("water",{name:"Water",type:"material",description:"Pure water for alchemy",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("üìö Added water to database"),this.addItemToDatabase("crystal",{name:"Crystal",type:"material",description:"Magical crystal for alchemy",stackable:!0,maxStack:50,value:15,rarity:"uncommon"}),console.log("üìö Added crystal to database"),this.addItemToDatabase("bronze_sword",{name:"Bronze Sword",type:"weapon",description:"A basic bronze sword",stackable:!1,value:50,rarity:"common",stats:{damage:5,speed:1},requirements:{level:1,strength:5}}),this.addItemToDatabase("iron_sword",{name:"Iron Sword",type:"weapon",description:"A sturdy iron sword",stackable:!1,value:120,rarity:"uncommon",stats:{damage:8,speed:.9},requirements:{level:5,strength:8}}),this.addItemToDatabase("leather_armor",{name:"Leather Armor",type:"armor",description:"Basic leather protection",stackable:!1,value:80,rarity:"common",stats:{defense:3,weight:.5},requirements:{level:1,agility:3}}),this.addItemToDatabase("hammer",{name:"Hammer",type:"tool",description:"Basic crafting hammer",stackable:!1,value:20,rarity:"common",stats:{efficiency:1,durability:100}}),this.addItemToDatabase("needle",{name:"Needle",type:"tool",description:"Sewing needle for crafting",stackable:!1,value:5,rarity:"common",stats:{efficiency:1,durability:50}}),this.addItemToDatabase("mortar",{name:"Mortar",type:"tool",description:"Mortar for alchemy",stackable:!1,value:15,rarity:"common",stats:{efficiency:1,durability:100}}),this.addItemToDatabase("chisel",{name:"Chisel",type:"tool",description:"Woodworking chisel",stackable:!1,value:12,rarity:"common",stats:{efficiency:1,durability:80}}),this.addItemToDatabase("torch",{name:"Torch",type:"light",description:"A wooden torch that provides light in darkness",stackable:!1,value:15,rarity:"common",stats:{lightRadius:15,lightIntensity:1.5,durability:100},requirements:{level:1},equipmentSlot:"offhand"})}addItemToDatabase(e,t){console.log("üìö Adding item to database: ".concat(e)),this.itemDatabase.set(e,{id:e,...t}),console.log("üìö Item ".concat(e," added to database. Current size: ").concat(this.itemDatabase.size))}addStartingItems(){console.log("üéí Adding starting items to inventory..."),console.log("üì¶ Adding bronze_ingot x5..."),this.addItem("bronze_ingot",5),console.log("üì¶ Adding wood x10..."),this.addItem("wood",10),console.log("üì¶ Adding leather x3..."),this.addItem("leather",3),console.log("üì¶ Adding thread x5..."),this.addItem("thread",5),console.log("üì¶ Adding herbs x8..."),this.addItem("herbs",8),console.log("üì¶ Adding water x20..."),this.addItem("water",20),console.log("üì¶ Adding hammer..."),this.addItem("hammer"),console.log("üì¶ Adding needle..."),this.addItem("needle"),console.log("üì¶ Adding mortar..."),this.addItem("mortar"),console.log("üì¶ Adding chisel..."),this.addItem("chisel"),console.log("üì¶ Adding torch..."),this.addItem("torch"),console.log("üéí Starting items added. Current inventory:",this.getInventory())}addItem(e,t=1){console.log("üéí Adding item: ".concat(e," x").concat(t));const i=this.itemDatabase.get(e);if(!i)return console.warn("‚ùå Item ".concat(e," not found in database")),!1;let s=!1;return i.stackable?s=this.addStackableItem(e,t):s=this.addNonStackableItem(e),s?(console.log("‚úÖ Successfully added ".concat(e," x").concat(t)),console.log("üéí Current inventory state:",this.getInventory())):console.warn("‚ùå Failed to add ".concat(e," x").concat(t)),s}addStackableItem(e,t){var i;for(let s=0;s<this.maxSlots;s++)if(this.slots[s]&&this.slots[s].id===e){const l=this.itemDatabase.get(e).maxStack-this.slots[s].quantity;if(l>0){const u=Math.min(t,l);if(this.slots[s].quantity+=u,t-=u,t<=0)return this.updateInventoryUI(),!0}}for(;t>0;){const s=this.findEmptySlot();if(s===-1)return console.warn("Inventory full!"),!1;const o=this.itemDatabase.get(e),l=Math.min(t,o.maxStack);this.slots[s]={id:e,quantity:l,quality:1,durability:((i=o.stats)==null?void 0:i.durability)||100},t-=l}return this.updateInventoryUI(),!0}addNonStackableItem(e){var s;const t=this.findEmptySlot();if(t===-1)return console.warn("Inventory full!"),!1;const i=this.itemDatabase.get(e);return this.slots[t]={id:e,quantity:1,quality:1,durability:((s=i.stats)==null?void 0:s.durability)||100},this.updateInventoryUI(),!0}findEmptySlot(){for(let e=0;e<this.maxSlots;e++)if(!this.slots[e])return e;return-1}removeItem(e,t=1){if(e<0||e>=this.maxSlots)return!1;const i=this.slots[e];return i?(i.quantity<=t?this.slots[e]=null:i.quantity-=t,this.updateInventoryUI(),!0):!1}findItemSlot(e){return this.slots.findIndex(t=>t&&t.id===e)}getItemQuantity(e){let t=0;for(const i of this.slots)i&&i.id===e&&(t+=i.quantity);return t}hasItem(e,t=1){return this.getItemQuantity(e)>=t}equipItem(e){const t=this.slots[e];if(!t)return!1;const i=this.itemDatabase.get(t.id);if(!i)return!1;if(i.type==="light"&&i.id==="torch")return this.equipTorch(e);if(i.type!=="weapon"&&i.type!=="armor")return console.warn("Cannot equip non-equipment item"),!1;if(!this.meetsRequirements(i.requirements))return console.warn("Requirements not met for equipping item"),!1;let s=null;return i.type==="weapon"?s="weapon":i.type==="armor"&&(s="chest"),s?(this.equipment[s]&&this.unequipItem(s),this.equipment[s]={...t,slotIndex:e},this.removeItem(e),console.log("Equipped ".concat(i.name)),this.updateInventoryUI(),!0):!1}equipTorch(e){const t=this.slots[e];return!t||t.id!=="torch"?!1:(this.equipment.offhand&&this.unequipItem("offhand"),this.equipment.offhand={...t,slotIndex:e},this.removeItem(e),console.log("üî• Torch equipped!"),this.updateInventoryUI(),!0)}unequipItem(e){const t=this.equipment[e];return t?(this.addItem(t.id,t.quantity),this.equipment[e]=null,console.log("Unequipped ".concat(t.id)),this.updateInventoryUI(),!0):!1}meetsRequirements(e){return e?!(e.level&&this.level<e.level):!0}addGold(e){return this.gold+=e,this.updateInventoryUI(),this.gold}removeGold(e){return this.gold>=e?(this.gold-=e,this.updateInventoryUI(),!0):!1}addExperience(e){this.experience+=e;const t=this.getExperienceForLevel(this.level+1);return this.experience>=t&&this.levelUp(),this.updateInventoryUI(),this.experience}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUp(){this.level++,console.log("üéâ Level up! You are now level ".concat(this.level)),this.addGold(this.level*10)}updateInventoryUI(){console.log("Inventory updated:",{slots:this.slots.filter(e=>e!==null).length,gold:this.gold,level:this.level,experience:this.experience})}getInventory(){return[...this.slots]}getEquipment(){return{...this.equipment}}getGold(){return this.gold}getLevel(){return this.level}getExperience(){return this.experience}getItemData(e){return this.itemDatabase.get(e)}equipItem(e,t){const i=this.itemDatabase.get(e);return i?i.equipmentSlot&&i.equipmentSlot!==t?(console.warn("Item ".concat(e," cannot be equipped in ").concat(t," slot")),!1):(this.equipment[t]&&this.unequipItem(t),this.equipment[t]={id:e,...i},console.log("üîß Equipped ".concat(i.name," in ").concat(t," slot")),this.updateInventoryUI(),!0):(console.warn("Item ".concat(e," not found in database")),!1)}unequipItem(e){if(!this.equipment[e])return!1;const t=this.equipment[e];return console.log("üîß Unequipped ".concat(t.name," from ").concat(e," slot")),this.addItem(t.id),this.equipment[e]=null,this.updateInventoryUI(),!0}isEquipped(e){for(const[t,i]of Object.entries(this.equipment))if(i&&i.id===e)return t;return!1}getInventoryValue(){let e=0;for(const t of this.slots)if(t){const i=this.itemDatabase.get(t.id);i&&(e+=i.value*t.quantity)}return e}getInventoryWeight(){let e=0;for(const t of this.slots)if(t){const i=this.itemDatabase.get(t.id);i&&i.stats&&i.stats.weight&&(e+=i.stats.weight*t.quantity)}return e}destroy(){this.slots=null,this.equipment=null,this.itemDatabase=null,console.log("üéí Inventory System destroyed")}}class De{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.player=null,this.worldManager=null,this.gridManager=null,this.inputManager=null,this.craftingSystem=null,this.inventorySystem=null,this.networkManager=null,this.audioManager=null,this.uiManager=null,this.optionsManager=null,this.clickIndicator=null,this.cameraOrbitAngle=0,this.cameraOrbitSpeed=.02,this.cameraOrbitDistance=10,this.cameraOrbitHeight=5,this.cameraOffsetX=0,this.cameraOffsetZ=10,this.cameraOffsetY=5,this.players=new Map,this.entities=[],this.lastCameraPosition=null,this.fps=0,this.frameCount=0,this.lastTime=0,this.isRunning=!1,this.isInitialized=!1,this.clock=new ve,this.animate=this.animate.bind(this),this.handleResize=this.handleResize.bind(this)}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è GameEngine already initialized, skipping...");return}console.log("üéÆ Initializing Game Engine..."),this.initScene(),this.worldManager=new Te(this.scene),this.gridManager=new Ce(this.scene,1e3,2),this.inputManager=new Pe,this.craftingSystem=new Le,this.inventorySystem=new $e,this.inputManager.init(),await this.inventorySystem.init(),this.gridManager.init(),await this.worldManager.init(),this.setupCamera(),this.player=new ne(this.scene,null),await this.player.init(),this.player.setCamera(this.camera),this.setupLighting(),this.setupInputHandlers(),this.setupDebugControls(),this.isInitialized=!0,console.log("‚úÖ Game Engine initialized"),this.monitorViewport()}initScene(){this.scene=new _e,this.scene.fog=new Z(1710638,50,200),this.renderer=new be({canvas:document.getElementById("game-canvas"),antialias:!0,alpha:!1,powerPreference:"high-performance",stencil:!1,depth:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Me,this.renderer.shadowMap.autoUpdate=!0,this.renderer.outputColorSpace=Se,this.renderer.toneMapping=xe,this.renderer.toneMappingExposure=1.2,this.renderer.sortObjects=!1,this.renderer.info.autoReset=!1,this.renderer.setClearColor(1710638)}setupCamera(){this.camera=new Ie(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.worldManager&&this.worldManager.setCamera(this.camera),this.player&&this.player.setCamera(this.camera),this.scene&&this.gridManager&&(this.scene.userData.gridManager=this.gridManager)}setupLighting(){console.log("üîß Lighting setup skipped - handled by WorldManager")}setupInputHandlers(){this.inputManager.onMouseClick=(e,t)=>{console.log("üéØ Mouse click detected:",t),this.handleMouseClick(t)},this.inputManager.onKeyDown=e=>{this.handleKeyDown(e)},this.inputManager.onKeyUp=e=>{this.handleKeyUp(e)}}handleMouseClick(e){console.log("üéØ Processing mouse click:",e);const t=this.getWorldPositionFromMouse(e);if(t)if(console.log("üéØ World position from mouse:",t),this.showClickIndicator(t),this.gridManager&&this.gridManager.isWalkable(t))console.log("‚úÖ Position is walkable, moving player"),this.player.moveToPosition(t);else{console.log("‚ùå Position is not walkable, finding nearest walkable cell");const i=this.gridManager.findNearestWalkable(t);this.player.moveToPosition(i)}else console.log("‚ùå Could not convert mouse to world position")}showClickIndicator(e){this.clickIndicator&&this.scene.remove(this.clickIndicator);const t=new P(.5,8,6),i=new B({color:16711680,transparent:!0,opacity:.8});this.clickIndicator=new f(t,i),this.clickIndicator.position.copy(e),this.clickIndicator.position.y=.5,this.scene.add(this.clickIndicator),setTimeout(()=>{this.clickIndicator&&(this.scene.remove(this.clickIndicator),this.clickIndicator=null)},2e3)}getWorldPositionFromMouse(e){const t=new Ee;t.setFromCamera(e,this.camera);const i=new ke(new x(0,1,0),0),s=new x;if(t.ray.intersectPlane(i,s))return console.log("üéØ Ground intersection found:",s),s;const o=t.intersectObjects(this.scene.children,!0);if(o.length>0){const l=o[0];return console.log("üéØ Object intersection found:",l.point),l.point}return null}handleObjectInteraction(e){e.userData.type==="crafting_station"&&this.uiManager.showCraftingPanel(),e.userData.type==="resource_node"&&this.player.startGathering(e),e.userData.type==="npc"&&this.uiManager.showNPCDialog(e.userData.npcId)}start(){this.isRunning||(this.isRunning=!0,this.clock.start(),this.gameLoop(),console.log("üéÆ Game loop started"))}stop(){this.isRunning=!1,this.clock.stop()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}gameLoop(){if(!this.isRunning||(requestAnimationFrame(()=>this.gameLoop()),this.isPaused))return;const e=this.clock.getDelta(),t=this.clock.getElapsedTime();this.player&&(this.player.update(e),this.updateCamera()),this.players.forEach((i,s)=>{i.update(e)}),this.entities.forEach(i=>{i.update(e)}),this.worldManager&&(!this.worldManager.camera&&this.camera&&this.worldManager.setCamera(this.camera),this.worldManager.update(e)),this.shouldRender()&&(this.renderer.render(this.scene,this.camera),this.renderer.shadowMap.enabled&&this.renderer.shadowMap.autoUpdate===!1&&(this.renderer.shadowMap.autoUpdate=!0,this.renderer.shadowMap.autoUpdate=!1)),this.updatePerformanceMetrics(t),this.frameCount++}shouldRender(){return this.lastCameraPosition?this.camera.position.distanceTo(this.lastCameraPosition)>.1?(this.lastCameraPosition.copy(this.camera.position),!0):this.frameCount%3===0:(this.lastCameraPosition=this.camera.position.clone(),!0)}setGraphicsQuality(e){if(!this.renderer){console.warn("üîß Renderer not available, skipping graphics quality change");return}try{switch(e){case"low":this.renderer.setPixelRatio(1),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!1),this.renderer.antialias=!1;break;case"medium":this.renderer.setPixelRatio(1.2),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!1;break;case"high":this.renderer.setPixelRatio(1.5),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!0;break;case"ultra":this.renderer.setPixelRatio(2),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!0;break;default:console.warn("üîß Unknown graphics quality: ".concat(e));return}console.log("üîß Graphics quality set to: ".concat(e))}catch(t){console.error("üîß Error setting graphics quality:",t)}}setRenderDistance(e){if(!this.camera){console.warn("üîß Camera not available, skipping render distance change");return}try{const t=parseInt(e);this.camera.far=t,this.camera.updateProjectionMatrix(),this.scene.fog?this.scene.fog.far=t*.8:(this.scene.fog=new Z(1710638,50,t*.8),console.log("üîß Created fog for render distance")),console.log("üîß Render distance set to: ".concat(e))}catch(t){console.error("üîß Error setting render distance:",t)}}setShadowQuality(e){if(!this.renderer||!this.renderer.shadowMap){console.warn("üîß Shadow map not available, skipping shadow quality change");return}try{switch(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.mapSize||(console.log("üîß Creating shadow map size property"),this.renderer.shadowMap.mapSize={width:1024,height:1024}),e){case"off":this.renderer.shadowMap.enabled=!1,this.disableAllLightShadows(),console.log("üîß Shadows disabled on renderer and all lights");return;case"low":this.renderer.shadowMap.mapSize.width=512,this.renderer.shadowMap.mapSize.height=512,this.enableAllLightShadows();break;case"medium":this.renderer.shadowMap.mapSize.width=1024,this.renderer.shadowMap.mapSize.height=1024,this.enableAllLightShadows();break;case"high":this.renderer.shadowMap.mapSize.width=2048,this.renderer.shadowMap.mapSize.height=2048,this.enableAllLightShadows();break;default:console.warn("üîß Unknown shadow quality: ".concat(e));return}this.renderer.shadowMap.needsUpdate=!0,console.log("üîß Shadow quality set to: ".concat(e))}catch(t){console.error("üîß Error setting shadow quality:",t)}}disableAllLightShadows(){this.scene&&this.scene.traverse(e=>{e.isLight&&(e.castShadow=!1,console.log("üîß Disabled shadow casting on light: ".concat(e.type)))})}enableAllLightShadows(){this.scene&&this.scene.traverse(e=>{e.isLight&&e.type==="DirectionalLight"&&(e.castShadow=!0,console.log("üîß Enabled shadow casting on light: ".concat(e.type)))})}setAntiAliasing(e){if(!this.renderer){console.warn("üîß Renderer not available, skipping anti-aliasing change");return}try{this.renderer.antialias=e,console.log("üîß Anti-aliasing ".concat(e?"enabled":"disabled"))}catch(t){console.error("üîß Error setting anti-aliasing:",t)}}setParticleEffects(e){this.particleEffectsEnabled=e,console.log("üîß Particle effects ".concat(e?"enabled":"disabled"))}setVSync(e){this.vsyncEnabled=e,console.log("üîß V-Sync preference set to: ".concat(e))}setFPSLimit(e){e==="unlimited"?this.fpsLimit=null:(this.fpsLimit=parseInt(e),this.frameInterval=1e3/this.fpsLimit),console.log("üîß FPS limit set to: ".concat(e))}isRendererReady(){return this.renderer&&this.camera&&this.scene}async waitForRenderer(){let e=0;const t=50;for(;!this.isRendererReady()&&e<t;)await new Promise(i=>setTimeout(i,100)),e++;return this.isRendererReady()?(console.log("üîß Renderer is ready for settings changes"),!0):(console.warn("üîß Renderer not ready after waiting, some settings may not apply"),!1)}debugShadows(){var i,s;if(!this.renderer){console.log("üîç No renderer available");return}if(console.log("üîç Shadow Debug Info:"),console.log("  - Shadow Map Enabled:",this.renderer.shadowMap.enabled),console.log("  - Shadow Map Size:",(i=this.renderer.shadowMap.mapSize)==null?void 0:i.width,"x",(s=this.renderer.shadowMap.mapSize)==null?void 0:s.height),console.log("  - Shadow Map Type:",this.renderer.shadowMap.type),console.log("  - Shadow Map Auto Update:",this.renderer.shadowMap.autoUpdate),console.log("  - Shadow Map Needs Update:",this.renderer.shadowMap.needsUpdate),this.worldManager&&this.worldManager.dayNightCycle){const o=this.worldManager.dayNightCycle.directionalLight;o&&(console.log("  - Directional Light Casts Shadows:",o.castShadow),console.log("  - Shadow Camera Near:",o.shadow.camera.near),console.log("  - Shadow Camera Far:",o.shadow.camera.far),console.log("  - Shadow Camera Bounds:",{left:o.shadow.camera.left,right:o.shadow.camera.right,top:o.shadow.camera.top,bottom:o.shadow.camera.bottom}))}let e=0;this.scene.traverse(o=>{o.castShadow&&e++}),console.log("  - Objects casting shadows:",e);let t=0;this.scene.traverse(o=>{o.isLight&&t++}),console.log("  - Total lights in scene:",t),console.log("  - Light Details:"),this.scene.traverse(o=>{o.isLight&&(console.log("    ".concat(o.type,": ").concat(o.name||"unnamed"," at (").concat(o.position.x.toFixed(1),", ").concat(o.position.y.toFixed(1),", ").concat(o.position.z.toFixed(1),")")),o.castShadow&&console.log("      Casts shadows: ".concat(o.castShadow)))})}debugMemory(){if(!this.renderer){console.log("üîç No renderer available");return}const e=this.renderer.info,t=e.memory,i=e.render;console.log("üîç Memory & Performance Debug:"),console.log("  - Triangles:",i.triangles.toLocaleString()),console.log("  - Draw Calls:",i.calls.toLocaleString()),console.log("  - Geometries:",t.geometries),console.log("  - Textures:",t.textures),console.log("  - FPS:",this.fps);let s=0,o=0,l=0;this.scene.traverse(u=>{s++,u.isMesh&&o++,u.isGroup&&l++}),console.log("  - Total Objects:",s),console.log("  - Meshes:",o),console.log("  - Groups:",l),i.triangles>5e6&&console.warn("‚ö†Ô∏è High triangle count detected - possible memory leak"),i.calls>5e4&&console.warn("‚ö†Ô∏è High draw call count detected - possible memory leak")}cleanupMemory(){this.renderer&&(this.renderer.info.reset(),window.gc?(window.gc(),console.log("üîß Memory cleanup completed")):console.log("üîß Renderer info reset (manual GC recommended)"))}cleanupUnusedResources(){if(!this.renderer||!this.scene)return;console.log("üîß Starting comprehensive resource cleanup...");const e=this.scene.children.length,t=this.renderer.info.memory.geometries,i=this.renderer.info.memory.materials;this.cleanupUnusedGeometries(),this.cleanupUnusedMaterials(),this.renderer.info.reset(),window.gc&&window.gc(),console.log("üîß Cleanup completed - Objects: ".concat(e," ‚Üí ").concat(this.scene.children.length)),console.log("üîß Geometries: ".concat(t," ‚Üí ").concat(this.renderer.info.memory.geometries)),console.log("üîß Materials: ".concat(i," ‚Üí ").concat(this.renderer.info.memory.materials))}cleanupUnusedGeometries(){this.worldManager&&this.worldManager.cleanupUnusedResources()}cleanupUnusedMaterials(){this.worldManager&&this.worldManager.cleanupUnusedResources()}validateSceneIntegrity(){if(!this.scene)return;let e=0,t=0;return this.scene.traverse(i=>{i&&i.isObject3D?(e++,i.position&&(isNaN(i.position.x)||isNaN(i.position.y)||isNaN(i.position.z))&&(console.warn("‚ö†Ô∏è Object with invalid position detected:",i),t++),i.geometry&&!i.geometry.attributes&&(console.warn("‚ö†Ô∏è Object with invalid geometry detected:",i),t++),i.material&&!i.material.isMaterial&&(console.warn("‚ö†Ô∏è Object with invalid material detected:",i),t++)):t++}),t>0?console.warn("‚ö†Ô∏è Scene integrity check: ".concat(e," valid, ").concat(t," invalid objects")):console.log("‚úÖ Scene integrity check: ".concat(e," valid objects")),{valid:e,invalid:t}}forceCleanup(){console.log("üîß Force cleanup triggered manually"),this.cleanupUnusedResources(),this.validateSceneIntegrity(),this.worldManager&&this.worldManager.validateWorldIntegrity()}debugMemoryUsage(){if(!this.renderer)return;const e=this.renderer.info,t=e.memory,i=e.render;console.log("üîß Memory Usage Debug:"),console.log("  - Geometries: ".concat(t.geometries)),console.log("  - Materials: ".concat(t.materials)),console.log("  - Textures: ".concat(t.textures)),console.log("  - Triangles: ".concat(i.triangles)),console.log("  - Draw Calls: ".concat(i.calls)),console.log("  - Scene Objects: ".concat(this.scene?this.scene.children.length:"N/A")),this.worldManager&&(console.log("üåç World Object Counts:"),console.log("  - Pyramids: ".concat(this.worldManager.pyramids.length)),console.log("  - Temples: ".concat(this.worldManager.temples.length)),console.log("  - Sphinxes: ".concat(this.worldManager.sphinxes.length)),console.log("  - Obelisks: ".concat(this.worldManager.obelisks.length)),console.log("  - Resources: ".concat(this.worldManager.resourceNodes.length)),console.log("  - Decorations: ".concat(this.worldManager.decorations.length)))}setupDebugControls(){document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&e.key==="C"&&(e.preventDefault(),console.log("üîß Debug: Manual cleanup triggered"),this.forceCleanup()),e.ctrlKey&&e.shiftKey&&e.key==="M"&&(e.preventDefault(),console.log("üîß Debug: Memory usage debug triggered"),this.debugMemoryUsage()),e.ctrlKey&&e.shiftKey&&e.key==="V"&&(e.preventDefault(),console.log("üîß Debug: Scene validation triggered"),this.validateSceneIntegrity()),e.ctrlKey&&e.shiftKey&&e.key==="O"&&(e.preventDefault(),console.log("üîß Debug: Object visibility debug triggered"),this.worldManager&&this.worldManager.debugObjectVisibility()),e.ctrlKey&&e.shiftKey&&e.key==="F"&&(e.preventDefault(),console.log("üîß Debug: Force all objects visible triggered"),this.worldManager&&this.worldManager.forceAllObjectsVisible())})}updateCamera(){if(!this.player)return;const e=this.player.getPosition();this.handleCameraOrbit();const t=new x(e.x+this.cameraOffsetX,e.y+this.cameraOffsetY,e.z+this.cameraOffsetZ);this.camera.position.copy(t),this.camera.lookAt(new x(e.x,e.y+1,e.z)),Math.random()<.005&&(console.log("üì∑ Camera position:",this.camera.position.toArray().map(i=>i.toFixed(2))),console.log("üë§ Player position:",e.toArray().map(i=>i.toFixed(2))),console.log("üì∑ Camera offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetY.toFixed(2),this.cameraOffsetZ.toFixed(2)))}handleCameraOrbit(){if(this.inputManager){if(this.inputManager.isKeyPressed("ArrowLeft")){const t=Math.atan2(this.cameraOffsetX,this.cameraOffsetZ)+this.cameraOrbitSpeed;this.cameraOffsetX=Math.sin(t)*this.cameraOrbitDistance,this.cameraOffsetZ=Math.cos(t)*this.cameraOrbitDistance,console.log("üì∑ Camera rotating left - New offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetZ.toFixed(2))}if(this.inputManager.isKeyPressed("ArrowRight")){const t=Math.atan2(this.cameraOffsetX,this.cameraOffsetZ)-this.cameraOrbitSpeed;this.cameraOffsetX=Math.sin(t)*this.cameraOrbitDistance,this.cameraOffsetZ=Math.cos(t)*this.cameraOrbitDistance,console.log("üì∑ Camera rotating right - New offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetZ.toFixed(2))}this.inputManager.isKeyPressed("ArrowUp")&&(this.cameraOffsetY+=this.cameraOrbitSpeed*2,this.cameraOffsetY=Math.min(15,this.cameraOffsetY),console.log("üì∑ Camera height increased to:",this.cameraOffsetY.toFixed(2))),this.inputManager.isKeyPressed("ArrowDown")&&(this.cameraOffsetY-=this.cameraOrbitSpeed*2,this.cameraOffsetY=Math.max(2,this.cameraOffsetY),console.log("üì∑ Camera height decreased to:",this.cameraOffsetY.toFixed(2)))}}updatePerformanceMetrics(e){if(e-this.lastTime>=1){const t=this.frameCount;this._fpsHistory||(this._fpsHistory=[]),this._fpsHistory.push(t),this._fpsHistory.length>5&&this._fpsHistory.shift(),this.fps=Math.round(this._fpsHistory.reduce((s,o)=>s+o,0)/this._fpsHistory.length),this.frameCount=0,this.lastTime=e;const i=this.renderer.info;i.memory,i.render,this.uiManager&&this.uiManager.updatePerformanceInfo(this.fps),this.frameCount%600===0&&this.cleanupMemory(),this.frameCount%1800===0&&this.cleanupUnusedResources(),this.frameCount%3600===0&&this.validateSceneIntegrity()}}animate(){if(!this.isRunning)return;requestAnimationFrame(this.animate);const e=performance.now(),t=(e-this.lastTime)/1e3;this.lastTime=e,this.frameCount++,this.frameCount%60===0&&(this.fps=Math.round(1/t)),this.worldManager&&this.worldManager.update(t),this.player&&this.player.update(t),this.inputManager&&this.inputManager.update(),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),this.updatePerformanceMetrics()}handleResize(){if(!this.camera||!this.renderer)return;console.log("üîÑ Handling resize event...");const e=window.innerWidth,t=window.innerHeight;console.log("üìê Viewport dimensions: ".concat(e,"x").concat(t)),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),this.uiManager&&this.uiManager.handleResize(e,t),console.log("‚úÖ Resize handled successfully")}handleResizeDebounced(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.handleResize()},100)}restoreViewport(){console.log("üîÑ Restoring viewport to full dimensions...");const e=window.innerWidth,t=window.innerHeight;this.renderer&&this.renderer.setSize(e,t,!1),this.camera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()),this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),console.log("‚úÖ Viewport restored to ".concat(e,"x").concat(t))}monitorViewport(){this.viewportMonitorInterval&&clearInterval(this.viewportMonitorInterval),this.viewportMonitorInterval=setInterval(()=>{const e=window.innerWidth,t=window.innerHeight;(this.lastViewportWidth!==e||this.lastViewportHeight!==t)&&(console.log("üìê Viewport changed: ".concat(this.lastViewportWidth,"x").concat(this.lastViewportHeight," ‚Üí ").concat(e,"x").concat(t)),this.lastViewportWidth=e,this.lastViewportHeight=t,(e<800||t<600)&&(console.log("‚ö†Ô∏è Viewport dimensions seem too small, attempting auto-restore..."),this.restoreViewport()))},1e3)}stopViewportMonitoring(){this.viewportMonitorInterval&&(clearInterval(this.viewportMonitorInterval),this.viewportMonitorInterval=null)}addPlayer(e,t){const i=new ne(this.scene,null);i.init(t),this.players.set(e,i)}removePlayer(e){const t=this.players.get(e);t&&(t.destroy(),this.players.delete(e))}setUIManager(e){this.uiManager=e,this.worldManager&&this.worldManager.setUIManager(e),e&&(e.gameEngine=this)}setNetworkManager(e){this.networkManager=e}setAudioManager(e){this.audioManager=e}setOptionsManager(e){this.optionsManager=e,console.log("‚öôÔ∏è Options Manager connected to Game Engine")}setMasterVolume(e){this.audioManager&&this.audioManager.setMasterVolume(e),console.log("üîä Master volume set to: ".concat(e))}setMusicVolume(e){this.audioManager&&this.audioManager.setMusicVolume(e),console.log("üéµ Music volume set to: ".concat(e))}setSFXVolume(e){this.audioManager&&this.audioManager.setSFXVolume(e),console.log("üîä SFX volume set to: ".concat(e))}setMouseSensitivity(e){this.inputManager&&this.inputManager.setMouseSensitivity(e),console.log("üñ±Ô∏è Mouse sensitivity set to: ".concat(e))}setCameraSpeed(e){this.player&&this.player.setCameraSpeed(e),console.log("üì∑ Camera speed set to: ".concat(e))}getPlayer(){return this.player}getScene(){return this.scene}getCamera(){return this.camera}getGridManager(){return this.gridManager}getCraftingSystem(){return this.craftingSystem}getInventorySystem(){return this.inventorySystem}handleKeyDown(e){switch(console.log("‚å®Ô∏è Key pressed:",e),this.player,e){case"KeyI":this.uiManager&&this.uiManager.toggleInventory();break;case"KeyC":this.uiManager&&this.uiManager.toggleCraftingPanel();break;case"KeyR":this.resetCamera();break;case"KeyD":this.debugCameraState();break;case"BracketLeft":break;case"BracketRight":break;case"Escape":console.log("‚å®Ô∏è Escape pressed - checking options manager..."),this.optionsManager?(console.log("‚úÖ Options manager found, toggling options..."),this.optionsManager.toggleOptions()):(console.log("‚ùå Options manager not found, falling back to hideAllPanels..."),this.uiManager&&this.uiManager.hideAllPanels());break}}debugCameraState(){if(console.log("üì∑ === Camera Debug Info ==="),console.log("üì∑ Current offsets:",{X:this.cameraOffsetX.toFixed(2),Y:this.cameraOffsetY.toFixed(2),Z:this.cameraOffsetZ.toFixed(2)}),console.log("üì∑ Camera position:",this.camera.position.toArray().map(e=>e.toFixed(2))),this.player){const e=this.player.getPosition();console.log("üë§ Player position:",e.toArray().map(t=>t.toFixed(2))),console.log("üì∑ Expected camera position:",[(e.x+this.cameraOffsetX).toFixed(2),(e.y+this.cameraOffsetY).toFixed(2),(e.z+this.cameraOffsetZ).toFixed(2)])}console.log("üì∑ ========================")}resetCamera(){this.cameraOffsetX=0,this.cameraOffsetY=5,this.cameraOffsetZ=10,console.log("üì∑ Camera reset to default orbital position")}handleKeyUp(e){console.log("‚å®Ô∏è Key released:",e)}}class qe{constructor(){this.gameEngine=null,this.isInitialized=!1,this.isVisible=!1,this.gameUI=null,this.craftingPanel=null,this.inventory=null,this.topHUD=null,this.actionButtons=null,this.activePanel=null,this.craftingCategory="weapons",this.performanceInfo=null,this.timeDisplay=null}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è UIManager already initialized, skipping...");return}if(console.log("üé® Initializing UI Manager..."),this.gameUI=document.getElementById("game-ui"),this.craftingPanel=document.getElementById("crafting-panel"),this.inventory=document.getElementById("inventory"),this.topHUD=document.querySelector(".top-hud"),this.actionButtons=document.querySelector(".action-buttons"),this.timeDisplay=document.getElementById("time-display"),!this.gameUI||!this.craftingPanel||!this.inventory)throw new Error("UI elements not found");this.setupEventListeners(),this.initializeCraftingItems(),this.initializeInventory(),this.initializeEquipmentSlots(),this.initializeTimeDisplay(),this.isInitialized=!0,console.log("‚úÖ UI Manager initialized")}setupEventListeners(){const e=document.getElementById("crafting-btn"),t=document.getElementById("inventory-btn"),i=document.getElementById("map-btn"),s=document.getElementById("skills-btn");e&&e.addEventListener("click",()=>this.showCraftingPanel()),t&&t.addEventListener("click",()=>this.showInventory()),i&&i.addEventListener("click",()=>this.showMap()),s&&s.addEventListener("click",()=>this.showSkills());const o=document.getElementById("close-crafting"),l=document.getElementById("close-inventory");o&&o.addEventListener("click",()=>this.hideCraftingPanel()),l&&l.addEventListener("click",()=>this.hideInventory()),document.querySelectorAll(".category-btn").forEach(m=>{m.addEventListener("click",()=>{this.setCraftingCategory(m.dataset.category)})}),this.addHelpText(),document.addEventListener("keydown",m=>{m.key==="t"||m.key==="T"?(console.log("üî• T key pressed - testing torch equipping..."),this.testTorchEquipping()):m.key==="i"||m.key==="I"?(console.log("üéí I key pressed - testing inventory..."),this.testInventory()):m.key==="r"||m.key==="R"?(console.log("üîÑ R key pressed - resetting camera..."),this.resetCamera()):m.key==="g"||m.key==="G"?(console.log("üó∫Ô∏è G key pressed - toggling grid..."),this.toggleGrid()):m.key==="c"||m.key==="C"?(console.log("üéØ C key pressed - testing click detection..."),this.testClickDetection()):m.key==="a"||m.key==="A"?(console.log("üé≠ A key pressed - testing player animations..."),this.testPlayerAnimations()):(m.key==="e"||m.key==="E")&&(console.log("üìã E key pressed - exporting model specifications..."),this.exportModelSpecs())})}initializeTimeDisplay(){}initializeCraftingItems(){if(!document.getElementById("crafting-items"))return;const t={weapons:[{id:"bronze_sword",name:"Bronze Sword",description:"Basic weapon",level:1,materials:["bronze_ingot","wood"]},{id:"iron_sword",name:"Iron Sword",description:"Improved weapon",level:5,materials:["iron_ingot","wood"]},{id:"steel_sword",name:"Steel Sword",description:"Advanced weapon",level:10,materials:["steel_ingot","wood"]}],armor:[{id:"leather_armor",name:"Leather Armor",description:"Basic protection",level:1,materials:["leather","thread"]},{id:"bronze_armor",name:"Bronze Armor",description:"Metal protection",level:5,materials:["bronze_ingot","leather"]},{id:"iron_armor",name:"Iron Armor",description:"Strong protection",level:10,materials:["iron_ingot","leather"]}],tools:[{id:"bronze_pickaxe",name:"Bronze Pickaxe",description:"Mining tool",level:1,materials:["bronze_ingot","wood"]},{id:"iron_pickaxe",name:"Iron Pickaxe",description:"Better mining",level:5,materials:["iron_ingot","wood"]},{id:"steel_pickaxe",name:"Steel Pickaxe",description:"Best mining",level:10,materials:["steel_ingot","wood"]}],potions:[{id:"health_potion",name:"Health Potion",description:"Restores health",level:1,materials:["herbs","water"]},{id:"strength_potion",name:"Strength Potion",description:"Increases strength",level:5,materials:["herbs","water","crystal"]},{id:"wisdom_potion",name:"Wisdom Potion",description:"Increases wisdom",level:10,materials:["herbs","water","crystal","essence"]}]};this.craftingItems=t}initializeInventory(){const e=document.getElementById("inventory-grid");if(e){for(let t=0;t<64;t++){const i=document.createElement("div");i.className="inventory-slot",i.dataset.slot=t,i.addEventListener("click",()=>{this.handleInventorySlotClick(t)}),i.addEventListener("contextmenu",s=>{s.preventDefault(),this.handleInventorySlotRightClick(t)}),e.appendChild(i)}this.initializeEquipmentSlots(),this.addItemToInventory(0,{id:"bronze_ingot",name:"Bronze Ingot",type:"material"}),this.addItemToInventory(1,{id:"wood",name:"Wood",type:"material"}),this.addItemToInventory(2,{id:"leather",name:"Leather",type:"material"}),this.addItemToInventory(3,{id:"torch",name:"Torch",type:"light"}),console.log("üéí Inventory initialized with sample items"),this.gameEngine&&this.syncWithInventorySystem()}}initializeEquipmentSlots(){document.querySelectorAll(".equipment-slot").forEach(t=>{t.addEventListener("click",()=>{this.handleEquipmentSlotClick(t.dataset.slot)}),t.addEventListener("contextmenu",i=>{i.preventDefault(),this.handleEquipmentSlotRightClick(t.dataset.slot)})})}addItemToInventory(e,t){const i=document.querySelector('[data-slot="'.concat(e,'"]'));i&&(i.classList.add("filled"),i.dataset.itemId=t.id,i.dataset.itemName=t.name,i.dataset.itemType=t.type,i.innerHTML='<span title="'.concat(t.name,'">').concat(this.getItemIcon(t),"</span>"))}getItemIcon(e){return{material:"üì¶",weapon:"‚öîÔ∏è",armor:"üõ°Ô∏è",tool:"üî®",potion:"üß™",food:"üçñ",gem:"üíé",light:"üî•"}[e.type]||"üì¶"}handleInventorySlotClick(e){const t=document.querySelector('[data-slot="'.concat(e,'"]'));if(!t||!t.classList.contains("filled")){console.log("‚ùå Slot ".concat(e," is empty or not found"));return}const i=t.dataset.itemId,s=t.dataset.itemName;console.log("üéØ Clicked on ".concat(s," (").concat(i,") in slot ").concat(e)),this.showItemInfo(i,s)}handleInventorySlotRightClick(e){const t=document.querySelector('[data-slot="'.concat(e,'"]'));if(!t||!t.classList.contains("filled"))return;const i=t.dataset.itemId,s=t.dataset.itemName,o=t.dataset.itemType;console.log("Right-clicked on ".concat(s," in slot ").concat(e)),o==="light"&&i==="torch"?this.equipTorch(e):o==="weapon"||o==="armor"?this.equipItem(i,s,e):this.showItemInfo(i,s)}equipTorch(e){if(console.log("üî• Equipping torch from slot ".concat(e)),!this.gameEngine){console.warn("Game engine not connected");return}const t=this.gameEngine.getInventorySystem();if(t)if(t.equipTorch(e)){console.log("üî• Torch equipped successfully!"),this.showNotification("üî• Torch equipped!","success");const s=this.gameEngine.getPlayer();s&&s.equipItem("torch","offhand"),this.updateInventoryDisplay()}else console.warn("Failed to equip torch"),this.showNotification("Failed to equip torch","error");else console.warn("Inventory system not found")}handleEquipmentSlotClick(e){const t=document.querySelector('[data-slot="'.concat(e,'"]'));if(t)if(console.log("üéØ Clicked on equipment slot: ".concat(e)),t.classList.contains("equipped")){const i=t.dataset.itemId,s=t.dataset.itemName;console.log("üîß Unequipping ".concat(s," from ").concat(e)),this.unequipItem(i,e),this.showNotification("üîß Unequipped ".concat(s),"info")}else console.log("üì≠ Equipment slot ".concat(e," is empty")),this.showNotification("üì≠ ".concat(e," slot is empty"),"info")}handleEquipmentSlotRightClick(e){const t=document.querySelector('[data-slot="'.concat(e,'"]'));if(t)if(console.log("üéØ Right-clicked on equipment slot: ".concat(e)),t.classList.contains("equipped")){const i=t.dataset.itemId,s=t.dataset.itemName;confirm("Unequip ".concat(s," from ").concat(e," slot?"))&&(console.log("üîß Unequipping ".concat(s," from ").concat(e)),this.unequipItem(i,e),this.showNotification("üîß Unequipped ".concat(s),"info"))}else console.log("üì≠ Equipment slot ".concat(e," is empty")),this.showNotification("üì≠ ".concat(e," slot is empty"),"info")}showItemContextMenu(e,t,i){const s=document.createElement("div");s.className="item-context-menu",s.innerHTML='\n            <div class="context-menu-item" data-action="use">Use</div>\n            <div class="context-menu-item" data-action="equip">Equip</div>\n            <div class="context-menu-item" data-action="drop">Drop</div>\n        ',s.style.cssText="\n            position: absolute;\n            background: rgba(0, 0, 0, 0.95);\n            border: 2px solid #ffd700;\n            border-radius: 8px;\n            padding: 5px 0;\n            color: white;\n            z-index: 1000;\n            min-width: 120px;\n        ";const l=document.querySelector('[data-slot="'.concat(i,'"]')).getBoundingClientRect();s.style.left=l.right+"px",s.style.top=l.top+"px",document.body.appendChild(s),s.addEventListener("click",u=>{const m=u.target.dataset.action;m&&(this.handleItemAction(m,e,t,i),s.remove())}),document.addEventListener("click",()=>s.remove(),{once:!0})}handleItemAction(e,t,i,s){switch(e){case"use":this.useItem(t,i);break;case"equip":this.equipItem(t,i,s);break;case"drop":this.dropItem(t,i,s);break}}useItem(e,t){console.log("Using ".concat(t))}equipItem(e,t,i){if(console.log("üîß Equipping ".concat(t," from slot ").concat(i)),!this.gameEngine){console.warn("‚ùå Game engine not connected"),this.showNotification("‚ùå Cannot equip item - game not ready","error");return}const s=this.gameEngine.getInventorySystem();if(!s){console.warn("‚ùå Inventory system not found"),this.showNotification("‚ùå Cannot equip item - inventory system not found","error");return}const o=s.itemDatabase.get(e);if(!o){console.warn("‚ùå Item data not found for ".concat(e)),this.showNotification("‚ùå Cannot equip ".concat(t," - item data not found"),"error");return}console.log("üìã Item data:",o);let l=null;if(e==="torch"||o.type==="light")l="offhand";else if(o.type==="weapon")l="weapon";else if(o.type==="armor")e.includes("head")||e.includes("helmet")?l="head":e.includes("chest")||e.includes("armor")?l="chest":e.includes("legs")||e.includes("pants")?l="legs":e.includes("feet")||e.includes("boots")?l="feet":l="chest";else{console.log("‚ùå ".concat(t," cannot be equipped (type: ").concat(o.type,")")),this.showNotification("‚ùå ".concat(t," cannot be equipped"),"error");return}console.log("üéØ Equipping ".concat(t," in ").concat(l," slot"));let u=!1;if(e==="torch"?u=s.equipTorch(i):u=s.equipItem(i),u){console.log("‚úÖ Successfully equipped ".concat(t," through inventory system"));const m=this.gameEngine.getPlayer();m&&(m.equipItem(e,l),console.log("üéÆ Player visual equipment updated")),this.updateEquipmentDisplay(),this.showNotification("‚úÖ ".concat(t," equipped in ").concat(l," slot!"),"success")}else{console.warn("‚ùå Failed to equip ".concat(t," through inventory system")),this.equipItemInSlot(e,t,l),this.removeItemFromInventory(i);const m=this.gameEngine.getPlayer();m&&m.equipItem(e,l),this.showNotification("‚úÖ ".concat(t," equipped in ").concat(l," slot!"),"success")}}equipItemInSlot(e,t,i){const s=document.querySelector('[data-slot="'.concat(i,'"]'));if(!s){console.warn("‚ùå Equipment slot ".concat(i," not found"));return}console.log("üéØ Equipping ".concat(t," in ").concat(i," slot"));let o="unknown";if(this.gameEngine&&this.gameEngine.getInventorySystem()){const u=this.gameEngine.getInventorySystem().itemDatabase.get(e);u&&(o=u.type)}s.classList.add("equipped"),s.dataset.itemId=e,s.dataset.itemName=t,s.dataset.itemType=o;const l=this.getItemIcon({type:o});s.innerHTML='\n            <div class="slot-label">'.concat(i.charAt(0).toUpperCase()+i.slice(1),'</div>\n            <div class="item-icon">').concat(l,'</div>\n            <div class="item-name">').concat(t,"</div>\n        "),this.gameEngine&&this.gameEngine.getPlayer()&&(this.gameEngine.getPlayer().equipItem(e,i),console.log("üéÆ Player equipment updated for ".concat(i))),console.log("‚úÖ Successfully equipped ".concat(t," in ").concat(i," slot"))}unequipItem(e,t){const i=document.querySelector('[data-slot="'.concat(t,'"]'));if(!i){console.warn("‚ùå Equipment slot ".concat(t," not found"));return}console.log("üîß Unequipping ".concat(e," from ").concat(t," slot")),i.classList.remove("equipped"),i.dataset.itemId="",i.dataset.itemName="",i.dataset.itemType="",i.innerHTML='<div class="slot-label">'.concat(t.charAt(0).toUpperCase()+t.slice(1),"</div>"),this.gameEngine&&this.gameEngine.getPlayer()&&(this.gameEngine.getPlayer().unequipItem(t),console.log("üéÆ Player equipment updated for ".concat(t)));const s=this.findEmptyInventorySlot();if(s!==-1){let o="unknown";if(this.gameEngine&&this.gameEngine.getInventorySystem()){const l=this.gameEngine.getInventorySystem().itemDatabase.get(e);l&&(o=l.type)}this.addItemToInventory(s,{id:e,name:e,type:o}),console.log("üì¶ ".concat(e," returned to inventory slot ").concat(s))}else console.warn("‚ùå No empty inventory slots available for ".concat(e)),this.showNotification("‚ùå Inventory full - cannot unequip ".concat(e),"error");console.log("‚úÖ Successfully unequipped ".concat(e," from ").concat(t," slot"))}removeItemFromInventory(e){const t=document.querySelector('[data-slot="'.concat(e,'"]'));t&&(t.classList.remove("filled"),t.dataset.itemId="",t.dataset.itemName="",t.dataset.itemType="",t.innerHTML="")}findEmptyInventorySlot(){for(let e=0;e<64;e++){const t=document.querySelector('[data-slot="'.concat(e,'"]'));if(t&&!t.classList.contains("filled"))return e}return-1}findItemSlotIndex(e){for(let t=0;t<64;t++){const i=document.querySelector('[data-slot="'.concat(t,'"]'));if(i&&i.classList.contains("filled")&&i.dataset.itemId===e)return t}return-1}dropItem(e,t,i){console.log("Dropping ".concat(t)),this.removeItemFromInventory(i)}showItemInfo(e,t){var s,o,l;console.log("Showing info for ".concat(t," (").concat(e,")"));const i=(l=(o=(s=this.gameEngine)==null?void 0:s.getInventorySystem())==null?void 0:o.itemDatabase)==null?void 0:l.get(e);this.showItemTooltip(e,t,i)}showItemTooltip(e,t,i){this.removeExistingTooltips();const s=document.createElement("div");s.className="item-tooltip",s.id="item-tooltip";const o=(i==null?void 0:i.type)||"unknown",l=this.getItemIcon({type:o});let u='\n            <div class="tooltip-header">\n                <span class="item-icon">'.concat(l,'</span>\n                <h4 class="item-name">').concat(t,'</h4>\n            </div>\n            <div class="tooltip-content">\n                <p class="item-type">Type: ').concat(o,"</p>\n        ");i!=null&&i.description&&(u+='<p class="item-description">'.concat(i.description,"</p>")),i!=null&&i.stats&&(u+='<div class="item-stats">',Object.entries(i.stats).forEach(([p,w])=>{u+='<span class="stat">'.concat(p,": ").concat(w,"</span>")}),u+="</div>"),u+='\n            <div class="tooltip-actions">\n        ',(i!=null&&i.equipmentSlot||o==="light"||o==="weapon"||o==="armor")&&(u+='<button class="action-btn equip-btn" data-action="equip">‚öîÔ∏è Equip</button>'),(o==="potion"||o==="food"||o==="tool")&&(u+='<button class="action-btn use-btn" data-action="use">üîÑ Use</button>'),u+='<button class="action-btn drop-btn" data-action="drop">üóëÔ∏è Drop</button>',u+='\n                <button class="action-btn close-btn" data-action="close">‚úï Close</button>\n            </div>\n        </div>\n        ',s.innerHTML=u;const m=document.querySelector('[data-item-id="'.concat(e,'"]'));if(m){const p=m.getBoundingClientRect();s.style.position="fixed",s.style.left="".concat(p.right+10,"px"),s.style.top="".concat(p.top,"px")}else s.style.position="fixed",s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)";s.addEventListener("click",p=>{if(p.target.classList.contains("action-btn")){const w=p.target.dataset.action;this.handleTooltipAction(w,e,t,i)}}),document.addEventListener("click",p=>{!s.contains(p.target)&&!p.target.closest(".inventory-slot")&&this.removeExistingTooltips()}),document.body.appendChild(s),setTimeout(()=>{this.removeExistingTooltips()},1e4)}handleTooltipAction(e,t,i,s){switch(console.log("Handling tooltip action: ".concat(e," for ").concat(i)),e){case"equip":this.equipItemFromTooltip(t,i,s);break;case"use":this.useItem(t,i);break;case"drop":this.dropItem(t,i);break;case"close":this.removeExistingTooltips();break}}equipItemFromTooltip(e,t,i){const s=this.findItemSlotIndex(e);if(s===-1){this.showNotification("‚ùå Item not found in inventory","error");return}e==="torch"?this.equipTorch(s):i.type==="weapon"||i.type==="armor"?this.equipItem(e,t,s):this.showNotification("‚ùå Cannot equip ".concat(t),"error"),this.removeExistingTooltips()}useItem(e,t){console.log("Using item: ".concat(t)),this.showNotification("üîÑ Using ".concat(t),"info"),this.removeExistingTooltips()}dropItem(e,t){console.log("Dropping item: ".concat(t)),this.showNotification("üóëÔ∏è Dropped ".concat(t),"warning"),this.removeExistingTooltips()}findItemSlotIndex(e){const t=document.querySelectorAll(".inventory-slot");for(let i=0;i<t.length;i++)if(t[i].dataset.itemId===e)return i;return-1}removeExistingTooltips(){document.querySelectorAll(".item-tooltip").forEach(t=>t.remove())}updateInventoryDisplay(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();if(!e)return;const t=document.getElementById("inventory-grid");if(!t)return;t.querySelectorAll(".inventory-slot").forEach(o=>{o.classList.remove("filled"),o.dataset.itemId="",o.dataset.itemName="",o.dataset.itemType="",o.innerHTML=""}),e.getInventory().forEach((o,l)=>{o&&this.addItemToInventory(l,{id:o.id,name:this.getItemDisplayName(o.id),type:this.getItemType(o.id)})}),this.updateEquipmentDisplay()}syncWithInventorySystem(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();if(!e)return;console.log("üîÑ Syncing UI with inventory system..."),[{id:"bronze_ingot",quantity:5},{id:"wood",quantity:10},{id:"leather",quantity:3},{id:"torch",quantity:1}].forEach(i=>{e.hasItem(i.id)||(console.log("üì¶ Adding ".concat(i.id," to inventory system")),e.addItem(i.id,i.quantity))}),this.updateInventoryDisplayFromSystem(),console.log("‚úÖ Inventory sync complete")}updateInventoryDisplayFromSystem(){if(!this.gameEngine){console.log("‚ö†Ô∏è Game engine not connected, showing sample items"),this.showSampleItems();return}const e=this.gameEngine.getInventorySystem();if(!e){console.log("‚ö†Ô∏è Inventory system not found, showing sample items"),this.showSampleItems();return}console.log("üîÑ Updating inventory display from system...");const t=e.getInventory();console.log("üéí Inventory from system:",t);const i=document.getElementById("inventory-grid");if(!i)return;i.querySelectorAll(".inventory-slot").forEach(l=>{l.classList.remove("filled"),l.dataset.itemId="",l.dataset.itemName="",l.dataset.itemType="",l.innerHTML=""});let o=!1;t.forEach((l,u)=>{if(l){o=!0;const m=e.itemDatabase.get(l.id);m&&this.addItemToInventory(u,{id:l.id,name:m.name,type:m.type})}}),o||(console.log("‚ö†Ô∏è No items in inventory system, showing sample items"),this.showSampleItems()),this.updateEquipmentDisplay()}showSampleItems(){console.log("üéí Showing sample items as fallback"),this.addItemToInventory(0,{id:"bronze_ingot",name:"Bronze Ingot",type:"material"}),this.addItemToInventory(1,{id:"wood",name:"Wood",type:"material"}),this.addItemToInventory(2,{id:"leather",name:"Leather",type:"material"}),this.addItemToInventory(3,{id:"torch",name:"Torch",type:"light"}),console.log("‚úÖ Sample items displayed")}getItemDisplayName(e){var i,s,o;const t=(o=(s=(i=this.gameEngine)==null?void 0:i.getInventorySystem())==null?void 0:s.itemDatabase)==null?void 0:o.get(e);return t?t.name:e}getItemType(e){var i,s,o;const t=(o=(s=(i=this.gameEngine)==null?void 0:i.getInventorySystem())==null?void 0:s.itemDatabase)==null?void 0:o.get(e);return t?t.type:"unknown"}updateEquipmentDisplay(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();if(!e)return;const t=e.getEquipment();Object.entries(t).forEach(([i,s])=>{const o=document.querySelector('[data-slot="'.concat(i,'"]'));o&&(s?(o.classList.add("equipped"),o.dataset.itemId=s.id,o.dataset.itemName=s.name||s.id,o.innerHTML='<div class="slot-label">'.concat(i,'</div><div class="item-icon">').concat(this.getItemIcon({type:this.getItemType(s.id)}),"</div>")):(o.classList.remove("equipped"),o.dataset.itemId="",o.dataset.itemName="",o.innerHTML='<div class="slot-label">'.concat(i,"</div>")))})}showCraftingPanel(){this.hideAllPanels(),this.craftingPanel.classList.remove("hidden"),this.activePanel="crafting",this.updateCraftingItems()}hideCraftingPanel(){this.craftingPanel.classList.add("hidden"),this.activePanel=null}showInventory(){console.log("üéí Showing inventory..."),this.hideAllPanels(),this.inventory.classList.remove("hidden"),this.activePanel="inventory",this.gameEngine&&this.updateInventoryDisplayFromSystem(),console.log("üéí Inventory panel shown")}hideInventory(){this.inventory.classList.add("hidden"),this.activePanel=null}showMap(){console.log("üó∫Ô∏è Map feature coming soon!")}showSkills(){console.log("üìö Skills feature coming soon!")}hideAllPanels(){this.craftingPanel.classList.add("hidden"),this.inventory.classList.add("hidden"),this.activePanel=null}setCraftingCategory(e){this.craftingCategory=e,document.querySelectorAll(".category-btn").forEach(t=>{t.classList.remove("active"),t.dataset.category===e&&t.classList.add("active")}),this.updateCraftingItems()}updateCraftingItems(){const e=document.getElementById("crafting-items");if(!e||!this.craftingItems)return;const t=this.craftingItems[this.craftingCategory]||[];e.innerHTML=t.map(i=>'\n            <div class="crafting-item" data-item-id="'.concat(i.id,'">\n                <div class="item-icon">').concat(this.getItemIcon({type:this.craftingCategory.slice(0,-1)}),"</div>\n                <h4>").concat(i.name,"</h4>\n                <p>").concat(i.description,'</p>\n                <p class="item-level">Level ').concat(i.level,'</p>\n                <p class="item-materials">Materials: ').concat(i.materials.join(", "),'</p>\n                <button class="craft-btn" onclick="this.craftItem(\'').concat(i.id,"')\">Craft</button>\n            </div>\n        ")).join(""),e.querySelectorAll(".craft-btn").forEach(i=>{i.addEventListener("click",s=>{const o=s.target.parentElement.dataset.itemId;this.craftItem(o)})})}craftItem(e){if(!this.gameEngine)return;const t=this.gameEngine.getCraftingSystem();t&&(t.craftItem(e)?(console.log("Successfully crafted ".concat(e)),this.showNotification("Crafted ".concat(e,"!"),"success")):(console.log("Failed to craft ".concat(e)),this.showNotification("Failed to craft ".concat(e),"error")))}showNotification(e,t="info"){const i=document.createElement("div");i.className="notification notification-".concat(t),i.textContent=e;const s={success:"‚úÖ",error:"‚ùå",info:"‚ÑπÔ∏è",warning:"‚ö†Ô∏è"};i.innerHTML="".concat(s[t]||"‚ÑπÔ∏è"," ").concat(e),i.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: ".concat(t==="success"?"#4CAF50":t==="error"?"#f44336":t==="warning"?"#ff9800":"#2196F3",";\n            color: white;\n            padding: 15px 20px;\n            border-radius: 5px;\n            z-index: 10000;\n            animation: slideIn 0.3s ease;\n            font-weight: 600;\n            box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n        "),document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>{i.parentElement&&i.remove()},300)},3e3)}updatePerformanceInfo(e){this.performanceInfo&&(this.performanceInfo.textContent="FPS: ".concat(e))}updateTimeDisplay(e){if(this.timeDisplay){let t="",i="üåÖ";e>.25&&e<.75?e<.4?(t="Morning",i="üåÖ"):e<.6?(t="Noon",i="‚òÄÔ∏è"):(t="Afternoon",i="üåá"):e<.25?(t="Night",i="üåô"):(t="Evening",i="üåÜ"),this.timeDisplay.textContent="".concat(i," ").concat(t)}}setGameEngine(e){this.gameEngine=e,this.gameEngine&&setTimeout(()=>{this.syncWithInventorySystem()},200)}show(){this.gameUI.classList.remove("hidden"),this.isVisible=!0}hide(){this.gameUI.classList.add("hidden"),this.isVisible=!1}destroy(){this.hideAllPanels(),console.log("üé® UI Manager destroyed")}testTorchEquipping(){if(console.log("üß™ Testing torch equipping system..."),!this.gameEngine){console.warn("‚ùå Game engine not connected");return}const e=this.gameEngine.getInventorySystem();if(!e){console.warn("‚ùå Inventory system not found");return}if(!this.gameEngine.getPlayer()){console.warn("‚ùå Player not found");return}console.log("‚úÖ All systems found, testing torch equipping..."),e.getInventory().findIndex(o=>o&&o.id==="torch")===-1&&(console.warn("‚ùå Torch not found in inventory, adding one..."),e.addItem("torch"),this.updateInventoryDisplay()),this.equipTorch(3)}testInventory(){if(console.log("üéí Testing inventory system..."),!this.gameEngine){console.warn("‚ùå Game engine not connected");return}const e=this.gameEngine.getInventorySystem();if(!e){console.warn("‚ùå Inventory system not found");return}if(!this.gameEngine.getPlayer()){console.warn("‚ùå Player not found");return}console.log("‚úÖ All systems found, testing inventory..."),console.log("üìä Inventory System Status:"),console.log("  - Initialized:",e.isInitialized),console.log("  - Item Database Size:",e.itemDatabase.size),console.log("  - Max Slots:",e.maxSlots),console.log("  - Current Slots:",e.slots.filter(o=>o!==null).length),console.log("üìö Item Database Contents:");for(const[o,l]of e.itemDatabase)console.log("  - ".concat(o,": ").concat(l.name," (").concat(l.type,")"));console.log("üì¶ Current Inventory:"),e.getInventory().forEach((o,l)=>{o&&console.log("  - Slot ".concat(l,": ").concat(o.id," x").concat(o.quantity))}),console.log("‚öîÔ∏è Current Equipment:");const s=e.getEquipment();Object.entries(s).forEach(([o,l])=>{console.log(l?"  - ".concat(o,": ").concat(l.id):"  - ".concat(o,": empty"))}),e.itemDatabase.size===0?(console.log("‚ö†Ô∏è Item database is empty, attempting to initialize..."),e.init().then(()=>{console.log("‚úÖ Inventory system initialized"),this.testInventory()}).catch(o=>{console.error("‚ùå Failed to initialize inventory system:",o)})):([{id:"bronze_ingot",quantity:5},{id:"wood",quantity:10},{id:"leather",quantity:3},{id:"torch",quantity:1}].forEach(l=>{e.hasItem(l.id)?(console.log("üì¶ ".concat(l.id," already exists, increasing quantity")),e.addItem(l.id,l.quantity)):(console.log("üì¶ Adding ".concat(l.id," to inventory system")),e.addItem(l.id,l.quantity))}),this.updateInventoryDisplayFromSystem(),console.log("üéí Inventory system tested successfully."))}testPlayerAnimations(){if(console.log("üé≠ Testing player animations..."),!this.gameEngine){console.warn("‚ùå Game engine not available");return}const e=this.gameEngine.getPlayer();if(!e){console.warn("‚ùå Player not found");return}console.log("‚úÖ Player found, testing animations..."),e.bodyParts?(console.log("üé≠ Player has",Object.keys(e.bodyParts).length,"body parts"),console.log("üé≠ Body parts:",Object.keys(e.bodyParts)),e.resetAnimation(),console.log("üé≠ Animation reset"),this.showNotification("üé≠ Player animations tested!","info")):(console.warn("‚ùå Player body parts not found"),this.showNotification("‚ùå Player animations not available","error"))}handleResize(e,t){console.log("üé® UI Manager handling resize: ".concat(e,"x").concat(t)),this.updateUIPositions(e,t),this.centerPanels(),console.log("‚úÖ UI resize handled")}updateUIPositions(e,t){[this.craftingPanel,this.inventory].forEach(s=>{s&&!s.classList.contains("hidden")&&(s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)")})}centerPanels(){[this.craftingPanel,this.inventory].forEach(t=>{t&&!t.classList.contains("hidden")&&(t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)")})}restoreViewport(){console.log("üîÑ Restoring viewport..."),this.gameEngine?this.gameEngine.restoreViewport():console.warn("‚ùå Game engine not available for viewport restoration"),this.centerPanels()}toggleGrid(){if(!this.gameEngine){console.warn("‚ùå Game engine not available");return}const e=this.gameEngine.getGridManager();if(!e){console.warn("‚ùå Grid manager not found");return}e.toggleGrid()}testClickDetection(){if(console.log("üéØ Testing click detection system..."),!this.gameEngine){console.warn("‚ùå Game engine not connected");return}const e=this.gameEngine.getGridManager();if(!e){console.warn("‚ùå Grid manager not found");return}console.log("‚úÖ Grid manager found, testing grid system...");const t=new x(0,0,0),i=e.getCellAtWorld(t);i?(console.log("‚úÖ Grid cell lookup working:",i),console.log("Cell ".concat(i.x,", ").concat(i.z," is ").concat(i.state))):console.warn("‚ùå Grid cell lookup failed");const s=e.isWalkable(t);console.log("‚úÖ Walkable check:",s);const o=e.findNearestWalkable(t);console.log("‚úÖ Nearest walkable position:",o)}resetCamera(){console.log("üîÑ Resetting camera..."),this.gameEngine?(this.gameEngine.resetCamera(),this.showNotification("üì∑ Camera reset to default position!","info")):(console.warn("‚ùå Game engine not available for camera reset."),this.showNotification("üì∑ Camera reset failed - game not ready.","error"))}addHelpText(){const e=document.createElement("div");e.className="help-text",e.innerHTML="\n            <h3>Controls</h3>\n            <p><strong>Camera Controls:</strong></p>\n            <p>‚Üê ‚Üí: Rotate camera around player</p>\n            <p>‚Üë ‚Üì: Adjust camera height</p>\n            <p>R: Reset camera to default</p>\n            <p>D: Debug camera state</p>\n            <p><strong>Movement:</strong></p>\n            <p>Click: Move to clicked location</p>\n            <p><strong>UI Controls:</strong></p>\n            <p>I: Toggle Inventory</p>\n            <p>C: Toggle Crafting</p>\n            <p>G: Toggle Grid</p>\n            <p>Escape: Close panels</p>\n            <p><strong>Debug:</strong></p>\n            <p>T: Test torch equipping</p>\n            <p>C: Test click detection</p>\n            <p>A: Test player animations</p>\n            <p>E: Export model specifications</p>\n        ",e.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            left: 20px;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 15px;\n            border-radius: 8px;\n            z-index: 999;\n            font-size: 0.9em;\n            max-width: 300px;\n            line-height: 1.5;\n        ",document.body.appendChild(e)}exportModelSpecs(){if(console.log("üìã Exporting model specifications..."),!this.gameEngine){console.warn("‚ùå Game engine not available"),this.showNotification("‚ùå Cannot export model specs - game engine not available","error");return}const e=this.gameEngine.getPlayer();if(!e){console.warn("‚ùå Player not found"),this.showNotification("‚ùå Cannot export model specs - player not found","error");return}const t=e.exportModelSpecs();if(t){console.log("‚úÖ Model specs exported successfully:",t),this.showNotification("‚úÖ Model specs exported! Check console for details.","success");const i=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download="low_poly_mmorpg_character_specs.json",document.body.appendChild(o),o.click(),URL.revokeObjectURL(s),document.body.removeChild(o)}else console.warn("‚ùå Failed to export model specs"),this.showNotification("‚ùå Failed to export model specs","error")}}const se=document.createElement("style");se.textContent="\n    @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n    }\n    \n    @keyframes slideOut {\n        from { transform: translateX(0); opacity: 1; }\n        to { transform: translateX(100%); opacity: 0; }\n    }\n";document.head.appendChild(se);class ze{constructor(e){this.gameEngine=e,this.optionsMenu=null,this.isOpen=!1,this.settings={graphics:{quality:"medium",renderDistance:"medium",shadowQuality:"medium",antiAliasing:"fxaa",particleEffects:"medium",vsync:"on",fpsLimit:"60"},audio:{masterVolume:50,musicVolume:70,sfxVolume:80},controls:{mouseSensitivity:1,cameraSpeed:1}},this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è OptionsManager already initialized, skipping...");return}if(console.log("‚öôÔ∏è Initializing Options Manager..."),this.optionsMenu=document.getElementById("options-menu"),!this.optionsMenu){console.error("‚ùå Options menu element not found in DOM");return}this.loadSettings(),this.setupEventListeners(),this.updateUI(),this.isInitialized=!0,console.log("‚úÖ Options Manager initialized")}setupEventListeners(){if(!this.optionsMenu){console.error("‚ùå Options menu not initialized, cannot setup event listeners");return}const e=document.getElementById("close-options");e&&e.addEventListener("click",()=>this.closeOptions()),document.querySelectorAll(".tab-btn").forEach(o=>{o.addEventListener("click",()=>this.switchTab(o.dataset.tab))});const i=document.getElementById("apply-settings");i&&i.addEventListener("click",()=>this.applySettings());const s=document.getElementById("reset-settings");s&&s.addEventListener("click",()=>this.resetSettings()),this.setupRangeInputs(),this.optionsMenu.addEventListener("click",o=>{o.target===this.optionsMenu&&this.closeOptions()})}setupRangeInputs(){const e=document.getElementById("master-volume"),t=document.getElementById("master-volume-value");e&&t&&e.addEventListener("input",n=>{t.textContent="".concat(n.target.value,"%")});const i=document.getElementById("music-volume"),s=document.getElementById("music-volume-value");i&&s&&i.addEventListener("input",n=>{s.textContent="".concat(n.target.value,"%")});const o=document.getElementById("sfx-volume"),l=document.getElementById("sfx-volume-value");o&&l&&o.addEventListener("input",n=>{l.textContent="".concat(n.target.value,"%")});const u=document.getElementById("mouse-sensitivity"),m=document.getElementById("mouse-sensitivity-value");u&&m&&u.addEventListener("input",n=>{m.textContent=n.target.value});const p=document.getElementById("camera-speed"),w=document.getElementById("camera-speed-value");p&&w&&p.addEventListener("input",n=>{w.textContent=n.target.value})}toggleOptions(){console.log("‚öôÔ∏è toggleOptions called - current state:",this.isOpen),this.isOpen?(console.log("‚öôÔ∏è Closing options..."),this.closeOptions()):(console.log("‚öôÔ∏è Opening options..."),this.openOptions())}openOptions(){console.log("‚öôÔ∏è openOptions - showing options menu..."),this.optionsMenu.classList.remove("hidden"),this.isOpen=!0,this.updateUI(),console.log("‚öôÔ∏è Options menu should now be visible")}closeOptions(){console.log("‚öôÔ∏è closeOptions - hiding options menu..."),this.optionsMenu.classList.add("hidden"),this.isOpen=!1,console.log("‚öôÔ∏è Options menu should now be hidden")}switchTab(e){document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),document.querySelector('[data-tab="'.concat(e,'"]')).classList.add("active"),document.getElementById("".concat(e,"-tab")).classList.add("active")}updateUI(){const e=document.getElementById("graphics-quality");e&&(e.value=this.settings.graphics.quality);const t=document.getElementById("render-distance");t&&(t.value=this.settings.graphics.renderDistance);const i=document.getElementById("shadow-quality");i&&(i.value=this.settings.graphics.shadowQuality);const s=document.getElementById("anti-aliasing");s&&(s.value=this.settings.graphics.antiAliasing);const o=document.getElementById("particle-effects");o&&(o.value=this.settings.graphics.particleEffects);const l=document.getElementById("vsync");l&&(l.value=this.settings.graphics.vsync);const u=document.getElementById("fps-limit");u&&(u.value=this.settings.graphics.fpsLimit);const m=document.getElementById("master-volume"),p=document.getElementById("master-volume-value");m&&p&&(m.value=this.settings.audio.masterVolume,p.textContent="".concat(this.settings.audio.masterVolume,"%"));const w=document.getElementById("music-volume"),n=document.getElementById("music-volume-value");w&&n&&(w.value=this.settings.audio.musicVolume,n.textContent="".concat(this.settings.audio.musicVolume,"%"));const a=document.getElementById("sfx-volume"),r=document.getElementById("sfx-volume-value");a&&r&&(a.value=this.settings.audio.sfxVolume,r.textContent="".concat(this.settings.audio.sfxVolume,"%"));const c=document.getElementById("mouse-sensitivity"),h=document.getElementById("mouse-sensitivity-value");c&&h&&(c.value=this.settings.controls.mouseSensitivity,h.textContent=this.settings.controls.mouseSensitivity);const g=document.getElementById("camera-speed"),d=document.getElementById("camera-speed-value");g&&d&&(g.value=this.settings.controls.cameraSpeed,d.textContent=this.settings.controls.cameraSpeed)}async applySettings(){this.settings.graphics.quality=document.getElementById("graphics-quality").value,this.settings.graphics.renderDistance=document.getElementById("render-distance").value,this.settings.graphics.shadowQuality=document.getElementById("shadow-quality").value,this.settings.graphics.antiAliasing=document.getElementById("anti-aliasing").value,this.settings.graphics.particleEffects=document.getElementById("particle-effects").value,this.settings.graphics.vsync=document.getElementById("vsync").value,this.settings.graphics.fpsLimit=document.getElementById("fps-limit").value,this.settings.audio.masterVolume=parseInt(document.getElementById("master-volume").value),this.settings.audio.musicVolume=parseInt(document.getElementById("music-volume").value),this.settings.audio.sfxVolume=parseInt(document.getElementById("sfx-volume").value),this.settings.controls.mouseSensitivity=parseFloat(document.getElementById("mouse-sensitivity").value),this.settings.controls.cameraSpeed=parseFloat(document.getElementById("camera-speed").value);try{await this.applyGraphicsSettings(),this.applyAudioSettings(),this.applyControlSettings(),this.saveSettings(),this.showNotification("Settings applied successfully!")}catch(e){console.error("Error applying settings:",e),this.showNotification("Failed to apply settings")}}async applyGraphicsSettings(){this.gameEngine.isRendererReady()||(console.log("üîß Waiting for renderer to be ready..."),await this.gameEngine.waitForRenderer());try{this.gameEngine.setGraphicsQuality(this.settings.graphics.quality),this.gameEngine.setShadowQuality(this.settings.graphics.shadowQuality);const e=this.settings.graphics.antiAliasing!=="off";this.gameEngine.setAntiAliasing(e),this.gameEngine.setVSync(this.settings.graphics.vsync==="on"),this.gameEngine.setFPSLimit(this.settings.graphics.fpsLimit),this.gameEngine.setRenderDistance(this.getRenderDistanceValue()),this.gameEngine.setParticleEffects(this.settings.graphics.particleEffects!=="off"),console.log("‚úÖ Graphics settings applied successfully")}catch(e){console.error("‚ùå Error applying graphics settings:",e),this.showNotification("Failed to apply graphics settings")}}getRenderDistanceValue(){switch(this.settings.graphics.renderDistance){case"low":return 200;case"medium":return 500;case"high":return 1e3;default:return 500}}applyAudioSettings(){this.gameEngine.audioManager&&(this.gameEngine.audioManager.setMasterVolume(this.settings.audio.masterVolume/100),this.gameEngine.audioManager.setMusicVolume(this.settings.audio.musicVolume/100),this.gameEngine.audioManager.setSFXVolume(this.settings.audio.sfxVolume/100))}applyControlSettings(){this.gameEngine.player&&this.gameEngine.player.setCameraSpeed(this.settings.controls.cameraSpeed)}updateRenderDistance(){if(!this.gameEngine.scene)return;const e=this.gameEngine.camera;if(e){switch(this.settings.graphics.renderDistance){case"low":e.far=200;break;case"medium":e.far=500;break;case"high":e.far=1e3;break}e.updateProjectionMatrix()}}updateParticleEffects(){if(this.gameEngine.worldManager&&this.gameEngine.worldManager.dayNightCycle){const e=this.gameEngine.worldManager.dayNightCycle.stars;if(e){const t=this.settings.graphics.particleEffects==="off"?0:this.settings.graphics.particleEffects==="low"?50:this.settings.graphics.particleEffects==="medium"?100:200;e.forEach((i,s)=>{i.visible=s<t})}}}resetSettings(){this.settings={graphics:{quality:"medium",renderDistance:"medium",shadowQuality:"medium",antiAliasing:"fxaa",particleEffects:"medium",vsync:"on",fpsLimit:"60"},audio:{masterVolume:50,musicVolume:70,sfxVolume:80},controls:{mouseSensitivity:1,cameraSpeed:1}},this.updateUI(),this.applySettings(),this.showNotification("Settings reset to default!")}saveSettings(){try{localStorage.setItem("egypt-mmo-settings",JSON.stringify(this.settings))}catch(e){console.warn("Could not save settings to localStorage:",e)}}loadSettings(){try{const e=localStorage.getItem("egypt-mmo-settings");if(e){const t=JSON.parse(e);this.settings={...this.settings,...t}}}catch(e){console.warn("Could not load settings from localStorage:",e)}}showNotification(e){const t=document.createElement("div");t.className="settings-notification",t.textContent=e,t.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #4CAF50;\n            color: white;\n            padding: 15px 20px;\n            border-radius: 8px;\n            z-index: 3000;\n            animation: slideIn 0.3s ease-out;\n        ",document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}destroy(){document.removeEventListener("keydown",this.handleKeydown),this.closeOptions()}}class Fe{constructor(){this.socket=null,this.isConnected=!1,this.serverUrl=window.location.hostname==="localhost"?"http://localhost:3001":"https://your-egypt-mmo.railway.app",this.playerId=null,this.players=new Map,this.onPlayerJoin=null,this.onPlayerLeave=null,this.onPlayerMove=null,this.onChatMessage=null,this.onWorldUpdate=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è NetworkManager already initialized, skipping...");return}console.log("üåê Initializing Network Manager..."),this.socket=null,this.isConnected=!1,this.playerId=null,this.reconnectAttempts=0,this.maxReconnectAttempts=3,this.isInitialized=!0,console.log("‚úÖ Network Manager initialized")}simulateNetworkConnection(){setTimeout(()=>{this.isConnected=!0,this.playerId=this.generatePlayerId(),console.log("üåê Connected to server (simulated) - Player ID: ".concat(this.playerId)),this.simulateOtherPlayers()},1e3)}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)}simulateOtherPlayers(){["Anubis","Cleopatra","Ramses","Nefertiti"].forEach((t,i)=>{setTimeout(()=>{const s={id:"player_".concat(i),name:t,position:{x:(Math.random()-.5)*100,y:0,z:(Math.random()-.5)*100},level:Math.floor(Math.random()*20)+1};this.onPlayerJoin&&this.onPlayerJoin(s)},(i+1)*2e3)})}async connect(){try{return this.socket=Ae(this.serverUrl,{transports:["websocket"],timeout:5e3,reconnection:!1,reconnectionAttempts:0,reconnectionDelay:0}),this.setupSocketEvents(),new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error("Connection timeout - running in single-player mode"))},3e3);this.socket.on("connect",()=>{clearTimeout(i),this.isConnected=!0,this.playerId=this.socket.id,console.log("üåê Connected to server - Player ID: ".concat(this.playerId)),e()}),this.socket.on("connect_error",s=>{clearTimeout(i),console.log("üåê Single-player mode: No server available"),t(new Error("No server available - running in single-player mode"))})})}catch(e){throw console.error("Failed to connect to server:",e),e}}setupSocketEvents(){this.socket&&(this.socket.on("disconnect",()=>{this.isConnected=!1,console.log("üåê Disconnected from server")}),this.socket.on("player_join",e=>{this.onPlayerJoin&&this.onPlayerJoin(e)}),this.socket.on("player_leave",e=>{this.onPlayerLeave&&this.onPlayerLeave(e)}),this.socket.on("player_move",e=>{this.onPlayerMove&&this.onPlayerMove(e)}),this.socket.on("chat_message",e=>{this.onChatMessage&&this.onChatMessage(e)}),this.socket.on("world_update",e=>{this.onWorldUpdate&&this.onWorldUpdate(e)}))}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.isConnected=!1,this.playerId=null,console.log("üåê Disconnected from server")}sendPlayerPosition(e){this.socket&&this.isConnected&&this.socket.emit("player_move",{position:e,timestamp:Date.now()})}sendPlayerAction(e,t){this.socket&&this.isConnected&&this.socket.emit("player_action",{action:e,data:t,timestamp:Date.now()})}sendChatMessage(e,t="global"){this.socket&&this.isConnected&&this.socket.emit("chat_message",{message:e,channel:t,timestamp:Date.now()})}sendCraftRequest(e,t){this.socket&&this.isConnected&&this.socket.emit("craft_request",{itemId:e,materials:t,timestamp:Date.now()})}sendTradeRequest(e,t,i){this.socket&&this.isConnected&&this.socket.emit("trade_request",{targetPlayerId:e,items:t,gold:i,timestamp:Date.now()})}sendResourceGather(e,t){this.socket&&this.isConnected&&this.socket.emit("resource_gather",{resourceId:e,position:t,timestamp:Date.now()})}sendBuildingPlace(e,t,i){this.socket&&this.isConnected&&this.socket.emit("building_place",{buildingType:e,position:t,rotation:i,timestamp:Date.now()})}onPlayerJoin(e){this.onPlayerJoin=e}onPlayerLeave(e){this.onPlayerLeave=e}onPlayerMove(e){this.onPlayerMove=e}onChatMessage(e){this.onChatMessage=e}onWorldUpdate(e){this.onWorldUpdate=e}isConnected(){return this.isConnected}getPlayerId(){return this.playerId}getConnectedPlayers(){return Array.from(this.players.values())}getNetworkStats(){return this.socket?{connected:this.isConnected,latency:this.socket.connected?this.socket.io.engine.ping:null,transport:this.socket.io.engine.transport.name,reconnectionAttempts:this.reconnectAttempts}:null}destroy(){this.disconnect(),this.players.clear(),console.log("üåê Network Manager destroyed")}}var W=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},O={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(I){(function(){var e=function(){this.init()};e.prototype={init:function(){var n=this||t;return n._counter=1e3,n._html5AudioPool=[],n.html5PoolSize=10,n._codecs={},n._howls=[],n._muted=!1,n._volume=1,n._canPlayEvent="canplaythrough",n._navigator=typeof window<"u"&&window.navigator?window.navigator:null,n.masterGain=null,n.noAudio=!1,n.usingWebAudio=!0,n.autoSuspend=!0,n.ctx=null,n.autoUnlock=!0,n._setup(),n},volume:function(n){var a=this||t;if(n=parseFloat(n),a.ctx||w(),typeof n<"u"&&n>=0&&n<=1){if(a._volume=n,a._muted)return a;a.usingWebAudio&&a.masterGain.gain.setValueAtTime(n,t.ctx.currentTime);for(var r=0;r<a._howls.length;r++)if(!a._howls[r]._webAudio)for(var c=a._howls[r]._getSoundIds(),h=0;h<c.length;h++){var g=a._howls[r]._soundById(c[h]);g&&g._node&&(g._node.volume=g._volume*n)}return a}return a._volume},mute:function(n){var a=this||t;a.ctx||w(),a._muted=n,a.usingWebAudio&&a.masterGain.gain.setValueAtTime(n?0:a._volume,t.ctx.currentTime);for(var r=0;r<a._howls.length;r++)if(!a._howls[r]._webAudio)for(var c=a._howls[r]._getSoundIds(),h=0;h<c.length;h++){var g=a._howls[r]._soundById(c[h]);g&&g._node&&(g._node.muted=n?!0:g._muted)}return a},stop:function(){for(var n=this||t,a=0;a<n._howls.length;a++)n._howls[a].stop();return n},unload:function(){for(var n=this||t,a=n._howls.length-1;a>=0;a--)n._howls[a].unload();return n.usingWebAudio&&n.ctx&&typeof n.ctx.close<"u"&&(n.ctx.close(),n.ctx=null,w()),n},codecs:function(n){return(this||t)._codecs[n.replace(/^x-/,"")]},_setup:function(){var n=this||t;if(n.state=n.ctx&&n.ctx.state||"suspended",n._autoSuspend(),!n.usingWebAudio)if(typeof Audio<"u")try{var a=new Audio;typeof a.oncanplaythrough>"u"&&(n._canPlayEvent="canplay")}catch(r){n.noAudio=!0}else n.noAudio=!0;try{var a=new Audio;a.muted&&(n.noAudio=!0)}catch(r){}return n.noAudio||n._setupCodecs(),n},_setupCodecs:function(){var n=this||t,a=null;try{a=typeof Audio<"u"?new Audio:null}catch(S){return n}if(!a||typeof a.canPlayType!="function")return n;var r=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c=n._navigator?n._navigator.userAgent:"",h=c.match(/OPR\/(\d+)/g),g=h&&parseInt(h[0].split("/")[1],10)<33,d=c.indexOf("Safari")!==-1&&c.indexOf("Chrome")===-1,y=c.match(/Version\/(.*?) /),_=d&&y&&parseInt(y[1],10)<15;return n._codecs={mp3:!!(!g&&(r||a.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!r,opus:!!a.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(a.canPlayType('audio/wav; codecs="1"')||a.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!a.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!a.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(a.canPlayType("audio/x-m4b;")||a.canPlayType("audio/m4b;")||a.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(a.canPlayType("audio/x-mp4;")||a.canPlayType("audio/mp4;")||a.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!_&&a.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!_&&a.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!a.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(a.canPlayType("audio/x-flac;")||a.canPlayType("audio/flac;")).replace(/^no$/,"")},n},_unlockAudio:function(){var n=this||t;if(!(n._audioUnlocked||!n.ctx)){n._audioUnlocked=!1,n.autoUnlock=!1,!n._mobileUnloaded&&n.ctx.sampleRate!==44100&&(n._mobileUnloaded=!0,n.unload()),n._scratchBuffer=n.ctx.createBuffer(1,1,22050);var a=function(r){for(;n._html5AudioPool.length<n.html5PoolSize;)try{var c=new Audio;c._unlocked=!0,n._releaseHtml5Audio(c)}catch(S){n.noAudio=!0;break}for(var h=0;h<n._howls.length;h++)if(!n._howls[h]._webAudio)for(var g=n._howls[h]._getSoundIds(),d=0;d<g.length;d++){var y=n._howls[h]._soundById(g[d]);y&&y._node&&!y._node._unlocked&&(y._node._unlocked=!0,y._node.load())}n._autoResume();var _=n.ctx.createBufferSource();_.buffer=n._scratchBuffer,_.connect(n.ctx.destination),typeof _.start>"u"?_.noteOn(0):_.start(0),typeof n.ctx.resume=="function"&&n.ctx.resume(),_.onended=function(){_.disconnect(0),n._audioUnlocked=!0,document.removeEventListener("touchstart",a,!0),document.removeEventListener("touchend",a,!0),document.removeEventListener("click",a,!0),document.removeEventListener("keydown",a,!0);for(var S=0;S<n._howls.length;S++)n._howls[S]._emit("unlock")}};return document.addEventListener("touchstart",a,!0),document.addEventListener("touchend",a,!0),document.addEventListener("click",a,!0),document.addEventListener("keydown",a,!0),n}},_obtainHtml5Audio:function(){var n=this||t;if(n._html5AudioPool.length)return n._html5AudioPool.pop();var a=new Audio().play();return a&&typeof Promise<"u"&&(a instanceof Promise||typeof a.then=="function")&&a.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(n){var a=this||t;return n._unlocked&&a._html5AudioPool.push(n),a},_autoSuspend:function(){var n=this;if(!(!n.autoSuspend||!n.ctx||typeof n.ctx.suspend>"u"||!t.usingWebAudio)){for(var a=0;a<n._howls.length;a++)if(n._howls[a]._webAudio){for(var r=0;r<n._howls[a]._sounds.length;r++)if(!n._howls[a]._sounds[r]._paused)return n}return n._suspendTimer&&clearTimeout(n._suspendTimer),n._suspendTimer=setTimeout(function(){if(n.autoSuspend){n._suspendTimer=null,n.state="suspending";var c=function(){n.state="suspended",n._resumeAfterSuspend&&(delete n._resumeAfterSuspend,n._autoResume())};n.ctx.suspend().then(c,c)}},3e4),n}},_autoResume:function(){var n=this;if(!(!n.ctx||typeof n.ctx.resume>"u"||!t.usingWebAudio))return n.state==="running"&&n.ctx.state!=="interrupted"&&n._suspendTimer?(clearTimeout(n._suspendTimer),n._suspendTimer=null):n.state==="suspended"||n.state==="running"&&n.ctx.state==="interrupted"?(n.ctx.resume().then(function(){n.state="running";for(var a=0;a<n._howls.length;a++)n._howls[a]._emit("resume")}),n._suspendTimer&&(clearTimeout(n._suspendTimer),n._suspendTimer=null)):n.state==="suspending"&&(n._resumeAfterSuspend=!0),n}};var t=new e,i=function(n){var a=this;if(!n.src||n.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}a.init(n)};i.prototype={init:function(n){var a=this;return t.ctx||w(),a._autoplay=n.autoplay||!1,a._format=typeof n.format!="string"?n.format:[n.format],a._html5=n.html5||!1,a._muted=n.mute||!1,a._loop=n.loop||!1,a._pool=n.pool||5,a._preload=typeof n.preload=="boolean"||n.preload==="metadata"?n.preload:!0,a._rate=n.rate||1,a._sprite=n.sprite||{},a._src=typeof n.src!="string"?n.src:[n.src],a._volume=n.volume!==void 0?n.volume:1,a._xhr={method:n.xhr&&n.xhr.method?n.xhr.method:"GET",headers:n.xhr&&n.xhr.headers?n.xhr.headers:null,withCredentials:n.xhr&&n.xhr.withCredentials?n.xhr.withCredentials:!1},a._duration=0,a._state="unloaded",a._sounds=[],a._endTimers={},a._queue=[],a._playLock=!1,a._onend=n.onend?[{fn:n.onend}]:[],a._onfade=n.onfade?[{fn:n.onfade}]:[],a._onload=n.onload?[{fn:n.onload}]:[],a._onloaderror=n.onloaderror?[{fn:n.onloaderror}]:[],a._onplayerror=n.onplayerror?[{fn:n.onplayerror}]:[],a._onpause=n.onpause?[{fn:n.onpause}]:[],a._onplay=n.onplay?[{fn:n.onplay}]:[],a._onstop=n.onstop?[{fn:n.onstop}]:[],a._onmute=n.onmute?[{fn:n.onmute}]:[],a._onvolume=n.onvolume?[{fn:n.onvolume}]:[],a._onrate=n.onrate?[{fn:n.onrate}]:[],a._onseek=n.onseek?[{fn:n.onseek}]:[],a._onunlock=n.onunlock?[{fn:n.onunlock}]:[],a._onresume=[],a._webAudio=t.usingWebAudio&&!a._html5,typeof t.ctx<"u"&&t.ctx&&t.autoUnlock&&t._unlockAudio(),t._howls.push(a),a._autoplay&&a._queue.push({event:"play",action:function(){a.play()}}),a._preload&&a._preload!=="none"&&a.load(),a},load:function(){var n=this,a=null;if(t.noAudio){n._emit("loaderror",null,"No audio support.");return}typeof n._src=="string"&&(n._src=[n._src]);for(var r=0;r<n._src.length;r++){var c,h;if(n._format&&n._format[r])c=n._format[r];else{if(h=n._src[r],typeof h!="string"){n._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}c=/^data:audio\/([^;,]+);/i.exec(h),c||(c=/\.([^.]+)$/.exec(h.split("?",1)[0])),c&&(c=c[1].toLowerCase())}if(c||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),c&&t.codecs(c)){a=n._src[r];break}}if(!a){n._emit("loaderror",null,"No codec support for selected audio sources.");return}return n._src=a,n._state="loading",window.location.protocol==="https:"&&a.slice(0,5)==="http:"&&(n._html5=!0,n._webAudio=!1),new s(n),n._webAudio&&l(n),n},play:function(n,a){var r=this,c=null;if(typeof n=="number")c=n,n=null;else{if(typeof n=="string"&&r._state==="loaded"&&!r._sprite[n])return null;if(typeof n>"u"&&(n="__default",!r._playLock)){for(var h=0,g=0;g<r._sounds.length;g++)r._sounds[g]._paused&&!r._sounds[g]._ended&&(h++,c=r._sounds[g]._id);h===1?n=null:c=null}}var d=c?r._soundById(c):r._inactiveSound();if(!d)return null;if(c&&!n&&(n=d._sprite||"__default"),r._state!=="loaded"){d._sprite=n,d._ended=!1;var y=d._id;return r._queue.push({event:"play",action:function(){r.play(y)}}),y}if(c&&!d._paused)return a||r._loadQueue("play"),d._id;r._webAudio&&t._autoResume();var _=Math.max(0,d._seek>0?d._seek:r._sprite[n][0]/1e3),S=Math.max(0,(r._sprite[n][0]+r._sprite[n][1])/1e3-_),k=S*1e3/Math.abs(d._rate),E=r._sprite[n][0]/1e3,C=(r._sprite[n][0]+r._sprite[n][1])/1e3;d._sprite=n,d._ended=!1;var L=function(){d._paused=!1,d._seek=_,d._start=E,d._stop=C,d._loop=!!(d._loop||r._sprite[n][2])};if(_>=C){r._ended(d);return}var b=d._node;if(r._webAudio){var $=function(){r._playLock=!1,L(),r._refreshBuffer(d);var D=d._muted||r._muted?0:d._volume;b.gain.setValueAtTime(D,t.ctx.currentTime),d._playStart=t.ctx.currentTime,typeof b.bufferSource.start>"u"?d._loop?b.bufferSource.noteGrainOn(0,_,86400):b.bufferSource.noteGrainOn(0,_,S):d._loop?b.bufferSource.start(0,_,86400):b.bufferSource.start(0,_,S),k!==1/0&&(r._endTimers[d._id]=setTimeout(r._ended.bind(r,d),k)),a||setTimeout(function(){r._emit("play",d._id),r._loadQueue()},0)};t.state==="running"&&t.ctx.state!=="interrupted"?$():(r._playLock=!0,r.once("resume",$),r._clearTimer(d._id))}else{var T=function(){b.currentTime=_,b.muted=d._muted||r._muted||t._muted||b.muted,b.volume=d._volume*t.volume(),b.playbackRate=d._rate;try{var D=b.play();if(D&&typeof Promise<"u"&&(D instanceof Promise||typeof D.then=="function")?(r._playLock=!0,L(),D.then(function(){r._playLock=!1,b._unlocked=!0,a?r._loadQueue():r._emit("play",d._id)}).catch(function(){r._playLock=!1,r._emit("playerror",d._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),d._ended=!0,d._paused=!0})):a||(r._playLock=!1,L(),r._emit("play",d._id)),b.playbackRate=d._rate,b.paused){r._emit("playerror",d._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}n!=="__default"||d._loop?r._endTimers[d._id]=setTimeout(r._ended.bind(r,d),k):(r._endTimers[d._id]=function(){r._ended(d),b.removeEventListener("ended",r._endTimers[d._id],!1)},b.addEventListener("ended",r._endTimers[d._id],!1))}catch(A){r._emit("playerror",d._id,A)}};b.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(b.src=r._src,b.load());var K=window&&window.ejecta||!b.readyState&&t._navigator.isCocoonJS;if(b.readyState>=3||K)T();else{r._playLock=!0,r._state="loading";var N=function(){r._state="loaded",T(),b.removeEventListener(t._canPlayEvent,N,!1)};b.addEventListener(t._canPlayEvent,N,!1),r._clearTimer(d._id)}}return d._id},pause:function(n){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"pause",action:function(){a.pause(n)}}),a;for(var r=a._getSoundIds(n),c=0;c<r.length;c++){a._clearTimer(r[c]);var h=a._soundById(r[c]);if(h&&!h._paused&&(h._seek=a.seek(r[c]),h._rateSeek=0,h._paused=!0,a._stopFade(r[c]),h._node))if(a._webAudio){if(!h._node.bufferSource)continue;typeof h._node.bufferSource.stop>"u"?h._node.bufferSource.noteOff(0):h._node.bufferSource.stop(0),a._cleanBuffer(h._node)}else(!isNaN(h._node.duration)||h._node.duration===1/0)&&h._node.pause();arguments[1]||a._emit("pause",h?h._id:null)}return a},stop:function(n,a){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"stop",action:function(){r.stop(n)}}),r;for(var c=r._getSoundIds(n),h=0;h<c.length;h++){r._clearTimer(c[h]);var g=r._soundById(c[h]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,r._stopFade(c[h]),g._node&&(r._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),r._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&r._clearSound(g._node))),a||r._emit("stop",g._id))}return r},mute:function(n,a){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"mute",action:function(){r.mute(n,a)}}),r;if(typeof a>"u")if(typeof n=="boolean")r._muted=n;else return r._muted;for(var c=r._getSoundIds(a),h=0;h<c.length;h++){var g=r._soundById(c[h]);g&&(g._muted=n,g._interval&&r._stopFade(g._id),r._webAudio&&g._node?g._node.gain.setValueAtTime(n?0:g._volume,t.ctx.currentTime):g._node&&(g._node.muted=t._muted?!0:n),r._emit("mute",g._id))}return r},volume:function(){var n=this,a=arguments,r,c;if(a.length===0)return n._volume;if(a.length===1||a.length===2&&typeof a[1]>"u"){var h=n._getSoundIds(),g=h.indexOf(a[0]);g>=0?c=parseInt(a[0],10):r=parseFloat(a[0])}else a.length>=2&&(r=parseFloat(a[0]),c=parseInt(a[1],10));var d;if(typeof r<"u"&&r>=0&&r<=1){if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"volume",action:function(){n.volume.apply(n,a)}}),n;typeof c>"u"&&(n._volume=r),c=n._getSoundIds(c);for(var y=0;y<c.length;y++)d=n._soundById(c[y]),d&&(d._volume=r,a[2]||n._stopFade(c[y]),n._webAudio&&d._node&&!d._muted?d._node.gain.setValueAtTime(r,t.ctx.currentTime):d._node&&!d._muted&&(d._node.volume=r*t.volume()),n._emit("volume",d._id))}else return d=c?n._soundById(c):n._sounds[0],d?d._volume:0;return n},fade:function(n,a,r,c){var h=this;if(h._state!=="loaded"||h._playLock)return h._queue.push({event:"fade",action:function(){h.fade(n,a,r,c)}}),h;n=Math.min(Math.max(0,parseFloat(n)),1),a=Math.min(Math.max(0,parseFloat(a)),1),r=parseFloat(r),h.volume(n,c);for(var g=h._getSoundIds(c),d=0;d<g.length;d++){var y=h._soundById(g[d]);if(y){if(c||h._stopFade(g[d]),h._webAudio&&!y._muted){var _=t.ctx.currentTime,S=_+r/1e3;y._volume=n,y._node.gain.setValueAtTime(n,_),y._node.gain.linearRampToValueAtTime(a,S)}h._startFadeInterval(y,n,a,r,g[d],typeof c>"u")}}return h},_startFadeInterval:function(n,a,r,c,h,g){var d=this,y=a,_=r-a,S=Math.abs(_/.01),k=Math.max(4,S>0?c/S:c),E=Date.now();n._fadeTo=r,n._interval=setInterval(function(){var C=(Date.now()-E)/c;E=Date.now(),y+=_*C,y=Math.round(y*100)/100,_<0?y=Math.max(r,y):y=Math.min(r,y),d._webAudio?n._volume=y:d.volume(y,n._id,!0),g&&(d._volume=y),(r<a&&y<=r||r>a&&y>=r)&&(clearInterval(n._interval),n._interval=null,n._fadeTo=null,d.volume(r,n._id),d._emit("fade",n._id))},k)},_stopFade:function(n){var a=this,r=a._soundById(n);return r&&r._interval&&(a._webAudio&&r._node.gain.cancelScheduledValues(t.ctx.currentTime),clearInterval(r._interval),r._interval=null,a.volume(r._fadeTo,n),r._fadeTo=null,a._emit("fade",n)),a},loop:function(){var n=this,a=arguments,r,c,h;if(a.length===0)return n._loop;if(a.length===1)if(typeof a[0]=="boolean")r=a[0],n._loop=r;else return h=n._soundById(parseInt(a[0],10)),h?h._loop:!1;else a.length===2&&(r=a[0],c=parseInt(a[1],10));for(var g=n._getSoundIds(c),d=0;d<g.length;d++)h=n._soundById(g[d]),h&&(h._loop=r,n._webAudio&&h._node&&h._node.bufferSource&&(h._node.bufferSource.loop=r,r&&(h._node.bufferSource.loopStart=h._start||0,h._node.bufferSource.loopEnd=h._stop,n.playing(g[d])&&(n.pause(g[d],!0),n.play(g[d],!0)))));return n},rate:function(){var n=this,a=arguments,r,c;if(a.length===0)c=n._sounds[0]._id;else if(a.length===1){var h=n._getSoundIds(),g=h.indexOf(a[0]);g>=0?c=parseInt(a[0],10):r=parseFloat(a[0])}else a.length===2&&(r=parseFloat(a[0]),c=parseInt(a[1],10));var d;if(typeof r=="number"){if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"rate",action:function(){n.rate.apply(n,a)}}),n;typeof c>"u"&&(n._rate=r),c=n._getSoundIds(c);for(var y=0;y<c.length;y++)if(d=n._soundById(c[y]),d){n.playing(c[y])&&(d._rateSeek=n.seek(c[y]),d._playStart=n._webAudio?t.ctx.currentTime:d._playStart),d._rate=r,n._webAudio&&d._node&&d._node.bufferSource?d._node.bufferSource.playbackRate.setValueAtTime(r,t.ctx.currentTime):d._node&&(d._node.playbackRate=r);var _=n.seek(c[y]),S=(n._sprite[d._sprite][0]+n._sprite[d._sprite][1])/1e3-_,k=S*1e3/Math.abs(d._rate);(n._endTimers[c[y]]||!d._paused)&&(n._clearTimer(c[y]),n._endTimers[c[y]]=setTimeout(n._ended.bind(n,d),k)),n._emit("rate",d._id)}}else return d=n._soundById(c),d?d._rate:n._rate;return n},seek:function(){var n=this,a=arguments,r,c;if(a.length===0)n._sounds.length&&(c=n._sounds[0]._id);else if(a.length===1){var h=n._getSoundIds(),g=h.indexOf(a[0]);g>=0?c=parseInt(a[0],10):n._sounds.length&&(c=n._sounds[0]._id,r=parseFloat(a[0]))}else a.length===2&&(r=parseFloat(a[0]),c=parseInt(a[1],10));if(typeof c>"u")return 0;if(typeof r=="number"&&(n._state!=="loaded"||n._playLock))return n._queue.push({event:"seek",action:function(){n.seek.apply(n,a)}}),n;var d=n._soundById(c);if(d)if(typeof r=="number"&&r>=0){var y=n.playing(c);y&&n.pause(c,!0),d._seek=r,d._ended=!1,n._clearTimer(c),!n._webAudio&&d._node&&!isNaN(d._node.duration)&&(d._node.currentTime=r);var _=function(){y&&n.play(c,!0),n._emit("seek",c)};if(y&&!n._webAudio){var S=function(){n._playLock?setTimeout(S,0):_()};setTimeout(S,0)}else _()}else if(n._webAudio){var k=n.playing(c)?t.ctx.currentTime-d._playStart:0,E=d._rateSeek?d._rateSeek-d._seek:0;return d._seek+(E+k*Math.abs(d._rate))}else return d._node.currentTime;return n},playing:function(n){var a=this;if(typeof n=="number"){var r=a._soundById(n);return r?!r._paused:!1}for(var c=0;c<a._sounds.length;c++)if(!a._sounds[c]._paused)return!0;return!1},duration:function(n){var a=this,r=a._duration,c=a._soundById(n);return c&&(r=a._sprite[c._sprite][1]/1e3),r},state:function(){return this._state},unload:function(){for(var n=this,a=n._sounds,r=0;r<a.length;r++)a[r]._paused||n.stop(a[r]._id),n._webAudio||(n._clearSound(a[r]._node),a[r]._node.removeEventListener("error",a[r]._errorFn,!1),a[r]._node.removeEventListener(t._canPlayEvent,a[r]._loadFn,!1),a[r]._node.removeEventListener("ended",a[r]._endFn,!1),t._releaseHtml5Audio(a[r]._node)),delete a[r]._node,n._clearTimer(a[r]._id);var c=t._howls.indexOf(n);c>=0&&t._howls.splice(c,1);var h=!0;for(r=0;r<t._howls.length;r++)if(t._howls[r]._src===n._src||n._src.indexOf(t._howls[r]._src)>=0){h=!1;break}return o&&h&&delete o[n._src],t.noAudio=!1,n._state="unloaded",n._sounds=[],n=null,null},on:function(n,a,r,c){var h=this,g=h["_on"+n];return typeof a=="function"&&g.push(c?{id:r,fn:a,once:c}:{id:r,fn:a}),h},off:function(n,a,r){var c=this,h=c["_on"+n],g=0;if(typeof a=="number"&&(r=a,a=null),a||r)for(g=0;g<h.length;g++){var d=r===h[g].id;if(a===h[g].fn&&d||!a&&d){h.splice(g,1);break}}else if(n)c["_on"+n]=[];else{var y=Object.keys(c);for(g=0;g<y.length;g++)y[g].indexOf("_on")===0&&Array.isArray(c[y[g]])&&(c[y[g]]=[])}return c},once:function(n,a,r){var c=this;return c.on(n,a,r,1),c},_emit:function(n,a,r){for(var c=this,h=c["_on"+n],g=h.length-1;g>=0;g--)(!h[g].id||h[g].id===a||n==="load")&&(setTimeout((function(d){d.call(this,a,r)}).bind(c,h[g].fn),0),h[g].once&&c.off(n,h[g].fn,h[g].id));return c._loadQueue(n),c},_loadQueue:function(n){var a=this;if(a._queue.length>0){var r=a._queue[0];r.event===n&&(a._queue.shift(),a._loadQueue()),n||r.action()}return a},_ended:function(n){var a=this,r=n._sprite;if(!a._webAudio&&n._node&&!n._node.paused&&!n._node.ended&&n._node.currentTime<n._stop)return setTimeout(a._ended.bind(a,n),100),a;var c=!!(n._loop||a._sprite[r][2]);if(a._emit("end",n._id),!a._webAudio&&c&&a.stop(n._id,!0).play(n._id),a._webAudio&&c){a._emit("play",n._id),n._seek=n._start||0,n._rateSeek=0,n._playStart=t.ctx.currentTime;var h=(n._stop-n._start)*1e3/Math.abs(n._rate);a._endTimers[n._id]=setTimeout(a._ended.bind(a,n),h)}return a._webAudio&&!c&&(n._paused=!0,n._ended=!0,n._seek=n._start||0,n._rateSeek=0,a._clearTimer(n._id),a._cleanBuffer(n._node),t._autoSuspend()),!a._webAudio&&!c&&a.stop(n._id,!0),a},_clearTimer:function(n){var a=this;if(a._endTimers[n]){if(typeof a._endTimers[n]!="function")clearTimeout(a._endTimers[n]);else{var r=a._soundById(n);r&&r._node&&r._node.removeEventListener("ended",a._endTimers[n],!1)}delete a._endTimers[n]}return a},_soundById:function(n){for(var a=this,r=0;r<a._sounds.length;r++)if(n===a._sounds[r]._id)return a._sounds[r];return null},_inactiveSound:function(){var n=this;n._drain();for(var a=0;a<n._sounds.length;a++)if(n._sounds[a]._ended)return n._sounds[a].reset();return new s(n)},_drain:function(){var n=this,a=n._pool,r=0,c=0;if(!(n._sounds.length<a)){for(c=0;c<n._sounds.length;c++)n._sounds[c]._ended&&r++;for(c=n._sounds.length-1;c>=0;c--){if(r<=a)return;n._sounds[c]._ended&&(n._webAudio&&n._sounds[c]._node&&n._sounds[c]._node.disconnect(0),n._sounds.splice(c,1),r--)}}},_getSoundIds:function(n){var a=this;if(typeof n>"u"){for(var r=[],c=0;c<a._sounds.length;c++)r.push(a._sounds[c]._id);return r}else return[n]},_refreshBuffer:function(n){var a=this;return n._node.bufferSource=t.ctx.createBufferSource(),n._node.bufferSource.buffer=o[a._src],n._panner?n._node.bufferSource.connect(n._panner):n._node.bufferSource.connect(n._node),n._node.bufferSource.loop=n._loop,n._loop&&(n._node.bufferSource.loopStart=n._start||0,n._node.bufferSource.loopEnd=n._stop||0),n._node.bufferSource.playbackRate.setValueAtTime(n._rate,t.ctx.currentTime),a},_cleanBuffer:function(n){var a=this,r=t._navigator&&t._navigator.vendor.indexOf("Apple")>=0;if(!n.bufferSource)return a;if(t._scratchBuffer&&n.bufferSource&&(n.bufferSource.onended=null,n.bufferSource.disconnect(0),r))try{n.bufferSource.buffer=t._scratchBuffer}catch(c){}return n.bufferSource=null,a},_clearSound:function(n){var a=/MSIE |Trident\//.test(t._navigator&&t._navigator.userAgent);a||(n.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var s=function(n){this._parent=n,this.init()};s.prototype={init:function(){var n=this,a=n._parent;return n._muted=a._muted,n._loop=a._loop,n._volume=a._volume,n._rate=a._rate,n._seek=0,n._paused=!0,n._ended=!0,n._sprite="__default",n._id=++t._counter,a._sounds.push(n),n.create(),n},create:function(){var n=this,a=n._parent,r=t._muted||n._muted||n._parent._muted?0:n._volume;return a._webAudio?(n._node=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),n._node.gain.setValueAtTime(r,t.ctx.currentTime),n._node.paused=!0,n._node.connect(t.masterGain)):t.noAudio||(n._node=t._obtainHtml5Audio(),n._errorFn=n._errorListener.bind(n),n._node.addEventListener("error",n._errorFn,!1),n._loadFn=n._loadListener.bind(n),n._node.addEventListener(t._canPlayEvent,n._loadFn,!1),n._endFn=n._endListener.bind(n),n._node.addEventListener("ended",n._endFn,!1),n._node.src=a._src,n._node.preload=a._preload===!0?"auto":a._preload,n._node.volume=r*t.volume(),n._node.load()),n},reset:function(){var n=this,a=n._parent;return n._muted=a._muted,n._loop=a._loop,n._volume=a._volume,n._rate=a._rate,n._seek=0,n._rateSeek=0,n._paused=!0,n._ended=!0,n._sprite="__default",n._id=++t._counter,n},_errorListener:function(){var n=this;n._parent._emit("loaderror",n._id,n._node.error?n._node.error.code:0),n._node.removeEventListener("error",n._errorFn,!1)},_loadListener:function(){var n=this,a=n._parent;a._duration=Math.ceil(n._node.duration*10)/10,Object.keys(a._sprite).length===0&&(a._sprite={__default:[0,a._duration*1e3]}),a._state!=="loaded"&&(a._state="loaded",a._emit("load"),a._loadQueue()),n._node.removeEventListener(t._canPlayEvent,n._loadFn,!1)},_endListener:function(){var n=this,a=n._parent;a._duration===1/0&&(a._duration=Math.ceil(n._node.duration*10)/10,a._sprite.__default[1]===1/0&&(a._sprite.__default[1]=a._duration*1e3),a._ended(n)),n._node.removeEventListener("ended",n._endFn,!1)}};var o={},l=function(n){var a=n._src;if(o[a]){n._duration=o[a].duration,p(n);return}if(/^data:[^;]+;base64,/.test(a)){for(var r=atob(a.split(",")[1]),c=new Uint8Array(r.length),h=0;h<r.length;++h)c[h]=r.charCodeAt(h);m(c.buffer,n)}else{var g=new XMLHttpRequest;g.open(n._xhr.method,a,!0),g.withCredentials=n._xhr.withCredentials,g.responseType="arraybuffer",n._xhr.headers&&Object.keys(n._xhr.headers).forEach(function(d){g.setRequestHeader(d,n._xhr.headers[d])}),g.onload=function(){var d=(g.status+"")[0];if(d!=="0"&&d!=="2"&&d!=="3"){n._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}m(g.response,n)},g.onerror=function(){n._webAudio&&(n._html5=!0,n._webAudio=!1,n._sounds=[],delete o[a],n.load())},u(g)}},u=function(n){try{n.send()}catch(a){n.onerror()}},m=function(n,a){var r=function(){a._emit("loaderror",null,"Decoding audio data failed.")},c=function(h){h&&a._sounds.length>0?(o[a._src]=h,p(a,h)):r()};typeof Promise<"u"&&t.ctx.decodeAudioData.length===1?t.ctx.decodeAudioData(n).then(c).catch(r):t.ctx.decodeAudioData(n,c,r)},p=function(n,a){a&&!n._duration&&(n._duration=a.duration),Object.keys(n._sprite).length===0&&(n._sprite={__default:[0,n._duration*1e3]}),n._state!=="loaded"&&(n._state="loaded",n._emit("load"),n._loadQueue())},w=function(){if(t.usingWebAudio){try{typeof AudioContext<"u"?t.ctx=new AudioContext:typeof webkitAudioContext<"u"?t.ctx=new webkitAudioContext:t.usingWebAudio=!1}catch(h){t.usingWebAudio=!1}t.ctx||(t.usingWebAudio=!1);var n=/iP(hone|od|ad)/.test(t._navigator&&t._navigator.platform),a=t._navigator&&t._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),r=a?parseInt(a[1],10):null;if(n&&r&&r<9){var c=/safari/.test(t._navigator&&t._navigator.userAgent.toLowerCase());t._navigator&&!c&&(t.usingWebAudio=!1)}t.usingWebAudio&&(t.masterGain=typeof t.ctx.createGain>"u"?t.ctx.createGainNode():t.ctx.createGain(),t.masterGain.gain.setValueAtTime(t._muted?0:t._volume,t.ctx.currentTime),t.masterGain.connect(t.ctx.destination)),t._setup()}};I.Howler=t,I.Howl=i,typeof W<"u"?(W.HowlerGlobal=e,W.Howler=t,W.Howl=i,W.Sound=s):typeof window<"u"&&(window.HowlerGlobal=e,window.Howler=t,window.Howl=i,window.Sound=s)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var s=i._howls.length-1;s>=0;s--)i._howls[s].stereo(t);return i},HowlerGlobal.prototype.pos=function(t,i,s){var o=this;if(!o.ctx||!o.ctx.listener)return o;if(i=typeof i!="number"?o._pos[1]:i,s=typeof s!="number"?o._pos[2]:s,typeof t=="number")o._pos=[t,i,s],typeof o.ctx.listener.positionX<"u"?(o.ctx.listener.positionX.setTargetAtTime(o._pos[0],Howler.ctx.currentTime,.1),o.ctx.listener.positionY.setTargetAtTime(o._pos[1],Howler.ctx.currentTime,.1),o.ctx.listener.positionZ.setTargetAtTime(o._pos[2],Howler.ctx.currentTime,.1)):o.ctx.listener.setPosition(o._pos[0],o._pos[1],o._pos[2]);else return o._pos;return o},HowlerGlobal.prototype.orientation=function(t,i,s,o,l,u){var m=this;if(!m.ctx||!m.ctx.listener)return m;var p=m._orientation;if(i=typeof i!="number"?p[1]:i,s=typeof s!="number"?p[2]:s,o=typeof o!="number"?p[3]:o,l=typeof l!="number"?p[4]:l,u=typeof u!="number"?p[5]:u,typeof t=="number")m._orientation=[t,i,s,o,l,u],typeof m.ctx.listener.forwardX<"u"?(m.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),m.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),m.ctx.listener.forwardZ.setTargetAtTime(s,Howler.ctx.currentTime,.1),m.ctx.listener.upX.setTargetAtTime(o,Howler.ctx.currentTime,.1),m.ctx.listener.upY.setTargetAtTime(l,Howler.ctx.currentTime,.1),m.ctx.listener.upZ.setTargetAtTime(u,Howler.ctx.currentTime,.1)):m.ctx.listener.setOrientation(t,i,s,o,l,u);else return p;return m},Howl.prototype.init=function(t){return function(i){var s=this;return s._orientation=i.orientation||[1,0,0],s._stereo=i.stereo||null,s._pos=i.pos||null,s._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},s._onstereo=i.onstereo?[{fn:i.onstereo}]:[],s._onpos=i.onpos?[{fn:i.onpos}]:[],s._onorientation=i.onorientation?[{fn:i.onorientation}]:[],t.call(this,i)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,i){var s=this;if(!s._webAudio)return s;if(s._state!=="loaded")return s._queue.push({event:"stereo",action:function(){s.stereo(t,i)}}),s;var o=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof t=="number")s._stereo=t,s._pos=[t,0,0];else return s._stereo;for(var l=s._getSoundIds(i),u=0;u<l.length;u++){var m=s._soundById(l[u]);if(m)if(typeof t=="number")m._stereo=t,m._pos=[t,0,0],m._node&&(m._pannerAttr.panningModel="equalpower",(!m._panner||!m._panner.pan)&&e(m,o),o==="spatial"?typeof m._panner.positionX<"u"?(m._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),m._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),m._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):m._panner.setPosition(t,0,0):m._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),s._emit("stereo",m._id);else return m._stereo}return s},Howl.prototype.pos=function(t,i,s,o){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"pos",action:function(){l.pos(t,i,s,o)}}),l;if(i=typeof i!="number"?0:i,s=typeof s!="number"?-.5:s,typeof o>"u")if(typeof t=="number")l._pos=[t,i,s];else return l._pos;for(var u=l._getSoundIds(o),m=0;m<u.length;m++){var p=l._soundById(u[m]);if(p)if(typeof t=="number")p._pos=[t,i,s],p._node&&((!p._panner||p._panner.pan)&&e(p,"spatial"),typeof p._panner.positionX<"u"?(p._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),p._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),p._panner.positionZ.setValueAtTime(s,Howler.ctx.currentTime)):p._panner.setPosition(t,i,s)),l._emit("pos",p._id);else return p._pos}return l},Howl.prototype.orientation=function(t,i,s,o){var l=this;if(!l._webAudio)return l;if(l._state!=="loaded")return l._queue.push({event:"orientation",action:function(){l.orientation(t,i,s,o)}}),l;if(i=typeof i!="number"?l._orientation[1]:i,s=typeof s!="number"?l._orientation[2]:s,typeof o>"u")if(typeof t=="number")l._orientation=[t,i,s];else return l._orientation;for(var u=l._getSoundIds(o),m=0;m<u.length;m++){var p=l._soundById(u[m]);if(p)if(typeof t=="number")p._orientation=[t,i,s],p._node&&(p._panner||(p._pos||(p._pos=l._pos||[0,0,-.5]),e(p,"spatial")),typeof p._panner.orientationX<"u"?(p._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),p._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),p._panner.orientationZ.setValueAtTime(s,Howler.ctx.currentTime)):p._panner.setOrientation(t,i,s)),l._emit("orientation",p._id);else return p._orientation}return l},Howl.prototype.pannerAttr=function(){var t=this,i=arguments,s,o,l;if(!t._webAudio)return t;if(i.length===0)return t._pannerAttr;if(i.length===1)if(typeof i[0]=="object")s=i[0],typeof o>"u"&&(s.pannerAttr||(s.pannerAttr={coneInnerAngle:s.coneInnerAngle,coneOuterAngle:s.coneOuterAngle,coneOuterGain:s.coneOuterGain,distanceModel:s.distanceModel,maxDistance:s.maxDistance,refDistance:s.refDistance,rolloffFactor:s.rolloffFactor,panningModel:s.panningModel}),t._pannerAttr={coneInnerAngle:typeof s.pannerAttr.coneInnerAngle<"u"?s.pannerAttr.coneInnerAngle:t._coneInnerAngle,coneOuterAngle:typeof s.pannerAttr.coneOuterAngle<"u"?s.pannerAttr.coneOuterAngle:t._coneOuterAngle,coneOuterGain:typeof s.pannerAttr.coneOuterGain<"u"?s.pannerAttr.coneOuterGain:t._coneOuterGain,distanceModel:typeof s.pannerAttr.distanceModel<"u"?s.pannerAttr.distanceModel:t._distanceModel,maxDistance:typeof s.pannerAttr.maxDistance<"u"?s.pannerAttr.maxDistance:t._maxDistance,refDistance:typeof s.pannerAttr.refDistance<"u"?s.pannerAttr.refDistance:t._refDistance,rolloffFactor:typeof s.pannerAttr.rolloffFactor<"u"?s.pannerAttr.rolloffFactor:t._rolloffFactor,panningModel:typeof s.pannerAttr.panningModel<"u"?s.pannerAttr.panningModel:t._panningModel});else return l=t._soundById(parseInt(i[0],10)),l?l._pannerAttr:t._pannerAttr;else i.length===2&&(s=i[0],o=parseInt(i[1],10));for(var u=t._getSoundIds(o),m=0;m<u.length;m++)if(l=t._soundById(u[m]),l){var p=l._pannerAttr;p={coneInnerAngle:typeof s.coneInnerAngle<"u"?s.coneInnerAngle:p.coneInnerAngle,coneOuterAngle:typeof s.coneOuterAngle<"u"?s.coneOuterAngle:p.coneOuterAngle,coneOuterGain:typeof s.coneOuterGain<"u"?s.coneOuterGain:p.coneOuterGain,distanceModel:typeof s.distanceModel<"u"?s.distanceModel:p.distanceModel,maxDistance:typeof s.maxDistance<"u"?s.maxDistance:p.maxDistance,refDistance:typeof s.refDistance<"u"?s.refDistance:p.refDistance,rolloffFactor:typeof s.rolloffFactor<"u"?s.rolloffFactor:p.rolloffFactor,panningModel:typeof s.panningModel<"u"?s.panningModel:p.panningModel};var w=l._panner;w||(l._pos||(l._pos=t._pos||[0,0,-.5]),e(l,"spatial"),w=l._panner),w.coneInnerAngle=p.coneInnerAngle,w.coneOuterAngle=p.coneOuterAngle,w.coneOuterGain=p.coneOuterGain,w.distanceModel=p.distanceModel,w.maxDistance=p.maxDistance,w.refDistance=p.refDistance,w.rolloffFactor=p.rolloffFactor,w.panningModel=p.panningModel}return t},Sound.prototype.init=function(t){return function(){var i=this,s=i._parent;i._orientation=s._orientation,i._stereo=s._stereo,i._pos=s._pos,i._pannerAttr=s._pannerAttr,t.call(this),i._stereo?s.stereo(i._stereo):i._pos&&s.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var i=this,s=i._parent;return i._orientation=s._orientation,i._stereo=s._stereo,i._pos=s._pos,i._pannerAttr=s._pannerAttr,i._stereo?s.stereo(i._stereo):i._pos?s.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,s._refreshBuffer(i)),t.call(this)}}(Sound.prototype.reset);var e=function(t,i){i=i||"spatial",i==="spatial"?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,typeof t._panner.positionX<"u"?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),typeof t._panner.orientationX<"u"?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}})()})(O);class Oe{constructor(){this.settings={masterVolume:.7,musicVolume:.5,sfxVolume:.8},this.musicTracks=new Map,this.soundEffects=new Map,this.currentMusic=null,this.isInitialized=!1,this.soundEnabled=!0,this.musicEnabled=!0,this.ambientEnabled=!0,this.categories={ui:"ui",combat:"combat",crafting:"crafting",environment:"environment",music:"music",ambient:"ambient"},this.init()}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è AudioManager already initialized, skipping...");return}console.log("üéµ Initializing Audio Manager...");try{O.Howler.volume(this.settings.masterVolume),this.loadMusic(),this.loadSounds(),this.isInitialized=!0,console.log("‚úÖ Audio Manager initialized")}catch(e){throw console.error("‚ùå Failed to initialize Audio Manager:",e),e}}setupAudioContext(){O.Howler.volume(this.masterVolume),document.addEventListener("click",()=>{O.Howler.ctx.state==="suspended"&&O.Howler.ctx.resume()},{once:!0})}loadSounds(){this.loadSound("button_click","ui",{src:["/sounds/ui/button_click.mp3"],volume:.6,rate:1}),this.loadSound("panel_open","ui",{src:["/sounds/ui/panel_open.mp3"],volume:.5,rate:1}),this.loadSound("panel_close","ui",{src:["/sounds/ui/panel_close.mp3"],volume:.5,rate:1}),this.loadSound("notification","ui",{src:["/sounds/ui/notification.mp3"],volume:.7,rate:1}),this.loadSound("hammer_strike","crafting",{src:["/sounds/crafting/hammer_strike.mp3"],volume:.8,rate:1}),this.loadSound("metal_clang","crafting",{src:["/sounds/crafting/metal_clang.mp3"],volume:.7,rate:1}),this.loadSound("wood_cut","crafting",{src:["/sounds/crafting/wood_cut.mp3"],volume:.6,rate:1}),this.loadSound("potion_bubble","crafting",{src:["/sounds/crafting/potion_bubble.mp3"],volume:.5,rate:1}),this.loadSound("wind_ambient","environment",{src:["/sounds/environment/wind_ambient.mp3"],volume:.4,rate:1,loop:!0}),this.loadSound("sand_footstep","environment",{src:["/sounds/environment/sand_footstep.mp3"],volume:.6,rate:1}),this.loadSound("water_splash","environment",{src:["/sounds/environment/water_splash.mp3"],volume:.7,rate:1}),this.loadSound("fire_crackle","environment",{src:["/sounds/environment/fire_crackle.mp3"],volume:.5,rate:1,loop:!0}),this.loadSound("sword_swing","combat",{src:["/sounds/combat/sword_swing.mp3"],volume:.8,rate:1}),this.loadSound("armor_clank","combat",{src:["/sounds/combat/armor_clank.mp3"],volume:.6,rate:1}),this.loadSound("magic_cast","combat",{src:["/sounds/combat/magic_cast.mp3"],volume:.7,rate:1}),this.createPlaceholderSounds()}createPlaceholderSounds(){const e=new(window.AudioContext||window.webkitAudioContext);this.createPlaceholderSound("button_click",()=>{const t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.exponentialRampToValueAtTime(400,e.currentTime+.1),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)}),this.createPlaceholderSound("hammer_strike",()=>{const t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(100,e.currentTime+.3),i.gain.setValueAtTime(.4,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}),this.createPlaceholderSound("wind_ambient",()=>{const t=e.createOscillator(),i=e.createGain(),s=e.createBiquadFilter();t.connect(s),s.connect(i),i.connect(e.destination),t.type="noise",s.type="lowpass",s.frequency.setValueAtTime(200,e.currentTime),i.gain.setValueAtTime(.1,e.currentTime),t.start(e.currentTime),t.stop(e.currentTime+2)})}createPlaceholderSound(e,t){this.soundEffects.set(e,{play:t,volume:1,category:"ui"})}loadMusic(){[{id:"main_theme",name:"Ancient Egypt Theme",category:"music"},{id:"desert_wind",name:"Desert Wind",category:"ambient"},{id:"pyramid_mystery",name:"Pyramid Mystery",category:"music"},{id:"crafting_peace",name:"Crafting Peace",category:"music"},{id:"battle_theme",name:"Battle Theme",category:"music"}].forEach(t=>{this.musicTracks.set(t.id,{name:t.name,category:t.category,loaded:!1,howl:null})}),this.simulateMusicLoading()}simulateMusicLoading(){setTimeout(()=>{this.musicTracks.forEach((e,t)=>{e.loaded=!0,console.log("üéµ Music track loaded: ".concat(e.name))})},2e3)}setupEventListeners(){document.addEventListener("crafting_start",()=>{this.playSound("hammer_strike")}),document.addEventListener("item_crafted",()=>{this.playSound("notification")}),document.addEventListener("panel_open",()=>{this.playSound("panel_open")}),document.addEventListener("panel_close",()=>{this.playSound("panel_close")})}playSound(e,t={}){if(!this.soundEnabled)return;const i=this.soundEffects.get(e);if(!i){console.warn("Sound not found: ".concat(e));return}try{if(i.play)i.play();else if(i.howl){const s=t.volume||i.volume||this.soundVolume;i.howl.volume(s*this.masterVolume),i.howl.play()}}catch(s){console.error("Error playing sound ".concat(e,":"),s)}}playMusic(e,t={}){if(!this.musicEnabled)return;const i=this.musicTracks.get(e);if(!i||!i.loaded){console.warn("Music not found or not loaded: ".concat(e));return}try{if(this.currentMusic&&this.currentMusic.howl&&this.currentMusic.howl.stop(),i.howl){const s=t.volume||this.musicVolume;i.howl.volume(s*this.masterVolume),i.howl.loop(!0),i.howl.play(),this.currentMusic=i}}catch(s){console.error("Error playing music ".concat(e,":"),s)}}stopMusic(){this.currentMusic&&this.currentMusic.howl&&(this.currentMusic.howl.stop(),this.currentMusic=null)}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),O.Howler.volume(this.masterVolume)}setSoundVolume(e){this.soundVolume=Math.max(0,Math.min(1,e))}setSFXVolume(e){this.soundVolume=Math.max(0,Math.min(1,e)),this.soundEffects.forEach(t=>{t.category==="sfx"&&t.howl&&t.howl.volume(e*this.masterVolume)})}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e)),this.currentMusic&&this.currentMusic.howl&&this.currentMusic.howl.volume(e*this.masterVolume)}toggleSound(){return this.soundEnabled=!this.soundEnabled,this.soundEnabled}toggleMusic(){return this.musicEnabled=!this.musicEnabled,this.musicEnabled||this.stopMusic(),this.musicEnabled}toggleAmbient(){return this.ambientEnabled=!this.ambientEnabled,this.ambientEnabled||this.stopAmbientSounds(),this.ambientEnabled}stopAmbientSounds(){this.soundEffects.forEach(e=>{e.category==="ambient"&&e.howl&&e.howl.stop()})}loadSound(e,t,i){try{const s=new O.Howl({src:i.src,volume:i.volume||1,rate:i.rate||1,loop:i.loop||!1,preload:!0,onload:()=>{console.log("üéµ Sound loaded: ".concat(e))},onloaderror:(o,l)=>{console.error("Failed to load sound ".concat(e,":"),l)}});this.soundEffects.set(e,{howl:s,volume:i.volume||1,category:t})}catch(s){console.error("Error loading sound ".concat(e,":"),s)}}getSound(e){return this.soundEffects.get(e)}getMusic(e){return this.musicTracks.get(e)}getAllSounds(){return Array.from(this.soundEffects.keys())}getAllMusic(){return Array.from(this.musicTracks.keys())}getAudioStats(){return{soundsLoaded:this.soundEffects.size,musicLoaded:Array.from(this.musicTracks.values()).filter(e=>e.loaded).length,masterVolume:this.masterVolume,soundVolume:this.soundVolume,musicVolume:this.musicVolume,soundEnabled:this.soundEnabled,musicEnabled:this.musicEnabled,ambientEnabled:this.ambientEnabled}}destroy(){this.stopMusic(),this.stopAmbientSounds(),this.soundEffects.clear(),this.musicTracks.clear(),O.Howler.unload(),console.log("üéµ Audio Manager destroyed")}}class Be{constructor(){this.totalAssets=0,this.loadedAssets=0,this.loadingProgress=0,this.isLoading=!0,this.loadingScreen=null,this.progressBar=null,this.loadingText=null,this.assetPromises=[],this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è LoadingManager already initialized, skipping...");return}if(console.log("üì¶ Initializing Loading Manager..."),this.loadingScreen=document.getElementById("loading-screen"),this.progressBar=document.querySelector(".loading-progress"),this.loadingText=document.querySelector(".loading-text"),!this.loadingScreen||!this.progressBar||!this.loadingText)throw new Error("Loading screen elements not found");await this.loadAssets(),this.isInitialized=!0,console.log("‚úÖ Loading Manager initialized")}async loadAssets(){const e=[{name:"Loading game data...",weight:.2},{name:"Loading 3D models...",weight:.3},{name:"Loading textures...",weight:.2},{name:"Loading audio...",weight:.1},{name:"Initializing systems...",weight:.2}];let t=0;for(const i of e)this.updateLoadingText(i.name),await this.simulateLoading(i.weight*1e3),t+=i.weight,this.updateProgress(t);this.updateLoadingText("Ready to enter ancient Egypt..."),await this.simulateLoading(500),this.isLoading=!1}simulateLoading(e){return new Promise(t=>{setTimeout(t,e)})}updateProgress(e){this.loadingProgress=Math.min(e,1),this.progressBar&&(this.progressBar.style.width="".concat(this.loadingProgress*100,"%"))}updateLoadingText(e){this.loadingText&&(this.loadingText.textContent=e)}hide(){this.loadingScreen&&(this.loadingScreen.style.opacity="0",setTimeout(()=>{this.loadingScreen.style.display="none"},500))}show(){this.loadingScreen&&(this.loadingScreen.style.display="flex",this.loadingScreen.style.opacity="1")}addAsset(e,t){this.totalAssets++,this.assetPromises.push(e),e.then(()=>{this.loadedAssets++,this.updateAssetProgress()}).catch(i=>{console.error("Failed to load asset: ".concat(t),i),this.loadedAssets++,this.updateAssetProgress()})}updateAssetProgress(){if(this.totalAssets>0){const e=this.loadedAssets/this.totalAssets;this.updateProgress(e)}}isLoading(){return this.isLoading}getProgress(){return this.loadingProgress}getLoadedAssets(){return this.loadedAssets}getTotalAssets(){return this.totalAssets}}class Re{constructor(){this.gameEngine=null,this.uiManager=null,this.optionsManager=null,this.networkManager=null,this.audioManager=null,this.loadingManager=null,this.isInitialized=!1}async init(){if(this.isInitialized){console.warn("‚ö†Ô∏è Egypt MMO already initialized, skipping...");return}try{console.log("üöÄ Initializing Egypt MMO..."),console.log("üîç Init called at:",new Date().toISOString()),console.log("üîç Stack trace:",new Error().stack),this.loadingManager=new Be,await this.loadingManager.init(),console.log("üîç Creating AudioManager..."),this.audioManager=new Oe,console.log("üîç Creating NetworkManager..."),this.networkManager=new Fe,console.log("üîç Creating GameEngine..."),this.gameEngine=new De,console.log("üîç Creating UIManager..."),this.uiManager=new qe,console.log("üîç Creating OptionsManager..."),this.optionsManager=new ze(this.gameEngine),await Promise.all([this.audioManager.init(),this.networkManager.init(),this.gameEngine.init(),this.uiManager.init(),this.optionsManager.init()]),this.gameEngine.setUIManager(this.uiManager),this.gameEngine.setNetworkManager(this.networkManager),this.gameEngine.setAudioManager(this.audioManager),this.gameEngine.setOptionsManager(this.optionsManager),this.uiManager.setGameEngine(this.gameEngine),await this.start()}catch(e){console.error("Failed to initialize Egypt MMO:",e),this.showErrorScreen(e)}}async start(){console.log("üéÆ Starting Egypt MMO..."),this.loadingManager.hide(),this.uiManager.show(),this.gameEngine.start(),await this.networkManager.connect(),this.isInitialized=!0,console.log("‚úÖ Egypt MMO started successfully!"),this.setupEventListeners()}setupEventListeners(){let e;window.addEventListener("resize",()=>{this.gameEngine&&(e&&clearTimeout(e),e=setTimeout(()=>{this.gameEngine.handleResize()},150))}),document.addEventListener("visibilitychange",()=>{var t,i;document.hidden?(t=this.gameEngine)==null||t.pause():((i=this.gameEngine)==null||i.resume(),setTimeout(()=>{this.gameEngine&&this.gameEngine.restoreViewport()},100))}),window.addEventListener("focus",()=>{setTimeout(()=>{this.gameEngine&&this.gameEngine.restoreViewport()},100)}),window.addEventListener("beforeunload",()=>{var t;(t=this.networkManager)==null||t.disconnect()})}showErrorScreen(e){const t=document.getElementById("loading-screen");t&&(t.innerHTML='\n                <div class="loading-content">\n                    <div class="egyptian-symbol">‚ö†Ô∏è</div>\n                    <h1>Initialization Failed</h1>\n                    <p>'.concat(e.message,'</p>\n                    <button onclick="location.reload()" class="action-btn">üîÑ Retry</button>\n                </div>\n            '))}}document.addEventListener("DOMContentLoaded",()=>{if(window.egyptMMO){console.log("üîÑ Vite hot reload detected, skipping re-initialization");return}if(window.gameInitializing){console.log("üîÑ Game initialization already in progress, skipping...");return}window.gameInitializing=!0;const I=new Re;window.egyptMMO=I,I.init().finally(()=>{window.gameInitializing=!1})});export{Ne as __vite_legacy_guard};
