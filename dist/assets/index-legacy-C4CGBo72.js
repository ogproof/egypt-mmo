System.register(["./three-legacy-DIAPvMFy.js","./networking-legacy-wVKw0lWj.js"],function(e,t){"use strict";var i,o,n,s,a,r,l,d,c,h,u,p,m,g,y,f,w,v,b,_,x,I,S,M,k,E,A,T,C,L,P,z,$,q,D,O,N,R,F,B,H,V,G,j;return{setters:[e=>{i=e.V,o=e.Q,n=e.C,s=e.M,a=e.a,r=e.b,l=e.S,d=e.c,c=e.A,h=e.d,u=e.e,p=e.R,m=e.f,g=e.D,y=e.G,f=e.g,w=e.h,v=e.P,b=e.F,_=e.i,x=e.B,I=e.j,S=e.k,M=e.I,k=e.l,E=e.m,A=e.n,T=e.o,C=e.p,L=e.q,P=e.r,z=e.L,$=e.s,q=e.t,D=e.u,O=e.v,N=e.W,R=e.w,F=e.x,B=e.y,H=e.z,V=e.E,G=e.H},e=>{j=e.l}],execute:function(){var e=document.createElement("style");e.textContent="*{margin:0;padding:0;box-sizing:border-box}body{font-family:Noto Sans,sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);color:#f4f4f4;overflow:hidden;height:100vh}#game-container{position:relative;width:100vw;height:100vh;overflow:hidden}.loading-screen{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s ease-out}.loading-content{text-align:center;color:#f4f4f4}.egyptian-symbol{font-size:4rem;margin-bottom:1rem;animation:pulse 2s infinite}.loading-content h1{font-family:Cinzel,serif;font-size:3rem;margin-bottom:.5rem;background:linear-gradient(45deg,gold,#ffed4e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.loading-content p{font-size:1.2rem;margin-bottom:2rem;color:#b8b8b8}.loading-bar{width:300px;height:8px;background:rgba(255,255,255,.1);border-radius:4px;margin:0 auto 1rem;overflow:hidden}.loading-progress{height:100%;background:linear-gradient(90deg,gold,#ffed4e);width:0%;transition:width .3s ease;animation:loading 2s ease-in-out infinite}.loading-text{font-size:.9rem;color:#888}#game-canvas{position:absolute;top:0;left:0;width:100vw!important;height:100vh!important;z-index:1;display:block;object-fit:cover}.game-ui{position:absolute;top:0;left:0;width:100%;height:100%;z-index:100;pointer-events:none}.game-ui>*{pointer-events:auto}.hidden{display:none!important}.top-hud{position:absolute;top:20px;left:20px;right:20px;display:flex;justify-content:space-between;align-items:center;z-index:200}.player-info{display:flex;align-items:center;background:rgba(0,0,0,.7);padding:10px 15px;border-radius:25px;border:2px solid #ffd700;backdrop-filter:blur(10px)}.player-avatar{font-size:1.5rem;margin-right:10px}.player-name{font-weight:600;color:gold}.player-level{font-size:.8rem;color:#b8b8b8}.resources{display:flex;gap:15px}.resource{background:rgba(0,0,0,.7);padding:8px 15px;border-radius:20px;border:2px solid #ffd700;backdrop-filter:blur(10px);font-weight:600}.resource.time{border-color:#4ecdc4;color:#4ecdc4;animation:timeGlow 2s ease-in-out infinite alternate}@keyframes timeGlow{0%{box-shadow:0 0 5px #4ecdc4}to{box-shadow:0 0 15px #4ecdc4,0 0 25px #4ecdc4}}.crafting-panel,.inventory{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);border:3px solid #ffd700;border-radius:15px;padding:20px;min-width:400px;max-width:800px;backdrop-filter:blur(15px);z-index:300}.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ffd700}.panel-header h3{font-family:Cinzel,serif;color:gold;font-size:1.5rem}.close-btn{background:none;border:none;color:gold;font-size:1.5rem;cursor:pointer;padding:5px;border-radius:50%;transition:all .3s ease}.close-btn:hover{background:rgba(255,215,0,.2);transform:scale(1.1)}.crafting-categories{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}.category-btn{background:rgba(255,215,0,.1);border:2px solid #ffd700;color:gold;padding:8px 15px;border-radius:20px;cursor:pointer;transition:all .3s ease;font-weight:500}.category-btn:hover,.category-btn.active{background:gold;color:#000;transform:translateY(-2px)}.crafting-items{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;max-height:400px;overflow-y:auto}.crafting-item{background:rgba(255,255,255,.05);border:2px solid #444;border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s ease}.crafting-item:hover{border-color:gold;transform:translateY(-3px);box-shadow:0 5px 15px rgba(255,215,0,.3)}.crafting-item img{width:50px;height:50px;margin-bottom:10px}.crafting-item h4{color:gold;margin-bottom:5px}.crafting-item p{font-size:.8rem;color:#b8b8b8}.inventory-content{display:flex;gap:20px;align-items:flex-start}.character-doll{flex-shrink:0;width:200px}.character-doll h4{color:gold;margin-bottom:15px;text-align:center;font-family:Cinzel,serif}.equipment-slots{display:grid;grid-template-columns:1fr;gap:10px}.equipment-slot{width:60px;height:60px;border:2px solid #ffd700;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.5);cursor:pointer;transition:all .3s ease;position:relative;margin:2px;padding:4px;text-align:center}.equipment-slot:hover{background:rgba(255,215,0,.2);border-color:#fff;transform:translateY(-2px);box-shadow:0 4px 8px rgba(255,215,0,.3)}.equipment-slot.equipped{background:rgba(255,215,0,.3);border-color:#fff;box-shadow:0 0 10px rgba(255,215,0,.5)}.equipment-slot.equipped:hover{background:rgba(255,215,0,.4);transform:translateY(-2px) scale(1.05);box-shadow:0 6px 12px rgba(255,215,0,.6)}.equipment-slot .slot-label{font-size:.6rem;color:gold;text-align:center;margin-bottom:2px;font-weight:600;text-transform:uppercase}.equipment-slot .item-icon{font-size:1.2rem;margin:2px 0}.equipment-slot .item-name{font-size:.5rem;color:#fff;text-align:center;margin-top:2px;font-weight:500;line-height:1.1;word-wrap:break-word;max-width:100%}.slot-label{font-size:.7rem;color:#888;text-align:center;position:absolute;bottom:-20px;left:50%;transform:translate(-50%);white-space:nowrap}.inventory-section{flex:1}.inventory-section h4{color:gold;margin-bottom:15px;text-align:center;font-family:Cinzel,serif}.item-context-menu{position:absolute;background:rgba(0,0,0,.95);border:2px solid #ffd700;border-radius:8px;padding:5px 0;color:#fff;z-index:1000;min-width:120px;box-shadow:0 4px 12px rgba(0,0,0,.5)}.context-menu-item{padding:8px 15px;cursor:pointer;transition:background-color .2s ease;font-size:.9rem}.context-menu-item:hover{background:rgba(255,215,0,.2);color:gold}.item-tooltip{position:fixed;background:rgba(0,0,0,.95);border:2px solid #ffd700;border-radius:10px;padding:15px;color:#fff;z-index:1000;min-width:250px;max-width:300px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,.8);font-family:Noto Sans,sans-serif}.tooltip-header{display:flex;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #ffd700}.tooltip-header .item-icon{font-size:1.5rem;margin-right:10px}.tooltip-header .item-name{margin:0;color:gold;font-size:1.1rem;font-weight:600}.tooltip-content{margin-bottom:15px}.tooltip-content p{margin:5px 0;font-size:.9rem}.tooltip-content .item-type{color:#4ecdc4;font-weight:500}.tooltip-content .item-description{color:#b8b8b8;font-style:italic;line-height:1.4}.tooltip-content .item-stats{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}.tooltip-content .stat{background:rgba(255,215,0,.2);color:gold;padding:4px 8px;border-radius:4px;font-size:.8rem;font-weight:500}.tooltip-actions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}.tooltip-actions .action-btn{background:rgba(255,215,0,.2);color:gold;border:1px solid #ffd700;border-radius:5px;padding:8px 12px;cursor:pointer;font-size:.8rem;font-weight:500;transition:all .3s ease;min-width:60px}.tooltip-actions .action-btn:hover{background:rgba(255,215,0,.4);border-color:#fff;transform:translateY(-1px)}.tooltip-actions .equip-btn{background:rgba(76,175,80,.2);color:#4caf50;border-color:#4caf50}.tooltip-actions .equip-btn:hover{background:rgba(76,175,80,.4)}.tooltip-actions .use-btn{background:rgba(33,150,243,.2);color:#2196f3;border-color:#2196f3}.tooltip-actions .use-btn:hover{background:rgba(33,150,243,.4)}.tooltip-actions .drop-btn{background:rgba(244,67,54,.2);color:#f44336;border-color:#f44336}.tooltip-actions .drop-btn:hover{background:rgba(244,67,54,.4)}.tooltip-actions .close-btn{background:rgba(158,158,158,.2);color:#9e9e9e;border-color:#9e9e9e}.tooltip-actions .close-btn:hover{background:rgba(158,158,158,.4)}.equipment-info{color:#4caf50!important;font-weight:700}.tooltip-buttons{display:flex;gap:10px;margin-top:15px;justify-content:center}.tooltip-buttons button{padding:8px 16px;border:2px solid #ffd700;background:rgba(255,215,0,.1);color:gold;border-radius:5px;cursor:pointer;font-family:Cinzel,serif;transition:all .3s ease}.tooltip-buttons button:hover{background:rgba(255,215,0,.3);transform:translateY(-2px)}.equip-btn{background:rgba(76,175,80,.2)!important;border-color:#4caf50!important;color:#4caf50!important}.equip-btn:hover{background:rgba(76,175,80,.4)!important}.inventory-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;max-height:400px;overflow-y:auto}.inventory-slot{width:50px;height:50px;border:2px solid #444;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);cursor:pointer;transition:all .3s ease;position:relative;margin:2px}.inventory-slot:hover{border-color:gold;background:rgba(255,215,0,.1);transform:translateY(-2px);box-shadow:0 4px 8px rgba(255,215,0,.3)}.inventory-slot.filled{background:rgba(255,215,0,.2);border-color:gold}.inventory-slot.filled:hover{background:rgba(255,215,0,.3);border-color:#fff;transform:translateY(-2px) scale(1.05);box-shadow:0 6px 12px rgba(255,215,0,.4)}.inventory-slot span{font-size:1.5rem;pointer-events:none}.action-buttons{position:absolute;bottom:30px;left:50%;transform:translate(-50%);display:flex;gap:15px;z-index:200}.action-btn{background:linear-gradient(135deg,gold,#ffed4e);border:none;color:#000;padding:12px 20px;border-radius:25px;cursor:pointer;font-weight:600;font-size:1rem;transition:all .3s ease;box-shadow:0 4px 15px rgba(255,215,0,.3)}.action-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(255,215,0,.4)}.action-btn:active{transform:translateY(-1px)}.options-menu{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(5px)}.options-menu.hidden{display:none}.options-content{background:linear-gradient(135deg,#2c1810,#4a2c1a);border:2px solid #8B4513;border-radius:15px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,.5);position:relative}.options-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #8B4513}.options-header h2{color:gold;margin:0;font-size:24px;text-shadow:0 0 10px rgba(255,215,0,.5)}.close-btn{background:#8b4513;color:#fff;border:none;border-radius:50%;width:35px;height:35px;font-size:18px;cursor:pointer;transition:all .3s ease}.close-btn:hover{background:sienna;transform:scale(1.1)}.options-tabs{display:flex;gap:10px;margin-bottom:25px}.tab-btn{background:#5d4037;color:#d7ccc8;border:2px solid #8B4513;border-radius:8px;padding:10px 20px;cursor:pointer;transition:all .3s ease;font-weight:500}.tab-btn:hover{background:#8b4513;color:#fff}.tab-btn.active{background:gold;color:#2c1810;border-color:gold;box-shadow:0 0 15px rgba(255,215,0,.5)}.tab-content{display:none;margin-bottom:25px}.tab-content.active{display:block}.setting-group{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:15px;background:rgba(139,69,19,.1);border-radius:8px;border:1px solid rgba(139,69,19,.3)}.setting-group label{color:#d7ccc8;font-weight:500;min-width:150px}.setting-group select,.setting-group input[type=range]{background:#5d4037;color:#fff;border:1px solid #8B4513;border-radius:5px;padding:8px 12px;min-width:150px}.setting-group select:focus,.setting-group input[type=range]:focus{outline:none;border-color:gold;box-shadow:0 0 10px rgba(255,215,0,.3)}.setting-group input[type=range]{width:150px;height:6px;background:#8b4513;outline:none;border-radius:3px;-webkit-appearance:none}.setting-group input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:gold;border-radius:50%;cursor:pointer;box-shadow:0 0 10px rgba(255,215,0,.5)}.setting-group input[type=range]::-moz-range-thumb{width:20px;height:20px;background:gold;color:gold;border-radius:50%;cursor:pointer;border:none;box-shadow:0 0 10px rgba(255,215,0,.5)}.setting-group span{color:gold;font-weight:500;min-width:50px;text-align:right}.options-actions{display:flex;gap:15px;justify-content:center;padding-top:20px;border-top:2px solid #8B4513}.apply-btn,.reset-btn{background:linear-gradient(135deg,#8b4513,sienna);color:#fff;border:none;border-radius:8px;padding:12px 25px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;min-width:140px}.apply-btn{background:linear-gradient(135deg,#4caf50,#45a049)}.apply-btn:hover{background:linear-gradient(135deg,#45a049,#4caf50);transform:translateY(-2px);box-shadow:0 5px 15px rgba(76,175,80,.4)}.reset-btn:hover{background:linear-gradient(135deg,sienna,#8b4513);transform:translateY(-2px);box-shadow:0 5px 15px rgba(139,69,19,.4)}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:rgba(255,255,255,.1);border-radius:4px}::-webkit-scrollbar-thumb{background:gold;border-radius:4px}::-webkit-scrollbar-thumb:hover{background:#ffed4e}@keyframes pulse{0%,to{transform:scale(1)}50%{transform:scale(1.1)}}@keyframes loading{0%{width:0%}50%{width:70%}to{width:100%}}@keyframes slideIn{0%{transform:translate(100%);opacity:0}to{transform:translate(0);opacity:1}}@media (max-width: 768px){.crafting-panel,.inventory{min-width:90vw;max-width:90vw}.crafting-categories{justify-content:center}.action-buttons{flex-wrap:wrap;justify-content:center}.top-hud{flex-direction:column;gap:15px;align-items:flex-start}.options-content{width:95%;padding:20px;max-height:90vh}.options-tabs{flex-wrap:wrap;gap:5px}.tab-btn{padding:8px 15px;font-size:14px}.setting-group{flex-direction:column;align-items:flex-start;gap:10px}.setting-group label{min-width:auto}.setting-group select,.setting-group input[type=range]{min-width:100%}.options-actions{flex-direction:column;gap:10px}.apply-btn,.reset-btn{min-width:100%}}\n/*$vite$:1*/",document.head.appendChild(e);class t{constructor(e,t){this.scene=e,this.physicsWorld=t,this.position=new i(0,0,0),this.rotation=0,this.isMoving=!1,this.targetPosition=null,this.moveSpeed=15,this.movementQuat=new o,this.targetQuat=new o,this.movementPath=null,this.currentPathIndex=0,this.camera=null,this.mesh=null,this.nameTag=null,this.targetIndicator=null,this.equipment={head:null,chest:null,legs:null,feet:null,weapon:null,offhand:null,accessory:null},this.equipmentMeshes={weapon:null,offhand:null},this.equippedLight=null,this.mixer=null,this.animations={},this.currentAnimation="idle",this.cameraRotation=new o,this.cameraRotationDirection=0,this.rotationSpeed=.01,this.movementDirection=null,this.stats={health:100,maxHealth:100,level:1,experience:0},this.isInitialized=!1}async init(){this.isInitialized?console.warn("⚠️ Player already initialized, skipping..."):(console.log("👤 Initializing Player..."),this.createMesh(),this.createNameTag(),this.setupAnimations(),this.position.set(0,0,0),this.mesh.position.copy(this.position),this.isInitialized=!0,console.log("✅ Player initialized"))}createMesh(){this.createHumanMesh(),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}createHumanMesh(){const e=new n(.5,1.5,8,8),t=new s({color:7048739,transparent:!0,opacity:.9});this.mesh=new a(e,t),this.mesh.position.y=1.5,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,console.log("👤 Simple capsule character created"),this.createNameTag()}animateWalk(e){if(this.mesh){const t=.1,i=8;this.mesh.position.y=1.5+Math.sin(e*i)*t}}animateIdle(e){if(this.mesh){const t=.02,i=2,o=1+Math.sin(e*i)*t;this.mesh.scale.set(o,o,o)}}resetAnimation(){this.mesh&&(this.mesh.position.y=1.5,this.mesh.scale.set(1,1,1))}createNameTag(){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=256,e.height=64,t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,e.width,e.height),t.fillStyle="#ffffff",t.font="24px Arial",t.textAlign="center",t.fillText("Player",e.width/2,40);const i=new r(e),o=new l({map:i}),n=new d(o);n.position.y=2.5,n.scale.set(2,.5,1),this.mesh.add(n)}setupAnimations(){this.mixer=new c(this.mesh),this.createIdleAnimation(),this.createWalkAnimation(),this.playAnimation("idle")}createIdleAnimation(){const e=new h(".quaternion",[0,1,2],[[0,0,0,1],[0,.02,0,1],[0,0,0,1]].flat()),t=new u("idle",2,[e]);this.animations.idle=this.mixer.clipAction(t)}createWalkAnimation(){const e=new h(".quaternion",[0,.5,1],[[0,0,0,1],[0,.05,0,1],[0,0,0,1]].flat()),t=new u("walk",1,[e]);this.animations.walk=this.mixer.clipAction(t)}playAnimation(e){this.currentAnimation!==e&&(this.animations[this.currentAnimation]&&this.animations[this.currentAnimation].stop(),this.animations[e]&&(this.animations[e].play(),this.currentAnimation=e))}handleKeyDown(e){switch(e){case"ArrowLeft":this.cameraRotationDirection=-1;break;case"ArrowRight":this.cameraRotationDirection=1}}handleKeyUp(e){switch(e){case"ArrowLeft":case"ArrowRight":this.cameraRotationDirection=0}}rotateCamera(e){if(0!==this.cameraRotationDirection){const t=(new o).setFromAxisAngle(new i(0,1,0),this.cameraRotationDirection*this.rotationSpeed*e*60);this.cameraRotation.multiply(t)}}handleMouseMove(e,t){}update(e){if(!this.isInitialized)return;this.updateMovement(e);const t=.001*performance.now();this.isMoving?this.animateWalk(t):this.animateIdle(t)}updateMovement(e){if(!this.isMoving||!this.targetPosition)return;if(this.position.distanceTo(this.targetPosition)<.2){this.isMoving=!1,this.targetPosition=null,this.movementPath=null,this.currentPathIndex=0;const e=this.scene.userData.gridManager;return e&&e.clearHighlight(),void console.log("✅ Reached destination")}const t=this.targetPosition.clone().sub(this.position).normalize(),i=this.moveSpeed*e,o=this.position.clone().add(t.multiplyScalar(i));if(this.position.copy(o),this.mesh.position.copy(this.position),this.camera&&(this.camera.position.x=this.position.x,this.camera.position.z=this.position.z+10,this.camera.lookAt(this.position)),t.length()>.1){const e=Math.atan2(t.x,t.z);this.mesh.rotation.y=e}this.nameTag&&(this.nameTag.position.copy(this.position),this.nameTag.position.y+=3),this.updateEquipmentPositions()}updateTorchAnimation(e){if(!this.equipmentMeshes.offhand)return;const t=.003*Date.now(),i=.1*Math.sin(8*t)+.05*Math.sin(15*t)+.95,o=this.equipmentMeshes.offhand.children[1];if(o&&o.scale.setScalar(i),this.equippedLight){const e=.2*Math.sin(6*t)+.1*Math.sin(12*t)+.9;this.equippedLight.intensity=1.5*e}}updatePhysics(e){if(this.mesh&&this.mesh.parent){if(this.mesh.position.x=this.position.x,this.mesh.position.y=this.position.y,this.mesh.position.z=this.position.z,this.mesh.updateMatrix(),this.isMoving&&Math.random()<.02&&(console.log("🔗 Mesh Sync - Internal:",this.position.x.toFixed(2),this.position.z.toFixed(2)),console.log("🔗 Mesh Sync - Mesh:",this.mesh.position.x.toFixed(2),this.mesh.position.z.toFixed(2))),this.movementDirection){const e=Math.atan2(this.movementDirection.x,this.movementDirection.z),t=(new o).setFromAxisAngle(new i(0,1,0),e);this.mesh.quaternion.copy(t)}}else console.error("❌ Mesh is missing or not in scene!")}updateAnimations(e){this.mixer&&this.mixer.update(e)}updateStats(e){}startGathering(e){console.log(`Started gathering from ${e.name||"resource"}`)}moveToPosition(e){console.log("👤 Player.moveToPosition called with:",e);const t=this.scene.userData.gridManager;if(!t)return console.warn("❌ Grid manager not found, using direct movement"),void this.moveToPositionDirect(e);if(t.isWalkable(e))this.targetPosition=e.clone(),this.targetPosition.y=0,t.highlightCell(e),console.log(`👤 Moving to clicked position: ${this.targetPosition.x.toFixed(1)}, ${this.targetPosition.z.toFixed(1)}`);else{const i=t.findNearestWalkable(e),o=t.getCellAtWorld(i);if(!o||"walkable"!==o.state)return void console.warn("❌ No walkable cell found at target position");t.highlightCell(i),this.targetPosition=i.clone(),this.targetPosition.y=0,console.log(`👤 Moving to nearest walkable: ${this.targetPosition.x.toFixed(1)}, ${this.targetPosition.z.toFixed(1)}`)}this.isMoving=!0,this.showTargetIndicator(this.targetPosition),this.movementPath=[this.targetPosition.clone()],this.currentPathIndex=0,console.log("🗺️ Direct path to target")}moveToPositionDirect(e){this.targetPosition=new i(e.x,0,e.z),this.isMoving=!0,console.log(`👤 Moving to position: ${this.targetPosition.x}, ${this.targetPosition.z}`),this.showTargetIndicator(this.targetPosition)}showTargetIndicator(e){this.targetIndicator&&this.scene.remove(this.targetIndicator);const t=new p(.3,.5,16),i=new m({color:65280,transparent:!0,opacity:.7,side:g});this.targetIndicator=new a(t,i),this.targetIndicator.rotation.x=-Math.PI/2,this.targetIndicator.position.copy(e),this.targetIndicator.position.y=.1,this.scene.add(this.targetIndicator),setTimeout(()=>{this.targetIndicator&&(this.scene.remove(this.targetIndicator),this.targetIndicator=null)},3e3)}getPosition(){return this.position.clone()}getRotation(){return this.mesh.quaternion.clone()}getCameraRotation(){return this.cameraRotation.clone()}setCameraSpeed(e){this.rotationSpeed=.01*e}getStats(){return{...this.stats}}getEquipment(){return{...this.equipment}}takeDamage(e){return this.stats.health=Math.max(0,this.stats.health-e),this.stats.health<=0&&this.die(),this.stats.health}heal(e){return this.stats.health=Math.min(this.stats.maxHealth,this.stats.health+e),this.stats.health}addExperience(e){this.stats.experience+=e;const t=this.getExperienceForLevel(this.stats.level+1);return this.stats.experience>=t&&this.levelUp(),this.stats.experience}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUp(){this.stats.level++,this.stats.maxHealth+=10,this.stats.health=this.stats.maxHealth,console.log(`🎉 Level up! You are now level ${this.stats.level}`)}die(){console.log("💀 Player died!"),this.respawn()}respawn(){this.position.set(0,0,0),this.stats.health=this.stats.maxHealth,console.log("🔄 Player respawned")}equipItem(e,t){this.equipment[t]&&this.unequipItem(t),this.equipment[t]=e,"offhand"===t&&"torch"===e&&this.equipTorch(),console.log(`🔧 Equipped ${e} in ${t} slot`)}unequipItem(e){const t=this.equipment[e];t&&("offhand"===e&&"torch"===t&&this.unequipTorch(),this.equipment[e]=null,console.log(`🔧 Unequipped ${t} from ${e} slot`))}equipTorch(){const e=new y,t=new f(.05,.05,1.5,8),i=new s({color:9127187}),o=new a(t,i);o.position.y=.75,e.add(o);const n=new w(.08,.4,8),r=new m({color:16729344,transparent:!0,opacity:.8}),l=new a(n,r);l.position.y=1.6,e.add(l),e.position.set(0,0,.6),e.rotation.z=0,this.mesh.add(e),this.equipmentMeshes.offhand=e,this.equippedLight=new v(16739125,8,40,1),this.equippedLight.position.set(0,1.5,.6),this.equippedLight.isPlayerTorchLight=!0,this.mesh.add(this.equippedLight),console.log("🔥 Bright torch equipped and lit!")}unequipTorch(){this.equipmentMeshes.offhand&&(this.mesh.remove(this.equipmentMeshes.offhand),this.equipmentMeshes.offhand=null),this.equippedLight&&(this.mesh.remove(this.equippedLight),this.equippedLight=null),console.log("🔥 Torch unequipped and extinguished")}setCamera(e){this.camera=e,console.log("📷 Camera reference set for player")}updateEquipmentPositions(){this.equippedLight}destroy(){this.mesh&&this.scene.remove(this.mesh),this.mixer&&this.mixer.stopAllAction(),console.log("👤 Player destroyed")}}class U{constructor(e){this.scene=e,this.worldSize=1e3,this.terrain=null,this.pyramids=[],this.temples=[],this.sphinxes=[],this.obelisks=[],this.resourceNodes=[],this.decorations=[],this.camera=null,this.frameCount=0,this.frustum=new b,this.visibleObjects=new Set,this.lodLevels=new Map,this.uiManager=null,this.isInitialized=!1}async init(){this.isInitialized?console.warn("⚠️ WorldManager already initialized, skipping..."):(console.log("🌍 Initializing World Manager..."),this.createTerrain(),this.createEgyptianStructures(),this.createResourceNodes(),this.createDecorations(),this.createLighting(),this.protectImportantObjects(),this.isInitialized=!0,console.log("✅ World Manager initialized"))}createTerrain(){const e=new _(this.worldSize,this.worldSize,8,8),t=new s({color:9127187,side:g});this.terrain=new a(e,t),this.terrain.rotation.x=-Math.PI/2,this.terrain.receiveShadow=!0,this.terrain.castShadow=!1,this.terrain.userData.type="terrain",this.scene.add(this.terrain),this.addTerrainVariation()}addTerrainVariation(){const e=new _(this.worldSize,this.worldSize,6,6),t=new s({color:10506797,side:g,transparent:!0,opacity:.7}),i=new a(e,t);i.rotation.x=-Math.PI/2,i.position.y=.1,i.receiveShadow=!0,i.castShadow=!1;const o=i.geometry.attributes.position.array;for(let n=0;n<o.length;n+=3){const e=o[n],t=o[n+2],i=Math.sin(.02*e)*Math.cos(.02*t)*3+Math.sin(.05*e)*Math.cos(.05*t)*1.5+Math.sin(.1*e)*Math.cos(.1*t)*.5;o[n+1]=i}i.geometry.attributes.position.needsUpdate=!0,this.scene.add(i)}createEgyptianStructures(){this.createPyramids(),this.createTemples(),this.createSphinxes(),this.createObelisks()}createPyramids(){[{x:-100,z:-100,size:20},{x:100,z:-150,size:15},{x:-150,z:100,size:25}].forEach((e,t)=>{const i=this.createPyramid(e.size);i.position.set(e.x,0,e.z),i.userData.type="landmark",i.userData.name=`Pyramid ${t+1}`,this.scene.add(i),this.pyramids.push(i)})}createPyramid(e){const t=new w(e,1.5*e,4),i=new s({color:16032864,transparent:!0,opacity:.9}),o=new a(t,i);o.castShadow=!0,o.receiveShadow=!0;const n=new s({color:9139029,transparent:!0,opacity:.3}),r=new a(t,n);return r.scale.setScalar(.8),r.position.y=.1*e,o.add(r),o}createTemples(){[{x:50,z:50},{x:-80,z:80},{x:120,z:-80}].forEach((e,t)=>{const i=this.createTemple();i.position.set(e.x,0,e.z),i.userData.type="landmark",i.userData.name=`Temple ${t+1}`,this.scene.add(i),this.temples.push(i)})}createTemple(){const e=new y,t=new x(15,2,15),i=new s({color:13808780}),o=new a(t,i);o.position.y=1,o.castShadow=!0,o.receiveShadow=!0,e.add(o);const n=new x(10,8,10),r=new s({color:16032864}),l=new a(n,r);l.position.y=6,l.castShadow=!0,l.receiveShadow=!0,e.add(l);const d=new w(8,4,4),c=new s({color:9139029}),h=new a(d,c);h.position.y=12,h.castShadow=!0,h.receiveShadow=!0,e.add(h);for(let u=0;u<4;u++){const t=new f(.5,.5,6),i=new s({color:13808780}),o=new a(t,i),n=u/4*Math.PI*2;o.position.set(8*Math.cos(n),4,8*Math.sin(n)),o.castShadow=!0,o.receiveShadow=!0,e.add(o)}return e}createSphinxes(){[{x:0,z:-200},{x:200,z:0},{x:-200,z:0}].forEach((e,t)=>{const i=this.createSphinx();i.position.set(e.x,0,e.z),i.userData.type="landmark",i.userData.name=`Sphinx ${t+1}`,this.scene.add(i),this.sphinxes.push(i)})}createSphinx(){const e=new y,t=new x(8,4,12),i=new s({color:13808780}),o=new a(t,i);o.position.y=2,o.castShadow=!0,o.receiveShadow=!0,e.add(o);const n=new x(4,3,4),r=new s({color:13808780}),l=new a(n,r);l.position.set(0,5,-4),l.castShadow=!0,l.receiveShadow=!0,e.add(l);const d=new I(.3,8,8),c=new s({color:0}),h=new a(d,c);h.position.set(-.8,5.5,-1.5),e.add(h);const u=new a(d,c);return u.position.set(.8,5.5,-1.5),e.add(u),e}createObelisks(){[{x:30,z:30},{x:-30,z:-30},{x:30,z:-30},{x:-30,z:30}].forEach((e,t)=>{const i=this.createObelisk();i.position.set(e.x,0,e.z),i.userData.type="landmark",i.userData.name=`Obelisk ${t+1}`,this.scene.add(i),this.obelisks.push(i)})}createObelisk(){const e=new y,t=new x(2,1,2),i=new s({color:9139029}),o=new a(t,i);o.position.y=.5,o.castShadow=!0,o.receiveShadow=!0,e.add(o);const n=new x(1,15,1),r=new s({color:13808780}),l=new a(n,r);l.position.y=8.5,l.castShadow=!0,l.receiveShadow=!0,e.add(l);const d=new w(.8,2,4),c=new s({color:16766720}),h=new a(d,c);return h.position.y=16,h.castShadow=!0,h.receiveShadow=!0,e.add(h),e}createResourceNodes(){[{type:"mining",name:"Copper Mine",color:13467442,position:{x:-50,z:-50}},{type:"mining",name:"Iron Mine",color:6908265,position:{x:50,z:-50}},{type:"woodcutting",name:"Palm Grove",color:2263842,position:{x:-50,z:50}},{type:"herbalism",name:"Herb Garden",color:3329330,position:{x:50,z:50}},{type:"fishing",name:"Oasis",color:52945,position:{x:0,z:-100}}].forEach((e,t)=>{const i=this.createResourceNode(e);i.position.set(e.position.x,0,e.position.z),i.userData.type="resource_node",i.userData.resourceType=e.type,i.userData.name=e.name,this.scene.add(i),this.resourceNodes[t]=i})}createResourceNode(e){let t,i;switch(e.type){case"mining":t=new w(3,6,8),i=new s({color:e.color});break;case"woodcutting":t=new f(2,3,8),i=new s({color:e.color});break;case"herbalism":t=new I(2,8,8),i=new s({color:e.color});break;case"fishing":t=new f(5,5,1),i=new s({color:e.color,transparent:!0,opacity:.6});break;default:t=new x(3,3,3),i=new s({color:e.color})}const o=new a(t,i);return o.position.y=t.parameters.height/2,o.castShadow=!0,o.receiveShadow=!0,o}createDecorations(){console.log("🏠 Creating world decorations..."),this.createPalmTrees(),this.createRocks(),this.createSandDunes(),this.createMedievalHouse(),console.log("✅ World decorations created")}createMedievalHouse(){console.log("🏠 Creating detailed medieval house...");const e=new y,t=new i(15,0,15);e.position.copy(t),this.createHouseStructure(e),this.createHouseInterior(e),this.createHouseFurniture(e),this.createHouseDecorations(e),this.scene.add(e),this.decorations.push(e),console.log("✅ Medieval house created at position:",t)}createHouseStructure(e){const t=new x(16,2,12),i=new s({color:6908265}),o=new a(t,i);o.position.y=1,o.castShadow=!0,o.receiveShadow=!0,e.add(o);const n=new x(15,6,11),r=new s({color:9127187}),l=new a(n,r);l.position.y=5,l.castShadow=!0,l.receiveShadow=!0,e.add(l);const d=new w(10,4,8),c=new s({color:6636321}),h=new a(d,c);h.position.y=11,h.castShadow=!0,h.receiveShadow=!0,e.add(h);const u=new x(3,5,.5),p=new s({color:6636321}),m=new a(u,p);m.position.set(0,2.5,5.8),e.add(m);const g=new x(2.6,4.6,.2),y=new s({color:9127187}),f=new a(g,y);f.position.set(0,2.3,6.2),e.add(f);const v=new x(2,2,.2),b=new s({color:8900331,transparent:!0,opacity:.7}),_=new a(v,b);_.position.set(-4,4,5.8),e.add(_);const I=new a(v,b);I.position.set(4,4,5.8),e.add(I);const S=new a(v,b);S.position.set(-3,4,-5.8),S.rotation.y=Math.PI,e.add(S);const M=new a(v,b);M.position.set(3,4,-5.8),M.rotation.y=Math.PI,e.add(M);const k=new x(1.5,4,1.5),E=new s({color:6908265}),A=new a(k,E);A.position.set(5,12,0),A.castShadow=!0,A.receiveShadow=!0,e.add(A)}createHouseInterior(e){const t=new x(14,.4,10),i=new s({color:9127187}),o=new a(t,i);o.position.set(0,.2,0),o.receiveShadow=!0,e.add(o);const n=new s({color:13808780}),r=new x(.4,5.6,10),l=new a(r,n);l.position.set(0,2.8,0),l.receiveShadow=!0,e.add(l);const d=new x(.4,5.6,10),c=new a(d,n);c.position.set(-4,2.8,0),c.receiveShadow=!0,e.add(c);const h=new x(.4,5.6,10),u=new a(h,n);u.position.set(4,2.8,0),u.receiveShadow=!0,e.add(u);const p=new x(14,5.6,.4),m=new a(p,n);m.position.set(0,2.8,-5),m.receiveShadow=!0,e.add(m);const g=new x(14,5.6,.4),y=new a(g,n);y.position.set(0,2.8,5),y.receiveShadow=!0,e.add(y)}createHouseFurniture(e){const t=new x(5,.6,3.6),i=new s({color:9127187}),o=new a(t,i);o.position.set(-5,.3,-3),o.castShadow=!0,o.receiveShadow=!0,e.add(o);const n=new x(4.6,.4,3.2),r=new s({color:14596231}),l=new a(n,r);l.position.set(-5,.7,-3),e.add(l);const d=new x(1.6,.2,1.2),c=new s({color:16119260}),h=new a(d,c);h.position.set(-5,1.1,-4.4),e.add(h);const u=new a(d,c);u.position.set(-5,1.1,-3.2),e.add(u);const p=new x(4,.2,2.4),m=new s({color:9127187}),g=new a(p,m);g.position.set(5,1.6,0),g.castShadow=!0,g.receiveShadow=!0,e.add(g);const y=new x(.2,1.6,.2),f=new s({color:6636321});for(let s=0;s<4;s++){const t=new a(y,f),i=5+(s%2==0?-1.8:1.8),o=s<2?-1:1;t.position.set(i,.8,o),e.add(t)}const w=new x(1.2,.2,1.2),b=new x(1.2,1.6,.2);[{x:5,z:2.5,rotation:0},{x:5,z:-2.5,rotation:Math.PI},{x:7.5,z:0,rotation:Math.PI/2},{x:2.5,z:0,rotation:-Math.PI/2}].forEach(t=>{const i=new a(w,m);i.position.set(t.x,.8,t.z),e.add(i);const o=new a(b,m);o.position.set(t.x,1.6,t.z+(0===t.rotation?.6:-.6)),o.rotation.y=t.rotation,e.add(o)});const _=new x(3,2.4,1.6),I=new s({color:6908265}),S=new a(_,I);S.position.set(0,1.2,-4.4),S.castShadow=!0,S.receiveShadow=!0,e.add(S);const M=new x(2,1.6,.6),k=new s({color:16729344,emissive:16729344,emissiveIntensity:.3}),E=new a(M,k);E.position.set(0,.8,-5.2),e.add(E);const A=new v(16739125,1,6);A.position.set(0,.8,-5.2),e.add(A);const T=new a(t,i);T.position.set(5,.3,-3),T.castShadow=!0,T.receiveShadow=!0,e.add(T);const C=new a(n,r);C.position.set(5,.7,-3),e.add(C);const L=new a(d,c);L.position.set(5,1.1,-4.4),e.add(L);const P=new a(d,c);P.position.set(5,1.1,-3.2),e.add(P)}createHouseDecorations(e){const t=new _(3,2),i=new s({color:9109504}),o=new a(t,i);o.position.set(0,4,-4.8),o.rotation.y=Math.PI,e.add(o);const n=new f(.1,.1,.6),r=new s({color:16119260}),l=new a(n,r);l.position.set(5,1.9,0),e.add(l);const d=new I(.16),c=new s({color:16766720,emissive:16766720,emissiveIntensity:.5}),h=new a(d,c);h.position.set(5,2.3,0),e.add(h);const u=new v(16766720,.6,4);u.position.set(5,2.3,0),e.add(u);const p=new x(.6,.1,.4),m=new s({color:9127187});for(let s=0;s<5;s++){const t=new a(p,m);t.position.set(5+.3*(s-2),1.95,.4),t.rotation.z=.2*Math.random()-.1,e.add(t)}const g=new _(6,4),y=new s({color:9109504}),w=new a(g,y);w.position.set(0,.22,0),w.rotation.x=-Math.PI/2,e.add(w);const b=new x(1.5,1,1),S=new s({color:9127187}),M=new a(b,S);M.position.set(-5,.5,3),M.castShadow=!0,M.receiveShadow=!0,e.add(M);const k=new f(.2,.2,2),E=new s({color:6908265}),A=new a(k,E);A.position.set(5,1,3),e.add(A);const T=new I(.3),C=new s({color:6908265}),L=new a(T,C);L.position.set(5,2.2,3),e.add(L)}createPalmTrees(){[{x:-20,z:-20},{x:20,z:-20},{x:-20,z:20},{x:20,z:20}].forEach(e=>{const t=this.createPalmTree();t.position.set(e.x,0,e.z),this.scene.add(t),this.decorations.push(t)})}createPalmTree(){const e=new y,t=new f(.4,.6,8,8),i=new s({color:9127187,roughness:.8}),o=new a(t,i);o.position.y=4,o.castShadow=!0,o.receiveShadow=!0,o.scale.set(1,1,1),e.add(o);const n=[2263842,3329330,25600];[{height:7.5,radius:1.5,count:8},{height:6.8,radius:1.2,count:6},{height:6.1,radius:.9,count:4}].forEach(t=>{for(let i=0;i<t.count;i++){const o=this.createSimplePalmFrond(),s=i/t.count*Math.PI*2;o.position.set(Math.cos(s)*t.radius,t.height,Math.sin(s)*t.radius),o.rotation.y=s,o.rotation.x=.15*Math.PI,o.rotation.z=.4*(Math.random()-.5);const a=Math.floor(Math.random()*n.length);o.children.forEach(e=>{e.material&&e.material.color.setHex(n[a])}),e.add(o)}});const r=new I(.1,6,6),l=new s({color:9127187});for(let s=0;s<6;s++){const t=new a(r,l),i=s/6*Math.PI*2,o=.6;t.position.set(Math.cos(i)*o,6.8,Math.sin(i)*o),e.add(t)}return e}createSimplePalmFrond(){const e=new y,t=new f(.02,.05,3,6),i=new s({color:2263842}),o=new a(t,i);o.position.y=1.5,e.add(o);for(let n=0;n<4;n++){const t=new _(.8,.3,1,1),i=new s({color:2263842,side:g}),o=new a(t,i);o.position.y=n/4*2.5,o.position.x=n/4*.2,o.rotation.z=n/4*.3,e.add(o)}return e}createRocks(){const e=new S(1.5),t=new s({color:6908265}),o=new M(e,t,20);o.castShadow=!0,o.receiveShadow=!0;for(let n=0;n<20;n++){const e=new k,t=(Math.random()-.5)*this.worldSize,s=(Math.random()-.5)*this.worldSize,a=1.5;e.setPosition(t,a,s),e.scale(new i(.5*Math.random()+.75,.5*Math.random()+.75,.5*Math.random()+.75)),o.setMatrixAt(n,e)}this.scene.add(o),this.decorations.push(o)}createRock(){const e=new S(2*Math.random()+1),t=new s({color:6908265}),i=new a(e,t);return i.position.y=e.parameters.radius,i.castShadow=!0,i.receiveShadow=!0,i.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),i}createSandDunes(){for(let e=0;e<10;e++){const e=this.createSandDune(),t=(Math.random()-.5)*this.worldSize,i=(Math.random()-.5)*this.worldSize;e.position.set(t,0,i),this.scene.add(e),this.decorations.push(e)}}createSandDune(){const e=new w(8,4,8),t=new s({color:16032864,transparent:!0,opacity:.8}),i=new a(e,t);return i.position.y=2,i.castShadow=!0,i.receiveShadow=!0,i.rotation.y=Math.random()*Math.PI*2,i}createLighting(){this.dayNightCycle={time:0,cycleSpeed:1e-4,sun:null,moon:null,ambientLight:null,directionalLight:null,stars:[]},this.dayNightCycle.ambientLight=new E(4210752,.4),this.scene.add(this.dayNightCycle.ambientLight),this.dayNightCycle.directionalLight=new A(16777215,1),this.dayNightCycle.directionalLight.position.set(50,100,50),this.dayNightCycle.directionalLight.castShadow=!0,this.dayNightCycle.directionalLight.shadow.mapSize.width=2048,this.dayNightCycle.directionalLight.shadow.mapSize.height=2048,this.dayNightCycle.directionalLight.shadow.camera.near=.1,this.dayNightCycle.directionalLight.shadow.camera.far=300,this.dayNightCycle.directionalLight.shadow.camera.left=-100,this.dayNightCycle.directionalLight.shadow.camera.right=100,this.dayNightCycle.directionalLight.shadow.camera.top=100,this.dayNightCycle.directionalLight.shadow.camera.bottom=-100,this.dayNightCycle.directionalLight.shadow.bias=-1e-4,this.dayNightCycle.directionalLight.shadow.normalBias=.02,this.dayNightCycle.directionalLight.shadow.radius=2,this.dayNightCycle.directionalLight.shadow.camera.updateProjectionMatrix(),this.dayNightCycle.directionalLight.shadow.autoUpdate=!0,this.scene.add(this.dayNightCycle.directionalLight);const e=new I(10,16,16),t=new m({color:16766720});this.dayNightCycle.sun=new a(e,t),this.dayNightCycle.sun.castShadow=!1,this.dayNightCycle.sun.receiveShadow=!1,this.scene.add(this.dayNightCycle.sun);const i=new I(8,16,16),o=new m({color:15132410});this.dayNightCycle.moon=new a(i,o),this.dayNightCycle.moon.castShadow=!1,this.dayNightCycle.moon.receiveShadow=!1,this.scene.add(this.dayNightCycle.moon),this.createSkyGradient(),this.createStars(),this.createTorch(),this.dayNightCycle.time=.35,this.updateDayNightCycle()}createSkyGradient(){const e=new I(500,32,32),t=new T({uniforms:{time:{value:0},topColor:{value:new L(8900331)},bottomColor:{value:new L(14743295)},offset:{value:33},exponent:{value:.6}},vertexShader:"\n                varying vec3 vWorldPosition;\n                void main() {\n                    vec4 worldPosition = modelMatrix * vec4(position, 1.0);\n                    vWorldPosition = worldPosition.xyz;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                uniform vec3 topColor;\n                uniform vec3 bottomColor;\n                uniform float offset;\n                uniform float exponent;\n                varying vec3 vWorldPosition;\n                void main() {\n                    float h = normalize(vWorldPosition + offset).y;\n                    gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);\n                }\n            ",side:C});this.skyDome=new a(e,t),this.scene.add(this.skyDome)}updateDayNightCycle(){const e=this.dayNightCycle.time,t=e*Math.PI*2,i=(e+.5)*Math.PI*2,o=300*Math.sin(t)+400,n=800*Math.cos(t);this.dayNightCycle.sun.position.set(n,o,0),this.dayNightCycle.directionalLight&&this.camera&&Math.random()<.02&&console.log(`🌞 Sun visual at: (${n.toFixed(1)}, ${o.toFixed(1)}) | Time: ${(24*e).toFixed(1)}h | Light intensity: ${this.dayNightCycle.directionalLight.intensity.toFixed(1)}`);const s=200*Math.sin(i)+300,a=600*Math.cos(i);this.dayNightCycle.moon.position.set(a,s,0),e>.25&&e<.75?(this.dayNightCycle.directionalLight.intensity=2,this.dayNightCycle.ambientLight.intensity=.8,this.updateSkyColors(8900331,14743295,16777215)):(this.dayNightCycle.directionalLight.intensity=1.5,this.dayNightCycle.ambientLight.intensity=.3,this.updateSkyColors(726054,1710638,1450302)),this.dayNightCycle.sun.visible=e>.25&&e<.75,this.dayNightCycle.moon.visible=e<=.25||e>=.75,e>.4&&e<.6?this.dayNightCycle.sun.material.color.setHex(16777215):e>.25&&e<.4?this.dayNightCycle.sun.material.color.setHex(16766720):e>.6&&e<.75&&this.dayNightCycle.sun.material.color.setHex(16739125)}updateSkyColors(e,t,i){this.skyDome&&this.skyDome.material.uniforms&&(this.skyDome.material.uniforms.topColor.value.setHex(e),this.skyDome.material.uniforms.bottomColor.value.setHex(t))}createStars(){const e=new I(.5,8,8),t=new m({color:16777215});for(let i=0;i<50;i++){const i=new a(e,t),o=Math.acos(2*Math.random()-1),n=Math.sqrt(1-Math.pow(2*Math.random()-1,2))*(2*Math.PI),s=400+100*Math.random();i.position.set(s*Math.sin(o)*Math.cos(n),s*Math.cos(o),s*Math.sin(o)*Math.sin(n)),i.material.opacity=.5+.5*Math.random(),i.material.transparent=!0,this.dayNightCycle.stars.push(i),this.scene.add(i)}}createTorch(){this.torch=new y;const e=new f(.1,.1,2,8),t=new s({color:9127187}),i=new a(e,t);i.position.y=1,i.castShadow=!0,i.receiveShadow=!0,this.torch.add(i);const o=new w(.3,.5,8),n=new s({color:6636321}),r=new a(o,n);r.position.y=2.25,r.castShadow=!0,r.receiveShadow=!0,this.torch.add(r);const l=new w(.2,.8,8),d=new m({color:16729344,transparent:!0,opacity:.8});this.flame=new a(l,d),this.flame.position.y=2.6,this.flame.castShadow=!1,this.flame.receiveShadow=!1,this.torch.add(this.flame),this.torchLight=new v(16739125,1.5,15,2),this.torchLight.position.set(0,2.5,0),this.torchLight.castShadow=!0,this.torchLight.shadow.mapSize.width=512,this.torchLight.shadow.mapSize.height=512,this.torchLight.shadow.camera.near=.1,this.torchLight.shadow.camera.far=20,this.torchLight.shadow.camera.fov=90,this.torchLight.shadow.bias=-.001,this.torchLight.shadow.radius=1,this.torch.add(this.torchLight),this.torch.position.set(60,0,60),this.torch.rotation.y=Math.PI/4,this.scene.add(this.torch),this.torchElements={flame:this.flame,light:this.torchLight},console.log("🔥 Torch created and placed in the world")}updateStarsVisibility(){const e=this.dayNightCycle.time,t=e<=.25||e>=.75;this.dayNightCycle.stars.forEach(e=>{if(e.visible=t,t){const t=.3*Math.sin(.001*Date.now()+.01*e.position.x)+.7;e.material.opacity=t}})}update(e){if(this.updateDayNightCycleProgress(e),this.updateDecorations(e),this.camera){if(this.frameCount||(this.frameCount=0),this.frameCount++,this.frameCount%10==0&&(this.updateFrustum(),this.updateObjectVisibility(),this.updateLOD(this.camera.position)),this.frameCount%5==0&&this.ensureCloseObjectsVisible(),this.updateShadowCamera(),this.frameCount%300==0){const e=this.dayNightCycle.directionalLight.shadow.camera;console.log(`📷 Shadow Camera - Pos: (${e.position.x.toFixed(1)}, ${e.position.y.toFixed(1)}, ${e.position.z.toFixed(1)}) | Looking at: (${this.dayNightCycle.directionalLight.target.position.x.toFixed(1)}, ${this.dayNightCycle.directionalLight.target.position.y.toFixed(1)}, ${this.dayNightCycle.directionalLight.target.position.z.toFixed(1)})`)}this.frameCount%60==0&&(console.log(`🌍 World update - Time: ${(24*this.dayNightCycle.time).toFixed(1)}h | Camera set: ${!!this.camera} | Light: ${!!this.dayNightCycle.directionalLight}`),this.frameCount%600==0&&this.debugLights(),1===this.frameCount&&this.checkForDefaultLights(),this.frameCount%1800==0&&this.monitorObjectHealth(),this.frameCount%720==0&&this.debugObjectVisibility(),this.frameCount%3600==0&&this.validateWorldIntegrity())}else this.frameCount&&this.frameCount%120!=0||console.log("🌍 World update - Camera not set in WorldManager")}updateDayNightCycleProgress(e){this.dayNightCycle.time+=this.dayNightCycle.cycleSpeed*e*60,this.dayNightCycle.time>=1&&(this.dayNightCycle.time=0),this.updateDayNightCycle(),this.updateAtmosphericEffects(),this.uiManager&&this.uiManager.updateTimeDisplay(this.dayNightCycle.time)}updateAtmosphericEffects(){const e=this.dayNightCycle.time;e>.2&&e<.3||e>.7&&e<.8?(this.scene.fog||(this.scene.fog=new P(15132410,100,300)),this.scene.fog.color.setHex(15132410)):e>.25&&e<.75?this.scene.fog&&(this.scene.fog=null):(this.scene.fog||(this.scene.fog=new P(726054,50,200)),this.scene.fog.color.setHex(726054)),this.updateTerrainColors(e),this.updateStarsVisibility()}updateShadowCamera(){if(!this.dayNightCycle.directionalLight||!this.camera)return;const e=this.camera.position,t=this.dayNightCycle.time,i=t*Math.PI*2,o=200*Math.cos(i),n=100*Math.sin(i)+100,s=e.x+o,a=e.z,r=n;this.dayNightCycle.directionalLight.position.set(s,r,a);const l=e.x-o,d=e.z;this.dayNightCycle.directionalLight.target.position.set(l,0,d),this.dayNightCycle.directionalLight.target.updateMatrixWorld(!0),this.dayNightCycle.directionalLight.shadow.needsUpdate=!0,this.frameCount%600==0&&(console.log(`🌞 PROPER Shadow System - Sun at (${o.toFixed(1)}, ${n.toFixed(1)}) | Time: ${(24*t).toFixed(1)}h`),console.log(`🔍 Light pos: (${s.toFixed(1)}, ${r.toFixed(1)}, ${a.toFixed(1)}) | Target: (${l.toFixed(1)}, 0, ${d.toFixed(1)})`))}updateTerrainColors(e){if(this.terrain){const t=this.terrain.material;e>.25&&e<.75?t.color.setHex(9127187):e>.4&&e<.6?t.color.setHex(13808780):e>.25&&e<.4||e>.6&&e<.75?t.color.setHex(13468991):t.color.setHex(6636321)}}updateDecorations(e){this.updateTorchAnimation(e)}updateTorchAnimation(e){if(!this.torchElements)return;const t=.003*Date.now(),i=.1*Math.sin(8*t)+.05*Math.sin(15*t)+.95;this.torchElements.flame.scale.setScalar(i),this.torchElements.flame.rotation.z=.1*Math.sin(3*t);const o=.2*Math.sin(6*t)+.1*Math.sin(12*t)+.9;this.torchElements.light.intensity=1.5*o;const n=.1*Math.sin(4*t);this.torchElements.light.color.setRGB(1,.42+n,.21+.5*n)}getWorldSize(){return this.worldSize}getChunkSize(){return this.chunkSize}getResourceNodes(){return Array.from(this.resourceNodes.values())}getLandmarks(){return[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks]}destroy(){this.scene.remove(this.terrain),this.buildings.forEach(e=>{this.scene.remove(e)}),this.resourceNodes.forEach(e=>{this.scene.remove(e)}),this.npcs.forEach(e=>{this.scene.remove(e)}),this.decorations.forEach(e=>{this.scene.remove(e)}),this.pyramids.forEach(e=>{this.scene.remove(e)}),this.temples.forEach(e=>{this.scene.remove(e)}),this.sphinxes.forEach(e=>{this.scene.remove(e)}),this.obelisks.forEach(e=>{this.scene.remove(e)}),this.torch&&this.scene.remove(this.torch),console.log("🌍 World Manager destroyed")}setCamera(e){console.log("🌍 Camera set in WorldManager:",e?"YES":"NO"),this.camera=e,this.updateFrustum(),console.log("🔍 Checking all lights after camera set:"),this.debugLights()}updateFrustum(){this.camera&&this.frustum.setFromProjectionMatrix((new k).multiplyMatrices(this.camera.projectionMatrix,this.camera.matrixWorldInverse))}isObjectVisible(e){return!this.frustum||!e.geometry||(e.geometry.boundingSphere||e.geometry.computeBoundingSphere(),this.frustum.intersectsSphere(e.geometry.boundingSphere))}updateObjectVisibility(){this.camera&&this.optimizeObjectVisibility()}updateStructureVisibility(e){e.forEach(e=>{e&&(e.visible=!0,this.visibleObjects.add(e))})}updateLOD(e){this.pyramids.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)}),this.temples.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)}),this.sphinxes.forEach(t=>{const i=e.distanceTo(t.position);this.applyLOD(t,i)})}applyLOD(e,t){t>300?e.geometry&&e.geometry.attributes.position.count>200&&e.geometry.setDrawRange(0,200):t>150?e.geometry&&e.geometry.attributes.position.count>300&&e.geometry.setDrawRange(0,300):e.geometry&&e.geometry.setDrawRange(0,e.geometry.attributes.position.count)}setShadowDistance(e){if(this.camera){const t=this.camera.position;this.pyramids.forEach(i=>{const o=t.distanceTo(i.position);i.castShadow=o<e,i.receiveShadow=o<e}),this.temples.forEach(i=>{const o=t.distanceTo(i.position);i.castShadow=o<e,i.receiveShadow=o<e}),this.sphinxes.forEach(i=>{const o=t.distanceTo(i.position);i.castShadow=o<e,i.receiveShadow=o<e}),this.obelisks.forEach(i=>{const o=t.distanceTo(i.position);i.castShadow=o<e,i.receiveShadow=o<e})}}checkForDefaultLights(){if(console.log("🔍 Checking for default Three.js lights..."),this.scene.children.length>0){let e=!1;this.scene.children.forEach((t,i)=>{t.isLight&&t!==this.dayNightCycle.directionalLight&&t!==this.dayNightCycle.ambientLight&&(console.log(`⚠️ Found default light at index ${i}:`,t.type),e=!0,console.log(`🔧 Removing default light: ${t.type}`),this.scene.remove(t))}),e||console.log("✅ No default lights found")}}setUIManager(e){this.uiManager=e}debugLights(){console.log("🔍 Debugging all lights in scene:");let e=0;this.scene.traverse(t=>{t.isLight&&(e++,console.log(`  Light ${e}: ${t.type} at (${t.position.x.toFixed(1)}, ${t.position.y.toFixed(1)}, ${t.position.z.toFixed(1)})`),console.log(`    - Intensity: ${t.intensity}`),console.log(`    - Casts shadows: ${t.castShadow}`),console.log(`    - Name: ${t.name||"unnamed"}`),t===this.dayNightCycle.directionalLight?console.log("    - ✅ This is the day/night cycle light"):t===this.dayNightCycle.ambientLight?console.log("    - ✅ This is the day/night cycle ambient light"):t.isPlayerTorchLight?console.log("    - 🔥 This is the player's equipped torch light"):console.log("    - ℹ️ Additional light source"))}),console.log(`Total lights found: ${e}`)}cleanupUnusedResources(){console.log("🌍 Starting WorldManager resource cleanup...");const e=this.pyramids.length,t=this.temples.length,i=this.sphinxes.length,o=this.obelisks.length,n=this.resourceNodes.length,s=this.decorations.length;this.cleanupCorruptedObjects(),this.optimizeObjectVisibility(),console.log("🌍 Cleanup completed:"),console.log(`  - Pyramids: ${e} → ${this.pyramids.length}`),console.log(`  - Temples: ${t} → ${this.temples.length}`),console.log(`  - Sphinxes: ${i} → ${this.sphinxes.length}`),console.log(`  - Obelisks: ${o} → ${this.obelisks.length}`),console.log(`  - Resources: ${n} → ${this.resourceNodes.length}`),console.log(`  - Decorations: ${s} → ${this.decorations.length}`)}cleanupCorruptedObjects(){const e=[];this.pyramids.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted pyramid detected, removing:",t),e.push({object:t,type:"pyramid",index:i}))}),this.temples.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted temple detected, removing:",t),e.push({object:t,type:"temple",index:i}))}),this.sphinxes.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted sphinx detected, removing:",t),e.push({object:t,type:"sphinx",index:i}))}),this.obelisks.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted obelisk detected, removing:",t),e.push({object:t,type:"obelisk",index:i}))}),this.resourceNodes.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted resource node detected, removing:",t),e.push({object:t,type:"resource",index:i}))}),this.decorations.forEach((t,i)=>{this.isObjectCorrupted(t)&&(console.warn("⚠️ Corrupted decoration detected, removing:",t),e.push({object:t,type:"decoration",index:i}))}),e.forEach(({object:e,type:t,index:i})=>{this.removeObjectSafely(e,t,i)}),e.length>0&&console.log(`🔧 Removed ${e.length} corrupted objects`)}isObjectCorrupted(e){return!(e&&e.isObject3D&&(!e.position||!(isNaN(e.position.x)||isNaN(e.position.y)||isNaN(e.position.z))&&isFinite(e.position.x)&&isFinite(e.position.y)&&isFinite(e.position.z))&&(!e.geometry||e.geometry.attributes)&&(!e.material||e.material.isMaterial)&&(!e.position||!(Math.abs(e.position.x)>2*this.worldSize||Math.abs(e.position.z)>2*this.worldSize||e.position.y<-100||e.position.y>1e3)))}optimizeObjectVisibility(){if(!this.camera)return;const e=this.camera.position,t=300,i=200,o=50;this.pyramids.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)}),this.temples.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)}),this.sphinxes.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)}),this.obelisks.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)}),this.resourceNodes.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)}),this.decorations.forEach(n=>{const s=e.distanceTo(n.position);if(n.visible=!0,s<=o)n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count);else if(s>i){if(n.geometry&&n.geometry.attributes.position){const e=s>t?.5:.8;n.geometry.setDrawRange(0,Math.floor(n.geometry.attributes.position.count*e))}}else n.geometry&&n.geometry.attributes.position&&n.geometry.setDrawRange(0,n.geometry.attributes.position.count)})}validateWorldIntegrity(){console.log("🌍 Starting world integrity validation...");let e=0,t=0,i=0;return[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks,...this.resourceNodes,...this.decorations].forEach((o,n)=>{e++,this.isObjectCorrupted(o)?(i++,console.warn(`⚠️ Invalid object at index ${n}:`,o)):t++}),this.scene&&this.scene.traverse(o=>{o&&o.isObject3D&&o!==this.terrain&&(e++,this.isObjectCorrupted(o)?(i++,console.warn("⚠️ Invalid scene object:",o)):t++)}),console.log(`🌍 World integrity check: ${t} valid, ${i} invalid out of ${e} total objects`),i>0&&(console.warn(`⚠️ ${i} invalid objects detected - running cleanup...`),this.cleanupCorruptedObjects()),{total:e,valid:t,invalid:i}}debugObjectVisibility(){if(!this.camera)return;const e=this.camera.position;console.log("🔍 Debugging object visibility near camera:",e.toArray().map(e=>e.toFixed(1)));let t=0,i=0;return this.pyramids.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden pyramid at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),this.temples.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden temple at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),this.sphinxes.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden sphinx at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),this.obelisks.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden obelisk at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),this.resourceNodes.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden resource at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),this.decorations.forEach((o,n)=>{const s=e.distanceTo(o.position);o.visible?i++:(t++,console.warn(`⚠️ Hidden decoration at index ${n}, distance: ${s.toFixed(1)}`),o.visible=!0)}),t>0?console.warn(`🔧 Fixed ${t} hidden objects, ${i} were already visible`):console.log(`✅ All objects are visible (${i} total)`),{hidden:t,visible:i}}forceAllObjectsVisible(){console.log("🔧 Force making all objects visible..."),this.pyramids.forEach(e=>e.visible=!0),this.temples.forEach(e=>e.visible=!0),this.sphinxes.forEach(e=>e.visible=!0),this.obelisks.forEach(e=>e.visible=!0),this.resourceNodes.forEach(e=>e.visible=!0),this.decorations.forEach(e=>e.visible=!0),console.log("✅ All objects forced to visible")}protectImportantObjects(){this.terrain&&(this.terrain.userData.protected=!0,this.terrain.userData.critical=!0),this.dayNightCycle&&(this.dayNightCycle.ambientLight&&(this.dayNightCycle.ambientLight.userData.protected=!0,this.dayNightCycle.ambientLight.userData.critical=!0),this.dayNightCycle.directionalLight&&(this.dayNightCycle.directionalLight.userData.protected=!0,this.dayNightCycle.directionalLight.userData.critical=!0)),this.torchLight&&(this.torchLight.userData.protected=!0,this.torchLight.userData.critical=!0)}removeObjectSafely(e,t,i){if(e.userData&&e.userData.protected)return console.warn(`⚠️ Attempted to remove protected ${t}, skipping:`,e),!1;try{switch(this.scene&&e.parent&&this.scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()),t){case"pyramid":this.pyramids.splice(i,1);break;case"temple":this.temples.splice(i,1);break;case"sphinx":this.sphinxes.splice(i,1);break;case"obelisk":this.obelisks.splice(i,1);break;case"resource":this.resourceNodes.splice(i,1);break;case"decoration":this.decorations.splice(i,1)}return console.log(`✅ Successfully removed corrupted ${t} at index ${i}`),!0}catch(o){return console.error(`❌ Error removing corrupted ${t}:`,o),!1}}monitorObjectHealth(){const e=.1*this.worldSize,t=new i(0,0,0),o=[];return this.pyramids.forEach((i,n)=>{i.position.distanceTo(t)>e&&o.push({object:i,type:"pyramid",index:n,distance:i.position.distanceTo(t)})}),this.temples.forEach((i,n)=>{i.position.distanceTo(t)>e&&o.push({object:i,type:"temple",index:n,distance:i.position.distanceTo(t)})}),this.sphinxes.forEach((i,n)=>{i.position.distanceTo(t)>e&&o.push({object:i,type:"sphinx",index:n,distance:i.position.distanceTo(t)})}),this.obelisks.forEach((i,n)=>{i.position.distanceTo(t)>e&&o.push({object:i,type:"obelisk",index:n,distance:i.position.distanceTo(t)})}),o.length>0&&(console.warn(`⚠️ ${o.length} objects have drifted too far from center:`),o.forEach(({type:e,index:t,distance:i})=>{console.warn(`  - ${e} at index ${t}: ${i.toFixed(1)} units from center`)})),o}restoreDriftedObjects(){this.monitorObjectHealth().forEach(({object:e,type:t,index:i})=>{const o=this.getRestoredPosition(e,t);o&&(e.position.copy(o),console.log(`✅ Restored ${t} at index ${i} to position:`,o))})}getRestoredPosition(e,t){const o=this.worldSize/2;switch(t){case"pyramid":return new i((Math.random()-.5)*o*.8,0,(Math.random()-.5)*o*.8);case"temple":return new i((Math.random()-.5)*o*.6,0,(Math.random()-.5)*o*.6);case"sphinx":return new i((Math.random()-.5)*o*.7,0,(Math.random()-.5)*o*.7);case"obelisk":return new i((Math.random()-.5)*o*.5,0,(Math.random()-.5)*o*.5);default:return new i((Math.random()-.5)*o*.4,0,(Math.random()-.5)*o*.4)}}ensureCloseObjectsVisible(){if(!this.camera)return;const e=this.camera.position,t=[...this.pyramids,...this.temples,...this.sphinxes,...this.obelisks,...this.resourceNodes,...this.decorations];let i=0;t.forEach(t=>{t&&t.position&&e.distanceTo(t.position)<=100&&(t.visible=!0,i++,t.geometry&&t.geometry.attributes.position&&t.geometry.setDrawRange(0,t.geometry.attributes.position.count))}),i>0&&this.frameCount%300==0&&console.log(`🔒 Safety check: Ensuring ${i} objects within 100m are visible`)}}class W{constructor(e,t=1e3,i=2){this.scene=e,this.worldSize=t,this.gridSize=i,this.gridCells=new Map,this.visibleCells=new Set,this.highlightedCell=null,this.gridMesh=null,this.cellsX=Math.ceil(t/i),this.cellsZ=Math.ceil(t/i),this.totalCells=this.cellsX*this.cellsZ,this.cellStates={EMPTY:"empty",WALKABLE:"walkable",OBSTACLE:"obstacle",WATER:"water",BUILDING:"building"},console.log(`🗺️ Grid Manager initialized: ${this.cellsX}x${this.cellsZ} cells (${this.totalCells} total) - ${i}x${i} units each`)}init(){console.log("🗺️ Initializing Grid Manager..."),this.createGrid(),this.initializeCellStates(),this.createGridVisualization(),console.log("✅ Grid Manager initialized")}createGrid(){for(let e=0;e<this.cellsX;e++)for(let t=0;t<this.cellsZ;t++){const o=this.getCellKey(e,t),n=e*this.gridSize-this.worldSize/2+this.gridSize/2,s=t*this.gridSize-this.worldSize/2+this.gridSize/2;this.gridCells.set(o,{x:e,z:t,worldX:n,worldZ:s,center:new i(n,0,s),state:this.cellStates.WALKABLE,occupied:!1,height:0,objects:[]})}}initializeCellStates(){this.gridCells.forEach((e,t)=>{0!==e.x&&e.x!==this.cellsX-1&&0!==e.z&&e.z!==this.cellsZ-1||(e.state=this.cellStates.OBSTACLE);const i=this.cellsX/2,o=this.cellsZ/2;Math.sqrt(Math.pow(e.x-i,2)+Math.pow(e.z-o,2))<20&&(e.state=this.cellStates.WALKABLE)})}createGridVisualization(){this.gridMesh=new y,this.scene.add(this.gridMesh),this.createGridLines(),this.gridMesh.visible=!1,console.log("🗺️ Grid visualization created (hidden by default - press G to show)")}createGridLines(){const e=new z({color:4473924,transparent:!0,opacity:.1});for(let t=0;t<=this.cellsX;t++){const o=t*this.gridSize-this.worldSize/2,n=(new $).setFromPoints([new i(o,0,-this.worldSize/2),new i(o,0,this.worldSize/2)]),s=new q(n,e);this.gridMesh.add(s)}for(let t=0;t<=this.cellsZ;t++){const o=t*this.gridSize-this.worldSize/2,n=(new $).setFromPoints([new i(-this.worldSize/2,0,o),new i(this.worldSize/2,0,o)]),s=new q(n,e);this.gridMesh.add(s)}}worldToGrid(e){return{x:Math.floor((e.x+this.worldSize/2)/this.gridSize),z:Math.floor((e.z+this.worldSize/2)/this.gridSize)}}gridToWorld(e,t){const o=e*this.gridSize-this.worldSize/2+this.gridSize/2,n=t*this.gridSize-this.worldSize/2+this.gridSize/2;return new i(o,0,n)}getCellKey(e,t){return`${e},${t}`}getCellAtWorld(e){const t=this.worldToGrid(e),i=this.getCellKey(t.x,t.z);return this.gridCells.get(i)}getCellAtGrid(e,t){const i=this.getCellKey(e,t);return this.gridCells.get(i)}isWalkable(e){const t=this.getCellAtWorld(e);return t&&t.state===this.cellStates.WALKABLE&&!t.occupied}findNearestWalkable(e){const t=this.worldToGrid(e);for(let i=0;i<=10;i++)for(let e=-i;e<=i;e++)for(let o=-i;o<=i;o++)if(Math.abs(e)===i||Math.abs(o)===i){const i=t.x+e,n=t.z+o;if(i>=0&&i<this.cellsX&&n>=0&&n<this.cellsZ){const e=this.getCellAtGrid(i,n);if(e&&e.state===this.cellStates.WALKABLE&&!e.occupied)return e.center.clone()}}return e.clone()}highlightCell(e){this.clearHighlight();const t=this.getCellAtWorld(e);if(!t||t.state!==this.cellStates.WALKABLE)return!1;const i=new _(.9*this.gridSize,.9*this.gridSize),o=new m({color:65280,transparent:!0,opacity:.3,side:g});return this.highlightedCell=new a(i,o),this.highlightedCell.rotation.x=-Math.PI/2,this.highlightedCell.position.copy(t.center),this.highlightedCell.position.y=.1,this.scene.add(this.highlightedCell),!0}clearHighlight(){this.highlightedCell&&(this.scene.remove(this.highlightedCell),this.highlightedCell=null)}getPathToTarget(e,t){return this.worldToGrid(e),this.worldToGrid(e),[t.clone()]}toggleGrid(){this.gridMesh&&(this.gridMesh.visible=!this.gridMesh.visible,console.log("🗺️ Grid visibility toggled:",this.gridMesh.visible))}setGridVisible(e){this.gridMesh&&(this.gridMesh.visible=e,console.log("🗺️ Grid visibility set to:",e))}update(){}destroy(){this.clearHighlight(),this.gridMesh&&(this.scene.remove(this.gridMesh),this.gridMesh=null),this.gridCells.clear(),this.visibleCells.clear()}}class K{constructor(){this.keys=new Set,this.mousePosition={x:0,y:0},this.mouseButtons=new Set,this.touchEvents=[],this.isInitialized=!1,this.isMouseDown=!1,this.isTouchActive=!1,this.touchStartPosition={x:0,y:0},this.mouseSensitivity=1,this.mouseDelta={x:0,y:0},this.onKeyDown=null,this.onKeyUp=null,this.onMouseClick=null,this.onMouseMove=null,this.onTouchStart=null,this.onTouchMove=null,this.onTouchEnd=null}init(){this.isInitialized?console.warn("⚠️ InputManager already initialized, skipping..."):(this.setupKeyboardEvents(),this.setupMouseEvents(),this.setupTouchEvents(),console.log("🎮 Input Manager initialized"),this.isInitialized=!0)}setupKeyboardEvents(){document.addEventListener("keydown",e=>{if(e.repeat)return;const t=e.code||e.key;this.keys.add(t),this.onKeyDown&&this.onKeyDown(t),this.isGameKey(t)&&e.preventDefault()}),document.addEventListener("keyup",e=>{const t=e.code||e.key;this.keys.delete(t),this.onKeyUp&&this.onKeyUp(t)})}setupMouseEvents(){const e=document.getElementById("game-canvas");e&&(e.addEventListener("click",t=>{const i=e.getBoundingClientRect(),o=(t.clientX-i.left)/i.width*2-1,n=-(t.clientY-i.top)/i.height*2+1;this.mousePosition={x:o,y:n},this.onMouseClick&&this.onMouseClick(t,{x:o,y:n})}),e.addEventListener("mousemove",t=>{const i=e.getBoundingClientRect(),o=(t.clientX-i.left)/i.width*2-1,n=-(t.clientY-i.top)/i.height*2+1;this.mousePosition={x:o,y:n},this.onMouseMove&&this.onMouseMove(t,{x:o,y:n})}),e.addEventListener("mousedown",e=>{this.isMouseDown=!0}),e.addEventListener("mouseup",()=>{this.isMouseDown=!1}),e.addEventListener("contextmenu",e=>{e.preventDefault()}))}setupTouchEvents(){const e=document.getElementById("game-canvas");e&&(e.addEventListener("touchstart",e=>{if(e.preventDefault(),this.isTouchActive=!0,1===e.touches.length){const t=e.touches[0];this.touchStartPosition.x=t.clientX,this.touchStartPosition.y=t.clientY}}),e.addEventListener("touchmove",e=>{e.preventDefault()}),e.addEventListener("touchend",e=>{e.preventDefault(),this.isTouchActive=!1}))}isKeyPressed(e){return this.keys.has(e)}isAnyKeyPressed(){return this.keys.size>0}getMousePosition(){return{...this.mousePosition}}getMovementInput(){const e={x:0,z:0};if((this.isKeyPressed("KeyW")||this.isKeyPressed("ArrowUp"))&&(e.z=-1),(this.isKeyPressed("KeyS")||this.isKeyPressed("ArrowDown"))&&(e.z=1),(this.isKeyPressed("KeyA")||this.isKeyPressed("ArrowLeft"))&&(e.x=-1),(this.isKeyPressed("KeyD")||this.isKeyPressed("ArrowRight"))&&(e.x=1),0!==e.x&&0!==e.z){const t=Math.sqrt(e.x*e.x+e.z*e.z);e.x/=t,e.z/=t}return e}getActionInput(){return{jump:this.isKeyPressed("Space"),sprint:this.isKeyPressed("ShiftLeft"),interact:this.isKeyPressed("KeyE"),inventory:this.isKeyPressed("KeyI"),crafting:this.isKeyPressed("KeyC"),map:this.isKeyPressed("KeyM"),skills:this.isKeyPressed("KeyK")}}setOnKeyDown(e){this.onKeyDown=e}setOnKeyUp(e){this.onKeyUp=e}setOnMouseMove(e){this.onMouseMove=e}setOnMouseClick(e){this.onMouseClick=e}isGameKey(e){return["KeyW","KeyA","KeyS","KeyD","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Space","ShiftLeft","KeyE","KeyI","KeyC","KeyM","KeyK"].includes(e)}update(){}reset(){this.keys.clear(),this.mouseDelta.x=0,this.mouseDelta.y=0,this.isMouseDown=!1}setMouseSensitivity(e){this.mouseSensitivity=e,console.log(`🖱️ Mouse sensitivity updated to: ${e}`)}exitPointerLock(){}destroy(){this.exitPointerLock(),this.reset(),console.log("🎮 Input Manager destroyed")}}class X{constructor(){this.recipes=new Map,this.isInitialized=!1,this.playerSkills={smithing:1,crafting:1,cooking:1,alchemy:1},this.playerExperience={smithing:0,crafting:0,alchemy:0,woodworking:0}}async init(){this.isInitialized?console.warn("⚠️ CraftingSystem already initialized, skipping..."):(console.log("⚒️ Initializing Crafting System..."),this.loadRecipes(),this.isInitialized=!0,console.log("✅ Crafting System initialized"))}loadRecipes(){this.addRecipe("bronze_sword",{name:"Bronze Sword",type:"weapon",skill:"smithing",level:1,experience:25,materials:[{id:"bronze_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:5e3}),this.addRecipe("iron_sword",{name:"Iron Sword",type:"weapon",skill:"smithing",level:5,experience:50,materials:[{id:"iron_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:8e3}),this.addRecipe("steel_sword",{name:"Steel Sword",type:"weapon",skill:"smithing",level:10,experience:100,materials:[{id:"steel_ingot",quantity:2},{id:"wood",quantity:1}],tools:["hammer"],time:12e3}),this.addRecipe("leather_armor",{name:"Leather Armor",type:"armor",skill:"crafting",level:1,experience:20,materials:[{id:"leather",quantity:3},{id:"thread",quantity:2}],tools:["needle"],time:4e3}),this.addRecipe("bronze_armor",{name:"Bronze Armor",type:"armor",skill:"smithing",level:5,experience:45,materials:[{id:"bronze_ingot",quantity:4},{id:"leather",quantity:2}],tools:["hammer"],time:1e4}),this.addRecipe("bronze_pickaxe",{name:"Bronze Pickaxe",type:"tool",skill:"smithing",level:1,experience:30,materials:[{id:"bronze_ingot",quantity:1},{id:"wood",quantity:2}],tools:["hammer"],time:6e3}),this.addRecipe("iron_pickaxe",{name:"Iron Pickaxe",type:"tool",skill:"smithing",level:5,experience:60,materials:[{id:"iron_ingot",quantity:1},{id:"wood",quantity:2}],tools:["hammer"],time:9e3}),this.addRecipe("health_potion",{name:"Health Potion",type:"potion",skill:"alchemy",level:1,experience:15,materials:[{id:"herbs",quantity:2},{id:"water",quantity:1}],tools:["mortar"],time:3e3}),this.addRecipe("strength_potion",{name:"Strength Potion",type:"potion",skill:"alchemy",level:5,experience:35,materials:[{id:"herbs",quantity:3},{id:"water",quantity:1},{id:"crystal",quantity:1}],tools:["mortar"],time:6e3}),this.addRecipe("wooden_shield",{name:"Wooden Shield",type:"armor",skill:"woodworking",level:1,experience:25,materials:[{id:"wood",quantity:4},{id:"leather",quantity:1}],tools:["chisel"],time:5e3})}addRecipe(e,t){this.recipes.set(e,t)}getRecipe(e){return this.recipes.get(e)}getAllRecipes(){return Array.from(this.recipes.values())}getRecipesBySkill(e){return Array.from(this.recipes.values()).filter(t=>t.skill===e)}getRecipesByLevel(e,t){return this.getRecipesBySkill(e).filter(e=>e.level<=t)}canCraftItem(e,t,i){const o=this.getRecipe(e);if(!o)return!1;if(this.playerSkills[o.skill]<o.level)return{canCraft:!1,reason:`Requires ${o.skill} level ${o.level}`};for(const n of o.materials){const e=this.getMaterialQuantity(t,n.id);if(e<n.quantity)return{canCraft:!1,reason:`Need ${n.quantity} ${n.id}, have ${e}`}}for(const n of o.tools)if(!this.hasTool(i,n))return{canCraft:!1,reason:`Need ${n} tool`};return{canCraft:!0}}craftItem(e,t,i){const o=this.canCraftItem(e,t,i);if(!o.canCraft)return console.log(`Cannot craft ${e}: ${o.reason}`),!1;const n=this.getRecipe(e);for(const a of n.materials)this.consumeMaterial(t,a.id,a.quantity);this.addExperience(n.skill,n.experience);const s=this.createItem(e,n);return console.log(`Successfully crafted ${s.name}!`),console.log(`Gained ${n.experience} ${n.skill} experience`),s}createItem(e,t){return{id:e,name:t.name,type:t.type,skill:t.skill,level:t.level,quality:this.calculateQuality(t.skill),durability:this.calculateDurability(t.skill),stats:this.calculateStats(t)}}calculateQuality(e){const t=.1*(this.playerSkills[e]-1);return Math.min(1+t,2)}calculateDurability(e){return 100+10*(this.playerSkills[e]-1)}calculateStats(e){const t={},i=this.calculateQuality(e.skill);switch(e.type){case"weapon":t.damage=Math.floor(5*e.level*i),t.speed=Math.max(1-.05*e.level,.5);break;case"armor":t.defense=Math.floor(3*e.level*i),t.weight=.5*e.level;break;case"tool":t.efficiency=Math.floor(2*e.level*i),t.durability=this.calculateDurability(e.skill);break;case"potion":t.power=Math.floor(2*e.level*i),t.duration=30*e.level}return t}addExperience(e,t){this.playerExperience[e]+=t;const i=this.playerSkills[e],o=this.getExperienceForLevel(i+1);this.playerExperience[e]>=o&&this.levelUpSkill(e)}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUpSkill(e){return this.playerSkills[e]++,console.log(`🎉 ${e} leveled up to ${this.playerSkills[e]}!`),this.playerSkills[e]}getMaterialQuantity(e,t){return{bronze_ingot:5,iron_ingot:3,steel_ingot:1,wood:10,leather:8,thread:15,herbs:20,water:50,crystal:2}[t]||0}consumeMaterial(e,t,i){console.log(`Consumed ${i} ${t}`)}hasTool(e,t){return["hammer","needle","mortar","chisel"].includes(t)}getPlayerSkills(){return{...this.playerSkills}}getPlayerExperience(){return{...this.playerExperience}}getSkillLevel(e){return this.playerSkills[e]||0}getSkillExperience(e){return this.playerExperience[e]||0}getNextLevelProgress(e){const t=this.playerSkills[e],i=this.playerExperience[e],o=this.getExperienceForLevel(t),n=(i-o)/(this.getExperienceForLevel(t+1)-o);return Math.max(0,Math.min(1,n))}getSkillInfo(e){return{level:this.playerSkills[e],experience:this.playerExperience[e],nextLevelExp:this.getExperienceForLevel(this.playerSkills[e]+1),progress:this.getNextLevelProgress(e)}}}class Y{constructor(){this.inventory={slots:[],gold:100,level:1,experience:0},this.equipment={head:null,chest:null,legs:null,feet:null,weapon:null,offhand:null,accessory:null},this.itemDatabase=new Map,this.maxSlots=64,this.slots=new Array(this.maxSlots).fill(null),this.isInitialized=!1}async init(){this.isInitialized?console.warn("⚠️ InventorySystem already initialized, skipping..."):(console.log("🎒 Initializing Inventory System..."),console.log("📚 Loading item database..."),this.loadItemDatabase(),console.log(`📚 Item database loaded with ${this.itemDatabase.size} items`),console.log("📦 Adding starting items..."),this.addStartingItems(),this.isInitialized=!0,console.log("✅ Inventory System initialized"))}loadItemDatabase(){console.log("📚 Starting to load item database..."),this.addItemToDatabase("bronze_ingot",{name:"Bronze Ingot",type:"material",description:"A refined bronze ingot for crafting",stackable:!0,maxStack:100,value:5,rarity:"common"}),console.log("📚 Added bronze_ingot to database"),this.addItemToDatabase("iron_ingot",{name:"Iron Ingot",type:"material",description:"A refined iron ingot for crafting",stackable:!0,maxStack:100,value:10,rarity:"common"}),console.log("📚 Added iron_ingot to database"),this.addItemToDatabase("steel_ingot",{name:"Steel Ingot",type:"material",description:"A refined steel ingot for crafting",stackable:!0,maxStack:100,value:25,rarity:"uncommon"}),console.log("📚 Added steel_ingot to database"),this.addItemToDatabase("wood",{name:"Wood",type:"material",description:"Basic wood for crafting",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("📚 Added wood to database"),this.addItemToDatabase("leather",{name:"Leather",type:"material",description:"Tanned leather for crafting",stackable:!0,maxStack:100,value:3,rarity:"common"}),console.log("📚 Added leather to database"),this.addItemToDatabase("thread",{name:"Thread",type:"material",description:"Strong thread for sewing",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("📚 Added thread to database"),this.addItemToDatabase("herbs",{name:"Herbs",type:"material",description:"Medicinal herbs for alchemy",stackable:!0,maxStack:100,value:2,rarity:"common"}),console.log("📚 Added herbs to database"),this.addItemToDatabase("water",{name:"Water",type:"material",description:"Pure water for alchemy",stackable:!0,maxStack:100,value:1,rarity:"common"}),console.log("📚 Added water to database"),this.addItemToDatabase("crystal",{name:"Crystal",type:"material",description:"Magical crystal for alchemy",stackable:!0,maxStack:50,value:15,rarity:"uncommon"}),console.log("📚 Added crystal to database"),this.addItemToDatabase("bronze_sword",{name:"Bronze Sword",type:"weapon",description:"A basic bronze sword",stackable:!1,value:50,rarity:"common",stats:{damage:5,speed:1},requirements:{level:1,strength:5}}),this.addItemToDatabase("iron_sword",{name:"Iron Sword",type:"weapon",description:"A sturdy iron sword",stackable:!1,value:120,rarity:"uncommon",stats:{damage:8,speed:.9},requirements:{level:5,strength:8}}),this.addItemToDatabase("leather_armor",{name:"Leather Armor",type:"armor",description:"Basic leather protection",stackable:!1,value:80,rarity:"common",stats:{defense:3,weight:.5},requirements:{level:1,agility:3}}),this.addItemToDatabase("hammer",{name:"Hammer",type:"tool",description:"Basic crafting hammer",stackable:!1,value:20,rarity:"common",stats:{efficiency:1,durability:100}}),this.addItemToDatabase("needle",{name:"Needle",type:"tool",description:"Sewing needle for crafting",stackable:!1,value:5,rarity:"common",stats:{efficiency:1,durability:50}}),this.addItemToDatabase("mortar",{name:"Mortar",type:"tool",description:"Mortar for alchemy",stackable:!1,value:15,rarity:"common",stats:{efficiency:1,durability:100}}),this.addItemToDatabase("chisel",{name:"Chisel",type:"tool",description:"Woodworking chisel",stackable:!1,value:12,rarity:"common",stats:{efficiency:1,durability:80}}),this.addItemToDatabase("torch",{name:"Torch",type:"light",description:"A wooden torch that provides light in darkness",stackable:!1,value:15,rarity:"common",stats:{lightRadius:15,lightIntensity:1.5,durability:100},requirements:{level:1},equipmentSlot:"offhand"})}addItemToDatabase(e,t){console.log(`📚 Adding item to database: ${e}`),this.itemDatabase.set(e,{id:e,...t}),console.log(`📚 Item ${e} added to database. Current size: ${this.itemDatabase.size}`)}addStartingItems(){console.log("🎒 Adding starting items to inventory..."),console.log("📦 Adding bronze_ingot x5..."),this.addItem("bronze_ingot",5),console.log("📦 Adding wood x10..."),this.addItem("wood",10),console.log("📦 Adding leather x3..."),this.addItem("leather",3),console.log("📦 Adding thread x5..."),this.addItem("thread",5),console.log("📦 Adding herbs x8..."),this.addItem("herbs",8),console.log("📦 Adding water x20..."),this.addItem("water",20),console.log("📦 Adding hammer..."),this.addItem("hammer"),console.log("📦 Adding needle..."),this.addItem("needle"),console.log("📦 Adding mortar..."),this.addItem("mortar"),console.log("📦 Adding chisel..."),this.addItem("chisel"),console.log("📦 Adding torch..."),this.addItem("torch"),console.log("🎒 Starting items added. Current inventory:",this.getInventory())}addItem(e,t=1){console.log(`🎒 Adding item: ${e} x${t}`);const i=this.itemDatabase.get(e);if(!i)return console.warn(`❌ Item ${e} not found in database`),!1;let o=!1;return o=i.stackable?this.addStackableItem(e,t):this.addNonStackableItem(e),o?(console.log(`✅ Successfully added ${e} x${t}`),console.log("🎒 Current inventory state:",this.getInventory())):console.warn(`❌ Failed to add ${e} x${t}`),o}addStackableItem(e,t){for(let i=0;i<this.maxSlots;i++)if(this.slots[i]&&this.slots[i].id===e){const o=this.itemDatabase.get(e).maxStack-this.slots[i].quantity;if(o>0){const e=Math.min(t,o);if(this.slots[i].quantity+=e,(t-=e)<=0)return this.updateInventoryUI(),!0}}for(;t>0;){const i=this.findEmptySlot();if(-1===i)return console.warn("Inventory full!"),!1;const o=this.itemDatabase.get(e),n=Math.min(t,o.maxStack);this.slots[i]={id:e,quantity:n,quality:1,durability:o.stats?.durability||100},t-=n}return this.updateInventoryUI(),!0}addNonStackableItem(e){const t=this.findEmptySlot();if(-1===t)return console.warn("Inventory full!"),!1;const i=this.itemDatabase.get(e);return this.slots[t]={id:e,quantity:1,quality:1,durability:i.stats?.durability||100},this.updateInventoryUI(),!0}findEmptySlot(){for(let e=0;e<this.maxSlots;e++)if(!this.slots[e])return e;return-1}removeItem(e,t=1){if(e<0||e>=this.maxSlots)return!1;const i=this.slots[e];return!!i&&(i.quantity<=t?this.slots[e]=null:i.quantity-=t,this.updateInventoryUI(),!0)}findItemSlot(e){return this.slots.findIndex(t=>t&&t.id===e)}getItemQuantity(e){let t=0;for(const i of this.slots)i&&i.id===e&&(t+=i.quantity);return t}hasItem(e,t=1){return this.getItemQuantity(e)>=t}equipItem(e){const t=this.slots[e];if(!t)return!1;const i=this.itemDatabase.get(t.id);if(!i)return!1;if("light"===i.type&&"torch"===i.id)return this.equipTorch(e);if("weapon"!==i.type&&"armor"!==i.type)return console.warn("Cannot equip non-equipment item"),!1;if(!this.meetsRequirements(i.requirements))return console.warn("Requirements not met for equipping item"),!1;let o=null;return"weapon"===i.type?o="weapon":"armor"===i.type&&(o="chest"),!!o&&(this.equipment[o]&&this.unequipItem(o),this.equipment[o]={...t,slotIndex:e},this.removeItem(e),console.log(`Equipped ${i.name}`),this.updateInventoryUI(),!0)}equipTorch(e){const t=this.slots[e];return!(!t||"torch"!==t.id||(this.equipment.offhand&&this.unequipItem("offhand"),this.equipment.offhand={...t,slotIndex:e},this.removeItem(e),console.log("🔥 Torch equipped!"),this.updateInventoryUI(),0))}unequipItem(e){const t=this.equipment[e];return!!t&&(this.addItem(t.id,t.quantity),this.equipment[e]=null,console.log(`Unequipped ${t.id}`),this.updateInventoryUI(),!0)}meetsRequirements(e){return!e||!(e.level&&this.level<e.level)}addGold(e){return this.gold+=e,this.updateInventoryUI(),this.gold}removeGold(e){return this.gold>=e&&(this.gold-=e,this.updateInventoryUI(),!0)}addExperience(e){this.experience+=e;const t=this.getExperienceForLevel(this.level+1);return this.experience>=t&&this.levelUp(),this.updateInventoryUI(),this.experience}getExperienceForLevel(e){return Math.floor(100*Math.pow(1.5,e-1))}levelUp(){this.level++,console.log(`🎉 Level up! You are now level ${this.level}`),this.addGold(10*this.level)}updateInventoryUI(){console.log("Inventory updated:",{slots:this.slots.filter(e=>null!==e).length,gold:this.gold,level:this.level,experience:this.experience})}getInventory(){return[...this.slots]}getEquipment(){return{...this.equipment}}getGold(){return this.gold}getLevel(){return this.level}getExperience(){return this.experience}getItemData(e){return this.itemDatabase.get(e)}equipItem(e,t){const i=this.itemDatabase.get(e);return i?i.equipmentSlot&&i.equipmentSlot!==t?(console.warn(`Item ${e} cannot be equipped in ${t} slot`),!1):(this.equipment[t]&&this.unequipItem(t),this.equipment[t]={id:e,...i},console.log(`🔧 Equipped ${i.name} in ${t} slot`),this.updateInventoryUI(),!0):(console.warn(`Item ${e} not found in database`),!1)}unequipItem(e){if(!this.equipment[e])return!1;const t=this.equipment[e];return console.log(`🔧 Unequipped ${t.name} from ${e} slot`),this.addItem(t.id),this.equipment[e]=null,this.updateInventoryUI(),!0}isEquipped(e){for(const[t,i]of Object.entries(this.equipment))if(i&&i.id===e)return t;return!1}getInventoryValue(){let e=0;for(const t of this.slots)if(t){const i=this.itemDatabase.get(t.id);i&&(e+=i.value*t.quantity)}return e}getInventoryWeight(){let e=0;for(const t of this.slots)if(t){const i=this.itemDatabase.get(t.id);i&&i.stats&&i.stats.weight&&(e+=i.stats.weight*t.quantity)}return e}destroy(){this.slots=null,this.equipment=null,this.itemDatabase=null,console.log("🎒 Inventory System destroyed")}}class Z{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.player=null,this.worldManager=null,this.gridManager=null,this.inputManager=null,this.craftingSystem=null,this.inventorySystem=null,this.networkManager=null,this.audioManager=null,this.uiManager=null,this.optionsManager=null,this.clickIndicator=null,this.cameraOrbitAngle=0,this.cameraOrbitSpeed=.02,this.cameraOrbitDistance=10,this.cameraOrbitHeight=5,this.cameraOffsetX=0,this.cameraOffsetZ=10,this.cameraOffsetY=5,this.players=new Map,this.entities=[],this.lastCameraPosition=null,this.fps=0,this.frameCount=0,this.lastTime=0,this.isRunning=!1,this.isInitialized=!1,this.clock=new D,this.animate=this.animate.bind(this),this.handleResize=this.handleResize.bind(this)}async init(){this.isInitialized?console.warn("⚠️ GameEngine already initialized, skipping..."):(console.log("🎮 Initializing Game Engine..."),this.initScene(),this.worldManager=new U(this.scene),this.gridManager=new W(this.scene,1e3,2),this.inputManager=new K,this.craftingSystem=new X,this.inventorySystem=new Y,this.inputManager.init(),await this.inventorySystem.init(),this.gridManager.init(),await this.worldManager.init(),this.setupCamera(),this.player=new t(this.scene,null),await this.player.init(),this.player.setCamera(this.camera),this.setupLighting(),this.setupInputHandlers(),this.setupDebugControls(),this.isInitialized=!0,console.log("✅ Game Engine initialized"),this.monitorViewport())}initScene(){this.scene=new O,this.scene.fog=new P(1710638,50,200),this.renderer=new N({canvas:document.getElementById("game-canvas"),antialias:!0,alpha:!1,powerPreference:"high-performance",stencil:!1,depth:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=R,this.renderer.shadowMap.autoUpdate=!0,this.renderer.outputColorSpace=F,this.renderer.toneMapping=B,this.renderer.toneMappingExposure=1.2,this.renderer.sortObjects=!1,this.renderer.info.autoReset=!1,this.renderer.setClearColor(1710638)}setupCamera(){this.camera=new H(75,window.innerWidth/window.innerHeight,.1,1e3),this.camera.position.set(0,5,10),this.camera.lookAt(0,0,0),this.worldManager&&this.worldManager.setCamera(this.camera),this.player&&this.player.setCamera(this.camera),this.scene&&this.gridManager&&(this.scene.userData.gridManager=this.gridManager)}setupLighting(){console.log("🔧 Lighting setup skipped - handled by WorldManager")}setupInputHandlers(){this.inputManager.onMouseClick=(e,t)=>{console.log("🎯 Mouse click detected:",t),this.handleMouseClick(t)},this.inputManager.onKeyDown=e=>{this.handleKeyDown(e)},this.inputManager.onKeyUp=e=>{this.handleKeyUp(e)}}handleMouseClick(e){console.log("🎯 Processing mouse click:",e);const t=this.getWorldPositionFromMouse(e);if(t)if(console.log("🎯 World position from mouse:",t),this.showClickIndicator(t),this.gridManager&&this.gridManager.isWalkable(t))console.log("✅ Position is walkable, moving player"),this.player.moveToPosition(t);else{console.log("❌ Position is not walkable, finding nearest walkable cell");const e=this.gridManager.findNearestWalkable(t);this.player.moveToPosition(e)}else console.log("❌ Could not convert mouse to world position")}showClickIndicator(e){this.clickIndicator&&this.scene.remove(this.clickIndicator);const t=new I(.5,8,6),i=new m({color:16711680,transparent:!0,opacity:.8});this.clickIndicator=new a(t,i),this.clickIndicator.position.copy(e),this.clickIndicator.position.y=.5,this.scene.add(this.clickIndicator),setTimeout(()=>{this.clickIndicator&&(this.scene.remove(this.clickIndicator),this.clickIndicator=null)},2e3)}getWorldPositionFromMouse(e){const t=new V;t.setFromCamera(e,this.camera);const o=new G(new i(0,1,0),0),n=new i;if(t.ray.intersectPlane(o,n))return console.log("🎯 Ground intersection found:",n),n;const s=t.intersectObjects(this.scene.children,!0);if(s.length>0){const e=s[0];return console.log("🎯 Object intersection found:",e.point),e.point}return null}handleObjectInteraction(e){"crafting_station"===e.userData.type&&this.uiManager.showCraftingPanel(),"resource_node"===e.userData.type&&this.player.startGathering(e),"npc"===e.userData.type&&this.uiManager.showNPCDialog(e.userData.npcId)}start(){this.isRunning||(this.isRunning=!0,this.clock.start(),this.gameLoop(),console.log("🎮 Game loop started"))}stop(){this.isRunning=!1,this.clock.stop()}pause(){this.isPaused=!0}resume(){this.isPaused=!1}gameLoop(){if(!this.isRunning)return;if(requestAnimationFrame(()=>this.gameLoop()),this.isPaused)return;const e=this.clock.getDelta(),t=this.clock.getElapsedTime();this.player&&(this.player.update(e),this.updateCamera()),this.players.forEach((t,i)=>{t.update(e)}),this.entities.forEach(t=>{t.update(e)}),this.worldManager&&(!this.worldManager.camera&&this.camera&&this.worldManager.setCamera(this.camera),this.worldManager.update(e)),this.shouldRender()&&(this.renderer.render(this.scene,this.camera),this.renderer.shadowMap.enabled&&!1===this.renderer.shadowMap.autoUpdate&&(this.renderer.shadowMap.autoUpdate=!0,this.renderer.shadowMap.autoUpdate=!1)),this.updatePerformanceMetrics(t),this.frameCount++}shouldRender(){return this.lastCameraPosition?this.camera.position.distanceTo(this.lastCameraPosition)>.1?(this.lastCameraPosition.copy(this.camera.position),!0):this.frameCount%3==0:(this.lastCameraPosition=this.camera.position.clone(),!0)}setGraphicsQuality(e){if(this.renderer)try{switch(e){case"low":this.renderer.setPixelRatio(1),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!1),this.renderer.antialias=!1;break;case"medium":this.renderer.setPixelRatio(1.2),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!1;break;case"high":this.renderer.setPixelRatio(1.5),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!0;break;case"ultra":this.renderer.setPixelRatio(2),this.renderer.shadowMap&&(this.renderer.shadowMap.enabled=!0),this.renderer.antialias=!0;break;default:return void console.warn(`🔧 Unknown graphics quality: ${e}`)}console.log(`🔧 Graphics quality set to: ${e}`)}catch(t){console.error("🔧 Error setting graphics quality:",t)}else console.warn("🔧 Renderer not available, skipping graphics quality change")}setRenderDistance(e){if(this.camera)try{const t=parseInt(e);this.camera.far=t,this.camera.updateProjectionMatrix(),this.scene.fog?this.scene.fog.far=.8*t:(this.scene.fog=new P(1710638,50,.8*t),console.log("🔧 Created fog for render distance")),console.log(`🔧 Render distance set to: ${e}`)}catch(t){console.error("🔧 Error setting render distance:",t)}else console.warn("🔧 Camera not available, skipping render distance change")}setShadowQuality(e){if(this.renderer&&this.renderer.shadowMap)try{switch(this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.mapSize||(console.log("🔧 Creating shadow map size property"),this.renderer.shadowMap.mapSize={width:1024,height:1024}),e){case"off":return this.renderer.shadowMap.enabled=!1,this.disableAllLightShadows(),void console.log("🔧 Shadows disabled on renderer and all lights");case"low":this.renderer.shadowMap.mapSize.width=512,this.renderer.shadowMap.mapSize.height=512,this.enableAllLightShadows();break;case"medium":this.renderer.shadowMap.mapSize.width=1024,this.renderer.shadowMap.mapSize.height=1024,this.enableAllLightShadows();break;case"high":this.renderer.shadowMap.mapSize.width=2048,this.renderer.shadowMap.mapSize.height=2048,this.enableAllLightShadows();break;default:return void console.warn(`🔧 Unknown shadow quality: ${e}`)}this.renderer.shadowMap.needsUpdate=!0,console.log(`🔧 Shadow quality set to: ${e}`)}catch(t){console.error("🔧 Error setting shadow quality:",t)}else console.warn("🔧 Shadow map not available, skipping shadow quality change")}disableAllLightShadows(){this.scene&&this.scene.traverse(e=>{e.isLight&&(e.castShadow=!1,console.log(`🔧 Disabled shadow casting on light: ${e.type}`))})}enableAllLightShadows(){this.scene&&this.scene.traverse(e=>{e.isLight&&"DirectionalLight"===e.type&&(e.castShadow=!0,console.log(`🔧 Enabled shadow casting on light: ${e.type}`))})}setAntiAliasing(e){if(this.renderer)try{this.renderer.antialias=e,console.log("🔧 Anti-aliasing "+(e?"enabled":"disabled"))}catch(t){console.error("🔧 Error setting anti-aliasing:",t)}else console.warn("🔧 Renderer not available, skipping anti-aliasing change")}setParticleEffects(e){this.particleEffectsEnabled=e,console.log("🔧 Particle effects "+(e?"enabled":"disabled"))}setVSync(e){this.vsyncEnabled=e,console.log(`🔧 V-Sync preference set to: ${e}`)}setFPSLimit(e){"unlimited"===e?this.fpsLimit=null:(this.fpsLimit=parseInt(e),this.frameInterval=1e3/this.fpsLimit),console.log(`🔧 FPS limit set to: ${e}`)}isRendererReady(){return this.renderer&&this.camera&&this.scene}async waitForRenderer(){let e=0;for(;!this.isRendererReady()&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;return this.isRendererReady()?(console.log("🔧 Renderer is ready for settings changes"),!0):(console.warn("🔧 Renderer not ready after waiting, some settings may not apply"),!1)}debugShadows(){if(!this.renderer)return void console.log("🔍 No renderer available");if(console.log("🔍 Shadow Debug Info:"),console.log("  - Shadow Map Enabled:",this.renderer.shadowMap.enabled),console.log("  - Shadow Map Size:",this.renderer.shadowMap.mapSize?.width,"x",this.renderer.shadowMap.mapSize?.height),console.log("  - Shadow Map Type:",this.renderer.shadowMap.type),console.log("  - Shadow Map Auto Update:",this.renderer.shadowMap.autoUpdate),console.log("  - Shadow Map Needs Update:",this.renderer.shadowMap.needsUpdate),this.worldManager&&this.worldManager.dayNightCycle){const e=this.worldManager.dayNightCycle.directionalLight;e&&(console.log("  - Directional Light Casts Shadows:",e.castShadow),console.log("  - Shadow Camera Near:",e.shadow.camera.near),console.log("  - Shadow Camera Far:",e.shadow.camera.far),console.log("  - Shadow Camera Bounds:",{left:e.shadow.camera.left,right:e.shadow.camera.right,top:e.shadow.camera.top,bottom:e.shadow.camera.bottom}))}let e=0;this.scene.traverse(t=>{t.castShadow&&e++}),console.log("  - Objects casting shadows:",e);let t=0;this.scene.traverse(e=>{e.isLight&&t++}),console.log("  - Total lights in scene:",t),console.log("  - Light Details:"),this.scene.traverse(e=>{e.isLight&&(console.log(`    ${e.type}: ${e.name||"unnamed"} at (${e.position.x.toFixed(1)}, ${e.position.y.toFixed(1)}, ${e.position.z.toFixed(1)})`),e.castShadow&&console.log(`      Casts shadows: ${e.castShadow}`))})}debugMemory(){if(!this.renderer)return void console.log("🔍 No renderer available");const e=this.renderer.info,t=e.memory,i=e.render;console.log("🔍 Memory & Performance Debug:"),console.log("  - Triangles:",i.triangles.toLocaleString()),console.log("  - Draw Calls:",i.calls.toLocaleString()),console.log("  - Geometries:",t.geometries),console.log("  - Textures:",t.textures),console.log("  - FPS:",this.fps);let o=0,n=0,s=0;this.scene.traverse(e=>{o++,e.isMesh&&n++,e.isGroup&&s++}),console.log("  - Total Objects:",o),console.log("  - Meshes:",n),console.log("  - Groups:",s),i.triangles>5e6&&console.warn("⚠️ High triangle count detected - possible memory leak"),i.calls>5e4&&console.warn("⚠️ High draw call count detected - possible memory leak")}cleanupMemory(){this.renderer&&(this.renderer.info.reset(),window.gc?(window.gc(),console.log("🔧 Memory cleanup completed")):console.log("🔧 Renderer info reset (manual GC recommended)"))}cleanupUnusedResources(){if(!this.renderer||!this.scene)return;console.log("🔧 Starting comprehensive resource cleanup...");const e=this.scene.children.length,t=this.renderer.info.memory.geometries,i=this.renderer.info.memory.materials;this.cleanupUnusedGeometries(),this.cleanupUnusedMaterials(),this.renderer.info.reset(),window.gc&&window.gc(),console.log(`🔧 Cleanup completed - Objects: ${e} → ${this.scene.children.length}`),console.log(`🔧 Geometries: ${t} → ${this.renderer.info.memory.geometries}`),console.log(`🔧 Materials: ${i} → ${this.renderer.info.memory.materials}`)}cleanupUnusedGeometries(){this.worldManager&&this.worldManager.cleanupUnusedResources()}cleanupUnusedMaterials(){this.worldManager&&this.worldManager.cleanupUnusedResources()}validateSceneIntegrity(){if(!this.scene)return;let e=0,t=0;return this.scene.traverse(i=>{i&&i.isObject3D?(e++,i.position&&(isNaN(i.position.x)||isNaN(i.position.y)||isNaN(i.position.z))&&(console.warn("⚠️ Object with invalid position detected:",i),t++),i.geometry&&!i.geometry.attributes&&(console.warn("⚠️ Object with invalid geometry detected:",i),t++),i.material&&!i.material.isMaterial&&(console.warn("⚠️ Object with invalid material detected:",i),t++)):t++}),t>0?console.warn(`⚠️ Scene integrity check: ${e} valid, ${t} invalid objects`):console.log(`✅ Scene integrity check: ${e} valid objects`),{valid:e,invalid:t}}forceCleanup(){console.log("🔧 Force cleanup triggered manually"),this.cleanupUnusedResources(),this.validateSceneIntegrity(),this.worldManager&&this.worldManager.validateWorldIntegrity()}debugMemoryUsage(){if(!this.renderer)return;const e=this.renderer.info,t=e.memory,i=e.render;console.log("🔧 Memory Usage Debug:"),console.log(`  - Geometries: ${t.geometries}`),console.log(`  - Materials: ${t.materials}`),console.log(`  - Textures: ${t.textures}`),console.log(`  - Triangles: ${i.triangles}`),console.log(`  - Draw Calls: ${i.calls}`),console.log(`  - Scene Objects: ${this.scene?this.scene.children.length:"N/A"}`),this.worldManager&&(console.log("🌍 World Object Counts:"),console.log(`  - Pyramids: ${this.worldManager.pyramids.length}`),console.log(`  - Temples: ${this.worldManager.temples.length}`),console.log(`  - Sphinxes: ${this.worldManager.sphinxes.length}`),console.log(`  - Obelisks: ${this.worldManager.obelisks.length}`),console.log(`  - Resources: ${this.worldManager.resourceNodes.length}`),console.log(`  - Decorations: ${this.worldManager.decorations.length}`))}setupDebugControls(){document.addEventListener("keydown",e=>{e.ctrlKey&&e.shiftKey&&"C"===e.key&&(e.preventDefault(),console.log("🔧 Debug: Manual cleanup triggered"),this.forceCleanup()),e.ctrlKey&&e.shiftKey&&"M"===e.key&&(e.preventDefault(),console.log("🔧 Debug: Memory usage debug triggered"),this.debugMemoryUsage()),e.ctrlKey&&e.shiftKey&&"V"===e.key&&(e.preventDefault(),console.log("🔧 Debug: Scene validation triggered"),this.validateSceneIntegrity()),e.ctrlKey&&e.shiftKey&&"O"===e.key&&(e.preventDefault(),console.log("🔧 Debug: Object visibility debug triggered"),this.worldManager&&this.worldManager.debugObjectVisibility()),e.ctrlKey&&e.shiftKey&&"F"===e.key&&(e.preventDefault(),console.log("🔧 Debug: Force all objects visible triggered"),this.worldManager&&this.worldManager.forceAllObjectsVisible())})}updateCamera(){if(!this.player)return;const e=this.player.getPosition();this.handleCameraOrbit();const t=new i(e.x+this.cameraOffsetX,e.y+this.cameraOffsetY,e.z+this.cameraOffsetZ);this.camera.position.copy(t),this.camera.lookAt(new i(e.x,e.y+1,e.z)),Math.random()<.005&&(console.log("📷 Camera position:",this.camera.position.toArray().map(e=>e.toFixed(2))),console.log("👤 Player position:",e.toArray().map(e=>e.toFixed(2))),console.log("📷 Camera offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetY.toFixed(2),this.cameraOffsetZ.toFixed(2)))}handleCameraOrbit(){if(this.inputManager){if(this.inputManager.isKeyPressed("ArrowLeft")){const e=Math.atan2(this.cameraOffsetX,this.cameraOffsetZ)+this.cameraOrbitSpeed;this.cameraOffsetX=Math.sin(e)*this.cameraOrbitDistance,this.cameraOffsetZ=Math.cos(e)*this.cameraOrbitDistance,console.log("📷 Camera rotating left - New offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetZ.toFixed(2))}if(this.inputManager.isKeyPressed("ArrowRight")){const e=Math.atan2(this.cameraOffsetX,this.cameraOffsetZ)-this.cameraOrbitSpeed;this.cameraOffsetX=Math.sin(e)*this.cameraOrbitDistance,this.cameraOffsetZ=Math.cos(e)*this.cameraOrbitDistance,console.log("📷 Camera rotating right - New offsets:",this.cameraOffsetX.toFixed(2),this.cameraOffsetZ.toFixed(2))}this.inputManager.isKeyPressed("ArrowUp")&&(this.cameraOffsetY+=2*this.cameraOrbitSpeed,this.cameraOffsetY=Math.min(15,this.cameraOffsetY),console.log("📷 Camera height increased to:",this.cameraOffsetY.toFixed(2))),this.inputManager.isKeyPressed("ArrowDown")&&(this.cameraOffsetY-=2*this.cameraOrbitSpeed,this.cameraOffsetY=Math.max(2,this.cameraOffsetY),console.log("📷 Camera height decreased to:",this.cameraOffsetY.toFixed(2)))}}updatePerformanceMetrics(e){if(e-this.lastTime>=1){const t=this.frameCount;this._fpsHistory||(this._fpsHistory=[]),this._fpsHistory.push(t),this._fpsHistory.length>5&&this._fpsHistory.shift(),this.fps=Math.round(this._fpsHistory.reduce((e,t)=>e+t,0)/this._fpsHistory.length),this.frameCount=0,this.lastTime=e;const i=this.renderer.info;i.memory,i.render,this.uiManager&&this.uiManager.updatePerformanceInfo(this.fps),this.frameCount%600==0&&this.cleanupMemory(),this.frameCount%1800==0&&this.cleanupUnusedResources(),this.frameCount%3600==0&&this.validateSceneIntegrity()}}animate(){if(!this.isRunning)return;requestAnimationFrame(this.animate);const e=performance.now(),t=(e-this.lastTime)/1e3;this.lastTime=e,this.frameCount++,this.frameCount%60==0&&(this.fps=Math.round(1/t)),this.worldManager&&this.worldManager.update(t),this.player&&this.player.update(t),this.inputManager&&this.inputManager.update(),this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),this.updatePerformanceMetrics()}handleResize(){if(!this.camera||!this.renderer)return;console.log("🔄 Handling resize event...");const e=window.innerWidth,t=window.innerHeight;console.log(`📐 Viewport dimensions: ${e}x${t}`),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t,!1),this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),this.uiManager&&this.uiManager.handleResize(e,t),console.log("✅ Resize handled successfully")}handleResizeDebounced(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(()=>{this.handleResize()},100)}restoreViewport(){console.log("🔄 Restoring viewport to full dimensions...");const e=window.innerWidth,t=window.innerHeight;this.renderer&&this.renderer.setSize(e,t,!1),this.camera&&(this.camera.aspect=e/t,this.camera.updateProjectionMatrix()),this.scene&&this.camera&&this.renderer.render(this.scene,this.camera),console.log(`✅ Viewport restored to ${e}x${t}`)}monitorViewport(){this.viewportMonitorInterval&&clearInterval(this.viewportMonitorInterval),this.viewportMonitorInterval=setInterval(()=>{const e=window.innerWidth,t=window.innerHeight;this.lastViewportWidth===e&&this.lastViewportHeight===t||(console.log(`📐 Viewport changed: ${this.lastViewportWidth}x${this.lastViewportHeight} → ${e}x${t}`),this.lastViewportWidth=e,this.lastViewportHeight=t,(e<800||t<600)&&(console.log("⚠️ Viewport dimensions seem too small, attempting auto-restore..."),this.restoreViewport()))},1e3)}stopViewportMonitoring(){this.viewportMonitorInterval&&(clearInterval(this.viewportMonitorInterval),this.viewportMonitorInterval=null)}addPlayer(e,i){const o=new t(this.scene,null);o.init(i),this.players.set(e,o)}removePlayer(e){const t=this.players.get(e);t&&(t.destroy(),this.players.delete(e))}setUIManager(e){this.uiManager=e,this.worldManager&&this.worldManager.setUIManager(e),e&&(e.gameEngine=this)}setNetworkManager(e){this.networkManager=e}setAudioManager(e){this.audioManager=e}setOptionsManager(e){this.optionsManager=e,console.log("⚙️ Options Manager connected to Game Engine")}setMasterVolume(e){this.audioManager&&this.audioManager.setMasterVolume(e),console.log(`🔊 Master volume set to: ${e}`)}setMusicVolume(e){this.audioManager&&this.audioManager.setMusicVolume(e),console.log(`🎵 Music volume set to: ${e}`)}setSFXVolume(e){this.audioManager&&this.audioManager.setSFXVolume(e),console.log(`🔊 SFX volume set to: ${e}`)}setMouseSensitivity(e){this.inputManager&&this.inputManager.setMouseSensitivity(e),console.log(`🖱️ Mouse sensitivity set to: ${e}`)}setCameraSpeed(e){this.player&&this.player.setCameraSpeed(e),console.log(`📷 Camera speed set to: ${e}`)}getPlayer(){return this.player}getScene(){return this.scene}getCamera(){return this.camera}getGridManager(){return this.gridManager}getCraftingSystem(){return this.craftingSystem}getInventorySystem(){return this.inventorySystem}handleKeyDown(e){switch(console.log("⌨️ Key pressed:",e),this.player,e){case"KeyI":this.uiManager&&this.uiManager.toggleInventory();break;case"KeyC":this.uiManager&&this.uiManager.toggleCraftingPanel();break;case"KeyR":this.resetCamera();break;case"KeyD":this.debugCameraState();break;case"BracketLeft":case"BracketRight":break;case"Escape":console.log("⌨️ Escape pressed - checking options manager..."),this.optionsManager?(console.log("✅ Options manager found, toggling options..."),this.optionsManager.toggleOptions()):(console.log("❌ Options manager not found, falling back to hideAllPanels..."),this.uiManager&&this.uiManager.hideAllPanels())}}debugCameraState(){if(console.log("📷 === Camera Debug Info ==="),console.log("📷 Current offsets:",{X:this.cameraOffsetX.toFixed(2),Y:this.cameraOffsetY.toFixed(2),Z:this.cameraOffsetZ.toFixed(2)}),console.log("📷 Camera position:",this.camera.position.toArray().map(e=>e.toFixed(2))),this.player){const e=this.player.getPosition();console.log("👤 Player position:",e.toArray().map(e=>e.toFixed(2))),console.log("📷 Expected camera position:",[(e.x+this.cameraOffsetX).toFixed(2),(e.y+this.cameraOffsetY).toFixed(2),(e.z+this.cameraOffsetZ).toFixed(2)])}console.log("📷 ========================")}resetCamera(){this.cameraOffsetX=0,this.cameraOffsetY=5,this.cameraOffsetZ=10,console.log("📷 Camera reset to default orbital position")}handleKeyUp(e){console.log("⌨️ Key released:",e)}}class Q{constructor(){this.gameEngine=null,this.isInitialized=!1,this.isVisible=!1,this.gameUI=null,this.craftingPanel=null,this.inventory=null,this.topHUD=null,this.actionButtons=null,this.activePanel=null,this.craftingCategory="weapons",this.performanceInfo=null,this.timeDisplay=null}async init(){if(this.isInitialized)console.warn("⚠️ UIManager already initialized, skipping...");else{if(console.log("🎨 Initializing UI Manager..."),this.gameUI=document.getElementById("game-ui"),this.craftingPanel=document.getElementById("crafting-panel"),this.inventory=document.getElementById("inventory"),this.topHUD=document.querySelector(".top-hud"),this.actionButtons=document.querySelector(".action-buttons"),this.timeDisplay=document.getElementById("time-display"),!this.gameUI||!this.craftingPanel||!this.inventory)throw new Error("UI elements not found");this.setupEventListeners(),this.initializeCraftingItems(),this.initializeInventory(),this.initializeEquipmentSlots(),this.initializeTimeDisplay(),this.isInitialized=!0,console.log("✅ UI Manager initialized")}}setupEventListeners(){const e=document.getElementById("crafting-btn"),t=document.getElementById("inventory-btn"),i=document.getElementById("map-btn"),o=document.getElementById("skills-btn");e&&e.addEventListener("click",()=>this.showCraftingPanel()),t&&t.addEventListener("click",()=>this.showInventory()),i&&i.addEventListener("click",()=>this.showMap()),o&&o.addEventListener("click",()=>this.showSkills());const n=document.getElementById("close-crafting"),s=document.getElementById("close-inventory");n&&n.addEventListener("click",()=>this.hideCraftingPanel()),s&&s.addEventListener("click",()=>this.hideInventory()),document.querySelectorAll(".category-btn").forEach(e=>{e.addEventListener("click",()=>{this.setCraftingCategory(e.dataset.category)})}),this.addHelpText(),document.addEventListener("keydown",e=>{"t"===e.key||"T"===e.key?(console.log("🔥 T key pressed - testing torch equipping..."),this.testTorchEquipping()):"i"===e.key||"I"===e.key?(console.log("🎒 I key pressed - testing inventory..."),this.testInventory()):"r"===e.key||"R"===e.key?(console.log("🔄 R key pressed - resetting camera..."),this.resetCamera()):"g"===e.key||"G"===e.key?(console.log("🗺️ G key pressed - toggling grid..."),this.toggleGrid()):"c"===e.key||"C"===e.key?(console.log("🎯 C key pressed - testing click detection..."),this.testClickDetection()):"a"===e.key||"A"===e.key?(console.log("🎭 A key pressed - testing player animations..."),this.testPlayerAnimations()):"e"!==e.key&&"E"!==e.key||(console.log("📋 E key pressed - exporting model specifications..."),this.exportModelSpecs())})}initializeTimeDisplay(){}initializeCraftingItems(){document.getElementById("crafting-items")&&(this.craftingItems={weapons:[{id:"bronze_sword",name:"Bronze Sword",description:"Basic weapon",level:1,materials:["bronze_ingot","wood"]},{id:"iron_sword",name:"Iron Sword",description:"Improved weapon",level:5,materials:["iron_ingot","wood"]},{id:"steel_sword",name:"Steel Sword",description:"Advanced weapon",level:10,materials:["steel_ingot","wood"]}],armor:[{id:"leather_armor",name:"Leather Armor",description:"Basic protection",level:1,materials:["leather","thread"]},{id:"bronze_armor",name:"Bronze Armor",description:"Metal protection",level:5,materials:["bronze_ingot","leather"]},{id:"iron_armor",name:"Iron Armor",description:"Strong protection",level:10,materials:["iron_ingot","leather"]}],tools:[{id:"bronze_pickaxe",name:"Bronze Pickaxe",description:"Mining tool",level:1,materials:["bronze_ingot","wood"]},{id:"iron_pickaxe",name:"Iron Pickaxe",description:"Better mining",level:5,materials:["iron_ingot","wood"]},{id:"steel_pickaxe",name:"Steel Pickaxe",description:"Best mining",level:10,materials:["steel_ingot","wood"]}],potions:[{id:"health_potion",name:"Health Potion",description:"Restores health",level:1,materials:["herbs","water"]},{id:"strength_potion",name:"Strength Potion",description:"Increases strength",level:5,materials:["herbs","water","crystal"]},{id:"wisdom_potion",name:"Wisdom Potion",description:"Increases wisdom",level:10,materials:["herbs","water","crystal","essence"]}]})}initializeInventory(){const e=document.getElementById("inventory-grid");if(e){for(let t=0;t<64;t++){const i=document.createElement("div");i.className="inventory-slot",i.dataset.slot=t,i.addEventListener("click",()=>{this.handleInventorySlotClick(t)}),i.addEventListener("contextmenu",e=>{e.preventDefault(),this.handleInventorySlotRightClick(t)}),e.appendChild(i)}this.initializeEquipmentSlots(),this.addItemToInventory(0,{id:"bronze_ingot",name:"Bronze Ingot",type:"material"}),this.addItemToInventory(1,{id:"wood",name:"Wood",type:"material"}),this.addItemToInventory(2,{id:"leather",name:"Leather",type:"material"}),this.addItemToInventory(3,{id:"torch",name:"Torch",type:"light"}),console.log("🎒 Inventory initialized with sample items"),this.gameEngine&&this.syncWithInventorySystem()}}initializeEquipmentSlots(){document.querySelectorAll(".equipment-slot").forEach(e=>{e.addEventListener("click",()=>{this.handleEquipmentSlotClick(e.dataset.slot)}),e.addEventListener("contextmenu",t=>{t.preventDefault(),this.handleEquipmentSlotRightClick(e.dataset.slot)})})}addItemToInventory(e,t){const i=document.querySelector(`[data-slot="${e}"]`);i&&(i.classList.add("filled"),i.dataset.itemId=t.id,i.dataset.itemName=t.name,i.dataset.itemType=t.type,i.innerHTML=`<span title="${t.name}">${this.getItemIcon(t)}</span>`)}getItemIcon(e){return{material:"📦",weapon:"⚔️",armor:"🛡️",tool:"🔨",potion:"🧪",food:"🍖",gem:"💎",light:"🔥"}[e.type]||"📦"}handleInventorySlotClick(e){const t=document.querySelector(`[data-slot="${e}"]`);if(!t||!t.classList.contains("filled"))return void console.log(`❌ Slot ${e} is empty or not found`);const i=t.dataset.itemId,o=t.dataset.itemName;console.log(`🎯 Clicked on ${o} (${i}) in slot ${e}`),this.showItemInfo(i,o)}handleInventorySlotRightClick(e){const t=document.querySelector(`[data-slot="${e}"]`);if(!t||!t.classList.contains("filled"))return;const i=t.dataset.itemId,o=t.dataset.itemName,n=t.dataset.itemType;console.log(`Right-clicked on ${o} in slot ${e}`),"light"===n&&"torch"===i?this.equipTorch(e):"weapon"===n||"armor"===n?this.equipItem(i,o,e):this.showItemInfo(i,o)}equipTorch(e){if(console.log(`🔥 Equipping torch from slot ${e}`),!this.gameEngine)return void console.warn("Game engine not connected");const t=this.gameEngine.getInventorySystem();if(t)if(t.equipTorch(e)){console.log("🔥 Torch equipped successfully!"),this.showNotification("🔥 Torch equipped!","success");const e=this.gameEngine.getPlayer();e&&e.equipItem("torch","offhand"),this.updateInventoryDisplay()}else console.warn("Failed to equip torch"),this.showNotification("Failed to equip torch","error");else console.warn("Inventory system not found")}handleEquipmentSlotClick(e){const t=document.querySelector(`[data-slot="${e}"]`);if(t)if(console.log(`🎯 Clicked on equipment slot: ${e}`),t.classList.contains("equipped")){const i=t.dataset.itemId,o=t.dataset.itemName;console.log(`🔧 Unequipping ${o} from ${e}`),this.unequipItem(i,e),this.showNotification(`🔧 Unequipped ${o}`,"info")}else console.log(`📭 Equipment slot ${e} is empty`),this.showNotification(`📭 ${e} slot is empty`,"info")}handleEquipmentSlotRightClick(e){const t=document.querySelector(`[data-slot="${e}"]`);if(t)if(console.log(`🎯 Right-clicked on equipment slot: ${e}`),t.classList.contains("equipped")){const i=t.dataset.itemId,o=t.dataset.itemName;confirm(`Unequip ${o} from ${e} slot?`)&&(console.log(`🔧 Unequipping ${o} from ${e}`),this.unequipItem(i,e),this.showNotification(`🔧 Unequipped ${o}`,"info"))}else console.log(`📭 Equipment slot ${e} is empty`),this.showNotification(`📭 ${e} slot is empty`,"info")}showItemContextMenu(e,t,i){const o=document.createElement("div");o.className="item-context-menu",o.innerHTML='\n            <div class="context-menu-item" data-action="use">Use</div>\n            <div class="context-menu-item" data-action="equip">Equip</div>\n            <div class="context-menu-item" data-action="drop">Drop</div>\n        ',o.style.cssText="\n            position: absolute;\n            background: rgba(0, 0, 0, 0.95);\n            border: 2px solid #ffd700;\n            border-radius: 8px;\n            padding: 5px 0;\n            color: white;\n            z-index: 1000;\n            min-width: 120px;\n        ";const n=document.querySelector(`[data-slot="${i}"]`).getBoundingClientRect();o.style.left=n.right+"px",o.style.top=n.top+"px",document.body.appendChild(o),o.addEventListener("click",n=>{const s=n.target.dataset.action;s&&(this.handleItemAction(s,e,t,i),o.remove())}),document.addEventListener("click",()=>o.remove(),{once:!0})}handleItemAction(e,t,i,o){switch(e){case"use":this.useItem(t,i);break;case"equip":this.equipItem(t,i,o);break;case"drop":this.dropItem(t,i,o)}}useItem(e,t){console.log(`Using ${t}`)}equipItem(e,t,i){if(console.log(`🔧 Equipping ${t} from slot ${i}`),!this.gameEngine)return console.warn("❌ Game engine not connected"),void this.showNotification("❌ Cannot equip item - game not ready","error");const o=this.gameEngine.getInventorySystem();if(!o)return console.warn("❌ Inventory system not found"),void this.showNotification("❌ Cannot equip item - inventory system not found","error");const n=o.itemDatabase.get(e);if(!n)return console.warn(`❌ Item data not found for ${e}`),void this.showNotification(`❌ Cannot equip ${t} - item data not found`,"error");console.log("📋 Item data:",n);let s=null;if("torch"===e||"light"===n.type)s="offhand";else if("weapon"===n.type)s="weapon";else{if("armor"!==n.type)return console.log(`❌ ${t} cannot be equipped (type: ${n.type})`),void this.showNotification(`❌ ${t} cannot be equipped`,"error");s=e.includes("head")||e.includes("helmet")?"head":e.includes("chest")||e.includes("armor")?"chest":e.includes("legs")||e.includes("pants")?"legs":e.includes("feet")||e.includes("boots")?"feet":"chest"}console.log(`🎯 Equipping ${t} in ${s} slot`);let a=!1;if(a="torch"===e?o.equipTorch(i):o.equipItem(i),a){console.log(`✅ Successfully equipped ${t} through inventory system`);const i=this.gameEngine.getPlayer();i&&(i.equipItem(e,s),console.log("🎮 Player visual equipment updated")),this.updateEquipmentDisplay(),this.showNotification(`✅ ${t} equipped in ${s} slot!`,"success")}else{console.warn(`❌ Failed to equip ${t} through inventory system`),this.equipItemInSlot(e,t,s),this.removeItemFromInventory(i);const o=this.gameEngine.getPlayer();o&&o.equipItem(e,s),this.showNotification(`✅ ${t} equipped in ${s} slot!`,"success")}}equipItemInSlot(e,t,i){const o=document.querySelector(`[data-slot="${i}"]`);if(!o)return void console.warn(`❌ Equipment slot ${i} not found`);console.log(`🎯 Equipping ${t} in ${i} slot`);let n="unknown";if(this.gameEngine&&this.gameEngine.getInventorySystem()){const t=this.gameEngine.getInventorySystem().itemDatabase.get(e);t&&(n=t.type)}o.classList.add("equipped"),o.dataset.itemId=e,o.dataset.itemName=t,o.dataset.itemType=n;const s=this.getItemIcon({type:n});o.innerHTML=`\n            <div class="slot-label">${i.charAt(0).toUpperCase()+i.slice(1)}</div>\n            <div class="item-icon">${s}</div>\n            <div class="item-name">${t}</div>\n        `,this.gameEngine&&this.gameEngine.getPlayer()&&(this.gameEngine.getPlayer().equipItem(e,i),console.log(`🎮 Player equipment updated for ${i}`)),console.log(`✅ Successfully equipped ${t} in ${i} slot`)}unequipItem(e,t){const i=document.querySelector(`[data-slot="${t}"]`);if(!i)return void console.warn(`❌ Equipment slot ${t} not found`);console.log(`🔧 Unequipping ${e} from ${t} slot`),i.classList.remove("equipped"),i.dataset.itemId="",i.dataset.itemName="",i.dataset.itemType="",i.innerHTML=`<div class="slot-label">${t.charAt(0).toUpperCase()+t.slice(1)}</div>`,this.gameEngine&&this.gameEngine.getPlayer()&&(this.gameEngine.getPlayer().unequipItem(t),console.log(`🎮 Player equipment updated for ${t}`));const o=this.findEmptyInventorySlot();if(-1!==o){let t="unknown";if(this.gameEngine&&this.gameEngine.getInventorySystem()){const i=this.gameEngine.getInventorySystem().itemDatabase.get(e);i&&(t=i.type)}this.addItemToInventory(o,{id:e,name:e,type:t}),console.log(`📦 ${e} returned to inventory slot ${o}`)}else console.warn(`❌ No empty inventory slots available for ${e}`),this.showNotification(`❌ Inventory full - cannot unequip ${e}`,"error");console.log(`✅ Successfully unequipped ${e} from ${t} slot`)}removeItemFromInventory(e){const t=document.querySelector(`[data-slot="${e}"]`);t&&(t.classList.remove("filled"),t.dataset.itemId="",t.dataset.itemName="",t.dataset.itemType="",t.innerHTML="")}findEmptyInventorySlot(){for(let e=0;e<64;e++){const t=document.querySelector(`[data-slot="${e}"]`);if(t&&!t.classList.contains("filled"))return e}return-1}findItemSlotIndex(e){for(let t=0;t<64;t++){const i=document.querySelector(`[data-slot="${t}"]`);if(i&&i.classList.contains("filled")&&i.dataset.itemId===e)return t}return-1}dropItem(e,t,i){console.log(`Dropping ${t}`),this.removeItemFromInventory(i)}showItemInfo(e,t){console.log(`Showing info for ${t} (${e})`);const i=this.gameEngine?.getInventorySystem()?.itemDatabase?.get(e);this.showItemTooltip(e,t,i)}showItemTooltip(e,t,i){this.removeExistingTooltips();const o=document.createElement("div");o.className="item-tooltip",o.id="item-tooltip";const n=i?.type||"unknown";let s=`\n            <div class="tooltip-header">\n                <span class="item-icon">${this.getItemIcon({type:n})}</span>\n                <h4 class="item-name">${t}</h4>\n            </div>\n            <div class="tooltip-content">\n                <p class="item-type">Type: ${n}</p>\n        `;i?.description&&(s+=`<p class="item-description">${i.description}</p>`),i?.stats&&(s+='<div class="item-stats">',Object.entries(i.stats).forEach(([e,t])=>{s+=`<span class="stat">${e}: ${t}</span>`}),s+="</div>"),s+='\n            <div class="tooltip-actions">\n        ',(i?.equipmentSlot||"light"===n||"weapon"===n||"armor"===n)&&(s+='<button class="action-btn equip-btn" data-action="equip">⚔️ Equip</button>'),"potion"!==n&&"food"!==n&&"tool"!==n||(s+='<button class="action-btn use-btn" data-action="use">🔄 Use</button>'),s+='<button class="action-btn drop-btn" data-action="drop">🗑️ Drop</button>',s+='\n                <button class="action-btn close-btn" data-action="close">✕ Close</button>\n            </div>\n        </div>\n        ',o.innerHTML=s;const a=document.querySelector(`[data-item-id="${e}"]`);if(a){const e=a.getBoundingClientRect();o.style.position="fixed",o.style.left=`${e.right+10}px`,o.style.top=`${e.top}px`}else o.style.position="fixed",o.style.left="50%",o.style.top="50%",o.style.transform="translate(-50%, -50%)";o.addEventListener("click",o=>{if(o.target.classList.contains("action-btn")){const n=o.target.dataset.action;this.handleTooltipAction(n,e,t,i)}}),document.addEventListener("click",e=>{o.contains(e.target)||e.target.closest(".inventory-slot")||this.removeExistingTooltips()}),document.body.appendChild(o),setTimeout(()=>{this.removeExistingTooltips()},1e4)}handleTooltipAction(e,t,i,o){switch(console.log(`Handling tooltip action: ${e} for ${i}`),e){case"equip":this.equipItemFromTooltip(t,i,o);break;case"use":this.useItem(t,i);break;case"drop":this.dropItem(t,i);break;case"close":this.removeExistingTooltips()}}equipItemFromTooltip(e,t,i){const o=this.findItemSlotIndex(e);-1!==o?("torch"===e?this.equipTorch(o):"weapon"===i.type||"armor"===i.type?this.equipItem(e,t,o):this.showNotification(`❌ Cannot equip ${t}`,"error"),this.removeExistingTooltips()):this.showNotification("❌ Item not found in inventory","error")}useItem(e,t){console.log(`Using item: ${t}`),this.showNotification(`🔄 Using ${t}`,"info"),this.removeExistingTooltips()}dropItem(e,t){console.log(`Dropping item: ${t}`),this.showNotification(`🗑️ Dropped ${t}`,"warning"),this.removeExistingTooltips()}findItemSlotIndex(e){const t=document.querySelectorAll(".inventory-slot");for(let i=0;i<t.length;i++)if(t[i].dataset.itemId===e)return i;return-1}removeExistingTooltips(){document.querySelectorAll(".item-tooltip").forEach(e=>e.remove())}updateInventoryDisplay(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();if(!e)return;const t=document.getElementById("inventory-grid");t&&(t.querySelectorAll(".inventory-slot").forEach(e=>{e.classList.remove("filled"),e.dataset.itemId="",e.dataset.itemName="",e.dataset.itemType="",e.innerHTML=""}),e.getInventory().forEach((e,t)=>{e&&this.addItemToInventory(t,{id:e.id,name:this.getItemDisplayName(e.id),type:this.getItemType(e.id)})}),this.updateEquipmentDisplay())}syncWithInventorySystem(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();e&&(console.log("🔄 Syncing UI with inventory system..."),[{id:"bronze_ingot",quantity:5},{id:"wood",quantity:10},{id:"leather",quantity:3},{id:"torch",quantity:1}].forEach(t=>{e.hasItem(t.id)||(console.log(`📦 Adding ${t.id} to inventory system`),e.addItem(t.id,t.quantity))}),this.updateInventoryDisplayFromSystem(),console.log("✅ Inventory sync complete"))}updateInventoryDisplayFromSystem(){if(!this.gameEngine)return console.log("⚠️ Game engine not connected, showing sample items"),void this.showSampleItems();const e=this.gameEngine.getInventorySystem();if(!e)return console.log("⚠️ Inventory system not found, showing sample items"),void this.showSampleItems();console.log("🔄 Updating inventory display from system...");const t=e.getInventory();console.log("🎒 Inventory from system:",t);const i=document.getElementById("inventory-grid");if(!i)return;i.querySelectorAll(".inventory-slot").forEach(e=>{e.classList.remove("filled"),e.dataset.itemId="",e.dataset.itemName="",e.dataset.itemType="",e.innerHTML=""});let o=!1;t.forEach((t,i)=>{if(t){o=!0;const n=e.itemDatabase.get(t.id);n&&this.addItemToInventory(i,{id:t.id,name:n.name,type:n.type})}}),o||(console.log("⚠️ No items in inventory system, showing sample items"),this.showSampleItems()),this.updateEquipmentDisplay()}showSampleItems(){console.log("🎒 Showing sample items as fallback"),this.addItemToInventory(0,{id:"bronze_ingot",name:"Bronze Ingot",type:"material"}),this.addItemToInventory(1,{id:"wood",name:"Wood",type:"material"}),this.addItemToInventory(2,{id:"leather",name:"Leather",type:"material"}),this.addItemToInventory(3,{id:"torch",name:"Torch",type:"light"}),console.log("✅ Sample items displayed")}getItemDisplayName(e){const t=this.gameEngine?.getInventorySystem()?.itemDatabase?.get(e);return t?t.name:e}getItemType(e){const t=this.gameEngine?.getInventorySystem()?.itemDatabase?.get(e);return t?t.type:"unknown"}updateEquipmentDisplay(){if(!this.gameEngine)return;const e=this.gameEngine.getInventorySystem();if(!e)return;const t=e.getEquipment();Object.entries(t).forEach(([e,t])=>{const i=document.querySelector(`[data-slot="${e}"]`);i&&(t?(i.classList.add("equipped"),i.dataset.itemId=t.id,i.dataset.itemName=t.name||t.id,i.innerHTML=`<div class="slot-label">${e}</div><div class="item-icon">${this.getItemIcon({type:this.getItemType(t.id)})}</div>`):(i.classList.remove("equipped"),i.dataset.itemId="",i.dataset.itemName="",i.innerHTML=`<div class="slot-label">${e}</div>`))})}showCraftingPanel(){this.hideAllPanels(),this.craftingPanel.classList.remove("hidden"),this.activePanel="crafting",this.updateCraftingItems()}hideCraftingPanel(){this.craftingPanel.classList.add("hidden"),this.activePanel=null}showInventory(){console.log("🎒 Showing inventory..."),this.hideAllPanels(),this.inventory.classList.remove("hidden"),this.activePanel="inventory",this.gameEngine&&this.updateInventoryDisplayFromSystem(),console.log("🎒 Inventory panel shown")}hideInventory(){this.inventory.classList.add("hidden"),this.activePanel=null}showMap(){console.log("🗺️ Map feature coming soon!")}showSkills(){console.log("📚 Skills feature coming soon!")}hideAllPanels(){this.craftingPanel.classList.add("hidden"),this.inventory.classList.add("hidden"),this.activePanel=null}setCraftingCategory(e){this.craftingCategory=e,document.querySelectorAll(".category-btn").forEach(t=>{t.classList.remove("active"),t.dataset.category===e&&t.classList.add("active")}),this.updateCraftingItems()}updateCraftingItems(){const e=document.getElementById("crafting-items");if(!e||!this.craftingItems)return;const t=this.craftingItems[this.craftingCategory]||[];e.innerHTML=t.map(e=>`\n            <div class="crafting-item" data-item-id="${e.id}">\n                <div class="item-icon">${this.getItemIcon({type:this.craftingCategory.slice(0,-1)})}</div>\n                <h4>${e.name}</h4>\n                <p>${e.description}</p>\n                <p class="item-level">Level ${e.level}</p>\n                <p class="item-materials">Materials: ${e.materials.join(", ")}</p>\n                <button class="craft-btn" onclick="this.craftItem('${e.id}')">Craft</button>\n            </div>\n        `).join(""),e.querySelectorAll(".craft-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.parentElement.dataset.itemId;this.craftItem(t)})})}craftItem(e){if(!this.gameEngine)return;const t=this.gameEngine.getCraftingSystem();t&&(t.craftItem(e)?(console.log(`Successfully crafted ${e}`),this.showNotification(`Crafted ${e}!`,"success")):(console.log(`Failed to craft ${e}`),this.showNotification(`Failed to craft ${e}`,"error")))}showNotification(e,t="info"){const i=document.createElement("div");i.className=`notification notification-${t}`,i.textContent=e,i.innerHTML=`${{success:"✅",error:"❌",info:"ℹ️",warning:"⚠️"}[t]||"ℹ️"} ${e}`,i.style.cssText=`\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: ${"success"===t?"#4CAF50":"error"===t?"#f44336":"warning"===t?"#ff9800":"#2196F3"};\n            color: white;\n            padding: 15px 20px;\n            border-radius: 5px;\n            z-index: 10000;\n            animation: slideIn 0.3s ease;\n            font-weight: 600;\n            box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n        `,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>{i.parentElement&&i.remove()},300)},3e3)}updatePerformanceInfo(e){this.performanceInfo&&(this.performanceInfo.textContent=`FPS: ${e}`)}updateTimeDisplay(e){if(this.timeDisplay){let t="",i="🌅";e>.25&&e<.75?e<.4?(t="Morning",i="🌅"):e<.6?(t="Noon",i="☀️"):(t="Afternoon",i="🌇"):e<.25?(t="Night",i="🌙"):(t="Evening",i="🌆"),this.timeDisplay.textContent=`${i} ${t}`}}setGameEngine(e){this.gameEngine=e,this.gameEngine&&setTimeout(()=>{this.syncWithInventorySystem()},200)}show(){this.gameUI.classList.remove("hidden"),this.isVisible=!0}hide(){this.gameUI.classList.add("hidden"),this.isVisible=!1}destroy(){this.hideAllPanels(),console.log("🎨 UI Manager destroyed")}testTorchEquipping(){if(console.log("🧪 Testing torch equipping system..."),!this.gameEngine)return void console.warn("❌ Game engine not connected");const e=this.gameEngine.getInventorySystem();e?this.gameEngine.getPlayer()?(console.log("✅ All systems found, testing torch equipping..."),-1===e.getInventory().findIndex(e=>e&&"torch"===e.id)&&(console.warn("❌ Torch not found in inventory, adding one..."),e.addItem("torch"),this.updateInventoryDisplay()),this.equipTorch(3)):console.warn("❌ Player not found"):console.warn("❌ Inventory system not found")}testInventory(){if(console.log("🎒 Testing inventory system..."),!this.gameEngine)return void console.warn("❌ Game engine not connected");const e=this.gameEngine.getInventorySystem();if(!e)return void console.warn("❌ Inventory system not found");if(!this.gameEngine.getPlayer())return void console.warn("❌ Player not found");console.log("✅ All systems found, testing inventory..."),console.log("📊 Inventory System Status:"),console.log("  - Initialized:",e.isInitialized),console.log("  - Item Database Size:",e.itemDatabase.size),console.log("  - Max Slots:",e.maxSlots),console.log("  - Current Slots:",e.slots.filter(e=>null!==e).length),console.log("📚 Item Database Contents:");for(const[i,o]of e.itemDatabase)console.log(`  - ${i}: ${o.name} (${o.type})`);console.log("📦 Current Inventory:"),e.getInventory().forEach((e,t)=>{e&&console.log(`  - Slot ${t}: ${e.id} x${e.quantity}`)}),console.log("⚔️ Current Equipment:");const t=e.getEquipment();Object.entries(t).forEach(([e,t])=>{t?console.log(`  - ${e}: ${t.id}`):console.log(`  - ${e}: empty`)}),0===e.itemDatabase.size?(console.log("⚠️ Item database is empty, attempting to initialize..."),e.init().then(()=>{console.log("✅ Inventory system initialized"),this.testInventory()}).catch(e=>{console.error("❌ Failed to initialize inventory system:",e)})):([{id:"bronze_ingot",quantity:5},{id:"wood",quantity:10},{id:"leather",quantity:3},{id:"torch",quantity:1}].forEach(t=>{e.hasItem(t.id)?(console.log(`📦 ${t.id} already exists, increasing quantity`),e.addItem(t.id,t.quantity)):(console.log(`📦 Adding ${t.id} to inventory system`),e.addItem(t.id,t.quantity))}),this.updateInventoryDisplayFromSystem(),console.log("🎒 Inventory system tested successfully."))}testPlayerAnimations(){if(console.log("🎭 Testing player animations..."),!this.gameEngine)return void console.warn("❌ Game engine not available");const e=this.gameEngine.getPlayer();e?(console.log("✅ Player found, testing animations..."),e.bodyParts?(console.log("🎭 Player has",Object.keys(e.bodyParts).length,"body parts"),console.log("🎭 Body parts:",Object.keys(e.bodyParts)),e.resetAnimation(),console.log("🎭 Animation reset"),this.showNotification("🎭 Player animations tested!","info")):(console.warn("❌ Player body parts not found"),this.showNotification("❌ Player animations not available","error"))):console.warn("❌ Player not found")}handleResize(e,t){console.log(`🎨 UI Manager handling resize: ${e}x${t}`),this.updateUIPositions(e,t),this.centerPanels(),console.log("✅ UI resize handled")}updateUIPositions(e,t){[this.craftingPanel,this.inventory].forEach(e=>{e&&!e.classList.contains("hidden")&&(e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)")})}centerPanels(){[this.craftingPanel,this.inventory].forEach(e=>{e&&!e.classList.contains("hidden")&&(e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)")})}restoreViewport(){console.log("🔄 Restoring viewport..."),this.gameEngine?this.gameEngine.restoreViewport():console.warn("❌ Game engine not available for viewport restoration"),this.centerPanels()}toggleGrid(){if(!this.gameEngine)return void console.warn("❌ Game engine not available");const e=this.gameEngine.getGridManager();e?e.toggleGrid():console.warn("❌ Grid manager not found")}testClickDetection(){if(console.log("🎯 Testing click detection system..."),!this.gameEngine)return void console.warn("❌ Game engine not connected");const e=this.gameEngine.getGridManager();if(!e)return void console.warn("❌ Grid manager not found");console.log("✅ Grid manager found, testing grid system...");const t=new i(0,0,0),o=e.getCellAtWorld(t);o?(console.log("✅ Grid cell lookup working:",o),console.log(`Cell ${o.x}, ${o.z} is ${o.state}`)):console.warn("❌ Grid cell lookup failed");const n=e.isWalkable(t);console.log("✅ Walkable check:",n);const s=e.findNearestWalkable(t);console.log("✅ Nearest walkable position:",s)}resetCamera(){console.log("🔄 Resetting camera..."),this.gameEngine?(this.gameEngine.resetCamera(),this.showNotification("📷 Camera reset to default position!","info")):(console.warn("❌ Game engine not available for camera reset."),this.showNotification("📷 Camera reset failed - game not ready.","error"))}addHelpText(){const e=document.createElement("div");e.className="help-text",e.innerHTML="\n            <h3>Controls</h3>\n            <p><strong>Camera Controls:</strong></p>\n            <p>← →: Rotate camera around player</p>\n            <p>↑ ↓: Adjust camera height</p>\n            <p>R: Reset camera to default</p>\n            <p>D: Debug camera state</p>\n            <p><strong>Movement:</strong></p>\n            <p>Click: Move to clicked location</p>\n            <p><strong>UI Controls:</strong></p>\n            <p>I: Toggle Inventory</p>\n            <p>C: Toggle Crafting</p>\n            <p>G: Toggle Grid</p>\n            <p>Escape: Close panels</p>\n            <p><strong>Debug:</strong></p>\n            <p>T: Test torch equipping</p>\n            <p>C: Test click detection</p>\n            <p>A: Test player animations</p>\n            <p>E: Export model specifications</p>\n        ",e.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            left: 20px;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 15px;\n            border-radius: 8px;\n            z-index: 999;\n            font-size: 0.9em;\n            max-width: 300px;\n            line-height: 1.5;\n        ",document.body.appendChild(e)}exportModelSpecs(){if(console.log("📋 Exporting model specifications..."),!this.gameEngine)return console.warn("❌ Game engine not available"),void this.showNotification("❌ Cannot export model specs - game engine not available","error");const e=this.gameEngine.getPlayer();if(!e)return console.warn("❌ Player not found"),void this.showNotification("❌ Cannot export model specs - player not found","error");const t=e.exportModelSpecs();if(t){console.log("✅ Model specs exported successfully:",t),this.showNotification("✅ Model specs exported! Check console for details.","success");const e=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),i=URL.createObjectURL(e),o=document.createElement("a");o.href=i,o.download="low_poly_mmorpg_character_specs.json",document.body.appendChild(o),o.click(),URL.revokeObjectURL(i),document.body.removeChild(o)}else console.warn("❌ Failed to export model specs"),this.showNotification("❌ Failed to export model specs","error")}}const J=document.createElement("style");J.textContent="\n    @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n    }\n    \n    @keyframes slideOut {\n        from { transform: translateX(0); opacity: 1; }\n        to { transform: translateX(100%); opacity: 0; }\n    }\n",document.head.appendChild(J);class ee{constructor(e){this.gameEngine=e,this.optionsMenu=null,this.isOpen=!1,this.settings={graphics:{quality:"medium",renderDistance:"medium",shadowQuality:"medium",antiAliasing:"fxaa",particleEffects:"medium",vsync:"on",fpsLimit:"60"},audio:{masterVolume:50,musicVolume:70,sfxVolume:80},controls:{mouseSensitivity:1,cameraSpeed:1}},this.isInitialized=!1}async init(){this.isInitialized?console.warn("⚠️ OptionsManager already initialized, skipping..."):(console.log("⚙️ Initializing Options Manager..."),this.optionsMenu=document.getElementById("options-menu"),this.optionsMenu?(this.loadSettings(),this.setupEventListeners(),this.updateUI(),this.isInitialized=!0,console.log("✅ Options Manager initialized")):console.error("❌ Options menu element not found in DOM"))}setupEventListeners(){if(!this.optionsMenu)return void console.error("❌ Options menu not initialized, cannot setup event listeners");const e=document.getElementById("close-options");e&&e.addEventListener("click",()=>this.closeOptions()),document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>this.switchTab(e.dataset.tab))});const t=document.getElementById("apply-settings");t&&t.addEventListener("click",()=>this.applySettings());const i=document.getElementById("reset-settings");i&&i.addEventListener("click",()=>this.resetSettings()),this.setupRangeInputs(),this.optionsMenu.addEventListener("click",e=>{e.target===this.optionsMenu&&this.closeOptions()})}setupRangeInputs(){const e=document.getElementById("master-volume"),t=document.getElementById("master-volume-value");e&&t&&e.addEventListener("input",e=>{t.textContent=`${e.target.value}%`});const i=document.getElementById("music-volume"),o=document.getElementById("music-volume-value");i&&o&&i.addEventListener("input",e=>{o.textContent=`${e.target.value}%`});const n=document.getElementById("sfx-volume"),s=document.getElementById("sfx-volume-value");n&&s&&n.addEventListener("input",e=>{s.textContent=`${e.target.value}%`});const a=document.getElementById("mouse-sensitivity"),r=document.getElementById("mouse-sensitivity-value");a&&r&&a.addEventListener("input",e=>{r.textContent=e.target.value});const l=document.getElementById("camera-speed"),d=document.getElementById("camera-speed-value");l&&d&&l.addEventListener("input",e=>{d.textContent=e.target.value})}toggleOptions(){console.log("⚙️ toggleOptions called - current state:",this.isOpen),this.isOpen?(console.log("⚙️ Closing options..."),this.closeOptions()):(console.log("⚙️ Opening options..."),this.openOptions())}openOptions(){console.log("⚙️ openOptions - showing options menu..."),this.optionsMenu.classList.remove("hidden"),this.isOpen=!0,this.updateUI(),console.log("⚙️ Options menu should now be visible")}closeOptions(){console.log("⚙️ closeOptions - hiding options menu..."),this.optionsMenu.classList.add("hidden"),this.isOpen=!1,console.log("⚙️ Options menu should now be hidden")}switchTab(e){document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".tab-content").forEach(e=>e.classList.remove("active")),document.querySelector(`[data-tab="${e}"]`).classList.add("active"),document.getElementById(`${e}-tab`).classList.add("active")}updateUI(){const e=document.getElementById("graphics-quality");e&&(e.value=this.settings.graphics.quality);const t=document.getElementById("render-distance");t&&(t.value=this.settings.graphics.renderDistance);const i=document.getElementById("shadow-quality");i&&(i.value=this.settings.graphics.shadowQuality);const o=document.getElementById("anti-aliasing");o&&(o.value=this.settings.graphics.antiAliasing);const n=document.getElementById("particle-effects");n&&(n.value=this.settings.graphics.particleEffects);const s=document.getElementById("vsync");s&&(s.value=this.settings.graphics.vsync);const a=document.getElementById("fps-limit");a&&(a.value=this.settings.graphics.fpsLimit);const r=document.getElementById("master-volume"),l=document.getElementById("master-volume-value");r&&l&&(r.value=this.settings.audio.masterVolume,l.textContent=`${this.settings.audio.masterVolume}%`);const d=document.getElementById("music-volume"),c=document.getElementById("music-volume-value");d&&c&&(d.value=this.settings.audio.musicVolume,c.textContent=`${this.settings.audio.musicVolume}%`);const h=document.getElementById("sfx-volume"),u=document.getElementById("sfx-volume-value");h&&u&&(h.value=this.settings.audio.sfxVolume,u.textContent=`${this.settings.audio.sfxVolume}%`);const p=document.getElementById("mouse-sensitivity"),m=document.getElementById("mouse-sensitivity-value");p&&m&&(p.value=this.settings.controls.mouseSensitivity,m.textContent=this.settings.controls.mouseSensitivity);const g=document.getElementById("camera-speed"),y=document.getElementById("camera-speed-value");g&&y&&(g.value=this.settings.controls.cameraSpeed,y.textContent=this.settings.controls.cameraSpeed)}async applySettings(){this.settings.graphics.quality=document.getElementById("graphics-quality").value,this.settings.graphics.renderDistance=document.getElementById("render-distance").value,this.settings.graphics.shadowQuality=document.getElementById("shadow-quality").value,this.settings.graphics.antiAliasing=document.getElementById("anti-aliasing").value,this.settings.graphics.particleEffects=document.getElementById("particle-effects").value,this.settings.graphics.vsync=document.getElementById("vsync").value,this.settings.graphics.fpsLimit=document.getElementById("fps-limit").value,this.settings.audio.masterVolume=parseInt(document.getElementById("master-volume").value),this.settings.audio.musicVolume=parseInt(document.getElementById("music-volume").value),this.settings.audio.sfxVolume=parseInt(document.getElementById("sfx-volume").value),this.settings.controls.mouseSensitivity=parseFloat(document.getElementById("mouse-sensitivity").value),this.settings.controls.cameraSpeed=parseFloat(document.getElementById("camera-speed").value);try{await this.applyGraphicsSettings(),this.applyAudioSettings(),this.applyControlSettings(),this.saveSettings(),this.showNotification("Settings applied successfully!")}catch(e){console.error("Error applying settings:",e),this.showNotification("Failed to apply settings")}}async applyGraphicsSettings(){this.gameEngine.isRendererReady()||(console.log("🔧 Waiting for renderer to be ready..."),await this.gameEngine.waitForRenderer());try{this.gameEngine.setGraphicsQuality(this.settings.graphics.quality),this.gameEngine.setShadowQuality(this.settings.graphics.shadowQuality);const e="off"!==this.settings.graphics.antiAliasing;this.gameEngine.setAntiAliasing(e),this.gameEngine.setVSync("on"===this.settings.graphics.vsync),this.gameEngine.setFPSLimit(this.settings.graphics.fpsLimit),this.gameEngine.setRenderDistance(this.getRenderDistanceValue()),this.gameEngine.setParticleEffects("off"!==this.settings.graphics.particleEffects),console.log("✅ Graphics settings applied successfully")}catch(e){console.error("❌ Error applying graphics settings:",e),this.showNotification("Failed to apply graphics settings")}}getRenderDistanceValue(){switch(this.settings.graphics.renderDistance){case"low":return 200;case"medium":default:return 500;case"high":return 1e3}}applyAudioSettings(){this.gameEngine.audioManager&&(this.gameEngine.audioManager.setMasterVolume(this.settings.audio.masterVolume/100),this.gameEngine.audioManager.setMusicVolume(this.settings.audio.musicVolume/100),this.gameEngine.audioManager.setSFXVolume(this.settings.audio.sfxVolume/100))}applyControlSettings(){this.gameEngine.player&&this.gameEngine.player.setCameraSpeed(this.settings.controls.cameraSpeed)}updateRenderDistance(){if(!this.gameEngine.scene)return;const e=this.gameEngine.camera;if(e){switch(this.settings.graphics.renderDistance){case"low":e.far=200;break;case"medium":e.far=500;break;case"high":e.far=1e3}e.updateProjectionMatrix()}}updateParticleEffects(){if(this.gameEngine.worldManager&&this.gameEngine.worldManager.dayNightCycle){const e=this.gameEngine.worldManager.dayNightCycle.stars;if(e){const t="off"===this.settings.graphics.particleEffects?0:"low"===this.settings.graphics.particleEffects?50:"medium"===this.settings.graphics.particleEffects?100:200;e.forEach((e,i)=>{e.visible=i<t})}}}resetSettings(){this.settings={graphics:{quality:"medium",renderDistance:"medium",shadowQuality:"medium",antiAliasing:"fxaa",particleEffects:"medium",vsync:"on",fpsLimit:"60"},audio:{masterVolume:50,musicVolume:70,sfxVolume:80},controls:{mouseSensitivity:1,cameraSpeed:1}},this.updateUI(),this.applySettings(),this.showNotification("Settings reset to default!")}saveSettings(){try{localStorage.setItem("egypt-mmo-settings",JSON.stringify(this.settings))}catch(e){console.warn("Could not save settings to localStorage:",e)}}loadSettings(){try{const e=localStorage.getItem("egypt-mmo-settings");if(e){const t=JSON.parse(e);this.settings={...this.settings,...t}}}catch(e){console.warn("Could not load settings from localStorage:",e)}}showNotification(e){const t=document.createElement("div");t.className="settings-notification",t.textContent=e,t.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #4CAF50;\n            color: white;\n            padding: 15px 20px;\n            border-radius: 8px;\n            z-index: 3000;\n            animation: slideIn 0.3s ease-out;\n        ",document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}destroy(){document.removeEventListener("keydown",this.handleKeydown),this.closeOptions()}}class te{constructor(){this.socket=null,this.isConnected=!1,this.serverUrl="http://localhost:3001",this.playerId=null,this.players=new Map,this.onPlayerJoin=null,this.onPlayerLeave=null,this.onPlayerMove=null,this.onChatMessage=null,this.onWorldUpdate=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.isInitialized=!1}async init(){this.isInitialized?console.warn("⚠️ NetworkManager already initialized, skipping..."):(console.log("🌐 Initializing Network Manager..."),this.socket=null,this.isConnected=!1,this.playerId=null,this.reconnectAttempts=0,this.maxReconnectAttempts=3,this.isInitialized=!0,console.log("✅ Network Manager initialized"))}simulateNetworkConnection(){setTimeout(()=>{this.isConnected=!0,this.playerId=this.generatePlayerId(),console.log(`🌐 Connected to server (simulated) - Player ID: ${this.playerId}`),this.simulateOtherPlayers()},1e3)}generatePlayerId(){return"player_"+Math.random().toString(36).substr(2,9)}simulateOtherPlayers(){["Anubis","Cleopatra","Ramses","Nefertiti"].forEach((e,t)=>{setTimeout(()=>{const i={id:`player_${t}`,name:e,position:{x:100*(Math.random()-.5),y:0,z:100*(Math.random()-.5)},level:Math.floor(20*Math.random())+1};this.onPlayerJoin&&this.onPlayerJoin(i)},2e3*(t+1))})}async connect(){try{return this.socket=j(this.serverUrl,{transports:["websocket"],timeout:5e3,reconnection:!1,reconnectionAttempts:0,reconnectionDelay:0}),this.setupSocketEvents(),new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error("Connection timeout - running in single-player mode"))},3e3);this.socket.on("connect",()=>{clearTimeout(i),this.isConnected=!0,this.playerId=this.socket.id,console.log(`🌐 Connected to server - Player ID: ${this.playerId}`),e()}),this.socket.on("connect_error",e=>{clearTimeout(i),console.log("🌐 Single-player mode: No server available"),t(new Error("No server available - running in single-player mode"))})})}catch(e){throw console.error("Failed to connect to server:",e),e}}setupSocketEvents(){this.socket&&(this.socket.on("disconnect",()=>{this.isConnected=!1,console.log("🌐 Disconnected from server")}),this.socket.on("player_join",e=>{this.onPlayerJoin&&this.onPlayerJoin(e)}),this.socket.on("player_leave",e=>{this.onPlayerLeave&&this.onPlayerLeave(e)}),this.socket.on("player_move",e=>{this.onPlayerMove&&this.onPlayerMove(e)}),this.socket.on("chat_message",e=>{this.onChatMessage&&this.onChatMessage(e)}),this.socket.on("world_update",e=>{this.onWorldUpdate&&this.onWorldUpdate(e)}))}disconnect(){this.socket&&(this.socket.disconnect(),this.socket=null),this.isConnected=!1,this.playerId=null,console.log("🌐 Disconnected from server")}sendPlayerPosition(e){this.socket&&this.isConnected&&this.socket.emit("player_move",{position:e,timestamp:Date.now()})}sendPlayerAction(e,t){this.socket&&this.isConnected&&this.socket.emit("player_action",{action:e,data:t,timestamp:Date.now()})}sendChatMessage(e,t="global"){this.socket&&this.isConnected&&this.socket.emit("chat_message",{message:e,channel:t,timestamp:Date.now()})}sendCraftRequest(e,t){this.socket&&this.isConnected&&this.socket.emit("craft_request",{itemId:e,materials:t,timestamp:Date.now()})}sendTradeRequest(e,t,i){this.socket&&this.isConnected&&this.socket.emit("trade_request",{targetPlayerId:e,items:t,gold:i,timestamp:Date.now()})}sendResourceGather(e,t){this.socket&&this.isConnected&&this.socket.emit("resource_gather",{resourceId:e,position:t,timestamp:Date.now()})}sendBuildingPlace(e,t,i){this.socket&&this.isConnected&&this.socket.emit("building_place",{buildingType:e,position:t,rotation:i,timestamp:Date.now()})}onPlayerJoin(e){this.onPlayerJoin=e}onPlayerLeave(e){this.onPlayerLeave=e}onPlayerMove(e){this.onPlayerMove=e}onChatMessage(e){this.onChatMessage=e}onWorldUpdate(e){this.onWorldUpdate=e}isConnected(){return this.isConnected}getPlayerId(){return this.playerId}getConnectedPlayers(){return Array.from(this.players.values())}getNetworkStats(){return this.socket?{connected:this.isConnected,latency:this.socket.connected?this.socket.io.engine.ping:null,transport:this.socket.io.engine.transport.name,reconnectionAttempts:this.reconnectAttempts}:null}destroy(){this.disconnect(),this.players.clear(),console.log("🌐 Network Manager destroyed")}}var ie="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},oe={};
/*!
       *  howler.js v2.2.4
       *  howlerjs.com
       *
       *  (c) 2013-2020, James Simpson of GoldFire Studios
       *  goldfirestudios.com
       *
       *  MIT License
       */
!function(e){!function(){var t=function(){this.init()};t.prototype={init:function(){var e=this||i;return e._counter=1e3,e._html5AudioPool=[],e.html5PoolSize=10,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.autoUnlock=!0,e._setup(),e},volume:function(e){var t=this||i;if(e=parseFloat(e),t.ctx||c(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,i.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var n=t._howls[o]._getSoundIds(),s=0;s<n.length;s++){var a=t._howls[o]._soundById(n[s]);a&&a._node&&(a._node.volume=a._volume*e)}return t}return t._volume},mute:function(e){var t=this||i;t.ctx||c(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,i.ctx.currentTime);for(var o=0;o<t._howls.length;o++)if(!t._howls[o]._webAudio)for(var n=t._howls[o]._getSoundIds(),s=0;s<n.length;s++){var a=t._howls[o]._soundById(n[s]);a&&a._node&&(a._node.muted=!!e||a._muted)}return t},stop:function(){for(var e=this||i,t=0;t<e._howls.length;t++)e._howls[t].stop();return e},unload:function(){for(var e=this||i,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,c()),e},codecs:function(e){return(this||i)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||i;if(e.state=e.ctx&&e.ctx.state||"suspended",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{void 0===(new Audio).oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0;try{(new Audio).muted&&(e.noAudio=!0)}catch(t){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||i,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(c){return e}if(!t||"function"!=typeof t.canPlayType)return e;var o=t.canPlayType("audio/mpeg;").replace(/^no$/,""),n=e._navigator?e._navigator.userAgent:"",s=n.match(/OPR\/(\d+)/g),a=s&&parseInt(s[0].split("/")[1],10)<33,r=-1!==n.indexOf("Safari")&&-1===n.indexOf("Chrome"),l=n.match(/Version\/(.*?) /),d=r&&l&&parseInt(l[1],10)<15;return e._codecs={mp3:!(a||!o&&!t.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!o,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(t.canPlayType('audio/wav; codecs="1"')||t.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(t.canPlayType("audio/x-m4b;")||t.canPlayType("audio/m4b;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!(d||!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!(d||!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_unlockAudio:function(){var e=this||i;if(!e._audioUnlocked&&e.ctx){e._audioUnlocked=!1,e.autoUnlock=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var t=function(i){for(;e._html5AudioPool.length<e.html5PoolSize;)try{var o=new Audio;o._unlocked=!0,e._releaseHtml5Audio(o)}catch(i){e.noAudio=!0;break}for(var n=0;n<e._howls.length;n++)if(!e._howls[n]._webAudio)for(var s=e._howls[n]._getSoundIds(),a=0;a<s.length;a++){var r=e._howls[n]._soundById(s[a]);r&&r._node&&!r._node._unlocked&&(r._node._unlocked=!0,r._node.load())}e._autoResume();var l=e.ctx.createBufferSource();l.buffer=e._scratchBuffer,l.connect(e.ctx.destination),void 0===l.start?l.noteOn(0):l.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),l.onended=function(){l.disconnect(0),e._audioUnlocked=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0);for(var i=0;i<e._howls.length;i++)e._howls[i]._emit("unlock")}};return document.addEventListener("touchstart",t,!0),document.addEventListener("touchend",t,!0),document.addEventListener("click",t,!0),document.addEventListener("keydown",t,!0),e}},_obtainHtml5Audio:function(){var e=this||i;if(e._html5AudioPool.length)return e._html5AudioPool.pop();var t=(new Audio).play();return t&&"undefined"!=typeof Promise&&(t instanceof Promise||"function"==typeof t.then)&&t.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(e){var t=this||i;return e._unlocked&&t._html5AudioPool.push(e),t},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&i.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio)for(var o=0;o<e._howls[t]._sounds.length;o++)if(!e._howls[t]._sounds[o]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){if(e.autoSuspend){e._suspendTimer=null,e.state="suspending";var t=function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())};e.ctx.suspend().then(t,t)}},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&i.usingWebAudio)return"running"===e.state&&"interrupted"!==e.ctx.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state||"running"===e.state&&"interrupted"===e.ctx.state?(e.ctx.resume().then(function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var i=new t,o=function(e){e.src&&0!==e.src.length?this.init(e):console.error("An array of source files must be passed with any new Howl.")};o.prototype={init:function(e){var t=this;return i.ctx||c(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload&&"metadata"!==e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhr={method:e.xhr&&e.xhr.method?e.xhr.method:"GET",headers:e.xhr&&e.xhr.headers?e.xhr.headers:null,withCredentials:!(!e.xhr||!e.xhr.withCredentials)&&e.xhr.withCredentials},t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=i.usingWebAudio&&!t._html5,void 0!==i.ctx&&i.ctx&&i.autoUnlock&&i._unlockAudio(),i._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&"none"!==t._preload&&t.load(),t},load:function(){var e=this,t=null;if(i.noAudio)e._emit("loaderror",null,"No audio support.");else{"string"==typeof e._src&&(e._src=[e._src]);for(var o=0;o<e._src.length;o++){var s,r;if(e._format&&e._format[o])s=e._format[o];else{if("string"!=typeof(r=e._src[o])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}(s=/^data:audio\/([^;,]+);/i.exec(r))||(s=/\.([^.]+)$/.exec(r.split("?",1)[0])),s&&(s=s[1].toLowerCase())}if(s||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),s&&i.codecs(s)){t=e._src[o];break}}if(t)return e._src=t,e._state="loading","https:"===window.location.protocol&&"http:"===t.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new n(e),e._webAudio&&a(e),e;e._emit("loaderror",null,"No codec support for selected audio sources.")}},play:function(e,t){var o=this,n=null;if("number"==typeof e)n=e,e=null;else{if("string"==typeof e&&"loaded"===o._state&&!o._sprite[e])return null;if(void 0===e&&(e="__default",!o._playLock)){for(var s=0,a=0;a<o._sounds.length;a++)o._sounds[a]._paused&&!o._sounds[a]._ended&&(s++,n=o._sounds[a]._id);1===s?e=null:n=null}}var r=n?o._soundById(n):o._inactiveSound();if(!r)return null;if(n&&!e&&(e=r._sprite||"__default"),"loaded"!==o._state){r._sprite=e,r._ended=!1;var l=r._id;return o._queue.push({event:"play",action:function(){o.play(l)}}),l}if(n&&!r._paused)return t||o._loadQueue("play"),r._id;o._webAudio&&i._autoResume();var d=Math.max(0,r._seek>0?r._seek:o._sprite[e][0]/1e3),c=Math.max(0,(o._sprite[e][0]+o._sprite[e][1])/1e3-d),h=1e3*c/Math.abs(r._rate),u=o._sprite[e][0]/1e3,p=(o._sprite[e][0]+o._sprite[e][1])/1e3;r._sprite=e,r._ended=!1;var m=function(){r._paused=!1,r._seek=d,r._start=u,r._stop=p,r._loop=!(!r._loop&&!o._sprite[e][2])};if(!(d>=p)){var g=r._node;if(o._webAudio){var y=function(){o._playLock=!1,m(),o._refreshBuffer(r);var e=r._muted||o._muted?0:r._volume;g.gain.setValueAtTime(e,i.ctx.currentTime),r._playStart=i.ctx.currentTime,void 0===g.bufferSource.start?r._loop?g.bufferSource.noteGrainOn(0,d,86400):g.bufferSource.noteGrainOn(0,d,c):r._loop?g.bufferSource.start(0,d,86400):g.bufferSource.start(0,d,c),h!==1/0&&(o._endTimers[r._id]=setTimeout(o._ended.bind(o,r),h)),t||setTimeout(function(){o._emit("play",r._id),o._loadQueue()},0)};"running"===i.state&&"interrupted"!==i.ctx.state?y():(o._playLock=!0,o.once("resume",y),o._clearTimer(r._id))}else{var f=function(){g.currentTime=d,g.muted=r._muted||o._muted||i._muted||g.muted,g.volume=r._volume*i.volume(),g.playbackRate=r._rate;try{var n=g.play();if(n&&"undefined"!=typeof Promise&&(n instanceof Promise||"function"==typeof n.then)?(o._playLock=!0,m(),n.then(function(){o._playLock=!1,g._unlocked=!0,t?o._loadQueue():o._emit("play",r._id)}).catch(function(){o._playLock=!1,o._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),r._ended=!0,r._paused=!0})):t||(o._playLock=!1,m(),o._emit("play",r._id)),g.playbackRate=r._rate,g.paused)return void o._emit("playerror",r._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||r._loop?o._endTimers[r._id]=setTimeout(o._ended.bind(o,r),h):(o._endTimers[r._id]=function(){o._ended(r),g.removeEventListener("ended",o._endTimers[r._id],!1)},g.addEventListener("ended",o._endTimers[r._id],!1))}catch(s){o._emit("playerror",r._id,s)}};"data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"===g.src&&(g.src=o._src,g.load());var w=window&&window.ejecta||!g.readyState&&i._navigator.isCocoonJS;if(g.readyState>=3||w)f();else{o._playLock=!0,o._state="loading";var v=function(){o._state="loaded",f(),g.removeEventListener(i._canPlayEvent,v,!1)};g.addEventListener(i._canPlayEvent,v,!1),o._clearTimer(r._id)}}return r._id}o._ended(r)},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var i=t._getSoundIds(e),o=0;o<i.length;o++){t._clearTimer(i[o]);var n=t._soundById(i[o]);if(n&&!n._paused&&(n._seek=t.seek(i[o]),n._rateSeek=0,n._paused=!0,t._stopFade(i[o]),n._node))if(t._webAudio){if(!n._node.bufferSource)continue;void 0===n._node.bufferSource.stop?n._node.bufferSource.noteOff(0):n._node.bufferSource.stop(0),t._cleanBuffer(n._node)}else isNaN(n._node.duration)&&n._node.duration!==1/0||n._node.pause();arguments[1]||t._emit("pause",n?n._id:null)}return t},stop:function(e,t){var i=this;if("loaded"!==i._state||i._playLock)return i._queue.push({event:"stop",action:function(){i.stop(e)}}),i;for(var o=i._getSoundIds(e),n=0;n<o.length;n++){i._clearTimer(o[n]);var s=i._soundById(o[n]);s&&(s._seek=s._start||0,s._rateSeek=0,s._paused=!0,s._ended=!0,i._stopFade(o[n]),s._node&&(i._webAudio?s._node.bufferSource&&(void 0===s._node.bufferSource.stop?s._node.bufferSource.noteOff(0):s._node.bufferSource.stop(0),i._cleanBuffer(s._node)):isNaN(s._node.duration)&&s._node.duration!==1/0||(s._node.currentTime=s._start||0,s._node.pause(),s._node.duration===1/0&&i._clearSound(s._node))),t||i._emit("stop",s._id))}return i},mute:function(e,t){var o=this;if("loaded"!==o._state||o._playLock)return o._queue.push({event:"mute",action:function(){o.mute(e,t)}}),o;if(void 0===t){if("boolean"!=typeof e)return o._muted;o._muted=e}for(var n=o._getSoundIds(t),s=0;s<n.length;s++){var a=o._soundById(n[s]);a&&(a._muted=e,a._interval&&o._stopFade(a._id),o._webAudio&&a._node?a._node.gain.setValueAtTime(e?0:a._volume,i.ctx.currentTime):a._node&&(a._node.muted=!!i._muted||e),o._emit("mute",a._id))}return o},volume:function(){var e,t,o,n=this,s=arguments;if(0===s.length)return n._volume;if(1===s.length||2===s.length&&void 0===s[1]?n._getSoundIds().indexOf(s[0])>=0?t=parseInt(s[0],10):e=parseFloat(s[0]):s.length>=2&&(e=parseFloat(s[0]),t=parseInt(s[1],10)),!(void 0!==e&&e>=0&&e<=1))return(o=t?n._soundById(t):n._sounds[0])?o._volume:0;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"volume",action:function(){n.volume.apply(n,s)}}),n;void 0===t&&(n._volume=e),t=n._getSoundIds(t);for(var a=0;a<t.length;a++)(o=n._soundById(t[a]))&&(o._volume=e,s[2]||n._stopFade(t[a]),n._webAudio&&o._node&&!o._muted?o._node.gain.setValueAtTime(e,i.ctx.currentTime):o._node&&!o._muted&&(o._node.volume=e*i.volume()),n._emit("volume",o._id));return n},fade:function(e,t,o,n){var s=this;if("loaded"!==s._state||s._playLock)return s._queue.push({event:"fade",action:function(){s.fade(e,t,o,n)}}),s;e=Math.min(Math.max(0,parseFloat(e)),1),t=Math.min(Math.max(0,parseFloat(t)),1),o=parseFloat(o),s.volume(e,n);for(var a=s._getSoundIds(n),r=0;r<a.length;r++){var l=s._soundById(a[r]);if(l){if(n||s._stopFade(a[r]),s._webAudio&&!l._muted){var d=i.ctx.currentTime,c=d+o/1e3;l._volume=e,l._node.gain.setValueAtTime(e,d),l._node.gain.linearRampToValueAtTime(t,c)}s._startFadeInterval(l,e,t,o,a[r],void 0===n)}}return s},_startFadeInterval:function(e,t,i,o,n,s){var a=this,r=t,l=i-t,d=Math.abs(l/.01),c=Math.max(4,d>0?o/d:o),h=Date.now();e._fadeTo=i,e._interval=setInterval(function(){var n=(Date.now()-h)/o;h=Date.now(),r+=l*n,r=Math.round(100*r)/100,r=l<0?Math.max(i,r):Math.min(i,r),a._webAudio?e._volume=r:a.volume(r,e._id,!0),s&&(a._volume=r),(i<t&&r<=i||i>t&&r>=i)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,a.volume(i,e._id),a._emit("fade",e._id))},c)},_stopFade:function(e){var t=this,o=t._soundById(e);return o&&o._interval&&(t._webAudio&&o._node.gain.cancelScheduledValues(i.ctx.currentTime),clearInterval(o._interval),o._interval=null,t.volume(o._fadeTo,e),o._fadeTo=null,t._emit("fade",e)),t},loop:function(){var e,t,i,o=this,n=arguments;if(0===n.length)return o._loop;if(1===n.length){if("boolean"!=typeof n[0])return!!(i=o._soundById(parseInt(n[0],10)))&&i._loop;e=n[0],o._loop=e}else 2===n.length&&(e=n[0],t=parseInt(n[1],10));for(var s=o._getSoundIds(t),a=0;a<s.length;a++)(i=o._soundById(s[a]))&&(i._loop=e,o._webAudio&&i._node&&i._node.bufferSource&&(i._node.bufferSource.loop=e,e&&(i._node.bufferSource.loopStart=i._start||0,i._node.bufferSource.loopEnd=i._stop,o.playing(s[a])&&(o.pause(s[a],!0),o.play(s[a],!0)))));return o},rate:function(){var e,t,o,n=this,s=arguments;if(0===s.length?t=n._sounds[0]._id:1===s.length?n._getSoundIds().indexOf(s[0])>=0?t=parseInt(s[0],10):e=parseFloat(s[0]):2===s.length&&(e=parseFloat(s[0]),t=parseInt(s[1],10)),"number"!=typeof e)return(o=n._soundById(t))?o._rate:n._rate;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"rate",action:function(){n.rate.apply(n,s)}}),n;void 0===t&&(n._rate=e),t=n._getSoundIds(t);for(var a=0;a<t.length;a++)if(o=n._soundById(t[a])){n.playing(t[a])&&(o._rateSeek=n.seek(t[a]),o._playStart=n._webAudio?i.ctx.currentTime:o._playStart),o._rate=e,n._webAudio&&o._node&&o._node.bufferSource?o._node.bufferSource.playbackRate.setValueAtTime(e,i.ctx.currentTime):o._node&&(o._node.playbackRate=e);var r=n.seek(t[a]),l=1e3*((n._sprite[o._sprite][0]+n._sprite[o._sprite][1])/1e3-r)/Math.abs(o._rate);!n._endTimers[t[a]]&&o._paused||(n._clearTimer(t[a]),n._endTimers[t[a]]=setTimeout(n._ended.bind(n,o),l)),n._emit("rate",o._id)}return n},seek:function(){var e,t,o=this,n=arguments;if(0===n.length?o._sounds.length&&(t=o._sounds[0]._id):1===n.length?o._getSoundIds().indexOf(n[0])>=0?t=parseInt(n[0],10):o._sounds.length&&(t=o._sounds[0]._id,e=parseFloat(n[0])):2===n.length&&(e=parseFloat(n[0]),t=parseInt(n[1],10)),void 0===t)return 0;if("number"==typeof e&&("loaded"!==o._state||o._playLock))return o._queue.push({event:"seek",action:function(){o.seek.apply(o,n)}}),o;var s=o._soundById(t);if(s){if(!("number"==typeof e&&e>=0)){if(o._webAudio){var a=o.playing(t)?i.ctx.currentTime-s._playStart:0,r=s._rateSeek?s._rateSeek-s._seek:0;return s._seek+(r+a*Math.abs(s._rate))}return s._node.currentTime}var l=o.playing(t);l&&o.pause(t,!0),s._seek=e,s._ended=!1,o._clearTimer(t),o._webAudio||!s._node||isNaN(s._node.duration)||(s._node.currentTime=e);var d=function(){l&&o.play(t,!0),o._emit("seek",t)};if(l&&!o._webAudio){var c=function(){o._playLock?setTimeout(c,0):d()};setTimeout(c,0)}else d()}return o},playing:function(e){var t=this;if("number"==typeof e){var i=t._soundById(e);return!!i&&!i._paused}for(var o=0;o<t._sounds.length;o++)if(!t._sounds[o]._paused)return!0;return!1},duration:function(e){var t=this,i=t._duration,o=t._soundById(e);return o&&(i=t._sprite[o._sprite][1]/1e3),i},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,o=0;o<t.length;o++)t[o]._paused||e.stop(t[o]._id),e._webAudio||(e._clearSound(t[o]._node),t[o]._node.removeEventListener("error",t[o]._errorFn,!1),t[o]._node.removeEventListener(i._canPlayEvent,t[o]._loadFn,!1),t[o]._node.removeEventListener("ended",t[o]._endFn,!1),i._releaseHtml5Audio(t[o]._node)),delete t[o]._node,e._clearTimer(t[o]._id);var n=i._howls.indexOf(e);n>=0&&i._howls.splice(n,1);var a=!0;for(o=0;o<i._howls.length;o++)if(i._howls[o]._src===e._src||e._src.indexOf(i._howls[o]._src)>=0){a=!1;break}return s&&a&&delete s[e._src],i.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,i,o){var n=this["_on"+e];return"function"==typeof t&&n.push(o?{id:i,fn:t,once:o}:{id:i,fn:t}),this},off:function(e,t,i){var o=this,n=o["_on"+e],s=0;if("number"==typeof t&&(i=t,t=null),t||i)for(s=0;s<n.length;s++){var a=i===n[s].id;if(t===n[s].fn&&a||!t&&a){n.splice(s,1);break}}else if(e)o["_on"+e]=[];else{var r=Object.keys(o);for(s=0;s<r.length;s++)0===r[s].indexOf("_on")&&Array.isArray(o[r[s]])&&(o[r[s]]=[])}return o},once:function(e,t,i){return this.on(e,t,i,1),this},_emit:function(e,t,i){for(var o=this,n=o["_on"+e],s=n.length-1;s>=0;s--)n[s].id&&n[s].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,i)}.bind(o,n[s].fn),0),n[s].once&&o.off(e,n[s].fn,n[s].id));return o._loadQueue(e),o},_loadQueue:function(e){var t=this;if(t._queue.length>0){var i=t._queue[0];i.event===e&&(t._queue.shift(),t._loadQueue()),e||i.action()}return t},_ended:function(e){var t=this,o=e._sprite;if(!t._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(t._ended.bind(t,e),100),t;var n=!(!e._loop&&!t._sprite[o][2]);if(t._emit("end",e._id),!t._webAudio&&n&&t.stop(e._id,!0).play(e._id),t._webAudio&&n){t._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=i.ctx.currentTime;var s=1e3*(e._stop-e._start)/Math.abs(e._rate);t._endTimers[e._id]=setTimeout(t._ended.bind(t,e),s)}return t._webAudio&&!n&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,t._clearTimer(e._id),t._cleanBuffer(e._node),i._autoSuspend()),t._webAudio||n||t.stop(e._id,!0),t},_clearTimer:function(e){var t=this;if(t._endTimers[e]){if("function"!=typeof t._endTimers[e])clearTimeout(t._endTimers[e]);else{var i=t._soundById(e);i&&i._node&&i._node.removeEventListener("ended",t._endTimers[e],!1)}delete t._endTimers[e]}return t},_soundById:function(e){for(var t=this,i=0;i<t._sounds.length;i++)if(e===t._sounds[i]._id)return t._sounds[i];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new n(e)},_drain:function(){var e=this,t=e._pool,i=0,o=0;if(!(e._sounds.length<t)){for(o=0;o<e._sounds.length;o++)e._sounds[o]._ended&&i++;for(o=e._sounds.length-1;o>=0;o--){if(i<=t)return;e._sounds[o]._ended&&(e._webAudio&&e._sounds[o]._node&&e._sounds[o]._node.disconnect(0),e._sounds.splice(o,1),i--)}}},_getSoundIds:function(e){if(void 0===e){for(var t=[],i=0;i<this._sounds.length;i++)t.push(this._sounds[i]._id);return t}return[e]},_refreshBuffer:function(e){return e._node.bufferSource=i.ctx.createBufferSource(),e._node.bufferSource.buffer=s[this._src],e._panner?e._node.bufferSource.connect(e._panner):e._node.bufferSource.connect(e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,i.ctx.currentTime),this},_cleanBuffer:function(e){var t=i._navigator&&i._navigator.vendor.indexOf("Apple")>=0;if(!e.bufferSource)return this;if(i._scratchBuffer&&e.bufferSource&&(e.bufferSource.onended=null,e.bufferSource.disconnect(0),t))try{e.bufferSource.buffer=i._scratchBuffer}catch(o){}return e.bufferSource=null,this},_clearSound:function(e){/MSIE |Trident\//.test(i._navigator&&i._navigator.userAgent)||(e.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var n=function(e){this._parent=e,this.init()};n.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++i._counter,t._sounds.push(e),e.create(),e},create:function(){var e=this,t=e._parent,o=i._muted||e._muted||e._parent._muted?0:e._volume;return t._webAudio?(e._node=void 0===i.ctx.createGain?i.ctx.createGainNode():i.ctx.createGain(),e._node.gain.setValueAtTime(o,i.ctx.currentTime),e._node.paused=!0,e._node.connect(i.masterGain)):i.noAudio||(e._node=i._obtainHtml5Audio(),e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(i._canPlayEvent,e._loadFn,!1),e._endFn=e._endListener.bind(e),e._node.addEventListener("ended",e._endFn,!1),e._node.src=t._src,e._node.preload=!0===t._preload?"auto":t._preload,e._node.volume=o*i.volume(),e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++i._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,t=e._parent;t._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue()),e._node.removeEventListener(i._canPlayEvent,e._loadFn,!1)},_endListener:function(){var e=this,t=e._parent;t._duration===1/0&&(t._duration=Math.ceil(10*e._node.duration)/10,t._sprite.__default[1]===1/0&&(t._sprite.__default[1]=1e3*t._duration),t._ended(e)),e._node.removeEventListener("ended",e._endFn,!1)}};var s={},a=function(e){var t=e._src;if(s[t])return e._duration=s[t].duration,void d(e);if(/^data:[^;]+;base64,/.test(t)){for(var i=atob(t.split(",")[1]),o=new Uint8Array(i.length),n=0;n<i.length;++n)o[n]=i.charCodeAt(n);l(o.buffer,e)}else{var a=new XMLHttpRequest;a.open(e._xhr.method,t,!0),a.withCredentials=e._xhr.withCredentials,a.responseType="arraybuffer",e._xhr.headers&&Object.keys(e._xhr.headers).forEach(function(t){a.setRequestHeader(t,e._xhr.headers[t])}),a.onload=function(){var t=(a.status+"")[0];"0"===t||"2"===t||"3"===t?l(a.response,e):e._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".")},a.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete s[t],e.load())},r(a)}},r=function(e){try{e.send()}catch(t){e.onerror()}},l=function(e,t){var o=function(){t._emit("loaderror",null,"Decoding audio data failed.")},n=function(e){e&&t._sounds.length>0?(s[t._src]=e,d(t,e)):o()};"undefined"!=typeof Promise&&1===i.ctx.decodeAudioData.length?i.ctx.decodeAudioData(e).then(n).catch(o):i.ctx.decodeAudioData(e,n,o)},d=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},c=function(){if(i.usingWebAudio){try{"undefined"!=typeof AudioContext?i.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?i.ctx=new webkitAudioContext:i.usingWebAudio=!1}catch(s){i.usingWebAudio=!1}i.ctx||(i.usingWebAudio=!1);var e=/iP(hone|od|ad)/.test(i._navigator&&i._navigator.platform),t=i._navigator&&i._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),o=t?parseInt(t[1],10):null;if(e&&o&&o<9){var n=/safari/.test(i._navigator&&i._navigator.userAgent.toLowerCase());i._navigator&&!n&&(i.usingWebAudio=!1)}i.usingWebAudio&&(i.masterGain=void 0===i.ctx.createGain?i.ctx.createGainNode():i.ctx.createGain(),i.masterGain.gain.setValueAtTime(i._muted?0:i._volume,i.ctx.currentTime),i.masterGain.connect(i.ctx.destination)),i._setup()}};e.Howler=i,e.Howl=o,void 0!==ie?(ie.HowlerGlobal=t,ie.Howler=i,ie.Howl=o,ie.Sound=n):"undefined"!=typeof window&&(window.HowlerGlobal=t,window.Howler=i,window.Howl=o,window.Sound=n)}(),
/*!
      	 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
      	 *  
      	 *  howler.js v2.2.4
      	 *  howlerjs.com
      	 *
      	 *  (c) 2013-2020, James Simpson of GoldFire Studios
      	 *  goldfirestudios.com
      	 *
      	 *  MIT License
      	 */
function(){var e;HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var t=this;if(!t.ctx||!t.ctx.listener)return t;for(var i=t._howls.length-1;i>=0;i--)t._howls[i].stereo(e);return t},HowlerGlobal.prototype.pos=function(e,t,i){var o=this;return o.ctx&&o.ctx.listener?(t="number"!=typeof t?o._pos[1]:t,i="number"!=typeof i?o._pos[2]:i,"number"!=typeof e?o._pos:(o._pos=[e,t,i],void 0!==o.ctx.listener.positionX?(o.ctx.listener.positionX.setTargetAtTime(o._pos[0],Howler.ctx.currentTime,.1),o.ctx.listener.positionY.setTargetAtTime(o._pos[1],Howler.ctx.currentTime,.1),o.ctx.listener.positionZ.setTargetAtTime(o._pos[2],Howler.ctx.currentTime,.1)):o.ctx.listener.setPosition(o._pos[0],o._pos[1],o._pos[2]),o)):o},HowlerGlobal.prototype.orientation=function(e,t,i,o,n,s){var a=this;if(!a.ctx||!a.ctx.listener)return a;var r=a._orientation;return t="number"!=typeof t?r[1]:t,i="number"!=typeof i?r[2]:i,o="number"!=typeof o?r[3]:o,n="number"!=typeof n?r[4]:n,s="number"!=typeof s?r[5]:s,"number"!=typeof e?r:(a._orientation=[e,t,i,o,n,s],void 0!==a.ctx.listener.forwardX?(a.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),a.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),a.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),a.ctx.listener.upX.setTargetAtTime(o,Howler.ctx.currentTime,.1),a.ctx.listener.upY.setTargetAtTime(n,Howler.ctx.currentTime,.1),a.ctx.listener.upZ.setTargetAtTime(s,Howler.ctx.currentTime,.1)):a.ctx.listener.setOrientation(e,t,i,o,n,s),a)},Howl.prototype.init=(e=Howl.prototype.init,function(t){var i=this;return i._orientation=t.orientation||[1,0,0],i._stereo=t.stereo||null,i._pos=t.pos||null,i._pannerAttr={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:360,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:360,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:0,distanceModel:void 0!==t.distanceModel?t.distanceModel:"inverse",maxDistance:void 0!==t.maxDistance?t.maxDistance:1e4,panningModel:void 0!==t.panningModel?t.panningModel:"HRTF",refDistance:void 0!==t.refDistance?t.refDistance:1,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:1},i._onstereo=t.onstereo?[{fn:t.onstereo}]:[],i._onpos=t.onpos?[{fn:t.onpos}]:[],i._onorientation=t.onorientation?[{fn:t.onorientation}]:[],e.call(this,t)}),Howl.prototype.stereo=function(e,i){var o=this;if(!o._webAudio)return o;if("loaded"!==o._state)return o._queue.push({event:"stereo",action:function(){o.stereo(e,i)}}),o;var n=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===i){if("number"!=typeof e)return o._stereo;o._stereo=e,o._pos=[e,0,0]}for(var s=o._getSoundIds(i),a=0;a<s.length;a++){var r=o._soundById(s[a]);if(r){if("number"!=typeof e)return r._stereo;r._stereo=e,r._pos=[e,0,0],r._node&&(r._pannerAttr.panningModel="equalpower",r._panner&&r._panner.pan||t(r,n),"spatial"===n?void 0!==r._panner.positionX?(r._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),r._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),r._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):r._panner.setPosition(e,0,0):r._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),o._emit("stereo",r._id)}}return o},Howl.prototype.pos=function(e,i,o,n){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"pos",action:function(){s.pos(e,i,o,n)}}),s;if(i="number"!=typeof i?0:i,o="number"!=typeof o?-.5:o,void 0===n){if("number"!=typeof e)return s._pos;s._pos=[e,i,o]}for(var a=s._getSoundIds(n),r=0;r<a.length;r++){var l=s._soundById(a[r]);if(l){if("number"!=typeof e)return l._pos;l._pos=[e,i,o],l._node&&(l._panner&&!l._panner.pan||t(l,"spatial"),void 0!==l._panner.positionX?(l._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),l._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),l._panner.positionZ.setValueAtTime(o,Howler.ctx.currentTime)):l._panner.setPosition(e,i,o)),s._emit("pos",l._id)}}return s},Howl.prototype.orientation=function(e,i,o,n){var s=this;if(!s._webAudio)return s;if("loaded"!==s._state)return s._queue.push({event:"orientation",action:function(){s.orientation(e,i,o,n)}}),s;if(i="number"!=typeof i?s._orientation[1]:i,o="number"!=typeof o?s._orientation[2]:o,void 0===n){if("number"!=typeof e)return s._orientation;s._orientation=[e,i,o]}for(var a=s._getSoundIds(n),r=0;r<a.length;r++){var l=s._soundById(a[r]);if(l){if("number"!=typeof e)return l._orientation;l._orientation=[e,i,o],l._node&&(l._panner||(l._pos||(l._pos=s._pos||[0,0,-.5]),t(l,"spatial")),void 0!==l._panner.orientationX?(l._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),l._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),l._panner.orientationZ.setValueAtTime(o,Howler.ctx.currentTime)):l._panner.setOrientation(e,i,o)),s._emit("orientation",l._id)}}return s},Howl.prototype.pannerAttr=function(){var e,i,o,n=this,s=arguments;if(!n._webAudio)return n;if(0===s.length)return n._pannerAttr;if(1===s.length){if("object"!=typeof s[0])return(o=n._soundById(parseInt(s[0],10)))?o._pannerAttr:n._pannerAttr;e=s[0],void 0===i&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),n._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:n._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:n._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:n._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:n._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:n._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:n._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:n._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:n._panningModel})}else 2===s.length&&(e=s[0],i=parseInt(s[1],10));for(var a=n._getSoundIds(i),r=0;r<a.length;r++)if(o=n._soundById(a[r])){var l=o._pannerAttr;l={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:l.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:l.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:l.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:l.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:l.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:l.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:l.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:l.panningModel};var d=o._panner;d||(o._pos||(o._pos=n._pos||[0,0,-.5]),t(o,"spatial"),d=o._panner),d.coneInnerAngle=l.coneInnerAngle,d.coneOuterAngle=l.coneOuterAngle,d.coneOuterGain=l.coneOuterGain,d.distanceModel=l.distanceModel,d.maxDistance=l.maxDistance,d.refDistance=l.refDistance,d.rolloffFactor=l.rolloffFactor,d.panningModel=l.panningModel}return n},Sound.prototype.init=function(e){return function(){var t=this,i=t._parent;t._orientation=i._orientation,t._stereo=i._stereo,t._pos=i._pos,t._pannerAttr=i._pannerAttr,e.call(this),t._stereo?i.stereo(t._stereo):t._pos&&i.pos(t._pos[0],t._pos[1],t._pos[2],t._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var t=this,i=t._parent;return t._orientation=i._orientation,t._stereo=i._stereo,t._pos=i._pos,t._pannerAttr=i._pannerAttr,t._stereo?i.stereo(t._stereo):t._pos?i.pos(t._pos[0],t._pos[1],t._pos[2],t._id):t._panner&&(t._panner.disconnect(0),t._panner=void 0,i._refreshBuffer(t)),e.call(this)}}(Sound.prototype.reset);var t=function(e,t){"spatial"===(t=t||"spatial")?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}()}(oe);class ne{constructor(){this.settings={masterVolume:.7,musicVolume:.5,sfxVolume:.8},this.musicTracks=new Map,this.soundEffects=new Map,this.currentMusic=null,this.isInitialized=!1,this.soundEnabled=!0,this.musicEnabled=!0,this.ambientEnabled=!0,this.categories={ui:"ui",combat:"combat",crafting:"crafting",environment:"environment",music:"music",ambient:"ambient"},this.init()}async init(){if(this.isInitialized)console.warn("⚠️ AudioManager already initialized, skipping...");else{console.log("🎵 Initializing Audio Manager...");try{oe.Howler.volume(this.settings.masterVolume),this.loadMusic(),this.loadSounds(),this.isInitialized=!0,console.log("✅ Audio Manager initialized")}catch(e){throw console.error("❌ Failed to initialize Audio Manager:",e),e}}}setupAudioContext(){oe.Howler.volume(this.masterVolume),document.addEventListener("click",()=>{"suspended"===oe.Howler.ctx.state&&oe.Howler.ctx.resume()},{once:!0})}loadSounds(){this.loadSound("button_click","ui",{src:["/sounds/ui/button_click.mp3"],volume:.6,rate:1}),this.loadSound("panel_open","ui",{src:["/sounds/ui/panel_open.mp3"],volume:.5,rate:1}),this.loadSound("panel_close","ui",{src:["/sounds/ui/panel_close.mp3"],volume:.5,rate:1}),this.loadSound("notification","ui",{src:["/sounds/ui/notification.mp3"],volume:.7,rate:1}),this.loadSound("hammer_strike","crafting",{src:["/sounds/crafting/hammer_strike.mp3"],volume:.8,rate:1}),this.loadSound("metal_clang","crafting",{src:["/sounds/crafting/metal_clang.mp3"],volume:.7,rate:1}),this.loadSound("wood_cut","crafting",{src:["/sounds/crafting/wood_cut.mp3"],volume:.6,rate:1}),this.loadSound("potion_bubble","crafting",{src:["/sounds/crafting/potion_bubble.mp3"],volume:.5,rate:1}),this.loadSound("wind_ambient","environment",{src:["/sounds/environment/wind_ambient.mp3"],volume:.4,rate:1,loop:!0}),this.loadSound("sand_footstep","environment",{src:["/sounds/environment/sand_footstep.mp3"],volume:.6,rate:1}),this.loadSound("water_splash","environment",{src:["/sounds/environment/water_splash.mp3"],volume:.7,rate:1}),this.loadSound("fire_crackle","environment",{src:["/sounds/environment/fire_crackle.mp3"],volume:.5,rate:1,loop:!0}),this.loadSound("sword_swing","combat",{src:["/sounds/combat/sword_swing.mp3"],volume:.8,rate:1}),this.loadSound("armor_clank","combat",{src:["/sounds/combat/armor_clank.mp3"],volume:.6,rate:1}),this.loadSound("magic_cast","combat",{src:["/sounds/combat/magic_cast.mp3"],volume:.7,rate:1}),this.createPlaceholderSounds()}createPlaceholderSounds(){const e=new(window.AudioContext||window.webkitAudioContext);this.createPlaceholderSound("button_click",()=>{const t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.exponentialRampToValueAtTime(400,e.currentTime+.1),i.gain.setValueAtTime(.3,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.1),t.start(e.currentTime),t.stop(e.currentTime+.1)}),this.createPlaceholderSound("hammer_strike",()=>{const t=e.createOscillator(),i=e.createGain();t.connect(i),i.connect(e.destination),t.frequency.setValueAtTime(200,e.currentTime),t.frequency.exponentialRampToValueAtTime(100,e.currentTime+.3),i.gain.setValueAtTime(.4,e.currentTime),i.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}),this.createPlaceholderSound("wind_ambient",()=>{const t=e.createOscillator(),i=e.createGain(),o=e.createBiquadFilter();t.connect(o),o.connect(i),i.connect(e.destination),t.type="noise",o.type="lowpass",o.frequency.setValueAtTime(200,e.currentTime),i.gain.setValueAtTime(.1,e.currentTime),t.start(e.currentTime),t.stop(e.currentTime+2)})}createPlaceholderSound(e,t){this.soundEffects.set(e,{play:t,volume:1,category:"ui"})}loadMusic(){[{id:"main_theme",name:"Ancient Egypt Theme",category:"music"},{id:"desert_wind",name:"Desert Wind",category:"ambient"},{id:"pyramid_mystery",name:"Pyramid Mystery",category:"music"},{id:"crafting_peace",name:"Crafting Peace",category:"music"},{id:"battle_theme",name:"Battle Theme",category:"music"}].forEach(e=>{this.musicTracks.set(e.id,{name:e.name,category:e.category,loaded:!1,howl:null})}),this.simulateMusicLoading()}simulateMusicLoading(){setTimeout(()=>{this.musicTracks.forEach((e,t)=>{e.loaded=!0,console.log(`🎵 Music track loaded: ${e.name}`)})},2e3)}setupEventListeners(){document.addEventListener("crafting_start",()=>{this.playSound("hammer_strike")}),document.addEventListener("item_crafted",()=>{this.playSound("notification")}),document.addEventListener("panel_open",()=>{this.playSound("panel_open")}),document.addEventListener("panel_close",()=>{this.playSound("panel_close")})}playSound(e,t={}){if(!this.soundEnabled)return;const i=this.soundEffects.get(e);if(i)try{if(i.play)i.play();else if(i.howl){const e=t.volume||i.volume||this.soundVolume;i.howl.volume(e*this.masterVolume),i.howl.play()}}catch(o){console.error(`Error playing sound ${e}:`,o)}else console.warn(`Sound not found: ${e}`)}playMusic(e,t={}){if(!this.musicEnabled)return;const i=this.musicTracks.get(e);if(i&&i.loaded)try{if(this.currentMusic&&this.currentMusic.howl&&this.currentMusic.howl.stop(),i.howl){const e=t.volume||this.musicVolume;i.howl.volume(e*this.masterVolume),i.howl.loop(!0),i.howl.play(),this.currentMusic=i}}catch(o){console.error(`Error playing music ${e}:`,o)}else console.warn(`Music not found or not loaded: ${e}`)}stopMusic(){this.currentMusic&&this.currentMusic.howl&&(this.currentMusic.howl.stop(),this.currentMusic=null)}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),oe.Howler.volume(this.masterVolume)}setSoundVolume(e){this.soundVolume=Math.max(0,Math.min(1,e))}setSFXVolume(e){this.soundVolume=Math.max(0,Math.min(1,e)),this.soundEffects.forEach(t=>{"sfx"===t.category&&t.howl&&t.howl.volume(e*this.masterVolume)})}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e)),this.currentMusic&&this.currentMusic.howl&&this.currentMusic.howl.volume(e*this.masterVolume)}toggleSound(){return this.soundEnabled=!this.soundEnabled,this.soundEnabled}toggleMusic(){return this.musicEnabled=!this.musicEnabled,this.musicEnabled||this.stopMusic(),this.musicEnabled}toggleAmbient(){return this.ambientEnabled=!this.ambientEnabled,this.ambientEnabled||this.stopAmbientSounds(),this.ambientEnabled}stopAmbientSounds(){this.soundEffects.forEach(e=>{"ambient"===e.category&&e.howl&&e.howl.stop()})}loadSound(e,t,i){try{const o=new oe.Howl({src:i.src,volume:i.volume||1,rate:i.rate||1,loop:i.loop||!1,preload:!0,onload:()=>{console.log(`🎵 Sound loaded: ${e}`)},onloaderror:(t,i)=>{console.error(`Failed to load sound ${e}:`,i)}});this.soundEffects.set(e,{howl:o,volume:i.volume||1,category:t})}catch(o){console.error(`Error loading sound ${e}:`,o)}}getSound(e){return this.soundEffects.get(e)}getMusic(e){return this.musicTracks.get(e)}getAllSounds(){return Array.from(this.soundEffects.keys())}getAllMusic(){return Array.from(this.musicTracks.keys())}getAudioStats(){return{soundsLoaded:this.soundEffects.size,musicLoaded:Array.from(this.musicTracks.values()).filter(e=>e.loaded).length,masterVolume:this.masterVolume,soundVolume:this.soundVolume,musicVolume:this.musicVolume,soundEnabled:this.soundEnabled,musicEnabled:this.musicEnabled,ambientEnabled:this.ambientEnabled}}destroy(){this.stopMusic(),this.stopAmbientSounds(),this.soundEffects.clear(),this.musicTracks.clear(),oe.Howler.unload(),console.log("🎵 Audio Manager destroyed")}}class se{constructor(){this.totalAssets=0,this.loadedAssets=0,this.loadingProgress=0,this.isLoading=!0,this.loadingScreen=null,this.progressBar=null,this.loadingText=null,this.assetPromises=[],this.isInitialized=!1}async init(){if(this.isInitialized)console.warn("⚠️ LoadingManager already initialized, skipping...");else{if(console.log("📦 Initializing Loading Manager..."),this.loadingScreen=document.getElementById("loading-screen"),this.progressBar=document.querySelector(".loading-progress"),this.loadingText=document.querySelector(".loading-text"),!this.loadingScreen||!this.progressBar||!this.loadingText)throw new Error("Loading screen elements not found");await this.loadAssets(),this.isInitialized=!0,console.log("✅ Loading Manager initialized")}}async loadAssets(){const e=[{name:"Loading game data...",weight:.2},{name:"Loading 3D models...",weight:.3},{name:"Loading textures...",weight:.2},{name:"Loading audio...",weight:.1},{name:"Initializing systems...",weight:.2}];let t=0;for(const i of e)this.updateLoadingText(i.name),await this.simulateLoading(1e3*i.weight),t+=i.weight,this.updateProgress(t);this.updateLoadingText("Ready to enter ancient Egypt..."),await this.simulateLoading(500),this.isLoading=!1}simulateLoading(e){return new Promise(t=>{setTimeout(t,e)})}updateProgress(e){this.loadingProgress=Math.min(e,1),this.progressBar&&(this.progressBar.style.width=100*this.loadingProgress+"%")}updateLoadingText(e){this.loadingText&&(this.loadingText.textContent=e)}hide(){this.loadingScreen&&(this.loadingScreen.style.opacity="0",setTimeout(()=>{this.loadingScreen.style.display="none"},500))}show(){this.loadingScreen&&(this.loadingScreen.style.display="flex",this.loadingScreen.style.opacity="1")}addAsset(e,t){this.totalAssets++,this.assetPromises.push(e),e.then(()=>{this.loadedAssets++,this.updateAssetProgress()}).catch(e=>{console.error(`Failed to load asset: ${t}`,e),this.loadedAssets++,this.updateAssetProgress()})}updateAssetProgress(){if(this.totalAssets>0){const e=this.loadedAssets/this.totalAssets;this.updateProgress(e)}}isLoading(){return this.isLoading}getProgress(){return this.loadingProgress}getLoadedAssets(){return this.loadedAssets}getTotalAssets(){return this.totalAssets}}class ae{constructor(){this.gameEngine=null,this.uiManager=null,this.optionsManager=null,this.networkManager=null,this.audioManager=null,this.loadingManager=null,this.isInitialized=!1}async init(){if(this.isInitialized)console.warn("⚠️ Egypt MMO already initialized, skipping...");else try{console.log("🚀 Initializing Egypt MMO..."),console.log("🔍 Init called at:",(new Date).toISOString()),console.log("🔍 Stack trace:",(new Error).stack),this.loadingManager=new se,await this.loadingManager.init(),console.log("🔍 Creating AudioManager..."),this.audioManager=new ne,console.log("🔍 Creating NetworkManager..."),this.networkManager=new te,console.log("🔍 Creating GameEngine..."),this.gameEngine=new Z,console.log("🔍 Creating UIManager..."),this.uiManager=new Q,console.log("🔍 Creating OptionsManager..."),this.optionsManager=new ee(this.gameEngine),await Promise.all([this.audioManager.init(),this.networkManager.init(),this.gameEngine.init(),this.uiManager.init(),this.optionsManager.init()]),this.gameEngine.setUIManager(this.uiManager),this.gameEngine.setNetworkManager(this.networkManager),this.gameEngine.setAudioManager(this.audioManager),this.gameEngine.setOptionsManager(this.optionsManager),this.uiManager.setGameEngine(this.gameEngine),await this.start()}catch(e){console.error("Failed to initialize Egypt MMO:",e),this.showErrorScreen(e)}}async start(){console.log("🎮 Starting Egypt MMO..."),this.loadingManager.hide(),this.uiManager.show(),this.gameEngine.start(),await this.networkManager.connect(),this.isInitialized=!0,console.log("✅ Egypt MMO started successfully!"),this.setupEventListeners()}setupEventListeners(){let e;window.addEventListener("resize",()=>{this.gameEngine&&(e&&clearTimeout(e),e=setTimeout(()=>{this.gameEngine.handleResize()},150))}),document.addEventListener("visibilitychange",()=>{document.hidden?this.gameEngine?.pause():(this.gameEngine?.resume(),setTimeout(()=>{this.gameEngine&&this.gameEngine.restoreViewport()},100))}),window.addEventListener("focus",()=>{setTimeout(()=>{this.gameEngine&&this.gameEngine.restoreViewport()},100)}),window.addEventListener("beforeunload",()=>{this.networkManager?.disconnect()})}showErrorScreen(e){const t=document.getElementById("loading-screen");t&&(t.innerHTML=`\n                <div class="loading-content">\n                    <div class="egyptian-symbol">⚠️</div>\n                    <h1>Initialization Failed</h1>\n                    <p>${e.message}</p>\n                    <button onclick="location.reload()" class="action-btn">🔄 Retry</button>\n                </div>\n            `)}}document.addEventListener("DOMContentLoaded",()=>{if(window.egyptMMO)return void console.log("🔄 Vite hot reload detected, skipping re-initialization");if(window.gameInitializing)return void console.log("🔄 Game initialization already in progress, skipping...");window.gameInitializing=!0;const e=new ae;window.egyptMMO=e,e.init().finally(()=>{window.gameInitializing=!1})})}}});
